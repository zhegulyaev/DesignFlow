<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DesignFlow ‚Äî –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</title>

<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' ry='6' fill='%230d1117'/%3E%3Cpath d='M11 2 L5 14 H10 L9 22 L19 8 H13 L14 2 Z' fill='%23facc15'/%3E%3C/svg%3E">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0d1117;--card:#161b22;--text:#c9d1d9;--muted:#8b949e;--accent:#58a6ff;--green:#2ea043;--red:#da3633;--gold:#d29922;--border:#30363d;--blue:#238636;--btn-blue:#2f81f7;--link-blue: #007bff;--purple:#a371f7;--btn-hover:#30363d;}
  *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;}
  
  body{background:var(--bg);color:var(--text);padding-bottom:100px;min-height:100vh;display:flex;flex-direction:column;}
  .c{max-width:1600px;margin:0 auto;padding:20px;width:100%;} 
  
  /* Header */
  h1{font-size:42px;font-weight:800;margin:0;letter-spacing: -1px;}
  .brand-grad { background:linear-gradient(90deg,#58a6ff,#a371f7,#d29922);-webkit-background-clip:text;-webkit-text-fill-color:transparent; }
  .brand-white { color: #ffffff; font-weight: 300; -webkit-text-fill-color: #ffffff; }
  
  /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø –≤ —à–∞–ø–∫–µ */
  .header-row{display:flex;justify-content:space-between;align-items:center;margin:30px 0 20px;}
  .month-select{background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 15px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;outline:none;transition:.2s;}
  .month-select:hover{border-color:var(--muted);}

  /* Warning Block */
  .top-panel{background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--border);margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px;}
  .backup-info{color:var(--muted);font-size:13px;max-width:650px;line-height:1.5;}
  .backup-info b{color:#f85149;}
  
  .btns{display:flex;gap:15px;flex-wrap:wrap; align-items: center;} 
  
  button{padding:10px 20px;background:#21262d;border:1px solid var(--border);color:var(--text);border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:.2s;display:flex;align-items:center;gap:8px;white-space: nowrap;}
  button:hover{border-color:var(--accent);color:var(--accent);}
  
  /* Tabs */
  .tabs-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .tabs{display:flex;gap:10px;overflow-x: auto; padding-bottom: 5px; flex-shrink: 1;}
  .tab{flex-shrink: 0; padding:8px 15px;border-radius:8px;cursor:pointer;font-size:15px; background:transparent;border:1px solid transparent;transition:.2s; font-weight: 500; color:var(--muted); display: flex; align-items: center; gap: 6px;}
  .tab svg { width: 14px; height: 14px; opacity: 0.6; transition: opacity .2s; }
  .tab:hover{background:#30363d;border-color:#30363d;color:var(--text);}
  .tab.active{background:var(--card); border-color:var(--border); font-weight: 600; color: var(--text) !important;}
  .tab.active svg { opacity: 1; color: var(--text); }
  .tab.tab-trash { margin-left: auto; }

  /* New Project Button (Notion Style) */
  #newProjectButton { background: var(--btn-blue); color: #fff; border: 1px solid var(--btn-blue); font-weight: 700; padding: 8px 16px; margin-left: 20px;}
  #newProjectButton:hover { background: #3c82f6; border-color: #3c82f6; color: #fff; }

  /* Tab Description - –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ Pace Block */
  .tab-desc-block { margin-bottom: 15px; } 

  /* Main Layout & Tables */
  .table-wrap{overflow-x:auto;background:var(--card);border-radius:12px;border:1px solid var(--border);padding:5px; margin-top: 10px;}
  table{width:100%;border-collapse:collapse; min-width: 1400px;} 
  th{text-align:left;color:var(--muted);font-size:12px;text-transform:uppercase;padding:12px 10px;border-bottom:1px solid var(--border);user-select:none; white-space: nowrap; cursor: pointer;}
  
  /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è Active */
  #t-active th:nth-child(8), /* –†–∞—Å—Ö–æ–¥—ã */
  #t-active th:nth-child(9), /* –°—É–º–º–∞ */
  #t-active th:nth-child(10) { /* –ß–∏—Å—Ç—ã–º–∏ */
      text-align: right;
  }

  th:first-child, td:first-child { width: 5%; cursor: default; text-align: center; }
  td{ padding: 5px 10px; border-bottom:1px solid #21262d; vertical-align:middle; font-size:15px; }
  tr:last-child td{border-bottom:none;}
  tr:hover td{background:#1c2128;}

  /* Checkbox column */
  th.select-col { width: 5%; cursor: default; }
  td.select-col { width: 5%; padding: 0; text-align: center; }
  
  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –∏ –∏–∫–æ–Ω–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è - –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è */
  .select-action-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      height: 100%;
      padding: 0 5px;
  }
  .bulk-checkbox { width: 16px; height: 16px; margin: 0; cursor: pointer; background: transparent; border: 1px solid var(--muted); border-radius: 4px; appearance: none; transition: background .1s, border-color .1s; flex-shrink: 0;}
  .bulk-checkbox:checked { background: var(--accent); border-color: var(--accent); }

  /* Table Footer (Totals) */
  tfoot td { padding: 15px 10px; border-top: 1px solid var(--border); background: transparent; font-weight: 600; color: var(--muted); text-align: right; font-size: 14px; white-space: nowrap; }
  tfoot td:first-child { text-align: left; color: var(--text); font-size: 15px; }
  tfoot td:nth-last-child(3) { color: var(--gold); } /* Total gross (Archive) */
  tfoot td:nth-last-child(2) { color: var(--green); } /* Total net (Archive) */
  /* Active table footer fix */
  #total-row-active td:nth-child(2) { color: var(--green); } /* Total net (Active) */

  
  /* Inputs & Selects */
  [contenteditable]{ outline:none; background: transparent; border: 1px solid transparent; padding: 5px 8px; border-radius: 6px; transition:.2s; display:inline-block; width: 100%; }
  [contenteditable]:focus, [contenteditable]:hover { border-color: var(--border); background: #21262d; cursor: text; }
  
  .date-cell { padding: 0 !important; } 
  .date-input-wrap { width: 100%; padding: 5px 8px; cursor: pointer; user-select: none; display: flex; align-items: center; justify-left: flex-start; transition: .2s; border-radius: 6px; gap: 6px; }
  .date-input-wrap:hover { background: #21262d; }
  .date-text-display { font-size: 14px; font-weight: 500; color: var(--text); white-space: nowrap; }
  .date-icon { color: var(--muted); width: 14px; height: 14px; flex-shrink: 0; } 

  /* Deadline Colors */
  .days-critical { color: var(--red); font-weight: 700; }
  .days-warning { color: var(--gold); font-weight: 700; }
  .days-normal { color: var(--muted); }
  
  /* Price/Contractor/Net Styling */
  .price-cell-wrap { display: flex; align-items: center; justify-content: flex-end; gap: 5px; height: 100%;}
  .price-cell-wrap input[type="number"] {
    background: transparent;
    border: none;
    color: var(--text);
    width: 100%;
    max-width: 90px;
    font-family: monospace;
    font-weight: 600;
    outline: none;
    text-align: right;
    padding: 5px 0; /* –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
    margin: 0;
    -moz-appearance: textfield;
  }
  .price-cell-wrap:focus-within { border-color: var(--border); background: #21262d; border-radius: 6px; }
  .price-cell-wrap input::-webkit-outer-spin-button, .price-cell-wrap input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .currency-symbol { color: var(--muted); font-size: 14px; font-weight: 600; font-family: monospace; min-width: 15px; }

  /* Net Column Fix */
  .net-display-wrap { display: flex; flex-direction: column; align-items: flex-end; padding: 5px 0; }
  .net-main-val { font-weight: 600; color: var(--text); }
  .net-prc-val { 
      font-size: 12px; 
      font-weight: 500; /* –ù–µ –∂–∏—Ä–Ω—ã–π */
      opacity: 0.6; /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
      color: var(--muted); 
      margin-top: 2px;
  }


  .paid-select, .tax-select { background: transparent; color: var(--text); border: 1px solid transparent; padding: 5px; border-radius: 6px; font-size: 13px; cursor: pointer; outline: none; transition: .2s; text-align: center;}
  .paid-select:hover, .tax-select:hover { background: var(--btn-hover); border-color: var(--border); }
  .paid-select option, .tax-select option { background: var(--card); }

  /* Actions */
  .client-wrap{display:flex;align-items:center;gap:8px; width: 100%;}
  .project-name-wrap {
    display: flex; align-items: center; gap: 8px;
    overflow: hidden;
  }
  .project-name-wrap span[contenteditable] { 
    flex-grow: 1; 
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis; 
    min-width: 100px; 
  }
  
  .dup-icon { opacity: 0; transition: opacity 0.2s; cursor: pointer; color: var(--muted); width: 16px; height: 16px; flex-shrink: 0;}
  tr:hover .dup-icon { opacity: 1; }

  .client-name.has-link { color: var(--link-blue); font-weight: 700; }
  
  .action-btns{display:flex;gap:6px;align-items:center;}
  .action-btn-base { padding: 6px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; user-select: none; min-width: 32px; text-align: center; }
  .done-btn:hover { background: var(--green); color: #fff; border-color: var(--green);}
  .wait-btn:hover { background: var(--purple); color: #fff; border-color: var(--purple);}
  .pause-btn:hover { background: var(--link-blue); color: #fff; border-color: var(--link-blue);}
  /* New hover styles for wait and pause in active table */
  .wait-active-btn:hover { background: var(--purple); color: #fff; border-color: var(--purple);}
  .pause-active-btn:hover { background: var(--link-blue); color: #fff; border-color: var(--link-blue);}

  .link-btn {
      padding: 5px;
      margin: 0;
      background: transparent;
      border: 1px solid transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 12px;
      flex-shrink: 0;
  }
  .link-btn:hover { border-color: var(--accent); color: var(--accent); }
  .link-btn-active { color: var(--accent); border-color: var(--border); background: #1a1f26; border-radius: 6px; }
  .link-btn-go { border: 1px solid var(--border); border-radius: 6px; background: #1a1f26; color: var(--text); }
  .link-btn-go:hover { border-color: var(--accent); color: var(--accent); }
  
  .del-btn{color:var(--red);cursor:pointer;font-size:18px;opacity:0.5; margin-left: 8px; flex-shrink: 0;}
  .del-btn:hover{opacity:1;}
  
  /* Pacing Block Updated (Fire) */
  .pace-block { 
    background: var(--card); border: 1px solid var(--border); border-radius: 12px; 
    padding: 15px 20px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    margin-bottom: 20px; 
    margin-top: 15px; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    transition: background .3s; 
  }
  .pace-block.critical { background: rgba(218, 54, 51, 0.15); border-color: var(--red); }
  .pace-info { display: flex; align-items: center; gap: 15px; }
  .pace-icon { font-size: 24px; }
  .pace-status { font-weight: 700; font-size: 14px; padding: 5px 12px; border-radius: 6px; }
  .pace-chill { background: rgba(57, 211, 83, 0.1); color: var(--green); }
  .pace-hurry { background: var(--red); color: white; }
  
  /* Stats Dashboard fixes */
  .stats-full { margin-top: 50px; display: flex; flex-direction: column; gap: 20px; }
  .stats-two-columns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .card-head { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
  .finance-title { font-size: 20px; font-weight: 800; color: #fff; }
  .finance-sub { color: var(--muted); font-size: 13px; margin-top: 4px; }
  .goal-wrap { margin-bottom: 18px; }
  .goal-info { display: flex; justify-content: space-between; font-size: 13px; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
  .progress-bg { height: 8px; background: linear-gradient(90deg, #1c2128, #1a1f26); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
  .progress-fill { height: 100%; width: 0; background: linear-gradient(90deg, #2ea043, #3fb950); transition: width 0.5s; box-shadow: 0 0 12px rgba(46,160,67,0.3); }
  .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
  .stat-box { padding: 14px; border: 1px solid var(--border); border-radius: 10px; background: #0f141b; }
  .stat-label-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 6px; }
  .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
  .stat-pill { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; background: rgba(88,166,255,0.12); color: var(--accent); border: 1px solid rgba(88,166,255,0.3); }
  .stat-val { font-size: 30px; font-weight: 800; }
  .stat-helper { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .text-green { color: var(--green); }
  .text-gold { color: var(--gold); }
  .mono { font-family: monospace; }
  .record-banner { background: #0f141b; border: 1px solid var(--border); padding: 18px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: inset 0 0 0 1px rgba(250, 204, 21, 0.05); }
  .record-title { color: var(--muted); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .record-value { font-size: 26px; font-weight: 900; color: var(--gold); }
  /* Bulk Toolbar */
  .bulk-toolbar {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
      background: var(--card); padding: 10px 20px; border-radius: 12px; 
      border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex; gap: 15px; z-index: 999; align-items: center;
  }
  .bulk-action-btn { 
      background: #21262d; border: 1px solid var(--border); color: var(--text); 
      padding: 8px 15px; font-size: 14px; border-radius: 6px; cursor: pointer; 
      transition: .2s; white-space: nowrap;
  }
  .bulk-action-btn.delete { color: var(--red); border-color: var(--red); }
  .bulk-action-btn:hover { background: #30363d; }
  .bulk-action-btn.delete:hover { background: rgba(218, 54, 51, 0.1); }
  
  /* Bulk Move Select */
  .bulk-move-select {
      padding: 8px 15px;
      background: #21262d;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      transition: .2s;
  }
  .bulk-move-select:hover { border-color: var(--accent); }
  .bulk-move-select option { background: var(--card); }


  /* Modals */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;backdrop-filter: blur(4px);}
  .modal-content{background:var(--card);padding:30px;border-radius:16px;width:400px;max-width:90%;border:1px solid var(--border);text-align:center; position: relative;}
  
  /* Inputs & Selects inside modal */
  .inp-group{margin-bottom:15px;text-align:left;}
  .inp-group label{display:block;margin-bottom:5px;font-size:13px;color:var(--muted);font-weight:600;}
  .inp-group input, .inp-group select {background-color: #21262d;border:1px solid var(--border);padding:10px;width:100%;color:var(--text);border-radius:8px; outline: none; box-sizing: border-box;}
  .row-inputs{display:flex;gap:15px;margin-bottom:15px;}
  .row-inputs > div {flex: 1;}
  .deadline-presets { display: flex; gap: 10px; align-items: flex-end; }
  .deadline-presets select { min-width: 130px; }
  
  .close-modal-x { 
      position: absolute; 
      top: 10px; 
      right: 15px; 
      font-size: 24px; 
      color: var(--muted); 
      cursor: pointer; 
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s;
  }
  .close-modal-x:hover { opacity: 1; }
  .save-stg { width: 100%; margin-top: 20px; }
  
  /* Settings Modal specific padding fix */
  #settingsModal .modal-content {
      padding: 30px; /* –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  }

  /* Date/Time Input Styling (Override attempts for dark theme) */
  .inp-group input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.8; cursor: pointer; }
  .inp-group input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.8; cursor: pointer; }
  .inp-group input:focus, .inp-group select:focus { border-color: var(--accent); }

  /* Finance Block Percentage */
  .stat-val-small { font-size: 16px; font-weight: 600; color: var(--muted); margin-left: 10px;}
  .stat-label-row { display: flex; align-items: center; justify-content: space-between; }
  .stat-val-margin { font-size: 24px; font-weight: 800; color: var(--text); }
  
  /* Link Modal Specific */
  #linkModal .modal-content { width: 350px; }
  
  /* Checkbox styling */
  .checkbox-wrap { 
    display: flex; align-items: center; gap: 8px; font-size: 14px; 
    color: var(--muted); margin-bottom: 15px; cursor: pointer;
    user-select: none;
  }
  .checkbox-wrap input[type="checkbox"] { width: 16px; height: 16px; margin: 0; cursor: pointer; }
  
  /* Trash Table Button Fix */
  .trash-action-btns { display: flex; gap: 10px; align-items: center; }
  .restore-trash-btn, .delete-forever-text {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s, border-color 0.2s;
      white-space: nowrap;
      text-decoration: none; /* For delete-forever-text */
      display: inline-block;
      text-align: center;
      min-width: 100px;
  }
  .restore-trash-btn { 
      color: var(--green); 
      border: 1px solid var(--green); 
      background: transparent; 
  }
  .restore-trash-btn:hover { 
      background: rgba(46, 160, 67, 0.1);
  }
  .delete-forever-text {
      color: var(--red);
      border: 1px solid var(--red);
      background: transparent;
      opacity: 1; /* –ü–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å */
  }
  .delete-forever-text:hover {
       background: rgba(218, 54, 51, 0.1);
  }
</style>
</head>
<body>

<svg style="display: none;">
    <symbol id="icon-active" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM3 8a5 5 0 0 1 10 0 5 5 0 0 1-10 0Z"/></symbol>
    <symbol id="icon-waiting" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM8 4a1 1 0 0 1 1 1v3.5a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1 0-1H8V5a1 1 0 0 1 1-1Z"/></symbol>
    <symbol id="icon-potential" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM8 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3ZM6 3a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3A.5.5 0 0 1 6 3Zm-2.5 5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5Z"/></symbol>
    <symbol id="icon-paused" viewBox="0 0 16 16"><path fill="currentColor" d="M5 2.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Zm6 0a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Z"/></symbol>
    <symbol id="icon-archive" viewBox="0 0 16 16"><path fill="currentColor" d="M13 1.75a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v12.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75Zm-1.5 8.75a.5.5 0 0 1-1 0V6.707L6.464 10.464a.5.5 0 0 1-.708-.708L10.793 6H7.5a.5.5 0 0 1 0-1h4.5a.5.5 0 0 1 .5.5v4.5Z"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 16 16"><path fill="currentColor" d="M4 3.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5ZM6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 10.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Z"/></symbol>
    <symbol id="icon-duplicate" viewBox="0 0 16 16"><path fill="currentColor" d="M2.25 1.75a.75.75 0 0 1 .75-.75h7.25a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0V2.5h-6.5v8h2a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1-.75-.75Zm4.5 4a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 .75.75v8a.75.75 0 0 1-.75.75h-6a.75.75 0 0 1-.75-.75v-8Z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 16 16"><path fill="currentColor" d="M3 2.75A.75.75 0 0 1 3.75 2h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 2.75ZM12.25 2a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5c0-.414.336-.75.75-.75ZM2 5.5a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 5.5Zm12.5 2.25v7.25c0 .414-.336.75-.75.75H2.25a.75.75 0 0 1-.75-.75V7.75c0-.414.336-.75.75-.75h11.5c.414 0 .75.336.75.75Z"/></symbol>
</svg>

<div class="c">
  
  <div class="header-row">
    <h1><span class="brand-grad">DesignFlow</span> <span class="brand-white">‚Äî –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</span></h1>
    <div style="display:flex;gap:15px;align-items:center">
        <button onclick="openSettings()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ª–µ–π</button>
        <select id="monthSelect" class="month-select" onchange="changeMonth(this.value)"></select>
    </div>
  </div>


  <div class="top-panel">
    <div class="backup-info">
      <b>‚ö† –í–∞–∂–Ω–æ:</b> –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. <br>
      –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ –∏–ª–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.
    </div>
    <div class="btns">
      <button onclick="exp()">üíæ –°–∫–∞—á–∞—Ç—å –±–∞–∑—É (–ë—ç–∫–∞–ø)</button>
      <button onclick="document.getElementById('imp').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É</button>
      <input type="file" id="imp" accept=".json" style="display:none" onchange="imp(this.files[0])">
      <button onclick="expCSV()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
    </div>
  </div>

  <div class="tabs-container">
    <div class="tabs">
        <div class="tab active" id="tab-active" onclick="switchTab('active')"><svg><use href="#icon-active"/></svg> –í —Ä–∞–±–æ—Ç–µ</div>
        <div class="tab" id="tab-waiting" onclick="switchTab('waiting')"><svg><use href="#icon-waiting"/></svg> –û–∂–∏–¥–∞–µ—Ç</div>
        <div class="tab" id="tab-potential" onclick="switchTab('potential')"><svg><use href="#icon-potential"/></svg> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>
        <div class="tab" id="tab-paused" onclick="switchTab('paused')"><svg><use href="#icon-paused"/></svg> –ù–∞ –ø–∞—É–∑–µ</div>
        <div class="tab" id="tab-archive" onclick="switchTab('archive')"><svg><use href="#icon-archive"/></svg> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
        <div class="tab tab-trash" id="tab-trash" onclick="switchTab('trash')"><svg><use href="#icon-trash"/></svg> –ö–æ—Ä–∑–∏–Ω–∞</div>
    </div>
    <button id="newProjectButton" onclick="openAddModal()">Ôºã –ù–æ–≤—ã–π</button>
  </div>
  
  <div class="tab-desc-block" id="tab-description">–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É.</div>

  <div class="pace-block" id="pace-indicator" style="display:none;">
      <div class="pace-info">
          <div class="pace-icon" id="pace-icon">üî•</div>
          <div>
              <div style="font-weight:700;font-size:16px; color:var(--text);" id="pace-title">–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!</div>
              <div style="font-size:13px;color:var(--muted)" id="pace-desc">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
      </div>
      <div class="pace-status" id="pace-status">–ö—Ä–∏—Ç–∏—á–Ω–æ</div>
  </div>

  <div class="main-layout">
    
    <div id="view-active">
      <div class="table-wrap">
        <table id="t-active">
          <thead>
            <tr>
              <th class="select-col"></th>
              <th width="15%" onclick="sortData('active', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç</th> 
              <th width="20%" onclick="sortData('active', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç</th> 
              <th width="8%" onclick="sortData('active', 'start', 'date')">–°—Ç–∞—Ä—Ç</th> 
              <th width="8%" onclick="sortData('active', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω</th> 
              <th width="6%" onclick="sortData('active', 'rem', 'number')">–û—Å—Ç–∞–ª–æ—Å—å</th>
              <th width="4%" onclick="sortData('active', 'taxPrc', 'number')">–ù–∞–ª–æ–≥ %</th>
              <th width="7%" onclick="sortData('active', 'contractor', 'number')" style="text-align:right;">–†–∞—Å—Ö–æ–¥—ã</th>
              <th width="8%" onclick="sortData('active', 'p', 'number')" style="text-align:right;">–°—É–º–º–∞</th>
              <th width="8%" style="text-align:right;">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="6%">–û–ø–ª–∞—á–µ–Ω–æ</th>
              <th width="4%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-active"><tr><td colspan="8">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-waiting" style="display:none">
        <div class="table-wrap">
          <table id="t-waiting">
            <thead>
              <tr>
                <th class="select-col"></th>
                <th width="20%" onclick="sortData('waiting', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç</th> 
                <th width="30%" onclick="sortData('waiting', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç</th> 
                <th width="15%" onclick="sortData('waiting', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω</th>
                <th width="15%" onclick="sortData('waiting', 'p', 'number')">–°—É–º–º–∞</th>
                <th width="15%"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="total-row-waiting"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
          </table>
        </div>
    </div>
    
    <div id="view-potential" style="display:none">
        <div class="table-wrap">
          <table id="t-potential">
            <thead>
              <tr>
                <th class="select-col"></th>
                <th width="25%" onclick="sortData('potential', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç</th> 
                <th width="40%" onclick="sortData('potential', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç</th> 
                <th width="15%" onclick="sortData('potential', 'p', 'number')">–°—É–º–º–∞</th>
                <th width="20%"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="total-row-potential"><tr><td colspan="3">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
          </table>
        </div>
    </div>

    <div id="view-paused" style="display:none">
      <div class="table-wrap">
        <table id="t-paused">
          <thead>
            <tr>
              <th class="select-col"></th>
              <th width="20%" onclick="sortData('paused', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç</th> 
              <th width="30%" onclick="sortData('paused', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç</th> 
              <th width="15%" onclick="sortData('paused', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω</th>
              <th width="15%" onclick="sortData('paused', 'p', 'number')">–°—É–º–º–∞</th>
              <th width="15%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-paused"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-archive" style="display:none">
      <div class="table-wrap">
        <table id="t-archive">
          <thead>
            <tr>
              <th class="select-col"></th>
              <th width="15%" onclick="sortData('archive', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç</th> 
              <th width="25%" onclick="sortData('archive', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç</th> 
              <th width="15%" onclick="sortData('archive', 'date', 'date')">–î–∞—Ç–∞ —Å–¥–∞—á–∏</th>
              <th width="10%" onclick="sortData('archive', 'p', 'number')">–°—É–º–º–∞</th>
              <th width="10%" onclick="sortData('archive', 'contractor', 'number')">–†–∞—Å—Ö–æ–¥—ã</th>
              <th width="10%">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="10%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-archive"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
    
    <div id="view-trash" style="display:none">
      <div class="table-wrap">
        <table id="t-trash">
          <thead>
            <tr>
              <th class="select-col"></th>
              <th width="20%">–£–¥–∞–ª–µ–Ω–æ</th>
              <th width="20%">–ö–ª–∏–µ–Ω—Ç</th> 
              <th width="30%">–ü—Ä–æ–µ–∫—Ç</th> 
              <th width="15%">–°—É–º–º–∞</th>
              <th width="15%">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">
          –û–±—ä–µ–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–¥–µ—Å—å 7 –¥–Ω–µ–π, –∑–∞—Ç–µ–º —É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞.
      </div>
    </div>
  </div> 
  
  <div class="dashboard">
    <div class="stats-full">
      <div class="stats-two-columns">
          <div class="card">
              <div class="card-head">
                  <div>
                      <div class="finance-title">–§–∏–Ω–∞–Ω—Å—ã: <span class="text-green" id="dash-month-name">...</span></div>
                      <div class="finance-sub">–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ (–û–±—â–∏–π –§–∞–∫—Ç –ß–∏—Å—Ç—ã–º–∏)</div>
                  </div>
                  <div class="stat-pill" id="goal-pill">–¶–µ–ª—å: 0 ‚ÇΩ</div>
              </div>
              <div class="goal-wrap">
                  <div class="goal-info">
                      <span>–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏</span>
                      <span id="goal-text">0 / 0 ‚ÇΩ</span>
                  </div>
                  <div class="progress-bg"><div class="progress-fill" id="p-bar"></div></div>
              </div>
              <div class="stats-grid">
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label">–§–∞–∫—Ç</div>
                          <div class="stat-pill">–ß–∏—Å—Ç—ã–º–∏</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-fact">0 ‚ÇΩ</div>
                      <div class="stat-helper" id="val-fact-prc">0%</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label">–ü–æ–ª—É—á–µ–Ω–æ</div>
                          <div class="stat-pill">–ß–∏—Å—Ç—ã–º–∏, Active</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-active-fact">0 ‚ÇΩ</div>
                      <div class="stat-helper">–û–ø–ª–∞—á–µ–Ω–æ –≤ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label">–ü–ª–∞–Ω</div>
                          <div class="stat-pill">–û—Å—Ç–∞—Ç–æ–∫</div>
                      </div>
                      <div class="stat-val text-gold mono" id="val-plan">0 ‚ÇΩ</div>
                      <div class="stat-helper">–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label">–ü—Ä–æ–≥–Ω–æ–∑ –∏—Ç–æ–≥–∞</div>
                          <div class="stat-pill">–§–∞–∫—Ç + –ü–ª–∞–Ω</div>
                      </div>
                      <div class="stat-val mono" id="val-total" style="color:var(--accent)">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ú–∞—Ä–∂–∞: <span id="val-margin">0 ‚ÇΩ</span> (<span id="val-margin-prc">0%</span>)</div>
                  </div>
              </div>
              <div style="position:relative;height:250px;width:100%"><canvas id="lineChart"></canvas></div>
          </div>

          <div class="card">
              <div class="card-head">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
              <div style="position:relative;height:200px;width:100%;display:flex;justify-content:center;margin-bottom:20px;"><canvas id="pieChart"></canvas></div>
              <div style="border-top:1px solid var(--border); padding-top:20px;">
                  <div style="font-size:14px;color:var(--muted);margin-bottom:15px;font-weight:600">–ü–æ –º–µ—Å—è—Ü–∞–º</div>
                  <div style="height:150px;width:100%"><canvas id="barChart"></canvas></div>
              </div>
          </div>
      </div>

      <div class="record-banner">
          <div class="record-title">üèÜ –†–µ–∫–æ—Ä–¥–Ω—ã–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –º–µ—Å—è—Ü</div>
          <div class="record-value mono" id="record-amount">0 ‚ÇΩ</div>
      </div>
    </div>
  </div>
  
  <footer style="text-align:center; margin-top:50px; padding-top:20px; border-top:1px solid var(--border); color:var(--muted); font-size: 14px;">
      DesignFlow Tracker by 
      <a href="https://t.me/r_zhegulyaev" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">Zhegulyaev</a>
  </footer>
</div>

<div class="bulk-toolbar" id="bulkToolbar" style="display: none;">
    <span style="color:var(--text); font-weight: 600;" id="bulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
    <button class="bulk-action-btn" onclick="bulkDuplicate()">‚ùê –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
    
    <select id="bulkMoveSelect" class="bulk-move-select" onchange="askBulkMove(this.value)">
        <option value="">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤...</option>
        <option value="active">–í —Ä–∞–±–æ—Ç—É</option>
        <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
        <option value="paused">–ù–∞ –ø–∞—É–∑–µ</option>
        <option value="archive">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–ê—Ä—Ö–∏–≤)</option>
    </select>
    
    <button class="bulk-action-btn delete" onclick="askBulkDelete()">√ó –£–¥–∞–ª–∏—Ç—å</button>
</div>

<div class="modal" id="addProjectModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('addProjectModal').style.display='none'">√ó</span>
        <h2 style="margin-bottom:20px">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
        <div class="inp-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
            <input type="text" id="add-proj-name" placeholder="–°–∞–π—Ç –¥–ª—è –∫–æ—Ñ–µ–π–Ω–∏">
        </div>
        <div class="inp-group">
            <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input type="text" id="add-proj-client" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
        </div>
        <div class="row-inputs">
             <div class="inp-group" style="flex:1">
                <label>–°—É–º–º–∞ (‚ÇΩ)</label>
                <input type="number" id="add-proj-price" placeholder="50000">
            </div>
             <div class="inp-group" style="flex:1">
                <label>–†–∞—Å—Ö–æ–¥—ã (‚ÇΩ)</label>
                <input type="number" id="add-proj-contractor" placeholder="0">
            </div>
             <div class="inp-group" style="width:80px">
                <label>–ù–∞–ª–æ–≥</label>
                <select id="add-proj-tax">
                    <option value="0">0%</option>
                    <option value="4">4%</option>
                    <option value="6">6%</option>
                    <option value="13">13%</option>
                </select>
            </div>
        </div>
        
        <div class="row-inputs deadline-presets">
            <div class="inp-group" style="flex:1">
                <label>–°—Ç–∞—Ä—Ç</label>
                 <div class="date-input-wrap" id="add-proj-start-display" onclick="openDateInModal('add-proj-start-val')">
                    <svg class="date-icon"><use href="#icon-calendar"/></svg>
                    <span class="date-text-display">–°–µ–≥–æ–¥–Ω—è</span>
                 </div>
                 <input type="hidden" id="add-proj-start-val" value="">
            </div>
            <div class="inp-group" style="flex:1">
                 <label>–î–µ–¥–ª–∞–π–Ω</label>
                 <div class="date-input-wrap" id="add-proj-dl-display" onclick="openDateInModal('add-proj-dl-val')">
                    <svg class="date-icon"><use href="#icon-calendar"/></svg>
                    <span class="date-text-display">–°–µ–≥–æ–¥–Ω—è</span>
                 </div>
                 <input type="hidden" id="add-proj-dl-val" value="">
            </div>
            <div class="inp-group" style="width:160px">
                <label>–ë—ã—Å—Ç—Ä—ã–π –¥–µ–¥–ª–∞–π–Ω</label>
                <select id="add-proj-dl-days" onchange="applyDeadlinePreset()">
                    <option value="">‚Äî</option>
                    <option value="1">1 –¥–µ–Ω—å</option>
                    <option value="2">2 –¥–Ω—è</option>
                    <option value="3">3 –¥–Ω—è</option>
                    <option value="5">5 –¥–Ω–µ–π</option>
                    <option value="7">7 –¥–Ω–µ–π</option>
                    <option value="14">14 –¥–Ω–µ–π</option>
                </select>
            </div>
        </div>

        <div class="inp-group">
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select id="add-proj-type">
                <option value="active">–í —Ä–∞–±–æ—Ç—É</option>
                <option value="potential">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</option>
                <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
                <option value="paused">–ù–∞ –ø–∞—É–∑–µ</option>
                <option value="archive">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–ê—Ä—Ö–∏–≤)</option>
            </select>
        </div>
        
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveNewProject()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<div class="modal" id="linkModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="closeLinkModal()">√ó</span>
        <h3 style="margin-bottom:10px">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <div class="inp-group">
            <input type="url" id="link-input" placeholder="https://t.me/...">
        </div>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" id="saveLinkBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="dateModal">
    <div class="modal-content date-modal-content">
        <span class="close-modal-x" onclick="closeDateModal()">√ó</span>
        <h3 style="margin-bottom: 0;" id="date-modal-title">–î–∞—Ç–∞</h3>
        <p style="color:var(--muted); font-size: 13px; margin-bottom: 15px;">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è.</p>
        
        <label class="checkbox-wrap">
            <input type="checkbox" id="date-has-time" onchange="toggleTimeInput()"> 
            –£–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
        </label>
        
        <div class="date-time-inputs" style="display:flex; gap: 15px;">
            <input type="date" id="date-input-val" style="flex:1">
            <input type="time" id="time-input-val" style="flex:1" disabled>
        </div>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveDate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('settingsModal').style.display='none'">√ó</span>
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="inp-group">
            <label>–¶–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü (‚ÇΩ)</label>
            <input type="number" id="stg-goal">
        </div>
        <div class="inp-group">
            <label>–†–µ–∫–æ—Ä–¥ (‚ÇΩ)</label>
            <input type="number" id="stg-rec">
        </div>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="deleteConfirmModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('deleteConfirmModal').style.display='none'">√ó</span>
        <h3 style="color:var(--text); margin-bottom:10px;" id="del-modal-title">–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É?</h3>
        <p style="color:var(--muted); margin-bottom: 20px; font-size:14px;" id="del-modal-desc">–û–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 7 –¥–Ω–µ–π.</p>
        <div style="display:flex;gap:15px;">
            <button onclick="document.getElementById('deleteConfirmModal').style.display='none'" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
            <button class="confirm-del-btn" style="background:var(--red); border-color:var(--red);" id="finalDeleteBtn" style="flex:1">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
const K = 'grok_design_v5'; 
const now = new Date();
const today = now.toISOString().slice(0, 10);
let currentMonth = today.slice(0,7); 
let currentTab = 'active';

let DATA = {
    settings: { record: 0 }, 
    monthlyGoals: { [currentMonth]: 250000 }, 
    active: [], archive: [], paused: [], waiting: [], potential: [], trash: []
};

let SORT = { active: 'dl', archive: 'date', potential: 'p', waiting: 'dl', paused: 'dl' }; 
let queue = { type: null, idx: null, field: null, targetId: null };

// --- BULK ACTIONS ---
let selectedRows = {}; // {active: Set(), waiting: Set(), ...}

function renderLinkControls(item, idx, type) {
    const hasLink = !!item.link;
    const editBtn = `<button class="link-btn ${hasLink ? 'link-btn-active' : ''}" onclick="openLink('${type}',${idx})" title="${hasLink ? '–ò–∑–º–µ–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É' : '–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É'}">üîó</button>`;
    const goBtn = hasLink ? `<button class="link-btn link-btn-go" onclick="openProjectLink(${idx}, '${type}')" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">‚Üó</button>` : '';
    return editBtn + goBtn;
}

function getClientNameClass(item) {
    return `client-name${item.link ? ' has-link' : ''}`;
}

function toggleSelect(type, idx, checkbox) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    const indexStr = idx.toString();
    
    if (checkbox.checked) {
        selectedRows[type].add(indexStr);
    } else {
        selectedRows[type].delete(indexStr);
    }
    updateBulkToolbar(type);
    
    const allChecked = selectedRows[type].size === DATA[type].length && DATA[type].length > 0;
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if(selectAllCheckbox) selectAllCheckbox.checked = allChecked;
}

function toggleSelectAll(type) {
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (!selectAllCheckbox) return;

    const isChecked = selectAllCheckbox.checked;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);
    
    if (!selectedRows[type]) selectedRows[type] = new Set();
    
    checkboxes.forEach((cb, i) => {
        cb.checked = isChecked;
        const row = cb.closest('tr');
        if (row && row.dataset.index) {
            const indexStr = row.dataset.index;
            if (isChecked) {
                selectedRows[type].add(indexStr);
            } else {
                selectedRows[type].delete(indexStr);
            }
        }
    });
    updateBulkToolbar(type);
}

function updateBulkToolbar(type) {
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    const toolbar = document.getElementById('bulkToolbar');
    
    document.getElementById('bulkCount').textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
    document.getElementById('bulkMoveSelect').value = ''; 

    toolbar.style.display = count > 0 ? 'flex' : 'none';
}

function askBulkDelete(type = currentTab) {
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    if (count === 0) return;
    
    document.getElementById('del-modal-title').innerText = `–£–¥–∞–ª–∏—Ç—å ${count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É?`;
    document.getElementById('del-modal-desc').innerText = "–û–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 7 –¥–Ω–µ–π.";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = '–£–¥–∞–ª–∏—Ç—å';
    document.getElementById('finalDeleteBtn').onclick = () => bulkDelete(type);
}

function bulkDelete(type = currentTab) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;

    const indicesToDelete = Array.from(selectedRows[type])
        .map(Number)
        .sort((a, b) => b - a); 
    
    indicesToDelete.forEach(idx => {
        const itemIndex = DATA[type].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[type].splice(itemIndex, 1)[0];
            item.deletedAt = Date.now();
            DATA.trash.unshift(item);
        }
    });
    
    selectedRows[type].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    save(); upd();
}

function bulkDuplicate(type = currentTab) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;
    
    const indicesToDuplicate = Array.from(selectedRows[type])
        .map(Number)
        .sort((a, b) => a - b);
    
    const newItems = [];
    
    indicesToDuplicate.forEach(idx => {
        const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
        if(item) {
             item.n = item.n + " (–ö–æ–ø–∏—è)";
             newItems.push(item);
        }
    });
    
    DATA[type].unshift(...newItems);
    selectedRows[type].clear();
    save(); upd();
}

function askBulkMove(targetType) {
    const currentType = currentTab;
    const count = selectedRows[currentType] ? selectedRows[currentType].size : 0;
    
    if (count === 0 || !targetType) {
        document.getElementById('bulkMoveSelect').value = '';
        return;
    }
    
    const targetName = document.querySelector(`#bulkMoveSelect option[value="${targetType}"]`).text;
    
    document.getElementById('del-modal-title').innerText = `–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ${count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ "${targetName}"?`;
    document.getElementById('del-modal-desc').innerText = `–ü—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "${document.getElementById(`tab-${currentType}`).textContent.trim()}".`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').innerText = '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏';
    
    document.getElementById('finalDeleteBtn').onclick = () => bulkMove(currentType, targetType);
}

function bulkMove(from, to) {
    if (!selectedRows[from] || selectedRows[from].size === 0) return;

    const indicesToMove = Array.from(selectedRows[from])
        .map(Number)
        .sort((a, b) => b - a);
    
    indicesToMove.forEach(idx => {
        const itemIndex = DATA[from].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[from].splice(itemIndex, 1)[0];
            if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
            if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
            if(to === 'potential' || to === 'waiting' || to === 'paused') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
            DATA[to].unshift(item);
        }
    });
    
    selectedRows[from].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.getElementById('bulkMoveSelect').value = '';
    save(); 
    if(from === to) {
        upd();
    } else {
        switchTab(to);
    }
}

function init(){
    let exist = localStorage.getItem(K);
    if(!exist) { const v4 = localStorage.getItem('grok_design_v4'); if(v4) exist = v4; }
    
    if (exist) {
        try { 
            const parsed = JSON.parse(exist);
            DATA = { ...DATA, ...parsed };
            if(!DATA.trash) DATA.trash = [];
            ['active', 'archive', 'paused', 'waiting', 'potential'].forEach(type => {
                 DATA[type].forEach(i => {
                    if(i.contractor === undefined) i.contractor = 0;
                    if(i.taxPrc === undefined) i.taxPrc = 0;
                 });
            });
        } catch(e) { console.error("Data load error", e); }
    }
    
    cleanupTrash();
    renderMonthSelect();
    setupModalsBackgroundCheck(); 
    document.getElementById('saveLinkBtn').onclick = saveLink;
    document.getElementById('add-proj-start-val').value = today;
    document.getElementById('add-proj-dl-val').value = today;
    sortData('active', 'dl', 'date', true);
    upd(); 
}

function save(){ localStorage.setItem(K, JSON.stringify(DATA)); }

function cleanupTrash(){
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    const nowMs = Date.now();
    const initLen = DATA.trash.length;
    DATA.trash = DATA.trash.filter(i => (nowMs - (i.deletedAt || 0)) < sevenDays);
    if(DATA.trash.length !== initLen) save();
}

function formatCurrency(n) { return new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ'; }

function formatDateDisplay(str) {
    if (!str || str.startsWith('0000')) return '‚Äî';
    const hasTime = str.includes('T') && str.length > 10;
    const dateObj = new Date(str.replace(' ', 'T'));
    if(isNaN(dateObj.getTime())) return '‚Äî';
    const d = dateObj.toLocaleDateString('ru', { day: 'numeric', month: 'short' }).replace('.', '');
    if(hasTime) return `${d} <span style="opacity:0.6;font-size:0.9em;margin-left:4px">${dateObj.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</span>`;
    return d;
}

function calcNet(item){
    const gross = +item.p || 0;
    const contr = +item.contractor || 0;
    const tax = +item.taxPrc || 0;
    const taxAmt = gross * (tax / 100);
    return Math.round(gross - taxAmt - contr);
}
function calcMarginPrc(item) {
    const gross = +item.p || 0;
    if (gross === 0) return 0;
    const net = calcNet(item);
    return Math.round((net / gross) * 100);
}

function setupModalsBackgroundCheck() {
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
}

function switchTab(t){
    currentTab = t;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
    ['active','waiting','potential','paused','archive','trash'].forEach(k => {
        const el = document.getElementById(`view-${k}`);
        if(el) el.style.display = (k === t) ? 'block' : 'none';
        const cb = document.getElementById(`selectAll${k.charAt(0).toUpperCase() + k.slice(1)}`);
        if(cb) cb.checked = false;
        if(selectedRows[k]) selectedRows[k].clear();
    });
    
    const desc = document.getElementById('tab-description');
    const descs = {
        active: "–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É.",
        waiting: "–û–∂–∏–¥–∞—é—Ç —Ä–µ–∞–∫—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.",
        potential: "–õ–∏–¥—ã –∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã. –ï—â—ë –Ω–µ –Ω–∞—á–∞—Ç—ã.",
        paused: "–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.",
        archive: "–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã.",
        trash: "–£–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã. –•—Ä–∞–Ω—è—Ç—Å—è 7 –¥–Ω–µ–π."
    };
    desc.textContent = descs[t];
    updateBulkToolbar(t);
    upd();
}

function sortData(type, key, dataType, initial = false) {
    if (!DATA[type]) return;
    let direction = 1;
    if (SORT[type] === key && !initial) {
        direction = DATA[type].sortDirection === 1 ? -1 : 1; 
    }
    DATA[type].sort((a, b) => {
        let va = a[key], vb = b[key];
        if (type === 'active' && (key === 'dl' || initial)) {
             const remA = getTimeRemaining(a.dl).days || Infinity;
             const remB = getTimeRemaining(b.dl).days || Infinity;
             if (remA !== remB) return direction * (remA - remB); 
        }
        if (dataType === 'date') return direction * (new Date((va || '9999').replace(' ', 'T')) - new Date((vb || '9999').replace(' ', 'T')));
        if (dataType === 'number') return direction * ((+va || 0) - (+vb || 0));
        return direction * String(va).localeCompare(String(vb));
    });
    DATA[type].sortDirection = direction;
    SORT[type] = key;
    save(); 
    if(!initial) upd();
}

function upd(){
    renderActive();
    renderSimple('waiting');
    renderSimple('paused');
    renderPotential();
    renderArchive();
    renderTrash();
    calcStats();
    updateBulkToolbar(currentTab);
}

function renderActive(){
    const tbody = document.querySelector('#t-active tbody');
    tbody.innerHTML = '';
    let totalP = 0, totalPr = 0;
    
    DATA.active.forEach((item, i) => {
        item.pr = calcNet(item); 
        totalP += +item.p; totalPr += item.pr;
        
        const rem = getTimeRemaining(item.dl);
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        
        const linkIcon = renderLinkControls(item, i, 'active');
        
        tr.innerHTML = `
            <td class="select-col">
                <div class="select-action-wrap">
                    <svg class="dup-icon" onclick="duplicateRow('active',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-active-${i}" onchange="toggleSelect('active', ${i}, this)" ${selectedRows.active?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-active-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('active',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span contenteditable onblur="updVal('active',${i},'n',this.innerText)">${item.n}</span>
            </td>
            
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('active',${i},'start')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.start)}</span></div></td>
            <td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('active',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.dl)}</span></div></td>
            
            <td class="mono"><div class="${rem.cls}">${rem.txt}</div></td>
            
            <td><select class="tax-select" onchange="updVal('active',${i},'taxPrc',this.value)">
                <option value="0" ${+item.taxPrc===0?'selected':''}>0%</option>
                <option value="4" ${+item.taxPrc===4?'selected':''}>4%</option>
                <option value="6" ${+item.taxPrc===6?'selected':''}>6%</option>
                <option value="13" ${+item.taxPrc===13?'selected':''}>13%</option>
            </select></td>
            
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="number" value="${item.contractor||0}" onblur="updVal('active',${i},'contractor',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="number" value="${item.p||0}" onblur="updVal('active',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            
            <td><select class="paid-select" onchange="updVal('active',${i},'paid',this.value)">
                <option value="0" ${+item.paid===0?'selected':''}>0%</option>
                <option value="50" ${+item.paid===50?'selected':''}>50%</option>
                <option value="100" ${+item.paid===100?'selected':''}>100%</option>
            </select></td>
            
            <td><div class="action-btns">
                <div class="done-btn action-btn-base" onclick="mv(${i},'active','archive')" title="–í—ã–ø–æ–ª–Ω–µ–Ω–æ">‚úì</div>
                <div class="wait-active-btn action-btn-base" onclick="mv(${i},'active','waiting')" title="–í –æ–∂–∏–¥–∞–Ω–∏–∏">...</div>
                <div class="pause-active-btn action-btn-base" onclick="mv(${i},'active','paused')" title="–ù–∞ –ø–∞—É–∑–µ">||</div>
                <span class="del-btn" onclick="askDel('active',${i})" title="–£–¥–∞–ª–∏—Ç—å">√ó</span>
            </div></td>
        `;
        tbody.appendChild(tr);
    });
    
    const footer = document.querySelector('#total-row-active');
    footer.innerHTML = `<tr>
        <td colspan="8">–í—Å–µ–≥–æ ${DATA.active.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td style="text-align:right;">${formatCurrency(totalP)}</td>
        <td style="text-align:right;">${formatCurrency(totalPr)}</td>
        <td colspan="2"></td>
    </tr>`;

    const paceBlock = document.getElementById('pace-indicator');
    const urgent = DATA.active.filter(x => getTimeRemaining(x.dl).cls.includes('critical')).length;
    
    if (currentTab === 'active') {
        if (urgent > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.add('critical');
            document.getElementById('pace-icon').innerHTML = 'üî•';
            document.getElementById('pace-title').innerText = '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!';
            document.getElementById('pace-desc').innerText = `–ì–æ—Ä–∏—Ç –¥–µ–¥–ª–∞–π–Ω–æ–≤: ${urgent}. –ü–æ–¥–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å!`;
            document.getElementById('pace-status').className='pace-status pace-hurry'; 
            document.getElementById('pace-status').innerText='–ö—Ä–∏—Ç–∏—á–Ω–æ';
        } else if (DATA.active.length > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.remove('critical');
            document.getElementById('pace-icon').innerHTML = 'üö¶';
            document.getElementById('pace-title').innerText = '–ê–Ω–∞–ª–∏–∑';
            document.getElementById('pace-desc').innerText = `–í—Å–µ —Å–ø–æ–∫–æ–π–Ω–æ.`;
            document.getElementById('pace-status').className='pace-status pace-chill'; 
            document.getElementById('pace-status').innerText='–ù–æ—Ä–º–∞';
        } else {
            paceBlock.style.display = 'none';
        }
    } else {
        paceBlock.style.display = 'none';
    }
}

function renderSimple(type){
    const tbody = document.querySelector(`#t-${type} tbody`);
    tbody.innerHTML = '';
    let tot = 0;
    DATA[type].forEach((item, i) => {
        tot += +item.p;
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        
        const linkIcon = renderLinkControls(item, i, type);
                                      
        const rem = getTimeRemaining(item.dl);
        
        tr.innerHTML = `
            <td class="select-col">
                <div class="select-action-wrap">
                    <svg class="dup-icon" onclick="duplicateRow('${type}',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-${type}-${i}" onchange="toggleSelect('${type}', ${i}, this)" ${selectedRows[type]?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-${type}-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('${type}',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span contenteditable onblur="updVal('${type}',${i},'n',this.innerText)">${item.n}</span>
            </td>
            <td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('${type}',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.dl)} (${rem.txt})</span></div></td>
            <td><div class="price-cell-wrap"><input type="number" value="${item.p||0}" onblur="updVal('${type}',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" onclick="mv(${i},'${type}','active')" title="–í —Ä–∞–±–æ—Ç—É">‚ñ∂Ô∏è</div>
                <span class="del-btn" onclick="askDel('${type}',${i})">√ó</span>
            </div></td>
        `;
        tbody.appendChild(tr);
    });
    const footer = document.querySelector(`#total-row-${type}`);
    footer.innerHTML = `<tr>
        <td colspan="4">–í—Å–µ–≥–æ ${DATA[type].length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td>${formatCurrency(tot)}</td>
        <td></td>
    </tr>`;
}

function renderPotential(){
    const tbody = document.querySelector('#t-potential tbody');
    tbody.innerHTML = '';
    let tot = 0;
    DATA.potential.forEach((item, i) => {
        tot += +item.p;
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        
        const linkIcon = renderLinkControls(item, i, 'potential');
                                      
        tr.innerHTML = `
            <td class="select-col">
                <div class="select-action-wrap">
                    <svg class="dup-icon" onclick="duplicateRow('potential',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-potential-${i}" onchange="toggleSelect('potential', ${i}, this)" ${selectedRows.potential?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-potential-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('potential',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span contenteditable onblur="updVal('potential',${i},'n',this.innerText)">${item.n}</span>
            </td>
            <td><div class="price-cell-wrap"><input type="number" value="${item.p||0}" onblur="updVal('potential',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="done-btn action-btn-base" onclick="mv(${i},'potential','active')" title="–í —Ä–∞–±–æ—Ç—É">‚úÖ –í —Ä–∞–±–æ—Ç—É</div>
                <span class="del-btn" onclick="askDel('potential',${i})">√ó</span>
            </div></td>
        `;
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-potential');
    footer.innerHTML = `<tr>
        <td colspan="3">–í—Å–µ–≥–æ ${DATA.potential.length} –ª–∏–¥–æ–≤</td>
        <td>${formatCurrency(tot)}</td>
        <td></td>
    </tr>`;
}

function renderArchive(){
    const tbody = document.querySelector('#t-archive tbody');
    tbody.innerHTML = '';
    let tP = 0, tPr = 0;
    const visibleItems = DATA.archive.filter(i => (i.date||'').startsWith(currentMonth));
    visibleItems.forEach((item, i) => {
        const realIdx = DATA.archive.indexOf(item);
        item.pr = calcNet(item);
        tP += +item.p; tPr += +item.pr;
        const tr = document.createElement('tr');
        tr.dataset.index = realIdx;
        
        const linkIcon = renderLinkControls(item, realIdx, 'archive');
                                      
        tr.innerHTML = `
            <td class="select-col">
                <div class="select-action-wrap">
                    <svg class="dup-icon" onclick="duplicateRow('archive',${realIdx})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-archive-${realIdx}" onchange="toggleSelect('archive', ${realIdx}, this)" ${selectedRows.archive?.has(realIdx.toString()) ? 'checked' : ''}>
                    <label for="check-archive-${realIdx}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('archive',${realIdx},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span contenteditable onblur="updVal('archive',${realIdx},'n',this.innerText)">${item.n}</span>
            </td>
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('archive',${realIdx},'date')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.date)}</span></div></td>
            <td><div class="price-cell-wrap"><input type="number" value="${item.p||0}" onblur="updVal('archive',${realIdx},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="price-cell-wrap"><input type="number" value="${item.contractor||0}" onblur="updVal('archive',${realIdx},'contractor',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" title="–í–µ—Ä–Ω—É—Ç—å" onclick="mv(${realIdx},'archive','active')">‚è™</div>
                <span class="del-btn" onclick="askDel('archive',${realIdx})">√ó</span>
            </div></td>
        `;
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-archive');
    footer.innerHTML = `<tr>
        <td colspan="4">–í—Å–µ–≥–æ ${visibleItems.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td>${formatCurrency(tP)}</td>
        <td></td>
        <td>${formatCurrency(tPr)}</td>
        <td></td>
    </tr>`;
}

function renderTrash(){
    const tbody = document.querySelector('#t-trash tbody');
    tbody.innerHTML = '';
    DATA.trash.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const delDate = item.deletedAt ? new Date(item.deletedAt).toLocaleDateString() : '?';
        tr.innerHTML = `
            <td class="select-col">
                <div class="select-action-wrap">
                    <svg class="dup-icon" onclick="duplicateRow('trash',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-trash-${i}" onchange="toggleSelect('trash', ${i}, this)" ${selectedRows.trash?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-trash-${i}" style="display:none;"></label>
                </div>
            </td>
            <td style="color:var(--red); font-size:12px">${delDate}</td>
            <td>${item.c}</td>
            <td>${item.n}</td>
            <td>${formatCurrency(item.p)}</td>
            <td>
                <div class="trash-action-btns">
                    <div class="restore-trash-btn" onclick="restoreFromTrash(${i})">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</div>
                    <div class="delete-forever-text" onclick="deleteForeverCheck(${i})" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞">–£–¥–∞–ª–∏—Ç—å</div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#t-trash tfoot td:first-child');
    if (footer) footer.innerText = `–í—Å–µ–≥–æ ${DATA.trash.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`;
}

function updVal(type, idx, key, val){
    if(key==='p' || key==='contractor' || key==='paid' || key==='taxPrc') val = +val;
    DATA[type][idx][key] = val;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function mv(idx, from, to){
    const item = DATA[from][idx];
    DATA[from].splice(idx, 1);
    if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
    if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
    if(to === 'potential' || to === 'waiting' || to === 'paused') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
    
    DATA[to].unshift(item);
    sortData('active', 'dl', 'date', true);
    save(); 
    setTimeout(() => { switchTab(to); }, 10);
}

function duplicateRow(type, idx){
    const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
    if(!item) return;
    item.n = item.n + " (–ö–æ–ø–∏—è)";
    DATA[type].unshift(item);
    save(); upd();
}

function askDel(type, idx){
    document.getElementById('del-modal-title').innerText = "–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É?";
    document.getElementById('del-modal-desc').innerText = "–û–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 7 –¥–Ω–µ–π.";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = '–£–¥–∞–ª–∏—Ç—å';
    
    document.getElementById('finalDeleteBtn').onclick = () => {
        const itemIndex = DATA[type].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[type].splice(itemIndex, 1)[0];
            item.deletedAt = Date.now();
            DATA.trash.unshift(item);
        }
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
    };
}

function deleteForeverCheck(idx) {
    document.getElementById('del-modal-title').innerText = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ";
    document.getElementById('del-modal-desc').innerText = "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = '–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞';
    
    document.getElementById('finalDeleteBtn').onclick = () => {
        DATA.trash.splice(idx, 1);
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
    };
}

function restoreFromTrash(idx){
    const item = DATA.trash.splice(idx, 1)[0];
    delete item.deletedAt;
    DATA.active.unshift(item);
    save(); switchTab('active');
}

function openAddModal(){
    ['name','client','price','contractor'].forEach(id => document.getElementById(`add-proj-${id}`).value = '');
    document.getElementById('add-proj-tax').value = '0';
    document.getElementById('add-proj-start-val').value = today;
    document.getElementById('add-proj-dl-val').value = today;
    document.getElementById('add-proj-dl-days').value = '';
    document.getElementById('add-proj-start-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(today);
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(today);
    document.getElementById('addProjectModal').style.display = 'flex';
}
function saveNewProject(){
    const name = document.getElementById('add-proj-name').value;
    const client = document.getElementById('add-proj-client').value;
    const price = +document.getElementById('add-proj-price').value || 0;
    const contr = +document.getElementById('add-proj-contractor').value || 0;
    const tax = +document.getElementById('add-proj-tax').value || 0;
    const type = document.getElementById('add-proj-type').value;
    const start = document.getElementById('add-proj-start-val').value || today;
    const dl = document.getElementById('add-proj-dl-val').value || today;
    
    const item = {
        n: name, c: client, p: price, contractor: contr, taxPrc: tax, link: '',
        start: type==='active'? start : undefined, 
        dl: type==='active' || type==='waiting' || type==='paused' ? dl : undefined, 
        paid: (type==='active'||type==='archive'? (type==='archive'?100:50) : 0),
        date: type==='archive' ? today : undefined
    };
    
    DATA[type].unshift(item);
    document.getElementById('addProjectModal').style.display = 'none';
    sortData('active', 'dl', 'date', true);
    save(); switchTab(type);
}

function applyDeadlinePreset() {
    const days = parseInt(document.getElementById('add-proj-dl-days').value, 10);
    if (!days) return;
    const startRaw = document.getElementById('add-proj-start-val').value || today;
    const baseDate = new Date(startRaw);
    if (isNaN(baseDate)) return;
    const dlDate = new Date(baseDate);
    dlDate.setDate(dlDate.getDate() + days);
    const iso = dlDate.toISOString().slice(0, 10);
    document.getElementById('add-proj-dl-val').value = iso;
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(iso);
}

function openDate(type, idx, field){
    queue = {type, idx, field, targetId: null};
    const val = DATA[type][idx][field];
    openDateBase(val);
}
function openDateInModal(targetInputId){
    const val = document.getElementById(targetInputId).value;
    queue = {type: null, idx: null, field: null, targetId: targetInputId};
    openDateBase(val);
}
function openDateBase(val) {
    const hasTime = val && val.includes('T') && val.length > 10;
    document.getElementById('date-has-time').checked = hasTime;
    
    if(val) {
        document.getElementById('date-input-val').value = val.slice(0, 10);
        document.getElementById('time-input-val').value = hasTime ? val.slice(11, 16) : '12:00';
    } else {
        document.getElementById('date-input-val').value = today;
        document.getElementById('time-input-val').value = '12:00';
    }
    toggleTimeInput();
    document.getElementById('dateModal').style.display = 'flex';
}
function toggleTimeInput(){
    const chk = document.getElementById('date-has-time');
    document.getElementById('time-input-val').disabled = !chk.checked;
    document.getElementById('time-input-val').style.opacity = chk.checked ? '1' : '0.3';
}
function closeDateModal(){ document.getElementById('dateModal').style.display = 'none'; }
function saveDate(){
    const d = document.getElementById('date-input-val').value;
    const t = document.getElementById('time-input-val').value;
    const useTime = document.getElementById('date-has-time').checked;
    if(!d) return;
    const result = useTime ? `${d}T${t}` : d;

    if (queue.targetId) {
        document.getElementById(queue.targetId).value = result;
        const displayId = queue.targetId.replace('-val', '-display');
        document.getElementById(displayId).querySelector('.date-text-display').innerHTML = formatDateDisplay(result);
        if (queue.targetId === 'add-proj-start-val') {
            const presetDays = parseInt(document.getElementById('add-proj-dl-days').value, 10);
            if (presetDays) applyDeadlinePreset();
        }
    } else {
        DATA[queue.type][queue.idx][queue.field] = result;
        sortData('active', 'dl', 'date', true);
    }
    
    closeDateModal(); save(); upd();
}

function openProjectLink(idx, type) {
    const link = DATA[type][idx].link;
    if (link) {
        window.open(link, '_blank');
    } else {
        openLink(type, idx);
    }
}
function openLink(type, idx){
    queue = {type, idx};
    document.getElementById('link-input').value = DATA[type][idx].link || '';
    document.getElementById('linkModal').style.display = 'flex';
}
function closeLinkModal(){ document.getElementById('linkModal').style.display = 'none'; }
function saveLink(){
    let url = document.getElementById('link-input').value.trim();
    if(url && !url.match(/^(https?:\/\/|mailto:)/)) url = 'https://' + url;
    DATA[queue.type][queue.idx].link = url;
    closeLinkModal(); save(); upd();
}

function openSettings(){
    document.getElementById('stg-goal').value = DATA.monthlyGoals[currentMonth] || 250000;
    document.getElementById('stg-rec').value = DATA.settings.record || 0;
    document.getElementById('settingsModal').style.display = 'flex';
}
function saveSettings(){
    DATA.monthlyGoals[currentMonth] = +document.getElementById('stg-goal').value;
    DATA.settings.record = +document.getElementById('stg-rec').value;
    document.getElementById('settingsModal').style.display = 'none';
    save(); upd();
}

function getTimeRemaining(dl){
    if(!dl) return {txt:'‚Äî', cls:'days-normal', days: Infinity};
    const end = new Date(dl.slice(0, 10) + 'T00:00:00').getTime(); 
    const todayNormalized = new Date(today + 'T00:00:00').getTime();
    
    const diff = end - todayNormalized;
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    
    if(days < 0) return {txt:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ', cls:'days-critical', days: -1};
    if(days === 0) return {txt:'–°–µ–≥–æ–¥–Ω—è', cls:'days-critical', days: 0};
    if(days <= 3) return {txt: days + ' –¥–Ω.', cls:'days-warning', days: days};
    return {txt: days + ' –¥–Ω.', cls:'days-normal', days: days};
}

function changeMonth(m){ 
    currentMonth = m; 
    if (!DATA.monthlyGoals[currentMonth]) {
        DATA.monthlyGoals[currentMonth] = 250000; 
        save();
    }
    upd(); 
}
function renderMonthSelect(){
    const sel = document.getElementById('monthSelect');
    const months = new Set([today.slice(0,7)]);
    [...DATA.archive, ...DATA.active].forEach(i => {
        if(i.date) months.add(i.date.slice(0,7));
        if(i.start) months.add(i.start.slice(0,7));
    });
    Object.keys(DATA.monthlyGoals).forEach(m => months.add(m));

    sel.innerHTML = '';
    Array.from(months).sort().reverse().forEach(m => {
        const d = new Date(m + '-01');
        const name = d.toLocaleString('ru', {month:'long', year:'numeric'});
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        if(m===currentMonth) opt.selected = true;
        sel.appendChild(opt);
    });
}

function calcStats(){
    const goal = DATA.monthlyGoals[currentMonth] || 250000;
    let fact = 0, activeFact = 0, plan = 0, totalGross = 0, totalNet = 0;
    
    const archiveThisMonth = DATA.archive.filter(i=>(i.date||'').startsWith(currentMonth));
    archiveThisMonth.forEach(i => {
        const net = calcNet(i);
        fact += net;
        totalGross += +i.p || 0;
        totalNet += net;
    });
    
    DATA.active.forEach(i => {
        const net = calcNet(i);
        const gross = +i.p || 0;
        const paidPrc = (i.paid||0)/100;
        activeFact += net * paidPrc;
        plan += net * (1 - paidPrc);
        totalGross += gross;
        totalNet += net;
    });

    DATA.paused.forEach(i => plan += calcNet(i));
    DATA.waiting.forEach(i => plan += calcNet(i));
    DATA.potential.forEach(i => plan += calcNet(i));

    const totalFact = fact + activeFact;
    const forecast = totalFact + plan;
    
    const totalMargin = totalNet;
    const totalGrossCombined = totalGross;
    const goalProgress = goal ? Math.round((totalFact/goal)*100) : 0;

    document.getElementById('val-fact').innerText = formatCurrency(totalFact);
    document.getElementById('val-fact-prc').innerText = `${goalProgress}% –æ—Ç —Ü–µ–ª–∏`;
    document.getElementById('val-active-fact').innerText = formatCurrency(activeFact);
    document.getElementById('val-margin').innerText = formatCurrency(totalMargin);
    document.getElementById('val-margin-prc').innerText = `${totalGrossCombined > 0 ? Math.round((totalMargin/totalGrossCombined)*100) : 0}%`;
    document.getElementById('val-plan').innerText = formatCurrency(plan);
    document.getElementById('val-total').innerText = formatCurrency(forecast);
    document.getElementById('goal-text').innerText = `${formatCurrency(totalFact)} / ${formatCurrency(goal)}`;
    document.getElementById('goal-pill').innerText = `–¶–µ–ª—å: ${formatCurrency(goal)}`;
    document.getElementById('record-amount').innerText = formatCurrency(DATA.settings.record || 0);
    document.getElementById('p-bar').style.width = goal > 0 ? Math.min(100, (totalFact/goal)*100) + '%' : '0%';
    document.getElementById('dash-month-name').innerText = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex]?.text || '';
    updateCharts(totalFact, plan);
}

let chL = null, chP = null, chB = null;
function updateCharts(fact, plan){
    const ctxL = document.getElementById('lineChart').getContext('2d');
    const ctxP = document.getElementById('pieChart').getContext('2d');
    const ctxB = document.getElementById('barChart').getContext('2d');
    const daysInM = new Date(currentMonth.split('-')[0], currentMonth.split('-')[1], 0).getDate();
    const labelsL = Array.from({length:daysInM},(_,i)=>i+1);
    
    const dataL = new Array(daysInM).fill(0);
    
    DATA.archive.filter(i=>(i.date||'').startsWith(currentMonth)).forEach(i => {
        const d = parseInt(i.date.split('-')[2]) - 1;
        if(d>=0 && d<daysInM) dataL[d] += calcNet(i);
    });
    
    let acc = 0; 
    const dataAcc = dataL.map(v => acc+=v);
    
    if(chL) chL.destroy();
    chL = new Chart(ctxL, {
        type: 'line',
        data: { labels: labelsL, datasets: [{label:'–§–∞–∫—Ç', data:dataAcc, borderColor:'#2ea043', backgroundColor:'rgba(46,160,67,0.1)', fill:true, tension:0.3, pointRadius:0}] },
        options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#30363d'}}}}
    });
    
    if(chP) chP.destroy();
    chP = new Chart(ctxP, {
        type: 'doughnut',
        data: { labels: ['–§–∞–∫—Ç (–û–ø–ª–∞—á–µ–Ω–æ)', '–ü–ª–∞–Ω (–û—Å—Ç–∞—Ç–æ–∫/–õ–∏–¥—ã)'], datasets: [{data:[fact, plan], backgroundColor:['#2ea043','#d29922'], borderWidth:0}] },
        options: {responsive:true, maintainAspectRatio:false, cutout:'75%', plugins:{legend:{position:'bottom', labels:{color:'#8b949e'}}}}
    });
    
    const h = {};
    DATA.archive.forEach(i => { const m = (i.date||'').slice(0,7); if(m) h[m] = (h[m]||0) + calcNet(i); });
    const allMonths = Object.keys(h);
    allMonths.sort();
    const keys = allMonths.slice(-6); 

    if(chB) chB.destroy();
    chB = new Chart(ctxB, {
        type: 'bar',
        data: { labels: keys.map(m => new Date(m + '-01').toLocaleString('ru', {month:'short'})), datasets: [{data: keys.map(k=>h[k]), backgroundColor: keys.map(k=>k===currentMonth?'#58a6ff':'#21262d'), borderRadius:4}] },
        options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false, ticks:{beginAtZero:true}}}}
    });
}

function exp(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([localStorage.getItem(K)],{type:'application/json'}));
  a.download=`DesignFlow-Backup-${today}.json`;
  a.click();
}
function expCSV(){
    const escape = v => `"${(v || '').toString().replace(/"/g, '""')}"`;
    let csv = ['–°—Ç–∞—Ç—É—Å', '–ö–ª–∏–µ–Ω—Ç', '–ü—Ä–æ–µ–∫—Ç', '–°—É–º–º–∞', '–ß–∏—Å—Ç—ã–º–∏', '–û–ø–ª–∞—á–µ–Ω–æ (%)', '–ù–∞–ª–æ–≥ (%)', '–†–∞—Å—Ö–æ–¥—ã', '–î–∞—Ç–∞ –°—Ç–∞—Ä—Ç–∞', '–î–µ–¥–ª–∞–π–Ω/–°–¥–∞—á–∏', '–°—Å—ã–ª–∫–∞'].map(escape).join(';') + '\n';
    const addRows = (list, status) => list.forEach(i => csv += [status, i.c, i.n, i.p, calcNet(i), i.paid||0, i.taxPrc||0, i.contractor||0, i.start||'', i.dl||i.date||'', i.link||''].map(escape).join(';') + '\n');
    addRows(DATA.active, '–í —Ä–∞–±–æ—Ç–µ'); addRows(DATA.waiting, '–û–∂–∏–¥–∞–µ—Ç'); addRows(DATA.potential, '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª');
    addRows(DATA.paused, '–ù–∞ –ø–∞—É–∑–µ'); addRows(DATA.archive, '–í—ã–ø–æ–ª–Ω–µ–Ω–æ');
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `DesignFlow-Export-${today}.csv`; a.click();
}
function imp(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=e=>{ localStorage.setItem(K,e.target.result); location.reload(); };
  r.readAsText(f);
}

window.onload = init;
</script>
</body>
</html>
