<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DesignFlow ‚Äî –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</title>

<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' ry='6' fill='%230d1117'/%3E%3Cpath d='M11 2 L5 14 H10 L9 22 L19 8 H13 L14 2 Z' fill='%23facc15'/%3E%3C/svg%3E">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --border:#e2e8f0;
  --accent:#5b7cfa;
  --accent-strong:#2643e9;
  --btn-blue:#5b7cfa;
  --surface:#eef2f6;
  --shadow:0 18px 45px rgba(15,23,42,0.08);
  --positive:#22c55e;
  --negative:#ef4444;
  --warning:#f59e0b;
  --red:#ef4444;
  --green:#22c55e;
  --gold:#f59e0b;
  --pill:#e8edfb;
  --input:#f8fafc;
  --badge:#1f2937;
}
[data-theme="dark"]{
  --bg:#0d1117;
  --card:#111827;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#1f2937;
  --accent:#7c9bff;
  --accent-strong:#5b7cfa;
  --btn-blue:#7c9bff;
  --surface:#161b22;
  --shadow:0 18px 45px rgba(0,0,0,0.45);
  --positive:#34d399;
  --negative:#f87171;
  --warning:#facc15;
  --red:#f87171;
  --green:#22d3ee;
  --gold:#facc15;
  --pill:#1f2a44;
  --input:#0f172a;
  --badge:#0b1324;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','SF Pro Display',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;}
body{background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5;}
.c{max-width:1300px;margin:0 auto;padding:32px 20px 72px;}

/* Header */
h1{font-size:38px;font-weight:800;letter-spacing:-0.8px;}
.brand-grad{background:linear-gradient(120deg,var(--accent),#9b8cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.brand-white{color:var(--text);font-weight:600;opacity:0.7;}
.header-row{display:flex;justify-content:space-between;align-items:center;gap:20px;margin-bottom:26px;flex-wrap:wrap;}
.header-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}

/* Buttons */
button{padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-weight:700;font-size:14px;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px;box-shadow:0 4px 14px rgba(15,23,42,0.04);} 
button:hover{border-color:var(--accent);color:var(--accent);} 
button.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 10px 25px rgba(91,124,250,0.25);} 
button.primary:hover{background:var(--accent-strong);border-color:var(--accent-strong);color:#fff;}
button.ghost{background:transparent;border-color:var(--border);box-shadow:none;color:var(--muted);} 
button.ghost:hover{color:var(--accent);}
#newProjectButton{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:800;border-radius:14px;}
#newProjectButton:hover{background:var(--accent-strong);border-color:var(--accent-strong);} 

select, input, textarea{border:1px solid var(--border);border-radius:12px;background:var(--input);color:var(--text);padding:10px 12px;font-weight:600;transition:border-color .2s,box-shadow .2s;background-clip:padding-box;}
select:focus, input:focus, textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px rgba(91,124,250,0.15);} 
[contenteditable]{outline:none;border:1px solid transparent;padding:8px;border-radius:10px;transition:.2s;background:transparent;display:inline-block;}
[contenteditable]:focus,[contenteditable]:hover{border-color:var(--border);background:var(--surface);}
.month-select{min-width:210px;}

/* Top banner */
.top-panel{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px 20px;display:flex;justify-content:space-between;gap:16px;align-items:center;flex-wrap:wrap;box-shadow:var(--shadow);}
.backup-info{color:var(--muted);max-width:680px;font-size:14px;}
.btns{display:flex;gap:10px;flex-wrap:wrap;}

/* Tabs */
.tabs-container{display:flex;justify-content:space-between;align-items:center;margin:20px 0 10px;gap:12px;flex-wrap:wrap;}
.tabs{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;}
.tab{padding:10px 14px;border:1px solid var(--border);border-radius:14px;color:var(--muted);background:var(--card);cursor:pointer;font-weight:700;transition:.2s;display:flex;align-items:center;gap:6px;}
.tab svg{width:14px;height:14px;opacity:0.6;}
.tab:hover{color:var(--accent);border-color:var(--accent);}
.tab.active{color:var(--text);border-color:var(--accent);background:var(--surface);}
.tab.active svg{opacity:1;}
.tab.tab-trash{margin-left:auto;}
.tab-desc-block{color:var(--muted);font-size:14px;margin-bottom:10px;}

/* Pace indicator */
.pace-block{display:flex;align-items:center;justify-content:space-between;gap:16px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 18px;box-shadow:var(--shadow);margin:14px 0;}
.pace-info{display:flex;align-items:center;gap:12px;}
.pace-icon{font-size:26px;} 
.pace-status{padding:6px 10px;border-radius:999px;font-weight:700;background:var(--surface);color:var(--text);border:1px solid var(--border);} 
.pace-rep-chip{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);}
.rep-dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:var(--accent);} 
.rep-chip-label{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:700;}
.rep-chip-score{font-weight:800;}

/* Tables */
.table-wrap{overflow-x:auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:8px;box-shadow:var(--shadow);}
table{width:100%;border-collapse:collapse;min-width:1200px;}
th{font-size:12px;font-weight:800;text-transform:uppercase;color:var(--muted);padding:12px 10px;text-align:left;border-bottom:1px solid var(--border);letter-spacing:0.3px;white-space:nowrap;}
th .sort-icon{margin-left:6px;color:var(--muted);font-size:10px;}
th .sort-icon::after{content:'‚Üï';}
th.sorted{color:var(--text);}
th.sorted .sort-icon{color:var(--accent);}
th.sorted.asc .sort-icon::after{content:'‚Üë';}
th.sorted.desc .sort-icon::after{content:'‚Üì';}
td{padding:10px;border-bottom:1px solid var(--border);font-size:15px;vertical-align:middle;color:var(--text);background:transparent;} 
tr:hover td{background:var(--surface);} 
th:first-child, td:first-child{text-align:center;width:36px;} 
tfoot td{padding:14px 10px;font-weight:700;color:var(--muted);background:var(--surface);} 
tfoot td:first-child{text-align:left;color:var(--text);} 

.select-col{width:40px;} 
.bulk-checkbox{width:16px;height:16px;margin:0;cursor:pointer;border:1px solid var(--border);border-radius:6px;appearance:none;background:transparent;transition:background .2s,border-color .2s;} 
.bulk-checkbox:checked{background:var(--accent);border-color:var(--accent);} 
.row-index{color:var(--muted);font-weight:700;font-size:12px;} 

.client-wrap{display:flex;align-items:center;gap:8px;} 
.client-name{font-weight:700;} 
.project-name{font-weight:600;} 

.date-cell{padding:0!important;} 
.date-input-wrap{display:flex;align-items:center;gap:8px;width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;background:var(--input);transition:.2s;} 
.date-input-wrap:hover{border-color:var(--accent);} 
.date-text-display{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;} 
.date-icon{width:14px;height:14px;color:var(--muted);} 
.time-text{color:var(--muted);font-weight:700;font-size:12px;} 

.price-cell-wrap{display:flex;align-items:center;justify-content:flex-end;gap:6px;padding:4px 0;border-radius:10px;} 
.price-cell-wrap input{background:transparent;border:none;color:var(--text);font-weight:700;text-align:right;width:100%;min-width:70px;font-family:monospace;} 
.price-cell-wrap:focus-within{background:var(--surface);outline:1px solid var(--border);} 
.currency-symbol{color:var(--muted);font-size:14px;font-weight:700;} 

.net-display-wrap{display:flex;flex-direction:column;align-items:flex-end;gap:2px;} 
.net-main-val{font-weight:800;} 
.net-prc-val{color:var(--muted);font-size:12px;} 

.action-btns{display:flex;gap:6px;align-items:center;} 
.action-btn-base{padding:8px;border:1px solid var(--border);border-radius:10px;font-weight:800;background:var(--surface);color:var(--text);} 
.link-btn{padding:6px 8px;border-radius:10px;border:1px solid transparent;color:var(--muted);background:transparent;font-weight:700;} 
.link-btn:hover{color:var(--accent);border-color:var(--accent);} 
.del-btn{border:1px solid transparent;border-radius:10px;padding:6px;color:var(--muted);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;} 
.del-btn:hover{color:var(--negative);border-color:var(--border);} 
.dup-icon{width:16px;height:16px;color:var(--muted);opacity:0.6;cursor:pointer;transition:.2s;} 
tr:hover .dup-icon{opacity:1;} 
.dup-icon:hover{color:var(--accent);} 

.status-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid var(--border);background:var(--surface);color:var(--muted);} 
.status-pill.active{color:var(--positive);} 
.status-pill.waiting{color:var(--warning);} 
.status-pill.potential{color:var(--accent);} 
.status-pill.paused{color:#a855f7;} 
.status-pill.archive{color:var(--muted);} 

/* Dashboard cards */
.stats-full{margin-top:36px;display:flex;flex-direction:column;gap:18px;}
.stats-two-columns{display:grid;grid-template-columns:1.4fr 1fr;gap:18px;align-items:start;}
.side-stack{display:flex;flex-direction:column;gap:14px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px 20px;box-shadow:var(--shadow);} 
.card-head{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin-bottom:12px;} 
.finance-title{font-size:20px;font-weight:800;} 
.finance-sub{color:var(--muted);font-size:13px;} 
.goal-wrap{margin-bottom:12px;} 
.progress-bg{height:12px;background:var(--surface);border-radius:12px;overflow:hidden;border:1px solid var(--border);} 
.progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-strong));border-radius:12px;transition:width .4s ease;} 
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px;} 
.stat-box{padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);} 
.stat-label-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;} 
.stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:800;letter-spacing:0.5px;} 
.stat-pill{padding:4px 8px;border-radius:999px;background:var(--pill);color:var(--accent);font-size:11px;font-weight:800;} 
.stat-val{font-size:26px;font-weight:800;} 
.stat-helper{color:var(--muted);font-size:12px;margin-top:4px;} 

.record-banner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-radius:14px;background:var(--surface);border:1px solid var(--border);} 
.record-texts{flex:1;min-width:0;} 
.record-title{color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;font-weight:800;font-size:12px;} 
.record-motiv{font-weight:800;margin-top:6px;} 
.record-progress-bg{margin-top:8px;height:10px;border-radius:10px;background:var(--card);border:1px solid var(--border);} 
.record-progress-fill{height:100%;width:0;background:linear-gradient(90deg,var(--warning),#f97316);border-radius:10px;transition:width .4s ease;} 
.record-side{display:flex;flex-direction:column;align-items:flex-end;gap:6px;} 
.record-value{font-weight:900;color:var(--warning);} 
.record-remaining{color:var(--muted);font-size:12px;font-weight:700;} 

.reputation-strip{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface);} 
.reputation-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;} 
.rep-metric{padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);} 
.rep-label{color:var(--muted);font-size:12px;text-transform:uppercase;font-weight:800;letter-spacing:0.4px;} 
.rep-value{font-weight:800;font-size:18px;} 
.rep-helper{color:var(--muted);font-size:12px;margin-top:4px;}
.rep-chart-box{padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);} 
.rep-chart-legend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;font-weight:700;}

/* Bulk actions */
.bulk-toolbar{position:fixed;bottom:26px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 16px;display:flex;gap:10px;box-shadow:var(--shadow);z-index:20;}
.bulk-action-btn{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;}
.bulk-action-btn.delete{color:var(--negative);border-color:var(--negative);} 
.bulk-move-select{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text);font-weight:700;}

/* Modals */
.modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);z-index:40;}
.modal-content{background:var(--card);border-radius:16px;border:1px solid var(--border);padding:24px;width:520px;max-width:94%;box-shadow:var(--shadow);position:relative;}
.close-modal-x{position:absolute;top:12px;right:14px;font-size:20px;color:var(--muted);cursor:pointer;}
.inp-group{margin-bottom:14px;text-align:left;}
.inp-group label{display:block;margin-bottom:6px;font-weight:700;color:var(--muted);font-size:13px;}
.row-inputs{display:flex;gap:12px;flex-wrap:wrap;}
.row-inputs>div{flex:1 1 200px;}
.save-stg{width:100%;margin-top:12px;}
.helper-note{color:var(--muted);font-size:12px;margin-top:6px;}

.toast{position:fixed;top:16px;right:18px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:none;align-items:center;gap:10px;box-shadow:var(--shadow);z-index:50;}
.toast.show{display:flex;} 
.toast-message{flex:1;font-weight:700;}
.toast-action{background:var(--accent);color:#fff;border:1px solid var(--accent);border-radius:8px;padding:6px 10px;font-weight:800;}
.toast-close{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:16px;}

.footer-note{color:var(--muted);font-size:12px;font-weight:700;margin-top:10px;}
</style>
</head>
<body>

<div class="toast" id="toast">
    <div class="toast-message" id="toast-message"></div>
    <button class="toast-action" id="toast-action" style="display:none"></button>
    <button class="toast-close" onclick="hideToast()">√ó</button>
</div>

<svg style="display: none;">
    <symbol id="icon-active" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM3 8a5 5 0 0 1 10 0 5 5 0 0 1-10 0Z"/></symbol>
    <symbol id="icon-all" viewBox="0 0 16 16"><path fill="currentColor" d="M2.5 2.5A.5.5 0 0 1 3 2h4.5a.5.5 0 0 1 .5.5V7a.5.5 0 0 1-.5.5H3A.5.5 0 0 1 2.5 7Zm6 0A.5.5 0 0 1 9 2h4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-.5.5H9a.5.5 0 0 1-.5-.5Zm-6 6A.5.5 0 0 1 3 8h4.5a.5.5 0 0 1 .5.5V13a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5Zm8 0A.5.5 0 0 1 11 8h2a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5Z"/></symbol>
    <symbol id="icon-waiting" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM8 4a1 1 0 0 1 1 1v3.5a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1 0-1H8V5a1 1 0 0 1 1-1Z"/></symbol>
    <symbol id="icon-potential" viewBox="0 0 16 16"><path fill="currentColor" d="M3 1.5A.5.5 0 0 1 3.5 1h7a.5.5 0 0 1 .4.8L9.6 4l1.3 2.2a.5.5 0 0 1-.43.8H5.5V14a.5.5 0 0 1-1 0z"/></symbol>
    <symbol id="icon-paused" viewBox="0 0 16 16"><path fill="currentColor" d="M5 2.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Zm6 0a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Z"/></symbol>
    <symbol id="icon-archive" viewBox="0 0 16 16"><path fill="currentColor" d="M13 1.75a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v12.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75Zm-1.5 8.75a.5.5 0 0 1-1 0V6.707L6.464 10.464a.5.5 0 0 1-.708-.708L10.793 6H7.5a.5.5 0 0 1 0-1h4.5a.5.5 0 0 1 .5.5v4.5Z"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 3.5 8 5H5.5a1 1 0 0 0 0 2h13a1 1 0 0 0 0-2H16l-1-1.5a1 1 0 0 0-.83-.45H9.83a1 1 0 0 0-.83.45Zm-2 5.5h10l-.6 9.01a1 1 0 0 1-1 .94H7.6a1 1 0 0 1-1-.94L6 9Z"/>
      <path fill="currentColor" d="M10 11a1 1 0 0 0-1 1v4a1 1 0 1 0 2 0v-4a1 1 0 0 0-1-1Zm4 0a1 1 0 0 0-1 1v4a1 1 0 1 0 2 0v-4a1 1 0 0 0-1-1Z"/>
    </symbol>
    <symbol id="icon-duplicate" viewBox="0 0 16 16"><path fill="currentColor" d="M2.25 1.75a.75.75 0 0 1 .75-.75h7.25a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0V2.5h-6.5v8h2a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1-.75-.75Zm4.5 4a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 .75.75v8a.75.75 0 0 1-.75.75h-6a.75.75 0 0 1-.75-.75v-8Z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 16 16"><path fill="currentColor" d="M3 2.75A.75.75 0 0 1 3.75 2h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 2.75ZM12.25 2a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5c0-.414.336-.75.75-.75ZM2 5.5a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 5.5Zm12.5 2.25v7.25c0 .414-.336.75-.75.75H2.25a.75.75 0 0 1-.75-.75V7.75c0-.414.336-.75.75-.75h11.5c.414 0 .75.336.75.75Z"/></symbol>
    <symbol id="icon-clock" viewBox="0 0 16 16"><path fill="currentColor" d="M8 1.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13Zm0 1.5a5 5 0 1 1 0 10a5 5 0 0 1 0-10Zm-.5 1.25c0-.276.224-.5.5-.5s.5.224.5.5v2.6l2 1.2a.5.5 0 1 1-.5.866l-2.25-1.35A.5.5 0 0 1 7.5 7V4.25Z"/></symbol>
</svg>

<div class="c">
  
  <div class="header-row">
    <h1><span class="brand-grad">DesignFlow</span> <span class="brand-white">‚Äî –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</span></h1>
    <div class="header-actions">
        <button class="ghost" id="themeToggle" onclick="toggleTheme()">üåô –¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º</button>
        <button onclick="openSettings()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ª–µ–π</button>
        <select id="monthSelect" class="month-select" onchange="changeMonth(this.value)"></select>
    </div>
  </div>


  <div class="top-panel">
    <div class="backup-info">
      <b>‚ö† –í–∞–∂–Ω–æ:</b> –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. <br>
      –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ –∏–ª–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.
    </div>
    <div class="btns">
      <button onclick="exp()">üíæ –°–∫–∞—á–∞—Ç—å –±–∞–∑—É (–ë—ç–∫–∞–ø)</button>
      <button onclick="document.getElementById('imp').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É</button>
      <input type="file" id="imp" accept=".json" style="display:none" onchange="imp(this.files[0])">
      <button onclick="expCSV()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
    </div>
  </div>

  <div class="tabs-container">
    <div class="tabs">
        <div class="tab" id="tab-all" onclick="switchTab('all')"><svg><use href="#icon-all"/></svg> –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
        <div class="tab active" id="tab-active" onclick="switchTab('active')"><svg><use href="#icon-active"/></svg> –í —Ä–∞–±–æ—Ç–µ</div>
        <div class="tab" id="tab-waiting" onclick="switchTab('waiting')"><svg><use href="#icon-waiting"/></svg> –û–∂–∏–¥–∞–µ—Ç</div>
        <div class="tab" id="tab-potential" onclick="switchTab('potential')"><svg><use href="#icon-potential"/></svg> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>
        <div class="tab" id="tab-paused" onclick="switchTab('paused')"><svg><use href="#icon-paused"/></svg> –ù–∞ –ø–∞—É–∑–µ</div>
        <div class="tab" id="tab-archive" onclick="switchTab('archive')"><svg><use href="#icon-archive"/></svg> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
        <div class="tab tab-trash" id="tab-trash" onclick="switchTab('trash')"><svg><use href="#icon-trash"/></svg> –ö–æ—Ä–∑–∏–Ω–∞</div>
    </div>
    <button id="newProjectButton" onclick="openAddModal()">Ôºã –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
  </div>
  
  <div class="tab-desc-block" id="tab-description">–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É.</div>

  <div class="pace-block" id="pace-indicator" style="display:none;">
      <div class="pace-info">
          <div class="pace-icon" id="pace-icon">üî•</div>
          <div>
              <div style="font-weight:700;font-size:16px; color:var(--text);" id="pace-title">–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!</div>
              <div style="font-size:13px;color:var(--muted)" id="pace-desc">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
      </div>
      <div class="pace-actions">
          <div class="pace-rep-chip good" id="pace-rep-chip">
              <span class="rep-dot good" id="pace-rep-dot"></span>
              <div class="rep-chip-text">
                  <div class="rep-chip-label">–†–µ–ø—É—Ç–∞—Ü–∏—è</div>
                  <div class="rep-chip-score" id="pace-rep-text">100 / 100</div>
              </div>
          </div>
          <button class="inline-link-btn" onclick="scrollToReputation()">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
          <div class="pace-status" id="pace-status">–ö—Ä–∏—Ç–∏—á–Ω–æ</div>
      </div>
  </div>

  <div class="main-layout">
    
    <div id="view-active">
      <div class="table-wrap">
        <table id="t-active">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="15%" data-type="active" data-key="c" onclick="sortData('active', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="20%" data-type="active" data-key="n" onclick="sortData('active', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="start" onclick="sortData('active', 'start', 'date')">–°—Ç–∞—Ä—Ç <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="dl" onclick="sortData('active', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω <span class="sort-icon"></span></th>
              <th width="6%" data-type="active" data-key="rem" onclick="sortData('active', 'rem', 'number')">–û—Å—Ç–∞–ª–æ—Å—å <span class="sort-icon"></span></th>
              <th width="4%" data-type="active" data-key="taxPrc" onclick="sortData('active', 'taxPrc', 'number')">–ù–∞–ª–æ–≥ % <span class="sort-icon"></span></th>
              <th width="7%" data-type="active" data-key="contractor" onclick="sortData('active', 'contractor', 'number')" style="text-align:right;">–†–∞—Å—Ö–æ–¥—ã <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="p" onclick="sortData('active', 'p', 'number')" style="text-align:right;">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="8%" style="text-align:right;">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="6%" style="text-align:right;">–û–ø–ª–∞—á–µ–Ω–æ</th>
              <th width="4%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-active">
            <tr><td colspan="8">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="view-waiting" style="display:none">
        <div class="table-wrap">
          <table id="t-waiting">
            <thead>
              <tr>
                <th class="select-col">‚Ññ</th>
              <th width="20%" data-type="waiting" data-key="c" onclick="sortData('waiting', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="30%" data-type="waiting" data-key="n" onclick="sortData('waiting', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="15%" data-type="waiting" data-key="dl" onclick="sortData('waiting', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω <span class="sort-icon"></span></th>
              <th width="15%" data-type="waiting" data-key="p" onclick="sortData('waiting', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="15%"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="total-row-waiting"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
          </table>
        </div>
    </div>
    
    <div id="view-potential" style="display:none">
        <div class="table-wrap">
          <table id="t-potential">
            <thead>
              <tr>
                <th class="select-col">‚Ññ</th>
              <th width="25%" data-type="potential" data-key="c" onclick="sortData('potential', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="40%" data-type="potential" data-key="n" onclick="sortData('potential', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="15%" data-type="potential" data-key="p" onclick="sortData('potential', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="20%"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="total-row-potential"><tr><td colspan="3">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
          </table>
        </div>
    </div>

    <div id="view-paused" style="display:none">
      <div class="table-wrap">
        <table id="t-paused">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="20%" data-type="paused" data-key="c" onclick="sortData('paused', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="30%" data-type="paused" data-key="n" onclick="sortData('paused', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="15%" data-type="paused" data-key="dl" onclick="sortData('paused', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω <span class="sort-icon"></span></th>
              <th width="15%" data-type="paused" data-key="p" onclick="sortData('paused', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="15%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-paused"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-archive" style="display:none">
      <div class="table-wrap">
        <table id="t-archive">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="15%" data-type="archive" data-key="c" onclick="sortData('archive', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="25%" data-type="archive" data-key="n" onclick="sortData('archive', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="15%" data-type="archive" data-key="date" onclick="sortData('archive', 'date', 'date')">–î–∞—Ç–∞ —Å–¥–∞—á–∏ <span class="sort-icon"></span></th>
              <th width="10%" data-type="archive" data-key="p" onclick="sortData('archive', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="10%" data-type="archive" data-key="contractor" onclick="sortData('archive', 'contractor', 'number')">–†–∞—Å—Ö–æ–¥—ã <span class="sort-icon"></span></th>
              <th width="10%">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="10%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-archive"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-all" style="display:none">
      <div class="table-wrap">
        <table id="t-all">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="12%">–°—Ç–∞—Ç—É—Å</th>
              <th width="16%">–ö–ª–∏–µ–Ω—Ç</th>
              <th width="24%">–ü—Ä–æ–µ–∫—Ç</th>
              <th width="14%">–°—Ä–æ–∫</th>
              <th width="10%">–°—É–º–º–∞</th>
              <th width="10%">–†–∞—Å—Ö–æ–¥—ã</th>
              <th width="8%">–ù–∞–ª–æ–≥</th>
              <th width="12%">–ß–∏—Å—Ç—ã–º–∏</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-all"><tr><td colspan="5">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
    
    <div id="view-trash" style="display:none">
      <div class="table-wrap">
        <table id="t-trash">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="20%">–£–¥–∞–ª–µ–Ω–æ</th>
              <th width="20%">–ö–ª–∏–µ–Ω—Ç</th>
              <th width="30%">–ü—Ä–æ–µ–∫—Ç</th>
              <th width="15%">–°—É–º–º–∞</th>
              <th width="15%">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-trash"><tr><td colspan="6">–ò—Ç–æ–≥–æ</td></tr></tfoot>
        </table>
      </div>
      <div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">
          –û–±—ä–µ–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–¥–µ—Å—å 7 –¥–Ω–µ–π, –∑–∞—Ç–µ–º —É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞.
      </div>
    </div>
  </div> 
  
  <div class="dashboard">
    <div class="stats-full">
      <div class="stats-two-columns">
          <div class="card">
              <div class="card-head">
                  <div>
                      <div class="finance-title">–§–∏–Ω–∞–Ω—Å—ã: <span class="text-green" id="dash-month-name">...</span></div>
                      <div class="finance-sub">–î–∞—à–±–æ—Ä–¥ –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –∏ –ø–ª–∞—Ç–µ–∂–∞–º</div>
                      <div class="stat-scope-note" id="stat-scope-note" title="–î–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º">–°—Ä–µ–∑: –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                  </div>
                  <div class="card-head-actions">
                      <div class="stat-pill" id="goal-pill">–¶–µ–ª—å: 0 ‚ÇΩ</div>
                      <button class="inline-link-btn" onclick="openGoalSettings()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  </div>
              </div>
              <div class="goal-wrap">
                  <div class="goal-info">
                      <span class="stat-label-with-help">–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ <span class="help-icon" data-tooltip="–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—è—á–Ω–æ–π —Ü–µ–ª–∏. –ó–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –æ–ø–ª–∞—Ç.">?</span></span>
                      <span id="goal-text">0 / 0 ‚ÇΩ</span>
                  </div>
                  <div class="progress-bg"><div class="progress-fill" id="p-bar"></div></div>
              </div>
              <div class="stats-grid">
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–§–ê–ö–¢</span><span class="help-icon" data-tooltip="–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤.">?</span></div>
                          <div class="stat-pill">–ß–∏—Å—Ç—ã–º–∏</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-fact">0 ‚ÇΩ</div>
                      <div class="stat-helper" id="val-fact-prc">0%</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ü–û–õ–£–ß–ï–ù–û</span><span class="help-icon" data-tooltip="–ß–∏—Å—Ç–∞—è —Å—É–º–º–∞, —É–∂–µ –ø–æ—Å—Ç—É–ø–∏–≤—à–∞—è –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º –≤ —Ä–∞–±–æ—Ç–µ (—Å—Ç–∞—Ç—É—Å ‚Äò–í —Ä–∞–±–æ—Ç–µ‚Äô).">?</span></div>
                          <div class="stat-pill">–ß–∏—Å—Ç—ã–º–∏ (–≤ —Ä–∞–±–æ—Ç–µ)</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-active-fact">0 ‚ÇΩ</div>
                      <div class="stat-helper">–û–ø–ª–∞—á–µ–Ω–æ –≤ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–û–ü–õ–ê–ß–ï–ù–û</span><span class="help-icon" data-tooltip="–í—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –±–µ–∑ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–≥—Ä—è–∑–Ω—ã–º–∏).">?</span></div>
                          <div class="stat-pill">–í—Å–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
                      </div>
                      <div class="stat-val mono" id="val-paid-gross" style="color:var(--accent)">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–≥—Ä—è–∑–Ω—ã–º–∏)</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ü–õ–ê–ù</span><span class="help-icon" data-tooltip="–°–∫–æ–ª—å–∫–æ –µ—â—ë –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –º–µ—Å—è—Ü–∞.">?</span></div>
                          <div class="stat-pill">–û—Å—Ç–∞—Ç–æ–∫ –¥–æ —Ü–µ–ª–∏</div>
                      </div>
                      <div class="stat-val text-gold mono" id="val-plan">0 ‚ÇΩ</div>
                      <div class="stat-helper">–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ü–†–û–ì–ù–û–ó –ò–¢–û–ì–ê</span><span class="help-icon" data-tooltip="–û—Ü–µ–Ω–∫–∞ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞: —Ç–µ–∫—É—â–∏–π —Ñ–∞–∫—Ç + –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º.">?</span></div>
                          <div class="stat-pill">–§–∞–∫—Ç + –æ–∂–∏–¥–∞–µ–º–æ–µ</div>
                      </div>
                      <div class="stat-val mono" id="val-total" style="color:var(--accent)">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ú–∞—Ä–∂–∞: <span id="val-margin">0 ‚ÇΩ</span> (<span id="val-margin-prc">0%</span>)</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–†–ê–°–•–û–î–´</span><span class="help-icon" data-tooltip="–°–æ–≤–æ–∫—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º, –≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤ –∏ –ø–∞—É–∑—É.">?</span></div>
                          <div class="stat-pill">–ü–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º</div>
                      </div>
                      <div class="stat-val mono text-red" id="val-expenses">0 ‚ÇΩ</div>
                      <div class="stat-helper">–°—É–º–º–∞ –∑–∞—Ç—Ä–∞—Ç</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ù–ê–õ–û–ì–ò</span><span class="help-icon" data-tooltip="–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–∞–≤–∫–∞–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.">?</span></div>
                          <div class="stat-pill">–ö —É–ø–ª–∞—Ç–µ</div>
                      </div>
                      <div class="stat-val mono" id="val-taxes">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ü–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–∞–≤–∫–∞–º</div>
                  </div>
              </div>
              <div style="position:relative;height:250px;width:100%"><canvas id="lineChart"></canvas></div>
          </div>

          <div class="side-stack">
              <div class="card efficiency-card">
                  <div class="card-head">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å <span class="help-icon" data-tooltip="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –º–µ–∂–¥—É —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –∏ –æ—Å—Ç–∞–≤—à–∏–º—Å—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º –ø—Ä–æ–µ–∫—Ç–æ–≤.">?</span></div>
                  <div style="position:relative;height:170px;width:100%;display:flex;justify-content:center;margin-bottom:14px;"><canvas id="pieChart"></canvas></div>
                  <div style="border-top:1px solid var(--border); padding-top:16px;">
                      <div style="font-size:14px;color:var(--muted);margin-bottom:12px;font-weight:600">–ü–æ –º–µ—Å—è—Ü–∞–º</div>
                      <div style="height:120px;width:100%"><canvas id="barChart"></canvas></div>
                  </div>
              </div>
              <div class="record-banner">
                  <div class="record-texts">
                      <div class="record-title">üèÜ –†–µ–∫–æ—Ä–¥–Ω—ã–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ –º–µ—Å—è—Ü <span class="help-icon" data-tooltip="–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–∫—Ç –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ —Å —Ç–≤–æ–∏–º –ª–∏—á–Ω—ã–º —Ä–µ–∫–æ—Ä–¥–æ–º. –ù–∞—Å—Ç—Ä–æ–π –∑–Ω–∞—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∫ –Ω–æ–≤–æ–π –ø–ª–∞–Ω–∫–µ.">?</span></div>
                      <div class="record-motiv" id="record-motiv">–û–±–Ω–æ–≤–∏–º —Ü–∏—Ñ—Ä—ã!</div>
                      <div class="record-progress-bg"><div class="record-progress-fill" id="record-progress"></div></div>
                  </div>
                  <div class="record-side">
                      <div class="record-value mono" id="record-amount">0 ‚ÇΩ</div>
                      <div class="record-remaining" id="record-remaining">–î–æ —Ä–µ–∫–æ—Ä–¥–∞ 0 ‚ÇΩ</div>
                      <button class="inline-link-btn" onclick="openRecordSettings()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∫–æ—Ä–¥</button>
                  </div>
              </div>
              <div class="reputation-card" id="reputation-card">
                  <div class="reputation-heading">
                      <div class="reputation-title">–†–µ–ø—É—Ç–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ <span class="help-icon" data-tooltip="–ü—É–ª—å—Å –ø–æ –¥–µ–¥–ª–∞–π–Ω–∞–º: —É—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –ø–æ—Ç–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.">?</span></div>
                      <div class="rep-chip good" id="reputation-chip">üî• –í—Å—ë –æ–∫</div>
                  </div>
                  <div class="reputation-score" id="reputation-score">100 / 100</div>
                  <div class="reputation-grade" id="reputation-grade">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç</div>
                  <div class="reputation-detail" id="reputation-detail">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–∫ —É—Å–∏–ª–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤. –î–µ—Ä–∂–∏ —Ç–µ–º–ø –∏ —Ñ–∏–∫—Å–∏—Ä—É–π —É—Å–ø–µ—Ö–∏ –≤ –∞—Ä—Ö–∏–≤–µ.</div>
                  <div class="reputation-fallout" id="reputation-fallout" style="display:none"></div>
                  <div class="reputation-grid">
                      <div class="rep-metric">
                          <div class="rep-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
                          <div class="rep-value" id="rep-active-count">0</div>
                          <div class="rep-helper" id="rep-on-time">–ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–µ–∫</div>
                      </div>
                      <div class="rep-metric">
                          <div class="rep-label">–ü—Ä–æ—Å—Ä–æ—á–∫–∏</div>
                          <div class="rep-value" id="rep-overdue">0</div>
                          <div class="rep-helper" id="rep-delay">–ú–∞–∫—Å 0 –¥–Ω.</div>
                      </div>
                  </div>
                  <div class="reputation-mini">
                      <div class="rep-chart-box">
                          <div class="rep-chart-legend"><span class="legend-title">–û–±—â–∞—è —Ä–µ–ø—É—Ç–∞—Ü–∏—è <span class="help-icon" data-tooltip="–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –≤–æ–≤—Ä–µ–º—è, —Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—è—Ç –∏ –≥–¥–µ —É–∂–µ –ø—Ä–æ—Å—Ä–æ—á–∫–∞.">?</span></span><span class="legend-score" id="rep-score-label">100</span></div>
                          <div style="flex:1; position:relative; min-height: 120px;"><canvas id="reputationChart"></canvas></div>
                          <div class="rep-chart-caption">
                              <div class="rep-chart-pill"><span class="rep-dot good"></span> –í —Å—Ä–æ–∫: <span id="rep-on-time-pill">0</span></div>
                              <div class="rep-chart-pill"><span class="rep-dot warn"></span> –ù–∞ –≥—Ä–∞–Ω–∏: <span id="rep-near-pill">0</span></div>
                              <div class="rep-chart-pill"><span class="rep-dot bad"></span> –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: <span id="rep-overdue-pill">0</span></div>
                          </div>
                      </div>
                      <div class="rep-tips">
                          <div class="rep-tips-title">–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å</div>
                          <div id="reputation-tips"></div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
    </div>
  </div>
  
  <footer style="text-align:center; margin-top:50px; padding-top:20px; border-top:1px solid var(--border); color:var(--muted); font-size: 14px;">
      DesignFlow Tracker by 
      <a href="https://t.me/r_zhegulyaev" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">Zhegulyaev</a>
  </footer>
</div>

<div class="bulk-toolbar" id="bulkToolbar" style="display: none;">
    <span style="color:var(--text); font-weight: 600;" id="bulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
    <button class="bulk-action-btn" onclick="clearSelection()">‚Ü∫ –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
    <button class="bulk-action-btn" onclick="bulkDuplicate()">‚ùê –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>

    <select id="bulkMoveSelect" class="bulk-move-select" onchange="askBulkMove(this.value)">
        <option value="">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤...</option>
        <option value="active">–í —Ä–∞–±–æ—Ç—É</option>
        <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
        <option value="paused">–ù–∞ –ø–∞—É–∑–µ</option>
        <option value="potential">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</option>
        <option value="archive">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–ê—Ä—Ö–∏–≤)</option>
    </select>
    
    <button class="bulk-action-btn delete" onclick="askBulkDelete()">√ó –£–¥–∞–ª–∏—Ç—å</button>
</div>

<div class="modal" id="addProjectModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('addProjectModal').style.display='none'">√ó</span>
        <h2 style="margin-bottom:20px">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
        <div class="inp-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
            <input type="text" id="add-proj-name" placeholder="–°–∞–π—Ç –¥–ª—è –∫–æ—Ñ–µ–π–Ω–∏">
        </div>
        <div class="inp-group">
            <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input type="text" id="add-proj-client" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
        </div>
        <div class="row-inputs">
             <div class="inp-group" style="flex:1">
                <label>–°—É–º–º–∞ (‚ÇΩ)</label>
                <input type="text" id="add-proj-price" placeholder="50 000" oninput="formatNumberInput(this)">
            </div>
             <div class="inp-group" style="flex:1">
                <label>–†–∞—Å—Ö–æ–¥—ã</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="add-proj-contractor" placeholder="0" style="flex:1 1 280px" oninput="formatNumberInput(this)">
                    <select id="add-proj-contractor-mode" class="symbol-select">
                        <option value="amount">‚ÇΩ</option>
                        <option value="percent">%</option>
                    </select>
                </div>
            </div>
             <div class="inp-group" style="flex: 0 0 120px;">
                <label>–ù–∞–ª–æ–≥</label>
                <select id="add-proj-tax" class="symbol-select">
                    <option value="0">0%</option>
                    <option value="4">4%</option>
                    <option value="6">6%</option>
                    <option value="13">13%</option>
                </select>
            </div>
        </div>
        
        <div class="date-duo">
            <div class="date-duo-card">
                <div class="inp-group">
                    <label>‚ö° –°—Ç–∞—Ä—Ç</label>
                     <div class="date-input-wrap date-chip" id="add-proj-start-display" onclick="openDateInModal('add-proj-start-val')">
                        <svg class="date-icon"><use href="#icon-calendar"/></svg>
                        <span class="date-text-display">–°–µ–≥–æ–¥–Ω—è</span>
                     </div>
                     <input type="hidden" id="add-proj-start-val" value="">
                </div>
            </div>
            <div class="date-duo-card">
                <div class="inp-group">
                     <label>üèÅ –î–µ–¥–ª–∞–π–Ω</label>
                     <div class="date-input-wrap date-chip" id="add-proj-dl-display" onclick="openDateInModal('add-proj-dl-val')">
                        <svg class="date-icon"><use href="#icon-calendar"/></svg>
                        <span class="date-text-display">–°–µ–≥–æ–¥–Ω—è</span>
                     </div>
                     <input type="hidden" id="add-proj-dl-val" value="">
                </div>
            </div>
        </div>

        <div class="deadline-template">
            <div class="inp-group">
                <label>–®–∞–±–ª–æ–Ω —Å—Ä–æ–∫–∞</label>
                <div class="deadline-presets">
                    <select id="add-proj-dl-days" onchange="applyDeadlinePreset()">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                        <option value="1">1 –¥–µ–Ω—å</option>
                        <option value="2">2 –¥–Ω—è</option>
                        <option value="3">3 –¥–Ω—è</option>
                        <option value="5">5 –¥–Ω–µ–π</option>
                        <option value="7">7 –¥–Ω–µ–π</option>
                        <option value="custom">–°–≤–æ–∏ –¥–Ω–∏</option>
                    </select>
                    <input type="number" id="add-proj-dl-custom" placeholder="–°–≤–æ–∏ –¥–Ω–∏" style="width:140px" oninput="applyDeadlinePreset()">
                </div>
            </div>
        </div>

        <div class="inp-group">
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select id="add-proj-type">
                <option value="active">–í —Ä–∞–±–æ—Ç—É</option>
                <option value="potential">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</option>
                <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
                <option value="paused">–ù–∞ –ø–∞—É–∑–µ</option>
                <option value="archive">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–ê—Ä—Ö–∏–≤)</option>
            </select>
        </div>
        
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveNewProject()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<div class="modal" id="linkModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="closeLinkModal()">√ó</span>
        <h3 style="margin-bottom:10px">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <div class="inp-group">
            <input type="url" id="link-input" placeholder="https://t.me/...">
        </div>
        <label class="checkbox-wrap" style="margin-top:-5px;">
            <input type="checkbox" id="link-is-telegram">
            –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Telegram (—á–∞—Ç/–∫–∞–Ω–∞–ª)
        </label>
        <p class="helper-note">–ï—Å–ª–∏ —É–∫–∞–∑–∞—Ç—å @username, –º—ã —É–±–µ—Ä—ë–º @ –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –µ–≥–æ –≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.</p>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" id="saveLinkBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="dateModal">
    <div class="modal-content date-modal-content">
        <span class="close-modal-x" onclick="closeDateModal()">√ó</span>
        <h3 style="margin-bottom: 0;" id="date-modal-title">–î–∞—Ç–∞</h3>
        <p style="color:var(--muted); font-size: 13px; margin-bottom: 15px;">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è.</p>
        
        <label class="checkbox-wrap">
            <input type="checkbox" id="date-has-time" onchange="toggleTimeInput()"> 
            –£–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
        </label>
        
        <div class="date-time-inputs">
            <div class="input-with-icon">
                <svg class="input-icon"><use href="#icon-calendar"/></svg>
                <input type="text" id="date-input-val" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
            </div>
            <div class="input-with-icon">
                <svg class="input-icon"><use href="#icon-clock"/></svg>
                <input type="text" id="time-input-val" placeholder="–ß–ß:–ú–ú" disabled>
            </div>
        </div>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveDate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('settingsModal').style.display='none'">√ó</span>
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="inp-group">
            <label>–¶–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü (‚ÇΩ)</label>
            <input type="text" id="stg-goal" oninput="formatNumberInput(this)">
        </div>
        <div class="inp-group">
            <label>–†–µ–∫–æ—Ä–¥ (‚ÇΩ)</label>
            <input type="text" id="stg-rec" oninput="formatNumberInput(this)">
        </div>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="deleteConfirmModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('deleteConfirmModal').style.display='none'">√ó</span>
        <h3 style="color:var(--text); margin-bottom:10px;" id="del-modal-title">–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É?</h3>
        <p style="color:var(--muted); margin-bottom: 20px; font-size:14px;" id="del-modal-desc">–û–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 7 –¥–Ω–µ–π.</p>
        <div style="display:flex;gap:15px;">
            <button onclick="document.getElementById('deleteConfirmModal').style.display='none'" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
            <button class="confirm-del-btn" style="background:var(--red); border-color:var(--red);" id="finalDeleteBtn" style="flex:1">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
const K = 'grok_design_v5';
const now = new Date();
const today = now.toISOString().slice(0, 10);
let currentMonth = today.slice(0,7);
let currentTab = 'active';
const TAB_DESCRIPTIONS = {
    active: "–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É.",
    waiting: "–û–∂–∏–¥–∞—é—Ç —Ä–µ–∞–∫—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.",
    potential: "–õ–∏–¥—ã –∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã. –ï—â—ë –Ω–µ –Ω–∞—á–∞—Ç—ã.",
    paused: "–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.",
    archive: "–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã.",
    all: "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ –∞—Ä—Ö–∏–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.",
    trash: "–£–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã. –•—Ä–∞–Ω—è—Ç—Å—è 7 –¥–Ω–µ–π."
};

const THEME_KEY = 'designflow_theme';

function getPreferredTheme() {
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) return stored;
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    const toggleBtn = document.getElementById('themeToggle');
    if (toggleBtn) {
        toggleBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª—ã–π —Ä–µ–∂–∏–º' : 'üåô –¢—ë–º–Ω—ã–π —Ä–µ–∂–∏–º';
    }
}

function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || getPreferredTheme();
    applyTheme(current === 'dark' ? 'light' : 'dark');
}

function initTheme() {
    applyTheme(getPreferredTheme());
}

const STATUS_META = {
    active: { label: '–í —Ä–∞–±–æ—Ç–µ', cls: 'active' },
    waiting: { label: '–û–∂–∏–¥–∞–µ—Ç', cls: 'waiting' },
    potential: { label: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª', cls: 'potential' },
    paused: { label: '–ù–∞ –ø–∞—É–∑–µ', cls: 'paused' },
    archive: { label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', cls: 'archive' },
};

const toNumeric = (val) => {
    const cleaned = String(val || '').replace(/\s+/g, '').replace(',', '.');
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
};

function formatPlainNumber(val) {
    const raw = String(val ?? '').replace(/\s+/g, '').trim();
    if (raw === '') return '';
    const isNegative = raw.startsWith('-');
    const normalized = raw.replace(/[^\d.,]/g, '').replace(/^-/, '');
    const [intPartRaw, fracRaw] = normalized.split(/[.,]/);
    const intPart = (intPartRaw || '0').replace(/\D/g, '');
    const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    const frac = fracRaw ? fracRaw.replace(/\D/g, '') : '';
    const formatted = frac ? `${formattedInt},${frac}` : formattedInt;
    return isNegative ? `-${formatted}` : formatted;
}

function formatNumberInput(inputEl) {
    if (!inputEl) return;
    inputEl.value = formatPlainNumber(inputEl.value);
}

let DATA = {
    settings: { record: 0 },
    monthlyGoals: { [currentMonth]: 250000 },
    active: [], archive: [], paused: [], waiting: [], potential: [], trash: []
};

let SORT = { active: 'dl', archive: 'date', potential: 'p', waiting: 'dl', paused: 'dl' };
let queue = { type: null, idx: null, field: null, targetId: null };
let previousDeadlineValue = '';
let toastTimeout = null;
let lastPermanentDeletion = null;
let datePicker = null;
let timePicker = null;

function showToast(message, actionText = '', actionHandler = null, duration = 3500) {
    const toast = document.getElementById('toast');
    const msgEl = document.getElementById('toast-message');
    const actionBtn = document.getElementById('toast-action');

    msgEl.textContent = message;

    if (actionText && actionHandler) {
        actionBtn.textContent = actionText;
        actionBtn.style.display = 'inline-flex';
        actionBtn.onclick = () => { actionHandler(); hideToast(); };
    } else {
        actionBtn.style.display = 'none';
        actionBtn.onclick = null;
    }

    toast.classList.add('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => hideToast(), duration);
}

function hideToast() {
    const toast = document.getElementById('toast');
    toast.classList.remove('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = null;
}

function undoPermanentDelete() {
    if (!lastPermanentDeletion || !Array.isArray(lastPermanentDeletion.items)) return;

    const { type, items } = lastPermanentDeletion;
    const targetList = DATA[type];
    if (!Array.isArray(targetList)) return;

    items
        .slice()
        .sort((a, b) => a.index - b.index)
        .forEach(({ item, index }) => {
            targetList.splice(index, 0, item);
        });

    lastPermanentDeletion = null;
    save();
    upd();
    showToast('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
}

// --- BULK ACTIONS ---
let selectedRows = {}; // {active: Set(), waiting: Set(), ...}

function renderLinkControls(item, idx, type) {
    const hasLink = !!item.link;
    const editBtn = `<button class="link-btn ${hasLink ? 'link-btn-active' : ''}" onclick="openLink('${type}',${idx})" title="${hasLink ? '–ò–∑–º–µ–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É' : '–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É'}">üîó</button>`;
    const goBtn = hasLink ? `<button class="link-btn link-btn-go" onclick="openProjectLink(${idx}, '${type}')" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">‚Üó</button>` : '';
    return editBtn + goBtn;
}

function getClientNameClass(item) {
    return `client-name${item.link ? ' has-link' : ''}`;
}

function toggleSelect(type, idx, checkbox) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    const indexStr = idx.toString();
    const row = checkbox.closest('tr');

    if (checkbox.checked) {
        selectedRows[type].add(indexStr);
        if (row) row.classList.add('row-selected');
    } else {
        selectedRows[type].delete(indexStr);
        if (row) row.classList.remove('row-selected');
    }
    updateBulkToolbar(type);
    
    const allChecked = selectedRows[type].size === DATA[type].length && DATA[type].length > 0;
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if(selectAllCheckbox) selectAllCheckbox.checked = allChecked;
}

function toggleSelectAll(type) {
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (!selectAllCheckbox) return;

    const isChecked = selectAllCheckbox.checked;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);
    
    if (!selectedRows[type]) selectedRows[type] = new Set();
    
    checkboxes.forEach((cb, i) => {
        cb.checked = isChecked;
        const row = cb.closest('tr');
        if (row && row.dataset.index) {
            const indexStr = row.dataset.index;
            row.classList.toggle('row-selected', isChecked);
            if (isChecked) {
                selectedRows[type].add(indexStr);
            } else {
                selectedRows[type].delete(indexStr);
            }
        }
    });
    updateBulkToolbar(type);
}

function toggleFooterSelection(type) {
    if (type !== 'all' && !DATA[type]) return;
    const rows = document.querySelectorAll(`#t-${type} tbody tr`);
    const totalRows = rows.length;
    if (!selectedRows[type]) selectedRows[type] = new Set();
    if (totalRows === 0) { clearSelection(type); return; }

    const shouldSelectAll = selectedRows[type].size !== totalRows;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);

    if (checkboxes.length > 0) {
        checkboxes.forEach(cb => {
            cb.checked = shouldSelectAll;
            const row = cb.closest('tr');
            if (row && row.dataset.index) {
                const indexStr = row.dataset.index;
                row.classList.toggle('row-selected', shouldSelectAll);
                if (shouldSelectAll) {
                    selectedRows[type].add(indexStr);
                } else {
                    selectedRows[type].delete(indexStr);
                }
            }
        });
    } else {
        rows.forEach(row => {
            const indexStr = row.dataset.index;
            row.classList.toggle('row-selected', shouldSelectAll);
            if (indexStr) {
                if (shouldSelectAll) {
                    selectedRows[type].add(indexStr);
                } else {
                    selectedRows[type].delete(indexStr);
                }
            }
        });
    }

    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (selectAllCheckbox) selectAllCheckbox.checked = shouldSelectAll;
    updateBulkToolbar(type);
}

function updateBulkToolbar(type) {
    if (type === 'all') {
        const toolbar = document.getElementById('bulkToolbar');
        if (toolbar) toolbar.style.display = 'none';
        return;
    }
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    const toolbar = document.getElementById('bulkToolbar');
    
    document.getElementById('bulkCount').textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
    document.getElementById('bulkMoveSelect').value = ''; 

    toolbar.style.display = count > 0 ? 'flex' : 'none';
}

function attachRowSelection(tr, type, idx, checkboxId) {
    tr.addEventListener('click', (e) => {
        if (e.target.closest('input, select, button, .action-btn-base, .del-btn, .date-input-wrap, .dup-icon, [contenteditable], .trash-action-btns, .link-btn, .inline-link-btn')) return;
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox) return;
        checkbox.checked = !checkbox.checked;
        toggleSelect(type, idx, checkbox);
    });
}

function clearSelection(type = currentTab) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    selectedRows[type].clear();

    document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`).forEach(cb => cb.checked = false);
    document.querySelectorAll(`#t-${type} tbody tr`).forEach(tr => tr.classList.remove('row-selected'));

    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    updateBulkToolbar(type);
}

function askBulkDelete(type = currentTab) {
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    if (count === 0) return;

    const isTrash = type === 'trash';
    document.getElementById('del-modal-title').innerText = isTrash ? `–£–¥–∞–ª–∏—Ç—å ${count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞–≤—Å–µ–≥–¥–∞?` : `–£–¥–∞–ª–∏—Ç—å ${count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É?`;
    document.getElementById('del-modal-desc').innerText = isTrash ? "–≠–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ." : "–û–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 7 –¥–Ω–µ–π.";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = isTrash ? '–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞' : '–£–¥–∞–ª–∏—Ç—å';
    document.getElementById('finalDeleteBtn').onclick = () => bulkDelete(type, isTrash);
}

function bulkDelete(type = currentTab, deleteForever = false) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;

    const indicesToDelete = Array.from(selectedRows[type])
        .map(Number)
        .sort((a, b) => b - a);

    const deletedItems = [];

    indicesToDelete.forEach(idx => {
        const itemIndex = DATA[type].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[type].splice(itemIndex, 1)[0];
            if (deleteForever) {
                deletedItems.push({ item, index: itemIndex });
            } else {
                item.deletedAt = Date.now();
                DATA.trash.unshift(item);
            }
        }
    });

    lastPermanentDeletion = deleteForever ? { type, items: deletedItems } : null;

    selectedRows[type].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    save(); upd();
    if (deleteForever) {
        showToast('–£–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞', '–û—Ç–º–µ–Ω–∞', undoPermanentDelete);
    } else {
        showToast(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É: ${indicesToDelete.length}`, '–ü–µ—Ä–µ–π—Ç–∏', () => switchTab('trash'));
    }
}

function bulkDuplicate(type = currentTab) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;
    
    const indicesToDuplicate = Array.from(selectedRows[type])
        .map(Number)
        .sort((a, b) => a - b);
    
    const newItems = [];
    
    indicesToDuplicate.forEach(idx => {
        const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
        if(item) {
             item.n = item.n + " (–ö–æ–ø–∏—è)";
             newItems.push(item);
        }
    });
    
    DATA[type].unshift(...newItems);
    selectedRows[type].clear();
    save(); upd();
}

function askBulkMove(targetType) {
    const currentType = currentTab;
    const count = selectedRows[currentType] ? selectedRows[currentType].size : 0;
    
    if (count === 0 || !targetType) {
        document.getElementById('bulkMoveSelect').value = '';
        return;
    }
    
    const targetName = document.querySelector(`#bulkMoveSelect option[value="${targetType}"]`).text;
    
    document.getElementById('del-modal-title').innerText = `–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ${count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ "${targetName}"?`;
    document.getElementById('del-modal-desc').innerText = `–ü—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "${document.getElementById(`tab-${currentType}`).textContent.trim()}".`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').innerText = '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏';
    
    document.getElementById('finalDeleteBtn').onclick = () => bulkMove(currentType, targetType);
}

function bulkMove(from, to) {
    if (!selectedRows[from] || selectedRows[from].size === 0) return;

    const indicesToMove = Array.from(selectedRows[from])
        .map(Number)
        .sort((a, b) => b - a);
    
    indicesToMove.forEach(idx => {
        const itemIndex = DATA[from].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[from].splice(itemIndex, 1)[0];
            if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
            if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
            if(to === 'potential' || to === 'waiting' || to === 'paused') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
            DATA[to].unshift(item);
        }
    });
    
    selectedRows[from].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.getElementById('bulkMoveSelect').value = '';
    save(); 
    if(from === to) {
        upd();
    } else {
        switchTab(to);
    }
}

function init(){
    initTheme();
    let exist = localStorage.getItem(K);
    if(!exist) { const v4 = localStorage.getItem('grok_design_v4'); if(v4) exist = v4; }
    
    if (exist) {
        try { 
            const parsed = JSON.parse(exist);
            DATA = { ...DATA, ...parsed };
            if(!DATA.trash) DATA.trash = [];
            ['active', 'archive', 'paused', 'waiting', 'potential'].forEach(type => {
                 DATA[type].forEach(i => {
                    if(i.contractor === undefined) i.contractor = 0;
                    if(i.taxPrc === undefined) i.taxPrc = 0;
                    if(!i.contractorMode) i.contractorMode = 'amount';
                 });
            });
        } catch(e) { console.error("Data load error", e); }
    }
    
    cleanupTrash();
    renderMonthSelect();
    setupModalsBackgroundCheck();
    setupDatePickers();
    document.getElementById('saveLinkBtn').onclick = saveLink;
    document.getElementById('add-proj-start-val').value = today;
    document.getElementById('add-proj-dl-val').value = today;
    sortData('active', 'dl', 'date', true);
    ['active','waiting','potential','paused','archive'].forEach(t => {
        DATA[t].sortDirection = DATA[t].sortDirection || 1;
        updateSortIndicators(t);
    });
    upd();
}

function save(){ localStorage.setItem(K, JSON.stringify(DATA)); }

function cleanupTrash(){
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    const nowMs = Date.now();
    const initLen = DATA.trash.length;
    DATA.trash = DATA.trash.filter(i => (nowMs - (i.deletedAt || 0)) < sevenDays);
    if(DATA.trash.length !== initLen) save();
}

function formatCurrency(n) { return new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ'; }

function formatDateDisplay(str) {
    if (!str || str.startsWith('0000')) return '‚Äî';
    const hasTime = str.includes('T') && str.length > 10;
    const dateObj = new Date(str.replace(' ', 'T'));
    if(isNaN(dateObj.getTime())) return '‚Äî';
    const d = dateObj.toLocaleDateString('ru', { day: 'numeric', month: 'short' }).replace('.', '');
    if(hasTime) {
        const t = dateObj.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
        return `${d} <span class="time-text">${t}</span>`;
    }
    return d;
}

function calcContractorAmount(item) {
    const gross = toNumeric(item.p);
    const mode = item.contractorMode || 'amount';
    const raw = toNumeric(item.contractor);
    return mode === 'percent' ? gross * (raw / 100) : raw;
}

function calcNet(item){
    const gross = toNumeric(item.p);
    const contr = calcContractorAmount(item);
    const tax = toNumeric(item.taxPrc);
    const taxAmt = gross * (tax / 100);
    return Math.round(gross - taxAmt - contr);
}
function calcMarginPrc(item) {
    const gross = toNumeric(item.p);
    if (gross === 0) return 0;
    const net = calcNet(item);
    return Math.round((net / gross) * 100);
}

function setupModalsBackgroundCheck() {
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
}

function switchTab(t){
    currentTab = t;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
    ['active','waiting','potential','paused','archive','all','trash'].forEach(k => {
        const el = document.getElementById(`view-${k}`);
        if(el) el.style.display = (k === t) ? 'block' : 'none';
        const cb = document.getElementById(`selectAll${k.charAt(0).toUpperCase() + k.slice(1)}`);
        if(cb) cb.checked = false;
        if(selectedRows[k]) selectedRows[k].clear();
    });

    const desc = document.getElementById('tab-description');
    desc.innerHTML = getTabSummary(t, TAB_DESCRIPTIONS[t]);
    const dashboard = document.querySelector('.dashboard');
    if (dashboard) dashboard.style.display = t === 'trash' ? 'none' : 'block';
    updateSortIndicators(t);
    updateBulkToolbar(t);
    upd();
}

function getTabSummary(type, baseText) {
    if (type === 'trash') {
        return `${baseText} ¬∑ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ.`;
    }
    return baseText;
}

function sortData(type, key, dataType, initial = false) {
    if (!DATA[type]) return;
    let direction = 1;
    if (SORT[type] === key && !initial) {
        direction = DATA[type].sortDirection === 1 ? -1 : 1; 
    }
    DATA[type].sort((a, b) => {
        let va = a[key], vb = b[key];
        if (type === 'active' && (key === 'dl' || initial)) {
             const remA = getTimeRemaining(a.dl).days || Infinity;
             const remB = getTimeRemaining(b.dl).days || Infinity;
             if (remA !== remB) return direction * (remA - remB);
        }
        if (dataType === 'date') return direction * (new Date((va || '9999').replace(' ', 'T')) - new Date((vb || '9999').replace(' ', 'T')));
        if (dataType === 'number') return direction * (toNumeric(va) - toNumeric(vb));
        return direction * String(va).localeCompare(String(vb));
    });
    DATA[type].sortDirection = direction;
    SORT[type] = key;
    save();
    updateSortIndicators(type);
    if(!initial) upd();
}

function updateSortIndicators(type) {
    const activeKey = SORT[type];
    const dir = DATA[type].sortDirection || 1;
    document.querySelectorAll(`th[data-type="${type}"]`).forEach(th => th.classList.remove('sorted', 'asc', 'desc'));
    const activeTh = document.querySelector(`th[data-type="${type}"][data-key="${activeKey}"]`);
    if (activeTh) {
        activeTh.classList.add('sorted');
        activeTh.classList.add(dir === 1 ? 'asc' : 'desc');
    }
}

function upd(){
    renderActive();
    renderSimple('waiting');
    renderSimple('paused');
    renderPotential();
    renderArchive();
    renderAll();
    renderTrash();
    calcStats();
    const desc = document.getElementById('tab-description');
    if (desc) desc.innerHTML = getTabSummary(currentTab, TAB_DESCRIPTIONS[currentTab]);
    updateBulkToolbar(currentTab);
}

function renderActive(){
    const tbody = document.querySelector('#t-active tbody');
    tbody.innerHTML = '';
    let totalP = 0, totalPr = 0, totalContr = 0, totalTax = 0, totalPaidGross = 0;
    
    DATA.active.forEach((item, i) => {
        item.pr = calcNet(item);
        const gross = toNumeric(item.p);
        totalP += gross; totalPr += item.pr || 0;
        const contractorAmount = calcContractorAmount(item);
        totalContr += contractorAmount;
        totalTax += gross * ((toNumeric(item.taxPrc) || 0) / 100);

        const rem = getTimeRemaining(item.dl);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.active?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');

        const linkIcon = renderLinkControls(item, i, 'active');
        const paidAmount = Math.round(gross * ((toNumeric(item.paid) || 0) / 100));
        totalPaidGross += paidAmount;
        const contractorSymbol = item.contractorMode === 'percent' ? '%' : '‚ÇΩ';

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('active',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-active-${i}" onchange="toggleSelect('active', ${i}, this)" ${selectedRows.active?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-active-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('active',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('active',${i},'n',this.innerText)">${item.n}</span>
            </td>
            
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('active',${i},'start')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.start)}</span></div></td>
            <td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('active',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.dl)}</span></div></td>
            
            <td class="mono"><div class="${rem.cls}">${rem.txt}</div></td>
            
            <td><select class="tax-select" onchange="updVal('active',${i},'taxPrc',this.value)">
                <option value="0" ${+item.taxPrc===0?'selected':''}>0%</option>
                <option value="4" ${+item.taxPrc===4?'selected':''}>4%</option>
                <option value="6" ${+item.taxPrc===6?'selected':''}>6%</option>
                <option value="13" ${+item.taxPrc===13?'selected':''}>13%</option>
            </select></td>
            
            <td style="text-align:right;">
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${formatPlainNumber(item.contractor ?? 0)}" oninput="formatNumberInput(this)" onblur="updateContractorValue('active',${i},this.value)">
                    <span class="currency-symbol">${contractorSymbol}</span>
                    <select class="expense-mode" onchange="updateContractorMode('active',${i},this.value)">
                        <option value="amount" ${item.contractorMode!=='percent'?'selected':''}>‚ÇΩ</option>
                        <option value="percent" ${item.contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">‚âà ${formatCurrency(contractorAmount)}</div>
            </td>

            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('active',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            
            <td class="paid-cell">
                <select class="paid-select" onchange="updVal('active',${i},'paid',this.value)">
                    <option value="0" ${+item.paid===0?'selected':''}>0%</option>
                    <option value="50" ${+item.paid===50?'selected':''}>50%</option>
                    <option value="100" ${+item.paid===100?'selected':''}>100%</option>
                </select>
                <div class="paid-amount">${formatCurrency(paidAmount)}</div>
            </td>
            
            <td><div class="action-btns">
                <div class="done-btn action-btn-base" onclick="mv(${i},'active','archive')" title="–í—ã–ø–æ–ª–Ω–µ–Ω–æ">‚úì</div>
                <div class="wait-active-btn action-btn-base" onclick="mv(${i},'active','waiting')" title="–í –æ–∂–∏–¥–∞–Ω–∏–∏">...</div>
                <div class="pause-active-btn action-btn-base" onclick="mv(${i},'active','paused')" title="–ù–∞ –ø–∞—É–∑–µ">||</div>
                <button class="del-btn" onclick="askDel('active',${i})" title="–£–¥–∞–ª–∏—Ç—å" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'active', i, `check-active-${i}`);
        tbody.appendChild(tr);
    });
    
    const footer = document.querySelector('#total-row-active');
    const repState = analyzeReputation();
    footer.innerHTML = `<tr>
        <td colspan="6" class="footer-total-toggle" onclick="toggleFooterSelection('active')">–í—Å–µ–≥–æ ${DATA.active.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td style="text-align:right;">
            <div class="footer-note">–ù–∞–ª–æ–≥–∏</div>
            <div>${formatCurrency(totalTax)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–†–∞—Å—Ö–æ–¥—ã</div>
            <div>${formatCurrency(totalContr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(totalP)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–ß–∏—Å—Ç—ã–º–∏</div>
            <div>${formatCurrency(totalPr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–û–ø–ª–∞—á–µ–Ω–æ</div>
            <div>${formatCurrency(totalPaidGross)}</div>
        </td>
        <td></td>
    </tr>`;

    updatePaceReputation(repState);

    const paceBlock = document.getElementById('pace-indicator');
    const urgent = DATA.active.filter(x => getTimeRemaining(x.dl).cls.includes('critical')).length;
    
    if (currentTab === 'active') {
        if (urgent > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.add('critical');
            document.getElementById('pace-icon').innerHTML = 'üî•';
            document.getElementById('pace-title').innerText = '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!';
            document.getElementById('pace-desc').innerText = `–ì–æ—Ä–∏—Ç –¥–µ–¥–ª–∞–π–Ω–æ–≤: ${urgent}. –ü–æ–¥–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å!`;
            document.getElementById('pace-status').className='pace-status pace-hurry'; 
            document.getElementById('pace-status').innerText='–ö—Ä–∏—Ç–∏—á–Ω–æ';
        } else if (DATA.active.length > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.remove('critical');
            document.getElementById('pace-icon').innerHTML = 'üö¶';
            document.getElementById('pace-title').innerText = '–ê–Ω–∞–ª–∏–∑';
            document.getElementById('pace-desc').innerText = `–í—Å–µ —Å–ø–æ–∫–æ–π–Ω–æ.`;
            document.getElementById('pace-status').className='pace-status pace-chill'; 
            document.getElementById('pace-status').innerText='–ù–æ—Ä–º–∞';
        } else {
            paceBlock.style.display = 'none';
        }
    } else {
        paceBlock.style.display = 'none';
    }
}

function renderSimple(type){
    const tbody = document.querySelector(`#t-${type} tbody`);
    tbody.innerHTML = '';
    let tot = 0;
    DATA[type].forEach((item, i) => {
        tot += toNumeric(item.p);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows[type]?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        
        const linkIcon = renderLinkControls(item, i, type);
                                      
        const rem = getTimeRemaining(item.dl);
        
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('${type}',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-${type}-${i}" onchange="toggleSelect('${type}', ${i}, this)" ${selectedRows[type]?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-${type}-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('${type}',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('${type}',${i},'n',this.innerText)">${item.n}</span>
            </td>
            <td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('${type}',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.dl)} (${rem.txt})</span></div></td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('${type}',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" onclick="mv(${i},'${type}','active')" title="–í —Ä–∞–±–æ—Ç—É">‚ñ∂Ô∏è</div>
                <button class="del-btn" onclick="askDel('${type}',${i})" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, type, i, `check-${type}-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector(`#total-row-${type}`);
    footer.innerHTML = `<tr>
        <td colspan="4" class="footer-total-toggle" onclick="toggleFooterSelection('${type}')">–í—Å–µ–≥–æ ${DATA[type].length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td>
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(tot)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderPotential(){
    const tbody = document.querySelector('#t-potential tbody');
    tbody.innerHTML = '';
    let tot = 0;
    DATA.potential.forEach((item, i) => {
        tot += toNumeric(item.p);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.potential?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        
        const linkIcon = renderLinkControls(item, i, 'potential');
                                      
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('potential',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-potential-${i}" onchange="toggleSelect('potential', ${i}, this)" ${selectedRows.potential?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-potential-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('potential',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('potential',${i},'n',this.innerText)">${item.n}</span>
            </td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('potential',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="done-btn action-btn-base" onclick="mv(${i},'potential','active')" title="–í —Ä–∞–±–æ—Ç—É">‚úÖ –í —Ä–∞–±–æ—Ç—É</div>
                <button class="del-btn" onclick="askDel('potential',${i})" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'potential', i, `check-potential-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-potential');
    footer.innerHTML = `<tr>
        <td colspan="3" class="footer-total-toggle" onclick="toggleFooterSelection('potential')">–í—Å–µ–≥–æ ${DATA.potential.length} –ª–∏–¥–æ–≤</td>
        <td>
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(tot)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderArchive(){
    const tbody = document.querySelector('#t-archive tbody');
    tbody.innerHTML = '';
    let tP = 0, tPr = 0, tContr = 0, tTax = 0;
    const visibleItems = DATA.archive.filter(i => (i.date||'').startsWith(currentMonth));
    visibleItems.forEach((item, i) => {
        const realIdx = DATA.archive.indexOf(item);
        item.pr = calcNet(item);
        tP += toNumeric(item.p); tPr += +item.pr || 0;
        const contractorAmount = calcContractorAmount(item);
        tContr += contractorAmount;
        tTax += toNumeric(item.p) * ((toNumeric(item.taxPrc) || 0) / 100);
        const tr = document.createElement('tr');
        tr.dataset.index = realIdx;

        const isSelected = selectedRows.archive?.has(realIdx.toString());
        if (isSelected) tr.classList.add('row-selected');
        
        const linkIcon = renderLinkControls(item, realIdx, 'archive');
                                      
        const contractorSymbol = item.contractorMode === 'percent' ? '%' : '‚ÇΩ';

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('archive',${realIdx})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-archive-${realIdx}" onchange="toggleSelect('archive', ${realIdx}, this)" ${selectedRows.archive?.has(realIdx.toString()) ? 'checked' : ''}>
                    <label for="check-archive-${realIdx}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('archive',${realIdx},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('archive',${realIdx},'n',this.innerText)">${item.n}</span>
            </td>
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('archive',${realIdx},'date')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.date)}</span></div></td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('archive',${realIdx},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td>
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${formatPlainNumber(item.contractor ?? 0)}" oninput="formatNumberInput(this)" onblur="updateContractorValue('archive',${realIdx},this.value)">
                    <span class="currency-symbol">${contractorSymbol}</span>
                    <select class="expense-mode" onchange="updateContractorMode('archive',${realIdx},this.value)">
                        <option value="amount" ${item.contractorMode!=='percent'?'selected':''}>‚ÇΩ</option>
                        <option value="percent" ${item.contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">‚âà ${formatCurrency(contractorAmount)}</div>
            </td>
            <td><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" title="–í–µ—Ä–Ω—É—Ç—å" onclick="mv(${realIdx},'archive','active')">‚è™</div>
                <button class="del-btn" onclick="askDel('archive',${realIdx})" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'archive', realIdx, `check-archive-${realIdx}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-archive');
    footer.innerHTML = `<tr>
        <td colspan="4" class="footer-total-toggle" onclick="toggleFooterSelection('archive')">–í—Å–µ–≥–æ ${visibleItems.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td style="text-align:right;">
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(tP)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–†–∞—Å—Ö–æ–¥—ã</div>
            <div>${formatCurrency(tContr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–ß–∏—Å—Ç—ã–º–∏</div>
            <div>${formatCurrency(tPr)}</div>
            <div class="footer-note">–ù–∞–ª–æ–≥–∏: ${formatCurrency(tTax)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderAll(){
    const tbody = document.querySelector('#t-all tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const allItems = [];
    ['active','waiting','paused','archive'].forEach(type => {
        DATA[type].forEach((item, idx) => allItems.push({ item, __type: type, idx }));
    });

    let totalGross = 0, totalNet = 0, totalExp = 0, totalTax = 0;

    allItems.forEach((wrap, i) => {
        const item = wrap.item;
        const status = STATUS_META[wrap.__type] || { label: wrap.__type, cls: '' };
        const contractorAmount = calcContractorAmount(item);
        const net = calcNet(item);
        const gross = toNumeric(item.p);
        const taxAmount = gross * ((toNumeric(item.taxPrc) || 0) / 100);
        totalGross += gross;
        totalNet += net;
        totalExp += contractorAmount;
        totalTax += taxAmount;

        const tr = document.createElement('tr');
        const deadlineValue = wrap.__type === 'archive' ? item.date : (item.dl || item.date || item.start);
        const rem = wrap.__type === 'archive' ? { cls: '', txt: '' } : getTimeRemaining(deadlineValue);
        const remText = wrap.__type === 'archive' || rem.txt === '‚Äî' ? '' : ` (${rem.txt})`;
        const dateDisplay = deadlineValue ? formatDateDisplay(deadlineValue) : '‚Äî';
        const dateCls = wrap.__type === 'archive' ? '' : rem.cls;

        tr.innerHTML = `
            <td class="select-col"><div class="row-index">${i + 1}</div></td>
            <td><span class="status-pill ${status.cls}">${status.label}</span></td>
            <td><div class="client-wrap">${item.c || '‚Äî'}</div></td>
            <td class="project-name-wrap">${item.n || '‚Äî'}</td>
            <td class="date-cell"><div class="date-input-wrap ${dateCls}"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${dateDisplay}${remText}</span></div></td>
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(gross)}" oninput="formatNumberInput(this)" onblur="updVal('${wrap.__type}',${wrap.idx},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td style="text-align:right;">
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${formatPlainNumber(item.contractor ?? 0)}" oninput="formatNumberInput(this)" onblur="updateContractorValue('${wrap.__type}',${wrap.idx},this.value)">
                    <span class="currency-symbol">${item.contractorMode==='percent'?'%':'‚ÇΩ'}</span>
                </div>
                <div class="expense-helper">‚âà ${formatCurrency(contractorAmount)}</div>
            </td>
            <td style="text-align:right;">${item.taxPrc || 0}%</td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(net)}</div></td>
        `;
        tbody.appendChild(tr);
    });

    const footer = document.querySelector('#total-row-all');
    if (footer) {
        footer.innerHTML = `<tr>
            <td colspan="5" class="footer-total-toggle" onclick="toggleFooterSelection('all')">–í—Å–µ–≥–æ ${allItems.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
            <td style="text-align:right;">
                <div class="footer-note">–°—É–º–º–∞</div>
                <div>${formatCurrency(totalGross)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–†–∞—Å—Ö–æ–¥—ã</div>
                <div>${formatCurrency(totalExp)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–ù–∞–ª–æ–≥–∏</div>
                <div>${formatCurrency(totalTax)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–ß–∏—Å—Ç—ã–º–∏</div>
                <div>${formatCurrency(totalNet)}</div>
            </td>
        </tr>`;
    }
}

function renderTrash(){
    const tbody = document.querySelector('#t-trash tbody');
    tbody.innerHTML = '';
    DATA.trash.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.trash?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        const delDate = item.deletedAt ? new Date(item.deletedAt).toLocaleDateString() : '?';
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('trash',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-trash-${i}" onchange="toggleSelect('trash', ${i}, this)" ${selectedRows.trash?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-trash-${i}" style="display:none;"></label>
                </div>
            </td>
            <td style="color:var(--red); font-size:12px">${delDate}</td>
            <td>${item.c}</td>
            <td>${item.n}</td>
            <td>${formatCurrency(item.p)}</td>
            <td>
                <div class="trash-action-btns">
                    <div class="restore-trash-btn" onclick="restoreFromTrash(${i})">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</div>
                    <div class="delete-forever-text" onclick="deleteForeverCheck(${i})" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞">–£–¥–∞–ª–∏—Ç—å</div>
                </div>
            </td>
        `;
        attachRowSelection(tr, 'trash', i, `check-trash-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#t-trash tfoot td:first-child');
    if (footer) {
        footer.className = 'footer-total-toggle';
        footer.onclick = () => toggleFooterSelection('trash');
        footer.innerText = `–í—Å–µ–≥–æ ${DATA.trash.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`;
    }
}

function updVal(type, idx, key, val){
    if(key==='p' || key==='contractor' || key==='paid' || key==='taxPrc') val = toNumeric(val);
    DATA[type][idx][key] = val;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function updateContractorValue(type, idx, val) {
    DATA[type][idx].contractor = toNumeric(val);
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function updateContractorMode(type, idx, mode) {
    DATA[type][idx].contractorMode = mode;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function mv(idx, from, to){
    const item = DATA[from][idx];
    DATA[from].splice(idx, 1);
    if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
    if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
    if(to === 'potential' || to === 'waiting' || to === 'paused') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
    
    DATA[to].unshift(item);
    sortData('active', 'dl', 'date', true);
    save(); 
    setTimeout(() => { switchTab(to); }, 10);
}

function duplicateRow(type, idx){
    const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
    if(!item) return;
    item.n = item.n + " (–ö–æ–ø–∏—è)";
    DATA[type].unshift(item);
    save(); upd();
}

function askDel(type, idx){
    const itemIndex = DATA[type].findIndex((_, i) => i === idx);
    if (itemIndex > -1) {
        const item = DATA[type].splice(itemIndex, 1)[0];
        item.deletedAt = Date.now();
        DATA.trash.unshift(item);
        lastPermanentDeletion = null;
        save(); upd();
        showToast('–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É', '–ü–µ—Ä–µ–π—Ç–∏', () => switchTab('trash'));
    }
}

function deleteForeverCheck(idx) {
    document.getElementById('del-modal-title').innerText = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ";
    document.getElementById('del-modal-desc').innerText = "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = '–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞';

    document.getElementById('finalDeleteBtn').onclick = () => {
        const item = DATA.trash.splice(idx, 1)[0];
        lastPermanentDeletion = item ? { type: 'trash', items: [{ item, index: idx }] } : null;
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
        showToast('–£–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞', '–û—Ç–º–µ–Ω–∞', undoPermanentDelete);
    };
}

function restoreFromTrash(idx){
    const item = DATA.trash.splice(idx, 1)[0];
    delete item.deletedAt;
    DATA.active.unshift(item);
    save(); switchTab('active');
}

function openAddModal(){
    ['name','client','price','contractor'].forEach(id => document.getElementById(`add-proj-${id}`).value = '');
    document.getElementById('add-proj-tax').value = '0';
    document.getElementById('add-proj-contractor-mode').value = 'amount';
    document.getElementById('add-proj-start-val').value = today;
    document.getElementById('add-proj-dl-val').value = today;
    previousDeadlineValue = today;
    document.getElementById('add-proj-dl-days').value = '';
    document.getElementById('add-proj-dl-custom').value = '';
    document.getElementById('add-proj-start-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(today);
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(today);
    document.getElementById('addProjectModal').style.display = 'flex';
}
function saveNewProject(){
    const name = document.getElementById('add-proj-name').value;
    const client = document.getElementById('add-proj-client').value;
    const price = toNumeric(document.getElementById('add-proj-price').value);
    const contr = toNumeric(document.getElementById('add-proj-contractor').value);
    const contrMode = document.getElementById('add-proj-contractor-mode').value || 'amount';
    const tax = +document.getElementById('add-proj-tax').value || 0;
    const type = document.getElementById('add-proj-type').value;
    const start = document.getElementById('add-proj-start-val').value || today;
    const dl = document.getElementById('add-proj-dl-val').value || today;
    
    const item = {
        n: name, c: client, p: price, contractor: contr, contractorMode: contrMode, taxPrc: tax, link: '',
        start: type==='active'? start : undefined,
        dl: type==='active' || type==='waiting' || type==='paused' ? dl : undefined, 
        paid: (type==='active'||type==='archive'? (type==='archive'?100:50) : 0),
        date: type==='archive' ? today : undefined
    };
    
    DATA[type].unshift(item);
    document.getElementById('addProjectModal').style.display = 'none';
    sortData('active', 'dl', 'date', true);
    save(); switchTab(type);
}

function applyDeadlinePreset() {
    const select = document.getElementById('add-proj-dl-days');
    const customInput = document.getElementById('add-proj-dl-custom');
    const currentDl = document.getElementById('add-proj-dl-val').value || document.getElementById('add-proj-start-val').value || today;

    if (!previousDeadlineValue) {
        previousDeadlineValue = currentDl;
    }

    if (document.activeElement === customInput && select.value !== 'custom') {
        select.value = 'custom';
    }

    if (select.value === '') {
        const restoreVal = previousDeadlineValue || currentDl;
        document.getElementById('add-proj-dl-val').value = restoreVal;
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(restoreVal);
        customInput.value = '';
        previousDeadlineValue = '';
        return;
    }

    if (select.value === 'custom' && customInput.value.trim() === '') {
        select.value = '';
        document.getElementById('add-proj-dl-val').value = previousDeadlineValue || currentDl;
        const restoredDl = document.getElementById('add-proj-dl-val').value || currentDl;
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(restoredDl);
        previousDeadlineValue = '';
        return;
    }

    let days = parseInt(select.value, 10);
    if (select.value === 'custom') {
        days = parseInt(customInput.value, 10);
    }

    if (!days || days <= 0) return;
    const startRaw = document.getElementById('add-proj-start-val').value || today;
    const baseDate = new Date(startRaw);
    if (isNaN(baseDate)) return;
    const dlDate = new Date(baseDate);
    dlDate.setDate(dlDate.getDate() + days);
    const iso = dlDate.toISOString().slice(0, 10);
    document.getElementById('add-proj-dl-val').value = iso;
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(iso);
}

function openDate(type, idx, field){
    queue = {type, idx, field, targetId: null};
    const val = DATA[type][idx][field];
    openDateBase(val);
}
function openDateInModal(targetInputId){
    const val = document.getElementById(targetInputId).value;
    queue = {type: null, idx: null, field: null, targetId: targetInputId};
    openDateBase(val);
}
function setupDatePickers(){
    if (typeof flatpickr !== 'function') return;

    datePicker = flatpickr('#date-input-val', {
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'j M',
        defaultDate: today,
        locale: flatpickr.l10ns.ru,
        disableMobile: true,
    });

    timePicker = flatpickr('#time-input-val', {
        enableTime: true,
        noCalendar: true,
        dateFormat: 'H:i',
        defaultDate: '12:00',
        time_24hr: true,
        minuteIncrement: 5,
        disableMobile: true,
    });
}
function openDateBase(val) {
    const hasTime = val && val.includes('T') && val.length > 10;
    document.getElementById('date-has-time').checked = hasTime;

    const dateVal = val ? val.slice(0, 10) : today;
    const timeVal = hasTime ? val.slice(11, 16) : '12:00';

    if (datePicker) datePicker.setDate(dateVal, true);
    else document.getElementById('date-input-val').value = dateVal;

    if (timePicker) timePicker.setDate(timeVal, true, 'H:i');
    else document.getElementById('time-input-val').value = timeVal;

    toggleTimeInput();
    document.getElementById('dateModal').style.display = 'flex';
}
function toggleTimeInput(){
    const chk = document.getElementById('date-has-time');
    const baseInput = document.getElementById('time-input-val');
    const inputs = [baseInput, timePicker?.input, timePicker?.altInput].filter(Boolean);

    inputs.forEach(inp => {
        inp.disabled = !chk.checked;
        inp.style.opacity = chk.checked ? '1' : '0.3';
    });

    if (timePicker) {
        timePicker.set('clickOpens', chk.checked);
    }
}
function closeDateModal(){ document.getElementById('dateModal').style.display = 'none'; }
function saveDate(){
    const d = document.getElementById('date-input-val').value;
    const t = document.getElementById('time-input-val').value;
    const useTime = document.getElementById('date-has-time').checked;
    if(!d) return;
    const result = useTime ? `${d}T${t}` : d;

    if (queue.targetId) {
        document.getElementById(queue.targetId).value = result;
        const displayId = queue.targetId.replace('-val', '-display');
        document.getElementById(displayId).querySelector('.date-text-display').innerHTML = formatDateDisplay(result);
        if (queue.targetId === 'add-proj-start-val') {
            const presetDays = parseInt(document.getElementById('add-proj-dl-days').value, 10);
            if (presetDays) applyDeadlinePreset();
        }
    } else {
        DATA[queue.type][queue.idx][queue.field] = result;
        sortData('active', 'dl', 'date', true);
    }
    
    closeDateModal(); save(); upd();
}

function openProjectLink(idx, type) {
    const link = DATA[type][idx].link;
    if (link) {
        window.open(link, '_blank');
    } else {
        openLink(type, idx);
    }
}
function openLink(type, idx){
    queue = {type, idx};
    const currentLink = DATA[type][idx].link || '';
    const tgCheckbox = document.getElementById('link-is-telegram');
    let displayValue = currentLink;

    if (currentLink.match(/t\.me\//)) {
        tgCheckbox.checked = true;
        displayValue = currentLink.replace(/^https?:\/\/t\.me\//, '').replace(/^@+/, '');
    } else {
        tgCheckbox.checked = false;
    }

    document.getElementById('link-input').value = displayValue;
    document.getElementById('linkModal').style.display = 'flex';
}
function closeLinkModal(){ document.getElementById('linkModal').style.display = 'none'; }
function saveLink(){
    const isTelegram = document.getElementById('link-is-telegram').checked;
    let url = document.getElementById('link-input').value.trim().replace(/^@+/, '');

    if (isTelegram) {
        url = url.replace(/^https?:\/\/t\.me\//, '').replace(/^@+/, '');
        url = url ? `https://t.me/${url}` : '';
    } else if (url && !url.match(/^(https?:\/\/|mailto:)/)) {
        url = 'https://' + url;
    }

    DATA[queue.type][queue.idx].link = url;
    closeLinkModal(); save(); upd();
}

function openSettings(){
    document.getElementById('stg-goal').value = formatPlainNumber(DATA.monthlyGoals[currentMonth] || 250000);
    document.getElementById('stg-rec').value = formatPlainNumber(DATA.settings.record || 0);
    document.getElementById('settingsModal').style.display = 'flex';
}
function openGoalSettings(){
    openSettings();
    const goalInput = document.getElementById('stg-goal');
    if (goalInput) {
        goalInput.focus();
        goalInput.select();
    }
}
function openRecordSettings(){
    openSettings();
    const recordInput = document.getElementById('stg-rec');
    if (recordInput) {
        recordInput.focus();
        recordInput.select();
    }
}
function saveSettings(){
    DATA.monthlyGoals[currentMonth] = toNumeric(document.getElementById('stg-goal').value);
    DATA.settings.record = toNumeric(document.getElementById('stg-rec').value);
    document.getElementById('settingsModal').style.display = 'none';
    save(); upd();
}

function pluralize(num, forms){
    const n = Math.abs(num) % 100;
    const n1 = n % 10;
    if (n > 10 && n < 20) return forms[2];
    if (n1 > 1 && n1 < 5) return forms[1];
    if (n1 === 1) return forms[0];
    return forms[2];
}

function getTimeRemaining(dl){
    if(!dl) return {txt:'‚Äî', cls:'days-normal', days: Infinity};
    const end = new Date(dl.slice(0, 10) + 'T00:00:00').getTime();
    const todayNormalized = new Date(today + 'T00:00:00').getTime();
    
    const diff = end - todayNormalized;
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    
    if(days < 0) return {txt:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ', cls:'days-critical', days: -1};
    if(days === 0) return {txt:'–°–µ–≥–æ–¥–Ω—è', cls:'days-critical', days: 0};
    if(days <= 3) return {txt: days + ' –¥–Ω.', cls:'days-warning', days: days};
    return {txt: days + ' –¥–Ω.', cls:'days-normal', days: days};
}

function changeMonth(m){ 
    currentMonth = m; 
    if (!DATA.monthlyGoals[currentMonth]) {
        DATA.monthlyGoals[currentMonth] = 250000;
        save();
    }
    upd();
}
function renderMonthSelect(){
    const sel = document.getElementById('monthSelect');
    const months = new Set([today.slice(0,7)]);
    [...DATA.archive, ...DATA.active].forEach(i => {
        if(i.date) months.add(i.date.slice(0,7));
        if(i.start) months.add(i.start.slice(0,7));
    });
    Object.keys(DATA.monthlyGoals).forEach(m => months.add(m));

    sel.innerHTML = '';
    Array.from(months).sort().reverse().forEach(m => {
        const d = new Date(m + '-01');
        const name = d.toLocaleString('ru', {month:'long', year:'numeric'});
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        if(m===currentMonth) opt.selected = true;
        sel.appendChild(opt);
    });
}

const repCenterText = {
    id: 'repCenterText',
    afterDraw(chart, args, opts) {
        const { ctx, chartArea: { width, height } } = chart;
        ctx.save();
        ctx.font = '900 22px -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif';
        ctx.fillStyle = '#f0f6fc';
        ctx.textAlign = 'center';
        ctx.fillText(opts.text || '', width / 2, height / 2 + 6);
        ctx.font = '600 12px -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif';
        ctx.fillStyle = '#8b949e';
        ctx.fillText(opts.subText || '', width / 2, height / 2 + 22);
        ctx.restore();
    }
};

function analyzeReputation(){
    const projectTypes = ['active', 'waiting', 'paused', 'potential'];
    const overdue = [];
    projectTypes.forEach(type => {
        DATA[type].forEach(item => {
            const rem = getTimeRemaining(item.dl);
            if (rem.days < 0) {
                overdue.push({
                    name: item.n || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                    client: item.c || '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞',
                    days: Math.abs(rem.days)
                });
            }
        });
    });

    const total = overdue.length;
    const worst = overdue.reduce((acc, cur) => Math.max(acc, cur.days), 0);
    const avg = total ? Math.round(overdue.reduce((acc, cur) => acc + cur.days, 0) / total) : 0;
    const activeCount = DATA.active.length;
    const nearDeadline = DATA.active.filter(item => {
        const rem = getTimeRemaining(item.dl);
        return rem.days >= 0 && rem.days <= 2;
    }).length;
    const onTime = Math.max(activeCount - total - nearDeadline, 0);
    const score = Math.max(0, Math.min(100, 100 - total * 12 - Math.max(0, worst - 2) * 3 - nearDeadline * 2));

    let level = 'good';
    let headline = '–í—Å—ë –æ–∫ ‚Äî —Ç—ã –¥–µ—Ä–∂–∏—à—å —Å—Ä–æ–∫–∏';
    let hint = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.';
    let chip = 'üî• –í—Å—ë –æ–∫';
    let detail = '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–∫ —É—Å–∏–ª–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤. –î–µ—Ä–∂–∏ —Ç–µ–º–ø –∏ —Ñ–∏–∫—Å–∏—Ä—É–π —É—Å–ø–µ—Ö–∏ –≤ –∞—Ä—Ö–∏–≤–µ.';
    let fallout = '–°–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–∏–≤—ã—á–∫—É –æ–ø–µ—Ä–µ–∂–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã ‚Äî —ç—Ç–æ –ª–∏—á–Ω—ã–π –±—Ä–µ–Ω–¥ –∏ –ø–æ—Ç–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.';
    let tips = [
        '–§–∏–∫—Å–∏—Ä—É–π –¥–µ–¥–ª–∞–π–Ω—ã –ø—Ä–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–¥–∞—á, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É.',
        '–ó–∞–∫—Ä—ã–≤–∞–π –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ –∞—Ä—Ö–∏–≤ ‚Äî —ç—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥.',
    ];

    if (total > 0) {
        const overdueWord = `${total} ${pluralize(total, ['–ø—Ä–æ—Å—Ä–æ—á–∫–∞', '–ø—Ä–æ—Å—Ä–æ—á–∫–∏', '–ø—Ä–æ—Å—Ä–æ—á–µ–∫'])}`;
        const daysWord = `${worst} ${pluralize(worst, ['–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π'])}`;
        if (total <= 2 && worst <= 5) {
            level = 'warn';
            headline = '–ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ ‚Äî –ø–æ–ø—Ä–∞–≤—å —Å—Ä–æ–∫–∏';
            hint = `${overdueWord} –¥–æ ${daysWord}. –û–±–Ω–æ–≤–∏ –ø–ª–∞–Ω –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.`;
            chip = '‚ö† –ü–æ–¥–Ω–∞–∂–º–∏';
            detail = '–ü–∞—Ä–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ –µ—â—ë –ø–æ–ø—Ä–∞–≤–∏–º–∞: –¥–æ–≥–æ–≤–æ—Ä–∏—Å—å –æ –Ω–æ–≤—ã—Ö —Å—Ä–æ–∫–∞—Ö –∏ –∑–∞–∫—Ä–æ–π –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–æ–≤–µ—Ä–∏–µ.';
            fallout = '–ï—Å–ª–∏ —Ç–∞–∫ —Ç—è–Ω—É—Ç—å –∏ –¥–∞–ª—å—à–µ, –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –∏ —É–π–¥—É—Ç –∫ —Ç–µ–º, –∫—Ç–æ –¥–µ—Ä–∂–∏—Ç —Å—Ä–æ–∫–∏.';
            tips = [
                '–î–æ–≥–æ–≤–æ—Ä–∏—Å—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –æ –Ω–æ–≤—ã—Ö —Å—Ä–æ–∫–∞—Ö –∏ –æ—Ç–º–µ—Ç—å –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ.',
                '–°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ –∑–∞–¥–∞—á–∞—Ö —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Å—Ä–æ—á–∫–æ–π, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –∫—Ä–∞—Å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã.',
                '–û—Ç–ª–æ–∂–∏ –Ω–æ–≤—ã–µ –±—Ä–æ–Ω–∏ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—É—â–∏—Ö —Ö–≤–æ—Å—Ç–æ–≤.',
            ];
        } else {
            level = 'bad';
            headline = '–†–µ–ø—É—Ç–∞—Ü–∏—è –ø—Ä–æ—Å–µ–¥–∞–µ—Ç';
            hint = `${overdueWord} –¥–æ ${daysWord} ‚Äî –ø–æ—Ä–∞ —Å–ø–∞—Å–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é.`;
            chip = 'ü§Ø –ñ–µ—Å—Ç—å';
            detail = '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ —É–∂–µ –±—å—é—Ç –ø–æ –∏–º–µ–Ω–∏. –ù–∞–≤–µ–¥–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö –∏ –≤–µ—Ä–Ω–∏ —Å—Ä–æ–∫–∏ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—å.';
            fallout = '–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å—Ä—ã–≤–æ–≤ = —à—Ç—Ä–∞—Ñ—ã, –≤–æ–∑–≤—Ä–∞—Ç—ã –∏ –∂—ë—Å—Ç–∫–∏–µ –æ—Ç–∑—ã–≤—ã. –õ–∏–¥—ã –±—É–¥—É—Ç –æ–±—Ö–æ–¥–∏—Ç—å —Ç–µ–±—è —Å—Ç–æ—Ä–æ–Ω–æ–π.';
            tips = [
                '–°–æ—Å—Ç–∞–≤—å –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–Ω—ã–π —Å–ø–∏—Å–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–π —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –∏ –¥–æ—Ä–æ–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã.',
                '–†–∞–∑–±–µ–π –æ–±—ä—ë–º –Ω–∞ –∫—Ä–∞—Ç–∫–∏–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –æ—Ç–º–µ—á–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å.',
                '–û–ø–æ–≤–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ —Å—Ç–∞—Ç—É—Å–µ ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤ –ø–æ –ø—Ä–æ—Å—Ä–æ—á–∫–∞–º.',
            ];
        }
    } else if (nearDeadline > 0) {
        fallout = '–ï—Å–ª–∏ –ø—Ä–æ–º–æ—Ä–≥–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –¥–Ω—è ‚Äî –æ–Ω–∏ —É–π–¥—É—Ç –≤ –∫—Ä–∞—Å–Ω—É—é –∑–æ–Ω—É –∏ –ø–æ—Ç—è–Ω—É—Ç —Ä–µ–π—Ç–∏–Ω–≥ –≤–Ω–∏–∑.';
        tips.push('–ù–∞ —Ä–∞–¥–∞—Ä–µ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏ —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –¥–Ω—è ‚Äî –≤—ã–¥–µ–ª–∏ –ø–æ–¥ –Ω–∏—Ö —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã.');
    }

    return { level, headline, hint, chip, detail, fallout, score, total, worst, avg, activeCount, nearDeadline, tips, onTime };
}

function updateReputationUI(){
    const state = analyzeReputation();
    const strip = document.getElementById('reputation-strip');
    if (strip) {
        strip.classList.remove('good', 'warn', 'bad');
        strip.classList.add(state.level);
    }

    const headline = document.getElementById('reputation-headline');
    if (headline) headline.innerText = state.headline;

    const hint = document.getElementById('reputation-hint');
    if (hint) hint.innerText = state.hint;

    const chip = document.getElementById('reputation-chip');
    if (chip) {
        chip.classList.remove('good', 'warn', 'bad');
        chip.classList.add(state.level);
        chip.innerText = state.chip;
    }

    const score = document.getElementById('reputation-score');
    if (score) score.innerText = `${state.score} / 100`;
    const scoreLabel = document.getElementById('rep-score-label');
    if (scoreLabel) scoreLabel.innerText = state.score;

    const grade = document.getElementById('reputation-grade');
    if (grade) {
        grade.innerText = state.total
            ? `${state.total} ${pluralize(state.total, ['–ø—Ä–æ—Å—Ä–æ—á–∫–∞', '–ø—Ä–æ—Å—Ä–æ—á–∫–∏', '–ø—Ä–æ—Å—Ä–æ—á–µ–∫'])} (–¥–æ ${state.worst} ${pluralize(state.worst, ['–¥–Ω—è', '–¥–Ω–µ–π', '–¥–Ω–µ–π'])})`
            : '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç';
    }

    const detail = document.getElementById('reputation-detail');
    if (detail) detail.innerText = state.detail;

    const fallout = document.getElementById('reputation-fallout');
    if (fallout) {
        fallout.style.display = state.level === 'good' ? 'none' : 'block';
        fallout.innerText = state.level === 'good' ? '' : state.fallout;
    }

    const activeCount = document.getElementById('rep-active-count');
    if (activeCount) activeCount.innerText = state.activeCount;

    const repOnTime = document.getElementById('rep-on-time');
    if (repOnTime) {
        const onTime = Math.max(state.onTime, 0);
        repOnTime.innerText = onTime > 0 ? `${onTime} –±–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–µ–∫` : '–í—Å–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã';
    }

    const repOverdue = document.getElementById('rep-overdue');
    if (repOverdue) repOverdue.innerText = state.total;

    const repDelay = document.getElementById('rep-delay');
    if (repDelay) repDelay.innerText = state.total ? `–ú–∞–∫—Å ${state.worst} –¥–Ω. ¬∑ –°—Ä ${state.avg} –¥–Ω.` : '–ü—Ä–æ—Å—Ä–æ—á–µ–∫ –Ω–µ—Ç';

    const tipsEl = document.getElementById('reputation-tips');
    if (tipsEl) {
        tipsEl.innerHTML = state.tips.map(tip => `
            <div class="rep-tip">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3v4"/><path d="M6.5 7.5l2.5 2.5"/><path d="M17.5 7.5L15 10"/><path d="M12 17v4"/><path d="M6 13l-2 2"/><path d="M18 13l2 2"/><circle cx="12" cy="12" r="4"/>
                </svg>
                <span>${tip}</span>
            </div>
        `).join('');
    }

    updatePaceReputation(state);

    const repOnTimePill = document.getElementById('rep-on-time-pill');
    if (repOnTimePill) repOnTimePill.innerText = Math.max(state.onTime, 0);

    const repNearPill = document.getElementById('rep-near-pill');
    if (repNearPill) repNearPill.innerText = state.nearDeadline;

    const repOverduePill = document.getElementById('rep-overdue-pill');
    if (repOverduePill) repOverduePill.innerText = state.total;

    const repChartEl = document.getElementById('reputationChart');
    if (repChartEl) {
        if (chRep) chRep.destroy();
        const onTimeVal = Math.max(state.onTime, 0);
        const nearVal = state.nearDeadline;
        const overdueVal = state.total;
        const totalVal = onTimeVal + nearVal + overdueVal;
        const hasData = totalVal > 0;
        const labels = hasData ? ['–í —Å—Ä–æ–∫', '–ù–∞ –≥—Ä–∞–Ω–∏', '–ü—Ä–æ—Å—Ä–æ—á–∫–∏'] : ['–†–µ–ø—É—Ç–∞—Ü–∏—è'];
        const data = hasData ? [onTimeVal, nearVal, overdueVal] : [1];
        const colors = hasData ? ['#2ea043', '#d29922', '#f85149'] : ['#2ea043'];
        chRep = new Chart(repChartEl.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '72%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${hasData ? ctx.parsed : 0}`
                        }
                    },
                    repCenterText: {
                        text: `${state.score} / 100`,
                        subText: state.level === 'good' ? '–î–æ–≤–µ—Ä–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ' : '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è'
                    }
                }
            },
            plugins: [repCenterText]
        });
    }
}

function updatePaceReputation(state){
    const chip = document.getElementById('pace-rep-chip');
    const text = document.getElementById('pace-rep-text');
    const dot = document.getElementById('pace-rep-dot');

    if (chip) {
        chip.classList.remove('good', 'warn', 'bad');
        chip.classList.add(state.level);
    }

    if (text) text.innerText = `${state.score} / 100`;
    if (dot) dot.className = `rep-dot ${state.level}`;
}

function scrollToReputation(){
    const card = document.getElementById('reputation-card');
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function getScopedDataForStats() {
    return {
        active: DATA.active,
        archive: DATA.archive,
        paused: DATA.paused,
        waiting: DATA.waiting,
        potential: DATA.potential,
    };
}

function calcStats(){
    const scope = getScopedDataForStats();
    const goal = toNumeric(DATA.monthlyGoals[currentMonth]) || 250000;
    let fact = 0, activeFact = 0, plan = 0, totalGross = 0, totalNet = 0;
    let totalExpenses = 0, totalTaxes = 0, totalPaidGross = 0;

    ['active','archive','paused','waiting','potential'].forEach(type => {
        scope[type].forEach(i => {
            totalExpenses += calcContractorAmount(i);
            totalTaxes += toNumeric(i.p) * ((toNumeric(i.taxPrc) || 0) / 100);
        });
    });

    const archiveThisMonth = scope.archive.filter(i=>(i.date||'').startsWith(currentMonth));
    archiveThisMonth.forEach(i => {
        const net = calcNet(i);
        fact += net;
        totalGross += toNumeric(i.p);
        totalNet += net;
        totalPaidGross += toNumeric(i.p);
    });

    scope.active.forEach(i => {
        const net = calcNet(i);
        const gross = toNumeric(i.p);
        const paidPrc = (toNumeric(i.paid)||0)/100;
        const paidGross = gross * paidPrc;
        activeFact += net * paidPrc;
        plan += net * (1 - paidPrc);
        totalGross += gross;
        totalNet += net;
        totalPaidGross += paidGross;
    });

    scope.paused.forEach(i => plan += calcNet(i));
    scope.waiting.forEach(i => plan += calcNet(i));
    scope.potential.forEach(i => plan += calcNet(i));

    const totalFact = fact + activeFact;
    const forecast = totalFact + plan;
    
    const totalMargin = totalNet;
    const totalGrossCombined = totalGross;
    const goalProgress = goal ? Math.round((totalFact/goal)*100) : 0;

    document.getElementById('val-fact').innerText = formatCurrency(totalFact);
    document.getElementById('val-fact-prc').innerText = `${goalProgress}% –æ—Ç —Ü–µ–ª–∏`;
    document.getElementById('val-active-fact').innerText = formatCurrency(activeFact);
    document.getElementById('val-margin').innerText = formatCurrency(totalMargin);
    document.getElementById('val-margin-prc').innerText = `${totalGrossCombined > 0 ? Math.round((totalMargin/totalGrossCombined)*100) : 0}%`;
    document.getElementById('val-plan').innerText = formatCurrency(plan);
    document.getElementById('val-total').innerText = formatCurrency(forecast);
    document.getElementById('val-expenses').innerText = formatCurrency(totalExpenses);
    document.getElementById('val-taxes').innerText = formatCurrency(totalTaxes);
    document.getElementById('val-paid-gross').innerText = formatCurrency(totalPaidGross);
    document.getElementById('goal-text').innerText = `${formatCurrency(totalFact)} / ${formatCurrency(goal)}`;
    document.getElementById('goal-pill').innerText = `–¶–µ–ª—å: ${formatCurrency(goal)}`;

    const record = DATA.settings.record || 0;
    const recordProgress = record > 0 ? Math.min(100, (totalFact/record)*100) : 0;
    const recordRemaining = Math.max(0, record - totalFact);
    let motivText = '–û–±–Ω–æ–≤–∏–º —Ü–∏—Ñ—Ä—ã!';
    if (!record) motivText = '–ó–∞–¥–∞–π —Ü–µ–ª—å –∏ –∑–∞–±–µ—Ä–∏ —Ä–µ–∫–æ—Ä–¥.';
    else if (recordRemaining <= 0) motivText = '–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å.';
    else if (recordProgress >= 70) motivText = '–ß—É—Ç—å-—á—É—Ç—å –¥–æ —Ä–µ–∫–æ—Ä–¥–∞!';
    else motivText = '–î–≤–∏–∂–µ–º—Å—è –∫ —Ä–µ–∫–æ—Ä–¥—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.';

    document.getElementById('record-motiv').innerText = motivText;
    document.getElementById('record-remaining').innerText = record ? (recordRemaining > 0 ? `–î–æ —Ä–µ–∫–æ—Ä–¥–∞ ${formatCurrency(recordRemaining)}` : '–†–µ–∫–æ—Ä–¥ –ø–æ–±–∏—Ç!') : '–ó–∞–¥–∞–π—Ç–µ —Ä–µ–∫–æ—Ä–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö';
    document.getElementById('record-amount').innerText = formatCurrency(record);
    document.getElementById('record-progress').style.width = record ? Math.min(100, (totalFact/record)*100) + '%' : '0%';

    document.getElementById('p-bar').style.width = goal > 0 ? Math.min(100, (totalFact/goal)*100) + '%' : '0%';
    document.getElementById('dash-month-name').innerText = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex]?.text || '';
    const scopeNote = '–°—Ä–µ–∑: –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã';
    const scopeHint = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏';
    const scopeEl = document.getElementById('stat-scope-note');
    if (scopeEl) {
        scopeEl.innerText = scopeNote;
        scopeEl.title = scopeHint;
    }
    updateReputationUI();
    updateCharts(totalFact, plan, scope);
}

let chL = null, chP = null, chB = null, chRep = null;
function updateCharts(fact, plan, scope){
    const ctxL = document.getElementById('lineChart').getContext('2d');
    const ctxP = document.getElementById('pieChart').getContext('2d');
    const ctxB = document.getElementById('barChart').getContext('2d');
    const daysInM = new Date(currentMonth.split('-')[0], currentMonth.split('-')[1], 0).getDate();
    const labelsL = Array.from({length:daysInM},(_,i)=>i+1);

    const dataL = new Array(daysInM).fill(0);

    scope.archive.filter(i=>(i.date||'').startsWith(currentMonth)).forEach(i => {
        const d = parseInt(i.date.split('-')[2]) - 1;
        if(d>=0 && d<daysInM) dataL[d] += calcNet(i);
    });
    
    let acc = 0; 
    const dataAcc = dataL.map(v => acc+=v);
    
    if(chL) chL.destroy();
    chL = new Chart(ctxL, {
        type: 'line',
        data: { labels: labelsL, datasets: [{label:'–§–∞–∫—Ç', data:dataAcc, borderColor:'#2ea043', backgroundColor:'rgba(46,160,67,0.1)', fill:true, tension:0.3, pointRadius:0}] },
        options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#30363d'}}}}
    });
    
    if(chP) chP.destroy();
    chP = new Chart(ctxP, {
        type: 'doughnut',
        data: { labels: ['–§–∞–∫—Ç (–û–ø–ª–∞—á–µ–Ω–æ)', '–ü–ª–∞–Ω (–û—Å—Ç–∞—Ç–æ–∫/–õ–∏–¥—ã)'], datasets: [{data:[fact, plan], backgroundColor:['#2ea043','#d29922'], borderWidth:0}] },
        options: {responsive:true, maintainAspectRatio:false, cutout:'75%', plugins:{legend:{position:'bottom', labels:{color:'#8b949e'}}}}
    });
    
    const h = {};
    scope.archive.forEach(i => { const m = (i.date||'').slice(0,7); if(m) h[m] = (h[m]||0) + calcNet(i); });
    const allMonths = Object.keys(h);
    allMonths.sort();
    const keys = allMonths.slice(-6); 

    if(chB) chB.destroy();
    chB = new Chart(ctxB, {
        type: 'bar',
        data: { labels: keys.map(m => new Date(m + '-01').toLocaleString('ru', {month:'short'})), datasets: [{data: keys.map(k=>h[k]), backgroundColor: keys.map(k=>k===currentMonth?'#58a6ff':'#21262d'), borderRadius:4}] },
        options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{display:false, ticks:{beginAtZero:true}}}}
    });
}

function exp(){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([localStorage.getItem(K)],{type:'application/json'}));
  a.download=`DesignFlow-Backup-${today}.json`;
  a.click();
}
function expCSV(){
    const escape = v => `"${(v || '').toString().replace(/"/g, '""')}"`;
    let csv = ['–°—Ç–∞—Ç—É—Å', '–ö–ª–∏–µ–Ω—Ç', '–ü—Ä–æ–µ–∫—Ç', '–°—É–º–º–∞', '–ß–∏—Å—Ç—ã–º–∏', '–û–ø–ª–∞—á–µ–Ω–æ (%)', '–ù–∞–ª–æ–≥ (%)', '–†–∞—Å—Ö–æ–¥—ã', '–î–∞—Ç–∞ –°—Ç–∞—Ä—Ç–∞', '–î–µ–¥–ª–∞–π–Ω/–°–¥–∞—á–∏', '–°—Å—ã–ª–∫–∞'].map(escape).join(';') + '\n';
    const addRows = (list, status) => list.forEach(i => csv += [status, i.c, i.n, i.p, calcNet(i), i.paid||0, i.taxPrc||0, calcContractorAmount(i), i.start||'', i.dl||i.date||'', i.link||''].map(escape).join(';') + '\n');
    addRows(DATA.active, '–í —Ä–∞–±–æ—Ç–µ'); addRows(DATA.waiting, '–û–∂–∏–¥–∞–µ—Ç'); addRows(DATA.potential, '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª');
    addRows(DATA.paused, '–ù–∞ –ø–∞—É–∑–µ'); addRows(DATA.archive, '–í—ã–ø–æ–ª–Ω–µ–Ω–æ');
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `DesignFlow-Export-${today}.csv`; a.click();
}
function imp(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=e=>{ localStorage.setItem(K,e.target.result); location.reload(); };
  r.readAsText(f);
}

window.onload = init;
</script>
</body>
</html>
