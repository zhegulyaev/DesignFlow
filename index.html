<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DesignFlow ‚Äî –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</title>

<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' ry='6' fill='%230d1117'/%3E%3Cpath d='M11 2 L5 14 H10 L9 22 L19 8 H13 L14 2 Z' fill='%23facc15'/%3E%3C/svg%3E">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <link rel="stylesheet" href="style.css">

</head>
<body>

<div class="toast" id="toast">
    <div class="toast-message" id="toast-message"></div>
    <button class="toast-action" id="toast-action" style="display:none"></button>
    <button class="toast-close" onclick="hideToast()">√ó</button>
</div>

<svg style="display: none;">
    <symbol id="icon-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4.5a1 1 0 0 1-1-1V2a1 1 0 1 1 2 0v1.5a1 1 0 0 1-1 1Zm0 17a1 1 0 0 1-1 1V24a1 1 0 1 1 2 0v-1.5a1 1 0 0 1-1-1Zm7.424-14.924a1 1 0 0 1 0-1.414l1.06-1.06a1 1 0 1 1 1.415 1.414l-1.06 1.06a1 1 0 0 1-1.415 0ZM2.1 20.4a1 1 0 0 1 0-1.415l1.06-1.06a1 1 0 1 1 1.414 1.414l-1.06 1.061A1 1 0 0 1 2.1 20.4Zm19.8-1.414a1 1 0 0 1-1.415 0l-1.06-1.06a1 1 0 1 1 1.414-1.415l1.06 1.06a1 1 0 0 1 0 1.415ZM2.1 3.6a1 1 0 0 1 1.414 0l1.06 1.06A1 1 0 0 1 3.16 6.074L2.1 5.014A1 1 0 0 1 2.1 3.6ZM4.5 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h1.5a1 1 0 0 1 1 1Zm18 0a1 1 0 0 1-1 1H20a1 1 0 1 1 0-2h1.5a1 1 0 0 1 1 1Zm-7 0a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0Z"/></symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M21.74 15.34a1 1 0 0 0-1.11-.27A7.5 7.5 0 0 1 9.06 4.5a1 1 0 0 0-.76-1.2a9 9 0 1 0 13.44 12.36Z"/></symbol>
    <symbol id="icon-pen" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="m5 15.5 9.9-9.9a1.8 1.8 0 0 1 2.55 0l1.95 1.95a1.8 1.8 0 0 1 0 2.55L9.5 20H4v-5.5Z"/><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M14 6l4 4"/></symbol>
    <symbol id="icon-check" viewBox="0 0 20 20"><path fill="currentColor" d="m16.707 6.293-7.25 7.25a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L8.5 11.672l6.543-6.543a1 1 0 0 1 1.414 1.164a.99.99 0 0 1-.25.293Z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" d="M4 7.5h10.5M4 12h12M4 16.5h10.5"/>
      <circle cx="16.5" cy="7.5" r="1.8" fill="none" stroke="currentColor" stroke-width="1.7"/>
      <circle cx="9" cy="12" r="1.8" fill="none" stroke="currentColor" stroke-width="1.7"/>
      <circle cx="15" cy="16.5" r="1.8" fill="none" stroke="currentColor" stroke-width="1.7"/>
    </symbol>
    <symbol id="icon-grid" viewBox="0 0 24 24"><path fill="currentColor" d="M5 4a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1Zm9 0a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1Zm-9 9a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1Zm9 0a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1Z"/></symbol>
    <symbol id="icon-grip" viewBox="0 0 24 24"><path fill="currentColor" d="M10 5a1 1 0 0 1-1 1H7a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1Zm7-1h-2a1 1 0 1 0 0 2h2a1 1 0 0 0 0-2Zm0 6h-2a1 1 0 1 0 0 2h2a1 1 0 0 0 0-2Zm0 6h-2a1 1 0 1 0 0 2h2a1 1 0 0 0 0-2Zm-8-4H7a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2Zm0 6H7a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2Zm0-12H7a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2Z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M6.34 4.93a1 1 0 0 0-1.41 1.41L10.59 12l-5.66 5.66a1 1 0 1 0 1.41 1.41L12 13.41l5.66 5.66a1 1 0 0 0 1.41-1.41L13.41 12l5.66-5.66a1 1 0 1 0-1.41-1.41L12 10.59Z"/></symbol>
    <symbol id="icon-hide" viewBox="0 0 24 24"><path fill="currentColor" d="M4.52 3.1a1 1 0 0 0-1.42 1.41l16 16a1 1 0 0 0 1.42-1.41l-2.03-2.03A11.3 11.3 0 0 0 21.89 12a11.29 11.29 0 0 0-3.67-4.91A9.3 9.3 0 0 0 12 5A9.4 9.4 0 0 0 8.6 5.6Zm5.58 5.58l2.11 2.1a2 2 0 0 0-2.1-2.1Zm-5.42-1.5A9.27 9.27 0 0 0 2.11 12a11.29 11.29 0 0 0 3.67 4.91A9.3 9.3 0 0 0 12 19a9.4 9.4 0 0 0 1.61-.14l-2.44-2.45A4 4 0 0 1 7.6 9.18Z"/></symbol>
    <symbol id="icon-active" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM3 8a5 5 0 0 1 10 0 5 5 0 0 1-10 0Z"/></symbol>
    <symbol id="icon-all" viewBox="0 0 16 16"><path fill="currentColor" d="M2.5 2.5A.5.5 0 0 1 3 2h4.5a.5.5 0 0 1 .5.5V7a.5.5 0 0 1-.5.5H3A.5.5 0 0 1 2.5 7Zm6 0A.5.5 0 0 1 9 2h4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-.5.5H9a.5.5 0 0 1-.5-.5Zm-6 6A.5.5 0 0 1 3 8h4.5a.5.5 0 0 1 .5.5V13a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5Zm8 0A.5.5 0 0 1 11 8h2a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5Z"/></symbol>
    <symbol id="icon-waiting" viewBox="0 0 16 16"><path fill="currentColor" d="M8 1.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13Zm0 1.5a5 5 0 1 1 0 10a5 5 0 0 1 0-10Zm-.5 1.25c0-.276.224-.5.5-.5s.5.224.5.5v2.6l2 1.2a.5.5 0 1 1-.5.866l-2.25-1.35A.5.5 0 0 1 7.5 7V4.25Z"/></symbol>
    <symbol id="icon-potential" viewBox="0 0 16 16"><path fill="currentColor" d="M3 1.5A.5.5 0 0 1 3.5 1h7a.5.5 0 0 1 .4.8L9.6 4l1.3 2.2a.5.5 0 0 1-.43.8H5.5V14a.5.5 0 0 1-1 0z"/></symbol>
    <symbol id="icon-paused" viewBox="0 0 16 16"><path fill="currentColor" d="M5 2.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Zm6 0a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Z"/></symbol>
    <symbol id="icon-archive" viewBox="0 0 16 16"><path fill="currentColor" d="M13 1.75a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v12.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75Zm-1.5 8.75a.5.5 0 0 1-1 0V6.707L6.464 10.464a.5.5 0 0 1-.708-.708L10.793 6H7.5a.5.5 0 0 1 0-1h4.5a.5.5 0 0 1 .5.5v4.5Z"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 3.5 8 5H5.5a1 1 0 0 0 0 2h13a1 1 0 0 0 0-2H16l-1-1.5a1 1 0 0 0-.83-.45H9.83a1 1 0 0 0-.83.45Zm-2 5.5h10l-.6 9.01a1 1 0 0 1-1 .94H7.6a1 1 0 0 1-1-.94L6 9Z"/>
      <path fill="currentColor" d="M10 11a1 1 0 0 0-1 1v4a1 1 0 1 0 2 0v-4a1 1 0 0 0-1-1Zm4 0a1 1 0 0 0-1 1v4a1 1 0 1 0 2 0v-4a1 1 0 0 0-1-1Z"/>
    </symbol>
    <symbol id="icon-duplicate" viewBox="0 0 16 16"><path fill="currentColor" d="M2.25 1.75a.75.75 0 0 1 .75-.75h7.25a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0V2.5h-6.5v8h2a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1-.75-.75Zm4.5 4a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 .75.75v8a.75.75 0 0 1-.75.75h-6a.75.75 0 0 1-.75-.75v-8Z"/></symbol>
    <symbol id="icon-link" viewBox="0 0 24 24"><path fill="currentColor" d="M13.06 3.94a5.5 5.5 0 0 1 7.78 7.78l-2.12 2.12a5.5 5.5 0 0 1-7.78 0a1 1 0 0 1 1.42-1.42a3.5 3.5 0 0 0 4.94 0l2.12-2.12a3.5 3.5 0 0 0-4.94-4.94l-.88.88a1 1 0 1 1-1.42-1.42Zm-6.72 6.72a5.5 5.5 0 0 1 7.78 0a1 1 0 1 1-1.42 1.42a3.5 3.5 0 0 0-4.94 0l-2.12 2.12a3.5 3.5 0 0 0 4.94 4.94l.88-.88a1 1 0 0 1 1.42 1.42l-.88.88a5.5 5.5 0 0 1-7.78-7.78Z"/></symbol>
    <symbol id="icon-external" viewBox="0 0 24 24"><path fill="currentColor" d="M14 4a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v5a1 1 0 1 1-2 0V6.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L17.586 5H15a1 1 0 0 1-1-1Z"/><path fill="currentColor" d="M5 6a1 1 0 0 1 1-1h5a1 1 0 1 1 0 2H7v10h10v-4a1 1 0 1 1 2 0v5a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1Z"/></symbol>
    <symbol id="icon-calendar-off" viewBox="0 0 24 24"><path fill="currentColor" d="M7 2a1 1 0 0 0-1 1v1H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-1V3a1 1 0 1 0-2 0v1H8V3a1 1 0 0 0-1-1Zm12 6v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V8h14Z"/><path fill="currentColor" d="M9.7 10.3a1 1 0 0 0-1.4 1.4L10.6 14l-2.3 2.3a1 1 0 0 0 1.4 1.4L12 15.4l2.3 2.3a1 1 0 0 0 1.4-1.4L13.4 14l2.3-2.3a1 1 0 1 0-1.4-1.4L12 12.6Z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 16 16"><path fill="currentColor" d="M3 2.75A.75.75 0 0 1 3.75 2h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 2.75ZM12.25 2a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5c0-.414.336-.75.75-.75ZM2 5.5a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 5.5Zm12.5 2.25v7.25c0 .414-.336.75-.75.75H2.25a.75.75 0 0 1-.75-.75V7.75c0-.414.336-.75.75-.75h11.5c.414 0 .75.336.75.75Z"/></symbol>
    <symbol id="icon-clock" viewBox="0 0 16 16"><path fill="currentColor" d="M8 1.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13Zm0 1.5a5 5 0 1 1 0 10a5 5 0 0 1 0-10Zm-.5 1.25c0-.276.224-.5.5-.5s.5.224.5.5v2.6l2 1.2a.5.5 0 1 1-.5.866l-2.25-1.35A.5.5 0 0 1 7.5 7V4.25Z"/></symbol>
    <symbol id="icon-undo" viewBox="0 0 20 20"><path fill="currentColor" d="M9.5 3a7.5 7.5 0 1 1-5.303 12.803a.75.75 0 0 1 1.06-1.061A6 6 0 1 0 7 5.233V7.5a.75.75 0 0 1-1.28.53l-3-3a.75.75 0 0 1 0-1.06l3-3A.75.75 0 0 1 7 1.97V4.2A7.47 7.47 0 0 1 9.5 3Z"/></symbol>
    <symbol id="icon-arrow-right" viewBox="0 0 24 24"><path fill="currentColor" d="M5 12a1 1 0 0 1 1-1h9.586l-3.293-3.293a1 1 0 1 1 1.414-1.414l5 5a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414-1.414L15.586 13H6a1 1 0 0 1-1-1Z"/></symbol>
    <symbol id="icon-upload" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3a1 1 0 0 1 .707.293l4 4a1 1 0 0 1-1.414 1.414L13 6.414V16a1 1 0 1 1-2 0V6.414L8.707 8.707A1 1 0 0 1 7.293 7.293l4-4A1 1 0 0 1 12 3Z"/><path fill="currentColor" d="M5 15a1 1 0 0 1 1 1v3h12v-3a1 1 0 1 1 2 0v3a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-3a1 1 0 0 1 1-1Z"/></symbol>
    <symbol id="icon-table" viewBox="0 0 24 24"><path fill="currentColor" d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm0 2v3h14V6H5Zm0 5v7h14v-7H5Zm4 2h2v3H9v-3Zm6 0h2v3h-2v-3Z"/></symbol>
    <symbol id="icon-download" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17a1 1 0 0 1-.707-.293l-4-4a1 1 0 0 1 1.414-1.414L11 13.586V4a1 1 0 1 1 2 0v9.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4A1 1 0 0 1 12 17Z"/><path fill="currentColor" d="M5 18a1 1 0 0 1 1 1v2h12v-2a1 1 0 1 1 2 0v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2a1 1 0 0 1 1-1Z"/></symbol>
    <symbol id="icon-alert" viewBox="0 0 24 24"><path fill="currentColor" d="M12.867 3.499a1 1 0 0 0-1.734 0l-8 14A1 1 0 0 0 4 19.5h16a1 1 0 0 0 .867-1.501l-8-14ZM12 8a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0V9a1 1 0 0 1 1-1Zm0 9a1.25 1.25 0 1 1 0-2.5a1.25 1.25 0 0 1 0 2.5Z"/></symbol>
    <symbol id="icon-info" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm0 4.75a1.25 1.25 0 1 1 0 2.5a1.25 1.25 0 0 1 0-2.5Zm-1.25 4a1 1 0 0 1 1-1h.5a1 1 0 0 1 1 1v6.5a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1Z"/></symbol>
    <symbol id="icon-csv" viewBox="0 0 24 24"><path fill="currentColor" d="M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9.414a2 2 0 0 0-.586-1.414l-4.414-4.414A2 2 0 0 0 14.586 3ZM5 5h9v4a2 2 0 0 0 2 2h4v8H5Zm11 0.414L18.586 8H16Z"/><path fill="currentColor" d="M7.5 13c-1.105 0-1.9.726-1.9 1.75S6.41 16.5 7.5 16.5c.57 0 1.06-.18 1.43-.51a.75.75 0 0 0-.99-1.12c-.12.1-.25.13-.44.13-.37 0-.65-.24-.65-.75s.28-.75.65-.75c.17 0 .31.04.44.14a.75.75 0 0 0 .99-1.12c-.37-.33-.86-.48-1.43-.48Zm2.43.1a.75.75 0 0 0-.57.9l.6 2.4a.75.75 0 1 0 1.46-.36l-.6-2.4a.75.75 0 0 0-.89-.54Zm3.93 0c-.62 0-1.07.29-1.31.66a1.6 1.6 0 0 0-.25.82c0 .36.12.67.31.93a1.88 1.88 0 0 0 1.53.79c.59 0 1.05-.17 1.39-.5a.75.75 0 1 0-1.02-1.09c-.08.08-.2.14-.38.14-.23 0-.44-.16-.44-.32c0-.12.03-.2.08-.26c.07-.1.19-.17.36-.17c.16 0 .26.04.35.12c.3.26.82.24 1.06-.1c.27-.35.1-.8-.1-1.02c-.27-.29-.7-.5-1.38-.5Z"/></symbol>
    <symbol id="icon-arrow-up" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5a1 1 0 0 1 .707.293l5 5a1 1 0 0 1-1.414 1.414L13 8.414V19a1 1 0 1 1-2 0V8.414l-3.293 3.293A1 1 0 0 1 6.293 10.293l5-5A1 1 0 0 1 12 5Z"/></symbol>
    <symbol id="icon-arrow-down" viewBox="0 0 24 24"><path fill="currentColor" d="M12 19a1 1 0 0 1-.707-.293l-5-5a1 1 0 0 1 1.414-1.414L11 15.586V5a1 1 0 1 1 2 0v10.586l3.293-3.293a1 1 0 0 1 1.414 1.414l-5 5A1 1 0 0 1 12 19Z"/></symbol>
</svg>

<div class="c">
  
  <div class="header-row">
    <div class="brand-wrap">
      <div class="brand-logo" aria-hidden="true">‚ö°</div>
      <div class="brand-text">
        <div class="brand-title">DesignFlow <span class="brand-version">BETA</span></div>
        <div class="brand-sub">–¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –±—é–¥–∂–µ—Ç–∞</div>
      </div>
    </div>
    <div style="display:flex;gap:15px;align-items:center">


          <style>
      .header-btn {
  position: relative; /* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–π–¥–∂–∏–∫–∞ */
  padding-right: 40px; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ —Å–ø—Ä–∞–≤–∞ –¥–ª—è –±–µ–π–¥–∂–∏–∫–∞ */
}

/* –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π —Å–∏–Ω–∏–π –±–µ–π–¥–∂–∏–∫ "New" */
.header-new-badge {
  position: absolute;
  top: -8px;
  right: -12px;
  background: var(--accent); /* –°–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç –∏–∑ —Ç–≤–æ–µ–π —Ç–µ–º—ã */
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 8px; /* –ó–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ —É–≥–ª—ã ‚Äî –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ */
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  pointer-events: none;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: background 0.3s;
}

/* –í —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ ‚Äî –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–∏–Ω–∏–π */
body:not([data-theme="dark"]) .header-new-badge {
  background: #3b82f6;
}

/* –•–æ–≤–µ—Ä ‚Äî —á—É—Ç—å —è—Ä—á–µ */
.header-btn:hover .header-new-badge {
  background: var(--accent-hover, #6a4bff);
}
</style>





<!-- –ö–Ω–æ–ø–∫–∞ "–¢—Ä–µ–∫–µ—Ä —Ü–µ–ª–µ–π" —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–º —Å–∏–Ω–∏–º –±–µ–π–¥–∂–∏–∫–æ–º "New" -->
<button class="header-btn" onclick="window.location.href='Goal.html'" title="–¢—Ä–µ–∫–µ—Ä —Ü–µ–ª–µ–π">
  <i class="fa-solid fa-bullseye"></i>
  <span class="header-btn-text">–¢—Ä–µ–∫–µ—Ä —Ü–µ–ª–µ–π</span>
  <!-- –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π –±–µ–π–¥–∂–∏–∫ "New" -->
  <span class="header-new-badge">New</span>
</button>
          
          
        <button onclick="openSettings()" id="openSettingsBtn">
            <svg class="btn-icon lg"><use href="#icon-settings"/></svg>
            <span class="btn-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </button>
        <select id="monthSelect" class="month-select" onchange="changeMonth(this.value)"></select>
    </div>
  </div>


<div class="top-panel">
  <div class="backup-alert">
      <div class="backup-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
      </div>
      <div class="backup-info">
          <div class="backup-title"><b>–í–∞–∂–Ω–æ:</b> –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</div>
          <div class="backup-sub">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ –∏–ª–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.</div>
      </div>
  </div>

  <div class="btns">
    <button class="btn-outline" onclick="exp()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      <span>–°–∫–∞—á–∞—Ç—å –±–∞–∑—É</span>
    </button>

    <button class="btn-outline" onclick="document.getElementById('importFile').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ JSON">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
      <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É</span>
    </button>

    <input type="file" id="importFile" style="display:none" onchange="imp(this.files[0])">
  </div>
</div>

  <div class="tabs-container">
    <div class="tabs">
        <div class="tab" id="tab-all" onclick="switchTab('all')"><svg><use href="#icon-all"/></svg> –í—Å–µ <span class="tab-count" id="count-all">0</span></div>
        <div class="tab active" id="tab-active" onclick="switchTab('active')"><svg><use href="#icon-active"/></svg> –í —Ä–∞–±–æ—Ç–µ <span class="tab-count" id="count-active">0</span></div>
        <div class="tab" id="tab-waiting" onclick="switchTab('waiting')"><svg><use href="#icon-waiting"/></svg> –û–∂–∏–¥–∞–µ—Ç <span class="tab-count" id="count-waiting">0</span></div>
        <div class="tab" id="tab-potential" onclick="switchTab('potential')"><svg><use href="#icon-potential"/></svg> –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª <span class="tab-count" id="count-potential">0</span></div>
        <div class="tab" id="tab-requests" onclick="switchTab('requests')"><svg><use href="#icon-all"/></svg> –ó–∞—è–≤–∫–∏ <span class="tab-count" id="count-requests">0</span></div>
        <div class="tab" id="tab-paused" onclick="switchTab('paused')"><svg><use href="#icon-paused"/></svg> –ù–∞ –ø–∞—É–∑–µ <span class="tab-count" id="count-paused">0</span></div>
        <div class="tab" id="tab-archive" onclick="switchTab('archive')"><svg><use href="#icon-archive"/></svg> –í—ã–ø–æ–ª–Ω–µ–Ω–æ <span class="tab-count" id="count-archive">0</span></div>
        <div class="tab tab-trash" id="tab-trash" onclick="switchTab('trash')"><svg><use href="#icon-trash"/></svg> –ö–æ—Ä–∑–∏–Ω–∞ <span class="tab-count" id="count-trash">0</span></div>
    </div>
    <button id="newProjectButton" onclick="openAddModal()">Ôºã –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
  </div>
  
  <div class="tab-desc-block" id="tab-description">–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É.</div>

<div class="pace-block" id="pace-indicator" style="display:none;" data-editable data-block-key="pace">
      <div class="pace-layout">
          <div class="pace-main">
              <div class="pace-icon-box">
                  <div id="pace-icon">üî•</div>
              </div>
              <div class="pace-info">
                  <div class="pace-label">–¢–µ–º–ø –Ω–µ–¥–µ–ª–∏</div>
                  <div class="pace-title-row">
                      <div class="pace-title" id="pace-title">–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!</div>
                      <div class="pace-status pace-hurry" id="pace-status">–ö—Ä–∏—Ç–∏—á–Ω–æ</div>
                  </div>
                  <div class="pace-desc" id="pace-desc">–ì–æ—Ä–∏—Ç –¥–µ–¥–ª–∞–π–Ω–æ–≤: 2. –ü–æ–¥–Ω–∞–∂–º–∏!</div>
              </div>
          </div>
          
          <div class="pace-side">
              <div class="pace-mini-stat">
                  <div class="pace-rep-val">
                      <span class="rep-dot good" id="pace-rep-dot"></span>
                      <span id="pace-rep-text">100 / 100</span>
                  </div>
                  <div class="pace-rep-sub" id="pace-rep-caption">–î–æ–≤–µ—Ä–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ</div>
                  <div id="pace-rep-chip" style="display:none"></div> 
              </div>
              <div class="pace-btn-wrap">
                  <button id="pace-details-btn" onclick="scrollToReputation()" title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17L17 7"/><path d="M7 7h10v10"/></svg>
                  </button>
              </div>
          </div>
      </div>
  </div>

  <div class="main-layout">
    
    <div id="view-active">
      <div class="table-wrap">
        <table id="t-active">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="18%" data-type="active" data-key="c" onclick="sortData('active', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="19%" data-type="active" data-key="n" onclick="sortData('active', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="start" onclick="sortData('active', 'start', 'date')">–°—Ç–∞—Ä—Ç <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="dl" onclick="sortData('active', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω <span class="sort-icon"></span></th>
              <th width="6%" data-type="active" data-key="rem" onclick="sortData('active', 'rem', 'number')">–û—Å—Ç–∞–ª–æ—Å—å <span class="sort-icon"></span></th>
              <th width="4%" data-type="active" data-key="taxPrc" onclick="sortData('active', 'taxPrc', 'number')">–ù–∞–ª–æ–≥ % <span class="sort-icon"></span></th>
              <th width="6%" data-type="active" data-key="contractor" onclick="sortData('active', 'contractor', 'number')" style="text-align:right;">–†–∞—Å—Ö–æ–¥—ã <span class="sort-icon"></span></th>
              <th width="10%" data-type="active" data-key="p" onclick="sortData('active', 'p', 'number')" style="text-align:right;">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="8%" style="text-align:right;">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="4%" style="text-align:right;">–û–ø–ª–∞—á–µ–Ω–æ</th>
              <th width="4%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-active">
            <tr><td colspan="8">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="view-waiting" style="display:none">
        <div class="table-wrap">
          <table id="t-waiting">
            <thead>
              <tr>
                <th class="select-col">‚Ññ</th>
              <th width="20%" data-type="waiting" data-key="c" onclick="sortData('waiting', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="30%" data-type="waiting" data-key="n" onclick="sortData('waiting', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="18%" data-type="waiting" data-key="p" onclick="sortData('waiting', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="22%"></th>
            </tr>
          </thead>
          <tbody></tbody>
            <tfoot id="total-row-waiting"><tr><td colspan="3">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
          </table>
        </div>
    </div>
    
    <div id="view-potential" style="display:none">
        <div class="table-wrap">
          <table id="t-potential">
            <thead>
              <tr>
                <th class="select-col">‚Ññ</th>
              <th width="25%" data-type="potential" data-key="c" onclick="sortData('potential', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="40%" data-type="potential" data-key="n" onclick="sortData('potential', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="15%" data-type="potential" data-key="p" onclick="sortData('potential', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="20%"></th>
              </tr>
            </thead>
            <tbody></tbody>
          <tfoot id="total-row-potential"><tr><td colspan="3">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-requests" style="display:none">
      <div class="table-wrap">
        <div class="row-inputs requests-row" style="padding: 15px; gap: 10px;">
            <div class="inp-group" style="flex:1">
                <label>–ö—Ç–æ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è</label>
                <input type="text" id="req-name" placeholder="–ò–º—è –∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è">
            </div>
            <div class="inp-group" style="flex:1">
                <label>–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                <input type="text" id="req-source" placeholder="–¢–µ–ª–µ–≥—Ä–∞–º, —Å–∞–π—Ç, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è">
            </div>
            <div class="inp-group" style="flex:1">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" id="req-note" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å">
            </div>
            <div class="inp-group" style="flex:1">
                <label>–°—Å—ã–ª–∫–∞</label>
                <input type="text" id="req-link" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –¢–ó –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å">
            </div>
            <div class="inp-group" style="flex:0 0 140px">
                <label>–ë—é–¥–∂–µ—Ç</label>
                <input type="text" id="req-budget" placeholder="0" oninput="formatNumberInput(this)">
            </div>
            <button class="save-stg request-add-btn" onclick="addRequest()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <table id="t-requests">
            <thead>
                <tr>
                    <th class="select-col">‚Ññ</th>
                    <th width="17%">–ö–ª–∏–µ–Ω—Ç</th>
                    <th width="17%">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th width="30%">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th width="12%">–°—Å—ã–ª–∫–∞</th>
                    <th width="12%">–ë—é–¥–∂–µ—Ç</th>
                    <th width="12%">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="total-row-requests"><tr><td colspan="5">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-paused" style="display:none">
      <div class="table-wrap">
        <table id="t-paused">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="20%" data-type="paused" data-key="c" onclick="sortData('paused', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="30%" data-type="paused" data-key="n" onclick="sortData('paused', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="15%" data-type="paused" data-key="dl" onclick="sortData('paused', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω <span class="sort-icon"></span></th>
              <th width="15%" data-type="paused" data-key="p" onclick="sortData('paused', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="15%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-paused"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-archive" style="display:none">
      <div class="table-wrap">
        <table id="t-archive">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="16%" data-type="archive" data-key="c" onclick="sortData('archive', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon"></span></th>
              <th width="28%" data-type="archive" data-key="n" onclick="sortData('archive', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon"></span></th>
              <th width="12%" data-type="archive" data-key="date" onclick="sortData('archive', 'date', 'date')">–î–µ–¥–ª–∞–π–Ω / —Å–¥–∞—á–∞ <span class="sort-icon"></span></th>
              <th width="10%" data-type="archive" data-key="p" onclick="sortData('archive', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon"></span></th>
              <th width="10%" data-type="archive" data-key="contractor" onclick="sortData('archive', 'contractor', 'number')">–†–∞—Å—Ö–æ–¥—ã <span class="sort-icon"></span></th>
              <th width="10%">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="10%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-archive"><tr><td colspan="4">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-all" style="display:none">
      <div class="table-wrap">
        <table id="t-all">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="12%">–°—Ç–∞—Ç—É—Å</th>
              <th width="20%">–ö–ª–∏–µ–Ω—Ç</th>
              <th width="22%">–ü—Ä–æ–µ–∫—Ç</th>
              <th width="12%">–°—Ä–æ–∫</th>
              <th width="10%">–°—É–º–º–∞</th>
              <th width="10%">–†–∞—Å—Ö–æ–¥—ã</th>
              <th width="8%">–ù–∞–ª–æ–≥</th>
              <th width="10%">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="8%">–û–ø–ª–∞—á–µ–Ω–æ</th>
              <th width="6%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-all"><tr><td colspan="6">–ò—Ç–æ–≥–æ:</td><td></td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
    
    <div id="view-trash" style="display:none">
      <div class="table-wrap">
        <table id="t-trash">
          <thead>
            <tr>
              <th class="select-col">‚Ññ</th>
              <th width="20%">–£–¥–∞–ª–µ–Ω–æ</th>
              <th width="20%">–ö–ª–∏–µ–Ω—Ç</th>
              <th width="30%">–ü—Ä–æ–µ–∫—Ç</th>
              <th width="10%">–°—É–º–º–∞</th>
              <th width="10%">–ß–∏—Å—Ç—ã–º–∏</th>
              <th width="10%">–û–ø–ª–∞—á–µ–Ω–æ</th>
              <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-trash"><tr><td colspan="8">–ò—Ç–æ–≥–æ</td></tr></tfoot>
        </table>
      </div>
      <div class="trash-toolbar">
          <div style="color: var(--muted); font-size: 13px;">–û–±—ä–µ–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–¥–µ—Å—å 30 –¥–Ω–µ–π, –∑–∞—Ç–µ–º —É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞.</div>
          <button class="trash-clean-btn" onclick="clearTrashForever()">
              <svg class="btn-icon"><use href="#icon-trash"/></svg>
              <span class="btn-label">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</span>
          </button>
      </div>
    </div>
  </div>
  
  <div class="dashboard" id="analytics-dashboard">
    <div class="stats-full">
      <div class="stats-two-columns">
          <div class="stats-main" data-block-container="main">
              <div class="card">
              <div class="card-head">
                  <div>
                      <div class="finance-title">–§–∏–Ω–∞–Ω—Å—ã: <span class="text-green" id="dash-month-name">...</span></div>
                      <div class="finance-sub">–î–∞—à–±–æ—Ä–¥ –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –∏ –ø–ª–∞—Ç–µ–∂–∞–º</div>
                      <div class="stat-scope-note" id="stat-scope-note" title="–î–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º">–°—Ä–µ–∑: –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                  </div>
                  <div class="card-head-actions">
                      <div class="stat-pill" id="goal-pill">–¶–µ–ª—å: 0 ‚ÇΩ</div>
                      <button class="inline-link-btn" onclick="openGoalSettings()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  </div>
              </div>
              <div class="goal-wrap" id="goal-progress">
                  <div class="goal-info">
                      <span class="stat-label-with-help">–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ <span class="help-icon" data-tooltip="–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –∫ –º–µ—Å—è—á–Ω–æ–π —Ü–µ–ª–∏. –ó–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –æ–ø–ª–∞—Ç.">?</span></span>
                      <span id="goal-text">0 / 0 ‚ÇΩ</span>
                  </div>
                  <div class="progress-bg"><div class="progress-fill" id="p-bar"></div></div>
              </div>
              <div class="stats-grid">
                  <div class="stat-box" data-stat="fact" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–§–ê–ö–¢</span><span class="help-icon" data-tooltip="–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤.">?</span></div>
                          <div class="stat-pill">–ß–∏—Å—Ç—ã–º–∏</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-fact">0 ‚ÇΩ</div>
                      <div class="stat-helper" id="val-fact-prc">0%</div>
                  </div>
                  <div class="stat-box" data-stat="active-fact" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ü–û–õ–£–ß–ï–ù–û</span><span class="help-icon" data-tooltip="–ß–∏—Å—Ç–∞—è —Å—É–º–º–∞, —É–∂–µ –ø–æ—Å—Ç—É–ø–∏–≤—à–∞—è –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º –≤ —Ä–∞–±–æ—Ç–µ (—Å—Ç–∞—Ç—É—Å ‚Äò–í —Ä–∞–±–æ—Ç–µ‚Äô).">?</span></div>
                          <div class="stat-pill">–ß–∏—Å—Ç—ã–º–∏ (–≤ —Ä–∞–±–æ—Ç–µ)</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-active-fact">0 ‚ÇΩ</div>
                      <div class="stat-helper">–û–ø–ª–∞—á–µ–Ω–æ –≤ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö</div>
                  </div>
                  <div class="stat-box" data-stat="paid-gross" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–û–ü–õ–ê–ß–ï–ù–û</span><span class="help-icon" data-tooltip="–í—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –±–µ–∑ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–≥—Ä—è–∑–Ω—ã–º–∏).">?</span></div>
                          <div class="stat-pill">–í—Å–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
                      </div>
                      <div class="stat-val mono" id="val-paid-gross" style="color:var(--accent)">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–≥—Ä—è–∑–Ω—ã–º–∏)</div>
                  </div>
                  <div class="stat-box" data-stat="total-gross" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–û–ë–©–ê–Ø –°–£–ú–ú–ê</span><span class="help-icon" data-tooltip="–í—Å–µ –±—é–¥–∂–µ—Ç—ã –ø—Ä–æ–µ–∫—Ç–æ–≤ (–≥—Ä—è–∑–Ω—ã–º–∏) –≤–æ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö, –≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤ –∏ –ø–∞—É–∑—É.">?</span></div>
                          <div class="stat-pill">–ì—Ä—è–∑–Ω—ã–º–∏</div>
                      </div>
                      <div class="stat-val mono" id="val-total-gross" style="color:var(--accent)">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ë—é–¥–∂–µ—Ç—ã –ø–æ –≤—Å–µ–º —Å—Ç–∞—Ç—É—Å–∞–º</div>
                  </div>
                  <div class="stat-box" data-stat="plan" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ü–õ–ê–ù</span><span class="help-icon" data-tooltip="–°–∫–æ–ª—å–∫–æ –µ—â—ë –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –º–µ—Å—è—Ü–∞.">?</span></div>
                          <div class="stat-pill">–û—Å—Ç–∞—Ç–æ–∫ –¥–æ —Ü–µ–ª–∏</div>
                      </div>
                      <div class="stat-val text-gold mono" id="val-plan">0 ‚ÇΩ</div>
                      <div class="stat-helper">–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å</div>
                  </div>
                  <div class="stat-box" data-stat="forecast" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ü–†–û–ì–ù–û–ó –ò–¢–û–ì–ê</span><span class="help-icon" data-tooltip="–û—Ü–µ–Ω–∫–∞ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞: —Ç–µ–∫—É—â–∏–π —Ñ–∞–∫—Ç + –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º.">?</span></div>
                          <div class="stat-pill">–§–∞–∫—Ç + –æ–∂–∏–¥–∞–µ–º–æ–µ</div>
                      </div>
                      <div class="stat-val mono" id="val-total" style="color:var(--accent)">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ú–∞—Ä–∂–∞: <span id="val-margin">0 ‚ÇΩ</span> (<span id="val-margin-prc">0%</span>)</div>
                  </div>
                  <div class="stat-box" data-stat="expenses" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–†–ê–°–•–û–î–´</span><span class="help-icon" data-tooltip="–°–æ–≤–æ–∫—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º, –≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤ –∏ –ø–∞—É–∑—É.">?</span></div>
                          <div class="stat-pill">–ü–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º</div>
                      </div>
                      <div class="stat-val mono text-red" id="val-expenses">0 ‚ÇΩ</div>
                      <div class="stat-helper">–°—É–º–º–∞ –∑–∞—Ç—Ä–∞—Ç</div>
                  </div>
                  <div class="stat-box" data-stat="taxes" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">–ù–ê–õ–û–ì–ò</span><span class="help-icon" data-tooltip="–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–∞–≤–∫–∞–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.">?</span></div>
                          <div class="stat-pill">–ö —É–ø–ª–∞—Ç–µ</div>
                      </div>
                      <div class="stat-val mono" id="val-taxes">0 ‚ÇΩ</div>
                      <div class="stat-helper">–ü–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ç–∞–≤–∫–∞–º</div>
                  </div>
              </div>
              <div style="position:relative;height:250px;width:100%"><canvas id="lineChart"></canvas></div>
          </div>
              <div class="card top-clients-card" id="top-clients-card" data-editable data-block-key="topClients">
                <div class="top-clients-header">
                  <div>
                    <div class="top-clients-title">–¢–æ–ø 5 –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    <div class="top-clients-sub" id="top-clients-sub">–ú–∞—Ä–∂–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º, –∞—Ä—Ö–∏–≤–Ω—ã–º, –Ω–∞ –ø–∞—É–∑–µ –∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏</div>
                  </div>
                  <div class="top-clients-controls">
                    <button class="top-clients-mode-btn" id="top-clients-mode-btn" onclick="toggleTopClientsMode()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–∏–ø –ø—Ä–∏–±—ã–ª–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞">
                      <span class="top-clients-dot"></span>
                      <span id="top-clients-mode-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</span>
                    </button>
                  </div>
                </div>
                <div class="top-clients-chart"><canvas id="topClientsChart"></canvas></div>
              </div>
          </div>

          <div class="side-stack" data-block-container="side">
              
              <div class="eff-card-modern" id="efficiency-card" data-editable data-block-key="efficiency">
                  <div class="eff-header">
                      <div class="eff-title">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                          –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                      </div>
                      <div class="help-icon" data-tooltip="–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º.">?</div>
                  </div>
                  
                  <div class="eff-content-grid">
                      <div class="eff-chart-box">
                          <div class="eff-label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª vs –§–∞–∫—Ç</div>
                          <div class="eff-chart-canvas-wrap" style="height:180px;">
                              <canvas id="pieChart"></canvas>
                          </div>
                      </div>
                      
                      <div class="eff-chart-box">
                          <div class="eff-label">–î–∏–Ω–∞–º–∏–∫–∞ (6 –º–µ—Å)</div>
                          <div class="eff-chart-canvas-wrap" style="height:160px;">
                              <canvas id="barChart"></canvas>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="record-clean" id="record-banner" data-editable data-block-key="record">
                  <div class="rec-clean-header">
                      <div class="rec-clean-title">
                          <svg class="rec-clean-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                          –õ–∏—á–Ω—ã–π –†–µ–∫–æ—Ä–¥
                      </div>
                      <button type="button" class="rec-edit-link" onclick="openRecordSettings()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                  </div>

                  <div class="rec-clean-values">
                      <div class="rec-val-group">
                          <span class="rec-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ–π—á–∞—Å</span>
                          <span class="rec-current-val" id="rec-current-fact">0 ‚ÇΩ</span>
                      </div>
                      <div class="rec-val-group rec-goal-group">
                          <span class="rec-label">–¶–µ–ª—å (–†–µ–∫–æ—Ä–¥)</span>
                          <span class="rec-target-val" id="record-amount">0 ‚ÇΩ</span>
                      </div>
                  </div>
                  
                  <div class="rec-progress-track">
                      <div class="rec-progress-bar" id="record-progress"></div>
                  </div>
                  
                  <div class="rec-status-text" id="record-remaining">–î–æ —Ä–µ–∫–æ—Ä–¥–∞: 0 ‚ÇΩ</div>
                  <div id="record-motiv" style="display:none"></div>
              </div>
              
              <div class="reputation-card" id="reputation-card" data-editable data-block-key="reputation">
                  <div class="rep-header-modern">
                      <div class="rep-main-score">
                          <div class="rep-badge-large">‚òÖ</div>
                          <div class="rep-header-texts">
                              <h3 id="reputation-score">100 / 100</h3>
                              <div class="rep-subtitle" id="reputation-headline">–†–µ–ø—É—Ç–∞—Ü–∏—è –±–µ–∑—É–ø—Ä–µ—á–Ω–∞</div>
                          </div>
                      </div>
                      <div class="rep-status-badge good" id="reputation-severity">–°—Ç–∞–±–∏–ª—å–Ω–æ</div>
                  </div>

                  <div class="rep-metrics-modern">
                      <div class="rep-metric-item">
                          <div class="rm-label">–í —Ä–∞–±–æ—Ç–µ</div>
                          <div class="rm-value" id="rep-active-count">0</div>
                          <div class="rm-sub" id="rep-on-time">–ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–µ–∫</div>
                      </div>
                      <div class="rep-metric-item">
                          <div class="rm-label">–ü—Ä–æ—Å—Ä–æ—á–∫–∏</div>
                          <div class="rm-value" id="rep-overdue">0</div>
                          <div class="rm-sub" id="reputation-grade">–ó–∞–¥–∞—á –Ω–µ—Ç</div>
                      </div>
                      <div class="rep-metric-item">
                          <div class="rm-label">–ó–∞–¥–µ—Ä–∂–∫–∞ (–¥–Ω–∏)</div>
                          <div class="rep-split-val">
                              <div class="rep-sub-item">
                                  <span class="rep-sub-val" id="rep-delay-max">0</span>
                                  <span class="rep-sub-lbl">–ú–∞–∫—Å</span>
                              </div>
                              <div style="width:1px; background:var(--border);"></div>
                              <div class="rep-sub-item">
                                  <span class="rep-sub-val" id="rep-delay-avg">0</span>
                                  <span class="rep-sub-lbl">–°—Ä–µ–¥–Ω—è—è</span>
                              </div>
                          </div>
                          <div id="rep-delay" style="display:none"></div>
                      </div>
                  </div>

                  <div class="rep-body-split">
                      <div class="rep-chart-area">
                          <canvas id="reputationChart"></canvas>
                          <div class="rep-legend-row">
                              <div class="rep-legend-pill"><span class="rep-dot good"></span> <span id="rep-on-time-pill">0</span></div>
                              <div class="rep-legend-pill"><span class="rep-dot warn"></span> <span id="rep-near-pill">0</span></div>
                              <div class="rep-legend-pill"><span class="rep-dot bad"></span> <span id="rep-overdue-pill">0</span></div>
                          </div>
                          <div id="reputation-hint" style="display:none"></div>
                          <div id="reputation-detail" style="display:none"></div>
                          <div id="rep-score-label" style="display:none"></div>
                      </div>
                      <div class="rep-advice-area">
                          <div class="rep-fallout-banner" id="reputation-fallout"></div>
                          <div class="rep-advice-title">
                              <span>–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å</span>
                              <span style="cursor:pointer; color:var(--accent)" onclick="openReputationTasks()">–ö –∑–∞–¥–∞—á–∞–º ‚Üí</span>
                          </div>
                          <div id="reputation-tips"></div>
                      </div>
                  </div>
              </div>

          </div>

      </div>
    </div>
  </div>

  <footer style="text-align:center; margin-top:50px; padding-top:20px; border-top:1px solid var(--border); color:var(--muted); font-size: 14px;">
      DesignFlow Tracker by
      <a href="https://t.me/r_zhegulyaev" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">Zhegulyaev</a>
  </footer>
</div>

<button class="scroll-toggle" id="scrollToggle" aria-label="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑"><svg><use href="#icon-arrow-down"/></svg></button>

<div class="bulk-toolbar" id="bulkToolbar" style="display: none;">
    <span style="color:var(--text); font-weight: 600;" id="bulkCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
    <button class="bulk-action-btn" onclick="clearSelection()">‚Ü∫ –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
    <button class="bulk-action-btn" onclick="bulkDuplicate()">‚ùê –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>

    <select id="bulkMoveSelect" class="bulk-move-select" onchange="askBulkMove(this.value)">
        <option value="">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤...</option>
        <option value="active">–í —Ä–∞–±–æ—Ç—É</option>
        <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
        <option value="paused">–ù–∞ –ø–∞—É–∑–µ</option>
        <option value="potential">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</option>
        <option value="requests">–í –∑–∞—è–≤–∫–∏</option>
        <option value="archive">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–ê—Ä—Ö–∏–≤)</option>
    </select>
    
    <button class="bulk-action-btn delete" onclick="askBulkDelete()">√ó –£–¥–∞–ª–∏—Ç—å</button>
</div>

<div class="modal" id="addProjectModal">
    <div class="modal-content modal-wide">
        <span class="close-modal-x" onclick="attemptCloseProjectModal()">√ó</span>
        <h2 style="margin-bottom:20px; font-size: 24px;">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
        
        <div class="modal-layout-modern">

            <div>
                <div class="modal-section-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                
                <div class="form-grid-row">
                    <div class="inp-modern">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="add-proj-type" onchange="handleStatusChange(this.value)">
                            <option value="active">–í —Ä–∞–±–æ—Ç—É (–ê–∫—Ç–∏–≤–Ω—ã–π)</option>
                            <option value="potential">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª (–õ–∏–¥)</option>
                            <option value="waiting">–û–∂–∏–¥–∞–µ—Ç (–ú–∞—Ç–µ—Ä–∏–∞–ª—ã)</option>
                            <option value="paused">–ù–∞ –ø–∞—É–∑–µ</option>
                            <option value="archive">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–ê—Ä—Ö–∏–≤)</option>
                        </select>
                    </div>
                    <div class="inp-modern">
                        <label>–ö–ª–∏–µ–Ω—Ç</label>
                        <input type="text" id="add-proj-client" placeholder="–ò–º—è –∏–ª–∏ –ö–æ–º–ø–∞–Ω–∏—è">
                    </div>
                </div>
                
                <div class="form-grid-row">
                    <div class="inp-modern form-grid-full" style="grid-column: 1 / -1;">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <div style="position:relative;">
                            <input type="text" id="add-proj-name" list="project-name-templates" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∏–∑–∞–π–Ω —Å–∞–π—Ç–∞">
                            <button type="button" class="clear-input-btn hidden" id="project-name-clear" onclick="clearProjectName()" style="top:10px; right:10px;">√ó</button>
                        </div>
                        <div class="template-control-group">
                            <div class="tpl-btn-chip create" onclick="saveNameTemplate()">+ –í —à–∞–±–ª–æ–Ω—ã</div>
                            <div class="tpl-btn-chip list" onclick="openTemplateManagerModal()">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã
                            </div>
                            <div class="template-helper" id="template-helper" style="margin:0; font-size:11px;"></div>
                            <datalist id="project-name-templates"></datalist>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="modal-section-title">–§–∏–Ω–∞–Ω—Å—ã</div>
                <div class="form-grid-row finance">
                    <div class="inp-modern">
                        <label>–°—É–º–º–∞ (‚ÇΩ)</label>
                        <input type="text" id="add-proj-price" placeholder="0" oninput="formatNumberInput(this)">
                    </div>
                    <div class="inp-modern">
                        <label>–û–ø–ª–∞—á–µ–Ω–æ</label>
                        <select id="add-proj-paid">
                            <option value="0">0%</option>
                            <option value="50" selected>50%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div class="inp-modern">
                        <label>–†–∞—Å—Ö–æ–¥—ã</label>
                        <select id="add-proj-contractor-mode" onchange="handleNewContractorModeChange(this.value)">
                            <option value="none">–ù–µ—Ç</option>
                            <option value="amount">–°—É–º–º–∞ (‚ÇΩ)</option>
                            <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç (%)</option>
                        </select>
                        <div class="helper-note is-hidden" id="add-contractor-helper" style="margin-top:6px;"></div>
                        <div id="contractor-amount-wrap" class="is-hidden" style="margin-top:6px;">
                             <div class="input-with-suffix">
                                <input type="text" class="contractor-input" id="add-proj-contractor" placeholder="–°—É–º–º–∞" oninput="formatNumberInput(this)">
                                <span class="input-suffix" id="contractor-suffix">‚ÇΩ</span>
                            </div>
                        </div>
                    </div>
                    <div class="inp-modern">
                        <label>–ù–∞–ª–æ–≥</label>
                        <select id="add-proj-tax">
                            <option value="0">0%</option>
                            <option value="4">4%</option>
                            <option value="6">6%</option>
                            <option value="13">13%</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <div class="modal-section-title">–°—Ä–æ–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏</div>
                <div class="date-panel" style="display:block; padding: 16px;">
    
    <div class="date-panel-row">
        <div class="date-panel-item">
            <label>üöÄ –î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞</label>
             <div class="date-input-wrap" id="add-proj-start-display" onclick="openDateInModal('add-proj-start-val')" style="background:var(--input-bg); width:100%; height:44px;">
                <svg class="date-icon"><use href="#icon-calendar"/></svg>
                <span class="date-text-display">–°–µ–≥–æ–¥–Ω—è</span>
             </div>
             <input type="hidden" id="add-proj-start-val" value="">
        </div>

        <div class="date-panel-item">
             <label>üèÅ –î–µ–¥–ª–∞–π–Ω</label>
             <div class="deadline-row" style="width:100%">
                 <div class="date-input-wrap" id="add-proj-dl-display" onclick="openDateInModal('add-proj-dl-val')" style="background:var(--input-bg); width:100%; height:44px;">
                   <svg class="date-icon"><use href="#icon-calendar"/></svg>
                   <span class="date-text-display">–ù–µ—Ç —Å—Ä–æ–∫–∞</span>
                </div>
                <button type="button" class="deadline-clear-btn" onclick="clearNewProjectDeadline()" title="–£–±—Ä–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω" style="height:44px; margin:0 0 0 4px;">
                    <svg><use href="#icon-calendar-off"/></svg>
                </button>
             </div>
            <input type="hidden" id="add-proj-dl-val" value="">
        </div>

        <div class="date-panel-item shrink">
            <label>‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ä–æ–∫</label>
            <select id="add-proj-dl-days" onchange="applyDeadlinePreset()" class="bulk-move-select" style="background:var(--input-bg); width:100%; height:44px; margin:0;">
                <option value="">–í—ã–±—Ä–∞—Ç—å...</option>
                <option value="1">1 –¥–µ–Ω—å</option>
                <option value="3">3 –¥–Ω—è</option>
                <option value="7">–ù–µ–¥–µ–ª—è</option>
                <option value="custom">–°–≤–æ–π —Å—Ä–æ–∫</option>
            </select>
        </div>

        <div class="date-panel-item mini">
            <label>&nbsp;</label> 
            <input type="number" id="add-proj-dl-custom" placeholder="–î–Ω–µ–π" oninput="applyDeadlinePreset()" style="width: 100%; display:none; background:var(--input-bg); border:1px solid var(--border); border-radius:10px; padding:10px; height: 44px;">
        </div>
        
        <input type="time" id="add-proj-dl-time" step="300" oninput="applyDeadlinePreset()" style="display:none;">
    </div>

</div>
                <div style="margin-top: 16px;">
                    <button type="button" class="link-btn link-inline-btn" id="new-project-link-btn" onclick="openLink('new')" style="justify-content: flex-start;">
                        <svg><use href="#icon-link"/></svg>
                        <span>–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª—ã</span>
                    </button>
                        <div class="link-preview" id="new-project-link-preview" style="display:none; margin-top:10px;">
                            <div class="link-preview-body">
                                <div class="link-preview-head">
                                    <div class="link-preview-label" id="new-project-link-label">–°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞</div>
                                    <div class="link-preview-info">
                                        <a class="link-preview-url" id="new-project-link-text" href="#" target="_blank"></a>
                                    </div>
                                </div>
                                <div class="link-preview-title" id="new-project-link-title" style="display:none"></div>
                            </div>
                            <div class="link-preview-actions">
                                <button class="edit-link-btn" type="button" onclick="openLink('new')">
                                    <svg><use href="#icon-pen"/></svg>
                                    <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                                </button>
                                <button class="del-btn" type="button" onclick="clearNewProjectLink()">√ó</button>
                            </div>
                        </div>
                    </div>
            </div>

        </div>

        <div class="add-modal-actions" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
            <button class="save-stg" onclick="saveNewProject()" style="width:100%; font-size: 16px; padding: 14px;">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </div>
    </div>
</div>

<div class="modal modal-centered" id="templateManagerModal">
    <div class="modal-content modal-wide template-manager-modal">
        <span class="close-modal-x" onclick="closeTemplateManagerModal()">√ó</span>
        <h3 style="margin-bottom: 8px;">–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã</h3>
        <p class="helper-note">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
        <div class="template-modal-add">
            <div class="inp-group template-modal-input">
                <label>–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</label>
                <input type="text" id="template-manager-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –î–∏–∑–∞–π–Ω –ª–µ–Ω–¥–∏–Ω–≥–∞">
            </div>
            <button class="save-stg template-add-btn" type="button" onclick="addTemplateFromModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="template-helper" id="template-manager-helper">–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.</div>
        <div class="template-list" id="template-manager-list"></div>
    </div>
</div>

<div class="modal" id="linkModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="closeLinkModal()">√ó</span>
        <h3 style="margin-bottom:10px">–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
        <div class="inp-group">
            <input type="url" id="link-input" placeholder="https://t.me/...">
        </div>
        <label class="checkbox-wrap" style="margin-top:-5px;">
            <input type="checkbox" id="link-is-telegram">
            –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Telegram (—á–∞—Ç/–∫–∞–Ω–∞–ª)
        </label>
        <p class="helper-note">–ï—Å–ª–∏ —É–∫–∞–∑–∞—Ç—å @username, –º—ã —É–±–µ—Ä—ë–º @ –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –µ–≥–æ –≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.</p>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" id="saveLinkBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="modal" id="dateModal">
    <div class="modal-content date-modal-content">
        <span class="close-modal-x" onclick="closeDateModal()">√ó</span>
        <h3 style="margin-bottom: 0;" id="date-modal-title">–î–∞—Ç–∞</h3>
        <p style="color:var(--muted); font-size: 13px; margin-bottom: 15px;">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –∏–ª–∏ –≤—Ä–µ–º—è.</p>
        
        <label class="checkbox-wrap">
            <input type="checkbox" id="date-has-time" onchange="toggleTimeInput()"> 
            –£–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
        </label>
        
        <div class="date-time-inputs">
            <div class="input-with-icon">
                <svg class="input-icon"><use href="#icon-calendar"/></svg>
                <input type="text" id="date-input-val" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
            </div>
            <div class="input-with-icon">
                <svg class="input-icon"><use href="#icon-clock"/></svg>
                <input type="text" id="time-input-val" placeholder="–ß–ß:–ú–ú" disabled>
            </div>
        </div>
        <div class="deadline-presets modal-deadline-presets">
            <select id="date-modal-preset" onchange="applyDateModalPreset()">
                <option value="">–ë—ã—Å—Ç—Ä—ã–π —Å—Ä–æ–∫</option>
                <option value="1">1 –¥–µ–Ω—å</option>
                <option value="3">3 –¥–Ω—è</option>
                <option value="7">–ù–µ–¥–µ–ª—è</option>
                <option value="custom">–°–≤–æ–π —Å—Ä–æ–∫</option>
            </select>
            <input type="number" id="date-modal-custom" placeholder="–î–Ω–µ–π" oninput="applyDateModalPreset()" style="display:none;">
            <button type="button" class="deadline-clear-btn" id="date-modal-clear" onclick="clearDateModalDeadline()">
                <svg><use href="#icon-calendar-off"/></svg>
                <span>–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞</span>
            </button>
        </div>
        <div class="date-modal-footer">
            <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveDate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content settings-modal">
        <span class="close-modal-x" onclick="attemptCloseSettings()">√ó</span>
        <div class="settings-header">
            <div class="settings-header-text">
                <div class="settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="settings-sub">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–ª–æ–∫–∞–º–∏, —Ç–µ–º–æ–π, —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏.</div>
            </div>
            <div class="settings-pill">DesignFlow BETA</div>
        </div>

        <div class="settings-layout">
            <div class="settings-tabs">
                <button class="settings-nav-btn active" data-target="appearance" onclick="activateSettingsPane('appearance')">
                    <svg class="settings-nav-icon"><use href="#icon-sun"/></svg>
                    <span>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</span>
                </button>
                <button class="settings-nav-btn" data-target="blocks" onclick="activateSettingsPane('blocks')">
                    <svg class="settings-nav-icon"><use href="#icon-grid"/></svg>
                    <span>–ë–ª–æ–∫–∏</span>
                </button>
                <button class="settings-nav-btn" data-target="tables" onclick="activateSettingsPane('tables')">
                    <svg class="settings-nav-icon"><use href="#icon-table"/></svg>
                    <span>–¢–∞–±–ª–∏—Ü–∞</span>
                </button>
                <button class="settings-nav-btn" data-target="data" onclick="activateSettingsPane('data')">
                    <svg class="settings-nav-icon"><use href="#icon-download"/></svg>
                    <span>–î–∞–Ω–Ω—ã–µ</span>
                </button>
            </div>

            <div class="settings-content">
                <div class="settings-pane active" data-pane="appearance">
                    <div class="settings-section">
                        <div class="settings-section-title">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
                        <div class="settings-section-sub">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–µ—Ç–ª—É—é, —Ç—ë–º–Ω—É—é –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ç–µ–º—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫.</div>
                        <div class="radio-grid">
                            <label class="radio-card">
                                <input type="radio" name="theme-mode" value="auto" id="theme-mode-auto">
                                <div>
                                    <div class="radio-card-title">–ê–≤—Ç–æ</div>
                                    <div class="radio-card-sub">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–º—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</div>
                                </div>
                            </label>
                            <label class="radio-card">
                                <input type="radio" name="theme-mode" value="light" id="theme-mode-light">
                                <div>
                                    <div class="radio-card-title">–°–≤–µ—Ç–ª–∞—è</div>
                                    <div class="radio-card-sub">–õ—ë–≥–∫–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –¥–ª—è –¥–Ω–µ–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏.</div>
                                </div>
                            </label>
                            <label class="radio-card">
                                <input type="radio" name="theme-mode" value="dark" id="theme-mode-dark">
                                <div>
                                    <div class="radio-card-title">–¢—ë–º–Ω–∞—è</div>
                                    <div class="radio-card-sub">–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞, –±–µ—Ä–µ–∂—ë—Ç –≥–ª–∞–∑–∞ –∏ –±–∞—Ç–∞—Ä–µ—é.</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-pane" data-pane="blocks">
                    <div class="settings-section">
                        <div class="settings-section-title">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤</div>
                        <div class="settings-section-sub">–°–∫—Ä–æ–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç —Ñ–æ–∫—É—Å—É. –ü—Ä–µ–≤—å—é –Ω–∏–∂–µ –ø–æ–∫–∞–∂—É—Ç, –∫–∞–∫ –≤—ã–≥–ª—è–¥—è—Ç –±–ª–æ–∫–∏.</div>
                        <div class="settings-options settings-columns">
                            <div class="block-setting" data-block="backup">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –±—ç–∫–∞–ø</div>
                                        <div class="settings-row-sub">–ü–ª–∞—à–∫–∞ —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-backup">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview block-preview--neutral">
                                    <div class="preview-banner">‚ö† –í–∞–∂–Ω–æ: –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.<span style="color: var(--muted); font-weight: 700; font-size: 12px;">–°–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø</span></div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                            <div class="block-setting" data-block="pace">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–º–ø–∞</div>
                                        <div class="settings-row-sub">–ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –ø–æ –¥–µ–¥–ª–∞–π–Ω–∞–º –∏ –º–∞—Ä–∂–µ.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-pace">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview">
                                    <div class="preview-card small"><div class="settings-row-title">–¢–µ–º–ø –Ω–µ–¥–µ–ª–∏</div><div class="preview-bar" style="margin-top:8px"><span style="width: 62%"></span></div></div>
                                    <div class="preview-card small"><div class="settings-row-title">–†–µ–ø—É—Ç–∞—Ü–∏—è</div><div class="preview-bar" style="margin-top:8px"><span style="width: 38%"></span></div></div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                            <div class="block-setting" data-block="dashboard">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–î–∞—à–±–æ—Ä–¥ –∏ –≥—Ä–∞—Ñ–∏–∫–∏</div>
                                        <div class="settings-row-sub">–ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —Ü–µ–ª—è–º, –¥–µ–Ω–µ–∂–Ω—ã–º –ø–æ—Ç–æ–∫–∞–º –∏ —Ç–æ–ø–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-dashboard">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview">
                                    <div class="preview-pill">–¶–µ–ª—å –º–µ—Å—è—Ü–∞</div>
                                    <div class="preview-grid">
                                    <div class="preview-card"><div class="settings-row-title">–§–∞–∫—Ç</div><div class="preview-bar" style="margin-top:8px"><span style="width:76%"></span></div></div>
                                        <div class="preview-card"><div class="settings-row-title">–ü—Ä–æ–≥–Ω–æ–∑</div><div class="preview-bar"style="margin-top:8px"><span style="width:54%"></span></div></div>
                                        <div class="preview-card"><div class="settings-row-title">–†–∞—Å—Ö–æ–¥—ã</div><div class="preview-bar"style="margin-top:8px"><span style="width:42%"></span></div></div>
                                    </div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                            <div class="block-setting" data-block="efficiency">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                                        <div class="settings-row-sub">–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–ª—É—á–µ–Ω–æ/–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-efficiency">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview">
                                    <div class="preview-card"><div class="settings-row-title">–ü–æ–ª—É—á–µ–Ω–æ</div><div class="preview-bar" style="margin-top:8px"><span style="width: 58%"></span></div></div>
                                    <div class="preview-card"><div class="settings-row-title">–î–∏–Ω–∞–º–∏–∫–∞</div><div class="preview-bar" style="margin-top:8px"><span style="width: 44%"></span></div></div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                            <div class="block-setting" data-block="topClients">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                                        <div class="settings-row-sub">–°—Ç–æ–ª–±–∏–∫–∏ –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ —Å—Ä–µ–¥–∏ 5 –ª—É—á—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-top-clients">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview">
                                    <div class="preview-card"><div class="settings-row-title">Top 5</div><div class="preview-bar" style="margin-top:8px"><span style="width: 65%"></span></div><div class="settings-row-sub" style="margin-top:8px">–õ—É—á—à–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –º–µ—Å—è—Ü–∞</div></div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                            <div class="block-setting" data-block="record">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–†–µ–∫–æ—Ä–¥ –º–µ—Å—è—Ü–∞</div>
                                        <div class="settings-row-sub">–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∫ –ª–∏—á–Ω–æ–º—É —Ä–µ–∫–æ—Ä–¥—É –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-record">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview">
                                    <div class="preview-banner">üèÜ –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ä–µ–∫–æ—Ä–¥—É</div>
                                    <div class="preview-bar" style="margin-top:8px"><span style="width:72%"></span></div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                            <div class="block-setting" data-block="reputation">
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-row-title">–†–µ–ø—É—Ç–∞—Ü–∏—è</div>
                                        <div class="settings-row-sub">–ö–∞—Ä—Ç–æ—á–∫–∞ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º –¥–µ–¥–ª–∞–π–Ω–æ–≤ –∏ —Å–æ–≤–µ—Ç–∞–º–∏.</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="block-toggle-reputation">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="block-preview">
                                    <div class="preview-grid">
                                        <div class="preview-card"><div class="settings-row-title">–†–µ–ø—É—Ç–∞—Ü–∏—è</div><div class="settings-row-sub" style="margin-top:6px">100 / 100</div></div>
                                        <div class="preview-card"><div class="settings-row-title">–ü—Ä–æ—Å—Ä–æ—á–∫–∏</div><div class="settings-row-sub" style="margin-top:6px">0 –∑–∞–¥–∞—á</div></div>
                                    </div>
                                    <div class="preview-state">–°–∫—Ä—ã—Ç–æ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-section-title">–ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
                        <div class="settings-section-sub">–í–∫–ª—é—á–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –¥–∞—à–±–æ—Ä–¥–µ.</div>
                        <div class="settings-chip-grid">
                            <div class="settings-chip">
                                <div><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏</strong><br><small>–ü–æ–ª–æ—Å–∞ –∏ –ø–æ–¥–ø–∏—Å–∏ –ø–æ –º–µ—Å—è—á–Ω–æ–π —Ü–µ–ª–∏</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-goal">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–§–∞–∫—Ç</strong><br><small>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –º–µ—Å—è—Ü</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-fact">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–ü–æ–ª—É—á–µ–Ω–æ (–≤ —Ä–∞–±–æ—Ç–µ)</strong><br><small>–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-active-fact">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–û–ø–ª–∞—á–µ–Ω–æ</strong><br><small>–ì—Ä—è–∑–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-paid-gross">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–û–±—â–∞—è —Å—É–º–º–∞</strong><br><small>–í—Å–µ –±—é–¥–∂–µ—Ç—ã –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-total-gross">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–ü–ª–∞–Ω</strong><br><small>–û—Å—Ç–∞—Ç–æ–∫ –¥–æ —Ü–µ–ª–∏</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-plan">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–ü—Ä–æ–≥–Ω–æ–∑ –∏—Ç–æ–≥–∞</strong><br><small>–§–∞–∫—Ç + –æ–∂–∏–¥–∞–µ–º—ã–µ –ø–ª–∞—Ç–µ–∂–∏</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-forecast">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–†–∞—Å—Ö–æ–¥—ã</strong><br><small>–í—Å–µ —Ç—Ä–∞—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-expenses">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-chip">
                                <div><strong>–ù–∞–ª–æ–≥–∏</strong><br><small>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</small></div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="stat-toggle-taxes">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-pane" data-pane="tables">
                    <div class="settings-section">
                        <div class="settings-section-title">–†–∞–∑–¥–µ–ª—ã —Ç–∞–±–ª–∏—Ü—ã</div>
                        <div class="settings-section-sub">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ —Å—Ç–∞—Ç—É—Å—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —Ç–∞–±–ª–∏—Ü–µ.</div>
                        <div class="settings-options settings-columns">
                            <div class="settings-row">
                                <div>
                                    <div class="settings-row-title">–ó–∞—è–≤–∫–∏</div>
                                    <div class="settings-row-sub">–ù–æ–≤—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ –∏ –ª–∏–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="table-toggle-requests">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-row">
                                <div>
                                    <div class="settings-row-title">–û–∂–∏–¥–∞–µ—Ç</div>
                                    <div class="settings-row-sub">–ü—Ä–æ–µ–∫—Ç—ã, –≥–¥–µ –∂–¥—ë–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞.</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="table-toggle-waiting">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-row">
                                <div>
                                    <div class="settings-row-title">–ù–∞ –ø–∞—É–∑–µ</div>
                                    <div class="settings-row-sub">–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç—å.</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="table-toggle-paused">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-footer-note">–ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å–∫—Ä—ã—Ç, –≤–∫–ª–∞–¥–∫–∞ –∏ –µ—ë –∏–∫–æ–Ω–∫–∞ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä–Ω—ë—Ç—Å—è –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ä–∞–∑–¥–µ–ª.</div>
                    </div>
                </div>

                <div class="settings-pane" data-pane="data">
                    <div class="settings-section">
                        <div style="display:flex; gap: 10px; align-items: baseline; flex-wrap: wrap;">
                            <div class="settings-section-title" style="margin:0;">–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</div>
                            <div class="settings-section-sub" style="margin:0;">–°–∫–∞—á–∞–π—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ JSON, –ª–∏–±–æ –≤—ã–≥—Ä—É–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ CSV.</div>
                        </div>
                        <div class="settings-actions">
                            <button onclick="exp()"><svg class="btn-icon"><use href="#icon-download"/></svg><span class="btn-label">–°–∫–∞—á–∞—Ç—å –±–∞–∑—É</span></button>
                            <button onclick="document.getElementById('imp').click()"><svg class="btn-icon"><use href="#icon-upload"/></svg><span class="btn-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É</span></button>
                            <button onclick="expCSV()"><svg class="btn-icon"><use href="#icon-csv"/></svg><span class="btn-label">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</span></button>
                        </div>
                        <input type="file" id="imp" accept=".json" style="display:none" onchange="imp(this.files[0])">
                        <div class="settings-footer-note" style="display:flex; align-items: flex-start; gap:8px;">
                            <svg class="btn-icon" style="color: var(--red); margin-top:2px;"><use href="#icon-alert"/></svg>
                            <span>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –î–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ –∏–ª–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.</span>
                        </div>
                    </div>

                    <div class="settings-section">
                <div style="display: flex !important; flex-direction: row !important; align-items: baseline !important; gap: 10px !important; margin-bottom: 10px !important; flex-wrap: nowrap !important;">
    <div class="settings-section-title" style="margin: 0 !important; display: inline-block !important; white-space: nowrap !important;">
        –¶–µ–ª–∏ –∏ —Ä–µ–∫–æ—Ä–¥
    </div>
    <span style="color:#56657d; font-size: 13px; line-height: 1.5; display: inline-block !important;">
        –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –º—ã –ø–æ–∫–∞–∂–µ–º –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –∏ –≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö.
    </span>
</div><br>
                        <div class="settings-actions" style="margin-top: 0; gap: 16px;">
                            <div class="inp-group" style="flex:1">
                                <label>–¶–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü (‚ÇΩ)</label>
                                <input type="text" id="stg-goal" oninput="formatNumberInput(this)">
                            </div>
                            <div class="inp-group" style="flex:1">
                                <label>–†–µ–∫–æ—Ä–¥ (‚ÇΩ)</label>
                                <input type="text" id="stg-rec" oninput="formatNumberInput(this)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-actions-row">
            <button class="btn-ghost" type="button" onclick="resetInterface()">–°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</button>
            <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>
</div>
<div class="modal" id="settingsUnsavedModal" style="display:none;">
    <div class="modal-content" style="max-width: 420px;">
        <h3 style="margin-bottom: 6px;">–ó–∞–∫—Ä—ã—Ç—å –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?</h3>
        <p style="color:var(--muted); font-weight: 700; line-height: 1.4;">–í—ã –∏–∑–º–µ–Ω–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–æ –Ω–µ –Ω–∞–∂–∞–ª–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª. –í—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏?</p>
        <div style="display:flex; gap:10px; margin-top: 18px; flex-wrap: wrap;">
            <button class="btn-ghost" style="flex:1; min-width:180px;" onclick="discardSettingsChanges()">–î–∞, –≤—ã–π—Ç–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—è</button>
            <button class="save-stg" style="flex:1; min-width:180px; background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveSettings()">–ù–µ—Ç, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏</button>
        </div>
    </div>
</div>
<div class="modal" id="deleteConfirmModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('deleteConfirmModal').style.display='none'">√ó</span>
        <h3 style="color:var(--text); margin-bottom:10px;" id="del-modal-title">–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É?</h3>
        <p style="color:var(--muted); margin-bottom: 20px; font-size:14px;" id="del-modal-desc">–û–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 30 –¥–Ω–µ–π.</p>
        <div style="display:flex;gap:15px;">
            <button onclick="document.getElementById('deleteConfirmModal').style.display='none'" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
            <button class="confirm-del-btn" style="background:var(--red); border-color:var(--red);" id="finalDeleteBtn" style="flex:1">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal" id="completeModal" style="display:none;">
    <div class="modal-content complete-modal-card">
        <span class="close-modal-x" onclick="closeCompleteModal()">√ó</span>
        
        <div class="complete-modal">
            <div class="complete-head">
                <div class="complete-title">–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω?</div>
                <div class="complete-sub">–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –¥–∞—Ç—É, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–ø—É—Ç–∞—Ü–∏—é.</div>
            </div>

            <div class="complete-status-flow">
                <div class="status-flow-label">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</div>
                <div class="status-flow">
                    <span class="status-pill-static" id="completeSourcePill">–í —Ä–∞–±–æ—Ç–µ</span>
                    <span class="status-flow-arrow">‚ûú</span>
                    <span class="status-pill-done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                </div>
            </div>

            <div class="complete-date-card">
                <div class="complete-date-head-row">
                    <div>
                        <div class="complete-date-title">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞</div>
                        <div class="complete-date-sub">–í–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</div>
                    </div>
                    <div class="complete-chip">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</div>
                </div>

                <div class="complete-inputs-col">
                    <div class="complete-input-group">
                        <label>–î–∞—Ç–∞ —Å–¥–∞—á–∏</label>
                        <div class="complete-input-wrap">
                            <svg class="complete-icon"><use href="#icon-calendar"/></svg>
                            <input type="date" id="completeDateInput" class="complete-input" onchange="updateCompleteHint()" oninput="updateCompleteHint()">
                        </div>
                    </div>
                    <div class="complete-input-group">
                        <label>–í—Ä–µ–º—è</label>
                        <div class="complete-input-wrap">
                            <svg class="complete-icon"><use href="#icon-clock"/></svg>
                            <input type="time" id="completeTimeInput" class="complete-input" step="300" onchange="updateCompleteHint()" oninput="updateCompleteHint()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="complete-feedback success" id="completeFeedback">
                <div class="feedback-check" id="completeFeedbackIcon"><svg class="feedback-icon"><use href="#icon-check"/></svg></div>
                <div class="feedback-content">
                    <h4 id="completeHintTitle">–û—Ç–ª–∏—á–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–Ω–æ!</h4>
                    <p id="completeHint">–°—Ä–æ–∫ —Å–æ–±–ª—é–¥—ë–Ω. –≠—Ç–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ —Å–∫–∞–∂–µ—Ç—Å—è –Ω–∞ –≤–∞—à–µ–π —Ä–µ–ø—É—Ç–∞—Ü–∏–∏.</p>
                </div>
            </div>

            <div class="complete-actions">
                <button class="btn-big btn-cancel" onclick="closeCompleteModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-big btn-submit" onclick="confirmCompletion()">
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const K = 'grok_design_v5';
const THEME_KEY = 'designflow_theme';
const THEME_OVERRIDE_KEY = 'designflow_theme_override';
const NAME_TEMPLATES_KEY = 'designflow_name_templates';
const UI_PREFS_KEY = 'designflow_ui_prefs';
const STAT_KEYS = ['fact','active-fact','paid-gross','total-gross','plan','forecast','expenses','taxes'];
const SIDE_BLOCK_KEYS = ['efficiency','record','reputation'];
const LAYOUT_BLOCK_KEYS = ['topClients','efficiency','record','reputation'];
const BLOCK_CONTAINERS = ['main','side'];
const DEFAULT_BLOCK_ORDER = {
    main: ['topClients'],
    side: ['efficiency','record','reputation']
};
const DEFAULT_UI_PREFS = {
    themeMode: 'dark',
    blockVisibility: {
        backup: true,
        pace: true,
        dashboard: true,
        efficiency: true,
        topClients: true,
        record: true,
        reputation: true
    },
    blockOrder: { ...DEFAULT_BLOCK_ORDER },
    tableVisibility: {
        waiting: true,
        requests: true,
        paused: true
    },
    statVisibility: {
        goal: true,
        fact: true,
        activeFact: true,
        paidGross: true,
        totalGross: true,
        plan: true,
        forecast: true,
        expenses: true,
        taxes: true
    },
    statOrder: [...STAT_KEYS],
    sideOrder: [...SIDE_BLOCK_KEYS]
};
let UI_PREFS = JSON.parse(JSON.stringify(DEFAULT_UI_PREFS));
let autoThemeInterval = null;
const now = new Date();
const today = now.toISOString().slice(0, 10);
let currentMonth = today.slice(0,7);
let currentTab = 'active';
let settingsSnapshot = null;
let settingsInitialState = null;
const TAB_DESCRIPTIONS = {
    active: "–ü—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É.",
    waiting: "–û–∂–∏–¥–∞—é—Ç —Ä–µ–∞–∫—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.",
    potential: "–õ–∏–¥—ã –∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã. –ï—â—ë –Ω–µ –Ω–∞—á–∞—Ç—ã.",
    requests: "–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è —Å –∫–∞–Ω–∞–ª–æ–≤.",
    paused: "–ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã.",
    archive: "–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã.",
    all: "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –∞—Ä—Ö–∏–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.",
    trash: "–£–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã. –•—Ä–∞–Ω—è—Ç—Å—è 30 –¥–Ω–µ–π."
};

const STATUS_META = {
    active: { label: '–í —Ä–∞–±–æ—Ç–µ', cls: 'active', icon: 'icon-active' },
    waiting: { label: '–û–∂–∏–¥–∞–µ—Ç', cls: 'waiting', icon: 'icon-waiting' },
    potential: { label: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª', cls: 'potential', icon: 'icon-potential' },
    paused: { label: '–ù–∞ –ø–∞—É–∑–µ', cls: 'paused', icon: 'icon-paused' },
    archive: { label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', cls: 'archive', icon: 'icon-check' },
};

const toNumeric = (val) => {
    const cleaned = String(val || '').replace(/\s+/g, '').replace(/,/g, '.');
    if (!cleaned) return 0;

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ—Ä–æ—Ç–∫–æ–π –∑–∞–ø–∏—Å–∏ "10k/10–∫" –¥–ª—è —Ç—ã—Å—è—á
    const normalized = cleaned.replace(/(\d*\.?\d+)[k–∫]/gi, '($1*1000)');

    // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (+ - * / –∏ —Å–∫–æ–±–∫–∏)
    if (/[^0-9+\-*/().]/.test(normalized)) return 0;

    try {
        const result = new Function('return ' + normalized)();
        const num = typeof result === 'number' ? result : parseFloat(result);
        return isFinite(num) ? num : 0;
    } catch {
        return 0;
    }
};

function formatPlainNumber(val) {
    const raw = String(val ?? '').replace(/\s+/g, '').trim();
    if (raw === '') return '';
    const isNegative = raw.startsWith('-');
    const normalized = raw.replace(/[^\d.,]/g, '').replace(/^-/, '');
    const [intPartRaw, fracRaw] = normalized.split(/[.,]/);
    const intPart = (intPartRaw || '0').replace(/\D/g, '');
    const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    const frac = fracRaw ? fracRaw.replace(/\D/g, '') : '';
    const formatted = frac ? `${formattedInt},${frac}` : formattedInt;
    return isNegative ? `-${formatted}` : formatted;
}

function getCssVar(name) {
    return getComputedStyle(document.body).getPropertyValue(name).trim();
}

function normalizeOrder(order, defaults) {
    const fallback = Array.isArray(defaults) ? defaults : [];
    const incoming = Array.isArray(order) ? order.filter(Boolean) : [];
    const seen = new Set();
    const result = [];
    [...incoming, ...fallback].forEach(key => {
        if (!key || seen.has(key)) return;
        seen.add(key);
        result.push(key);
    });
    return result;
}

function normalizeBlockOrder(orderMap, fallback = DEFAULT_BLOCK_ORDER) {
    const result = {};
    const seen = new Set();
    Object.keys(fallback).forEach(zone => result[zone] = []);
    Object.entries({ ...fallback, ...(orderMap || {}) }).forEach(([zone, list]) => {
        if (!result[zone]) result[zone] = [];
        (list || []).forEach(key => {
            if (!LAYOUT_BLOCK_KEYS.includes(key) || seen.has(key)) return;
            result[zone].push(key);
            seen.add(key);
        });
    });
    LAYOUT_BLOCK_KEYS.forEach(key => {
        if (seen.has(key)) return;
        const fallbackZone = fallback.main.includes(key) ? 'main' : fallback.side.includes(key) ? 'side' : Object.keys(fallback)[0];
        result[fallbackZone] = result[fallbackZone] || [];
        result[fallbackZone].push(key);
    });
    return result;
}

function loadUiPrefs() {
    try {
        const storedTheme = localStorage.getItem(THEME_KEY);
        let stored = JSON.parse(localStorage.getItem(UI_PREFS_KEY));
        if (!stored) {
            const snapshot = JSON.parse(localStorage.getItem(K) || 'null');
            stored = snapshot?.uiPrefs || null;
        }
        if (stored) {
            UI_PREFS = {
                ...DEFAULT_UI_PREFS,
                ...stored,
                blockVisibility: {
                    ...DEFAULT_UI_PREFS.blockVisibility,
                    ...(stored.blockVisibility || {})
                },
                tableVisibility: {
                    ...DEFAULT_UI_PREFS.tableVisibility,
                    ...(stored.tableVisibility || {})
                },
                statVisibility: {
                    ...DEFAULT_UI_PREFS.statVisibility,
                    ...(stored.statVisibility || {})
                },
                statOrder: normalizeOrder(stored.statOrder, STAT_KEYS),
                sideOrder: normalizeOrder(stored.sideOrder, SIDE_BLOCK_KEYS),
                blockOrder: normalizeBlockOrder(stored.blockOrder, DEFAULT_BLOCK_ORDER)
            };
            if (stored?.blockVisibility?.reputation === false && stored?.blockVisibility?.record === undefined) {
                UI_PREFS.blockVisibility.record = false;
            }
        } else {
            UI_PREFS = { ...DEFAULT_UI_PREFS };
            // FIX: –ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, —Å—Ç–∞–≤–∏–º LIGHT –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (!storedTheme) UI_PREFS.themeMode = 'light';
            else if (storedTheme === 'light' || storedTheme === 'dark') {
                UI_PREFS.themeMode = storedTheme;
            }
        }
    } catch (e) {
        console.warn('UI prefs load failed', e);
    }
    UI_PREFS.statOrder = normalizeOrder(UI_PREFS.statOrder, STAT_KEYS);
    UI_PREFS.sideOrder = normalizeOrder(UI_PREFS.sideOrder, SIDE_BLOCK_KEYS);
    UI_PREFS.blockOrder = normalizeBlockOrder(UI_PREFS.blockOrder, DEFAULT_BLOCK_ORDER);
    if (!UI_PREFS.themeMode) UI_PREFS.themeMode = 'light'; // FIX: —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –∑–¥–µ—Å—å —Ç–æ–∂–µ
    persistUiPrefs();
}

function persistUiPrefs() {
    localStorage.setItem(UI_PREFS_KEY, JSON.stringify(UI_PREFS));
}

function resolveTheme(mode = UI_PREFS.themeMode, { respectOverride = true } = {}) {
    if (mode === 'light' || mode === 'dark') return mode;
    if (respectOverride) {
        const override = localStorage.getItem(THEME_OVERRIDE_KEY);
        if (override === 'light' || override === 'dark') return override;
    }
    const hour = new Date().getHours();
    return hour >= 7 && hour < 20 ? 'light' : 'dark';
}

function startAutoThemeWatcher() {
    stopAutoThemeWatcher();
    autoThemeInterval = setInterval(() => applyThemeMode('auto', { silent: true, skipSave: true, respectOverride: false }), 5 * 60 * 1000);
}

function stopAutoThemeWatcher() {
    if (autoThemeInterval) {
        clearInterval(autoThemeInterval);
        autoThemeInterval = null;
    }
}

function applyTheme(theme) {
    const isLight = theme === 'light';
    document.body.classList.toggle('light', isLight);
    const icon = document.getElementById('themeToggleIcon');
    const label = document.getElementById('themeToggleLabel');
    if (icon) {
        const use = icon.querySelector('use');
        if (use) use.setAttribute('href', isLight ? '#icon-moon' : '#icon-sun');
    }
    if (label) {
        const mode = UI_PREFS.themeMode || 'dark';
        label.textContent = mode === 'auto'
            ? (isLight ? '–ê–≤—Ç–æ ¬∑ –°–≤–µ—Ç–ª–∞—è' : '–ê–≤—Ç–æ ¬∑ –¢—ë–º–Ω–∞—è')
            : (isLight ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
    }
}

function applyThemeMode(mode, { silent = false, skipSave = false, respectOverride = true, overrideTheme } = {}) {
    UI_PREFS.themeMode = mode || 'dark';
    if (UI_PREFS.themeMode !== 'auto') {
        localStorage.removeItem(THEME_OVERRIDE_KEY);
    } else {
        if (!respectOverride) localStorage.removeItem(THEME_OVERRIDE_KEY);
        if (overrideTheme === 'light' || overrideTheme === 'dark') {
            localStorage.setItem(THEME_OVERRIDE_KEY, overrideTheme);
        }
    }
    const actual = resolveTheme(UI_PREFS.themeMode, { respectOverride });
    localStorage.setItem(THEME_KEY, actual);
    if (!skipSave) persistUiPrefs();
    applyTheme(actual);
    document.querySelectorAll('input[name="theme-mode"]').forEach(r => r.checked = r.value === UI_PREFS.themeMode);
    if (UI_PREFS.themeMode === 'auto') {
        startAutoThemeWatcher();
    } else {
        stopAutoThemeWatcher();
    }
    if (!silent && typeof calcStats === 'function') {
        calcStats();
    }
}

function toggleTheme() {
    if (UI_PREFS.themeMode === 'auto') {
        const current = resolveTheme('auto');
        const nextActual = current === 'light' ? 'dark' : 'light';
        applyThemeMode('auto', { overrideTheme: nextActual });
        return;
    }
    const next = UI_PREFS.themeMode === 'light' ? 'dark' : 'light';
    applyThemeMode(next);
}

function initTheme() {
    const storedTheme = localStorage.getItem(THEME_KEY);
    if (!localStorage.getItem(UI_PREFS_KEY) && (storedTheme === 'light' || storedTheme === 'dark')) {
        UI_PREFS.themeMode = storedTheme;
    }
    applyThemeMode(UI_PREFS.themeMode || storedTheme || 'dark', { silent: true });
    if (UI_PREFS.themeMode === 'auto') startAutoThemeWatcher();
}

function applyBlockVisibility() {
    const visibility = UI_PREFS.blockVisibility || {};
    const backup = document.getElementById('backup-panel');
    const pace = document.getElementById('pace-indicator');
    const dashboard = document.getElementById('analytics-dashboard');
    const record = document.getElementById('record-banner');
    const reputation = document.getElementById('reputation-card');
    const efficiency = document.getElementById('efficiency-card');
    const topClients = document.getElementById('top-clients-card');
    const paceDetails = document.getElementById('pace-details-btn');

    if (backup) backup.classList.toggle('is-hidden', visibility.backup === false);
    if (pace) pace.classList.toggle('is-hidden', visibility.pace === false);
    if (dashboard) dashboard.classList.toggle('is-hidden', visibility.dashboard === false);
    const hideAnalytics = visibility.dashboard === false;
    if (efficiency) efficiency.classList.toggle('is-hidden', hideAnalytics || visibility.efficiency === false);
    if (topClients) topClients.classList.toggle('is-hidden', hideAnalytics || visibility.topClients === false);
    if (record) record.classList.toggle('is-hidden', hideAnalytics || visibility.record === false);
    if (reputation) reputation.classList.toggle('is-hidden', hideAnalytics || visibility.reputation === false);
    if (paceDetails) paceDetails.classList.toggle('is-hidden', visibility.reputation === false || hideAnalytics);
}

function updateSettingsPreviewStates() {
    document.querySelectorAll('.block-setting').forEach(block => {
        const toggle = block.querySelector('input[type="checkbox"]');
        const enabled = toggle ? toggle.checked !== false : true;
        block.classList.toggle('is-off', !enabled);
    });
}

function applyStatVisibility() {
    const visibility = UI_PREFS.statVisibility || {};
    document.querySelectorAll('[data-stat]').forEach(el => {
        const key = el.getAttribute('data-stat');
        const camelKey = key.replace(/-([a-z])/g, (_, ch) => ch.toUpperCase());
        const enabled = (visibility[key] ?? visibility[camelKey] ?? true) !== false;
        el.classList.toggle('is-hidden', !enabled);
    });
    const goal = document.getElementById('goal-progress');
    const goalPill = document.getElementById('goal-pill');
    if (goal) goal.classList.toggle('is-hidden', visibility.goal === false);
    if (goalPill) goalPill.classList.toggle('is-hidden', visibility.goal === false);
}

function applyStatOrder() {
    const grid = document.querySelector('.stats-grid');
    if (!grid) return;
    UI_PREFS.statOrder = normalizeOrder(UI_PREFS.statOrder, STAT_KEYS);
    const map = Object.fromEntries([...grid.children].map(el => [el.getAttribute('data-stat'), el]));
    UI_PREFS.statOrder.forEach(key => {
        if (map[key]) grid.appendChild(map[key]);
    });
}

function applyBlockOrder() {
    const containers = Object.fromEntries([...document.querySelectorAll('[data-block-container]')]
        .map(el => [el.getAttribute('data-block-container'), el]));
    UI_PREFS.blockOrder = normalizeBlockOrder(UI_PREFS.blockOrder, DEFAULT_BLOCK_ORDER);
    const lookup = Object.fromEntries([...document.querySelectorAll('[data-block-key]')]
        .map(el => [el.getAttribute('data-block-key'), el]));
    BLOCK_CONTAINERS.forEach(zone => {
        const container = containers[zone];
        if (!container) return;
        UI_PREFS.blockOrder[zone].forEach(key => {
            if (lookup[key]) {
                container.appendChild(lookup[key]);
            }
        });
    });
}

let layoutEditMode = false;
let draggingStat = null;
let draggingBlock = null;
let dragPreview = null;
let layoutEditSnapshot = null;

function createEditControls(type, key) {
    const wrap = document.createElement('div');
    wrap.className = 'edit-controls';
    const handle = document.createElement('span');
    handle.className = 'edit-handle';
    handle.innerHTML = '<svg class="btn-icon lg"><use href="#icon-grip"/></svg>';
    handle.title = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –±–ª–æ–∫';
    const remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'edit-remove';
    remove.title = '–°–∫—Ä—ã—Ç—å –±–ª–æ–∫';
    remove.innerHTML = '<svg aria-hidden="true" class="btn-icon"><use href="#icon-trash"/></svg>';
    remove.onclick = (e) => {
        e.stopPropagation();
        hideEditableBlock(type, key);
    };
    wrap.appendChild(handle);
    wrap.appendChild(remove);
    return wrap;
}

function hideEditableBlock(type, key) {
    if (type === 'stat') {
        UI_PREFS.statVisibility[key] = false;
        applyStatVisibility();
    } else {
        UI_PREFS.blockVisibility[key] = false;
        applyBlockVisibility();
    }
    persistUiPrefs();
}

function setupEditableBlocks() {
    document.querySelectorAll('[data-stat]').forEach(el => {
        const key = el.getAttribute('data-stat');
        el.setAttribute('draggable', layoutEditMode ? 'true' : 'false');
        el.removeEventListener('dragstart', onStatDragStart);
        el.removeEventListener('dragover', onStatDragOver);
        el.removeEventListener('dragleave', onStatDragLeave);
        el.removeEventListener('drop', onStatDrop);
        if (layoutEditMode) {
            el.addEventListener('dragstart', onStatDragStart);
            el.addEventListener('dragover', onStatDragOver);
            el.addEventListener('dragleave', onStatDragLeave);
            el.addEventListener('drop', onStatDrop);
        }
        if (!el.dataset.controlsReady) {
            const controls = createEditControls('stat', key);
            el.appendChild(controls);
            const hint = document.createElement('div');
            hint.className = 'edit-hint';
            hint.textContent = '–¢—è–Ω–∏, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç—å';
            el.appendChild(hint);
            el.dataset.controlsReady = '1';
        }
    });

    document.querySelectorAll('[data-block-key]').forEach(el => {
        const key = el.getAttribute('data-block-key');
        el.dataset.editable = el.dataset.editable || 'block';
        const canDragBlock = LAYOUT_BLOCK_KEYS.includes(key);
        el.setAttribute('draggable', layoutEditMode && canDragBlock ? 'true' : 'false');
        const handle = el.querySelector('.edit-handle');
        if (handle) handle.style.display = canDragBlock && layoutEditMode ? 'inline-flex' : 'none';
        el.removeEventListener('dragstart', onBlockDragStart);
        el.removeEventListener('dragend', onBlockDragEnd);
        el.removeEventListener('dragover', onBlockDragOverBlock);
        el.removeEventListener('dragleave', onBlockDragLeaveBlock);
        el.removeEventListener('drop', onBlockDropOnBlock);
        if (!el.dataset.controlsReady) {
            const controls = createEditControls('block', key);
            el.appendChild(controls);
            el.dataset.controlsReady = '1';
        }
        if (layoutEditMode && canDragBlock) {
            el.addEventListener('dragstart', onBlockDragStart);
            el.addEventListener('dragend', onBlockDragEnd);
            el.addEventListener('dragover', onBlockDragOverBlock);
            el.addEventListener('dragleave', onBlockDragLeaveBlock);
            el.addEventListener('drop', onBlockDropOnBlock);
        }
    });

    document.querySelectorAll('[data-block-container]').forEach(container => {
        container.removeEventListener('dragover', onBlockDragOverContainer);
        container.removeEventListener('dragleave', onBlockDragLeaveContainer);
        container.removeEventListener('drop', onBlockDropOnContainer);
        if (layoutEditMode) {
            container.addEventListener('dragover', onBlockDragOverContainer);
            container.addEventListener('dragleave', onBlockDragLeaveContainer);
            container.addEventListener('drop', onBlockDropOnContainer);
        }
    });

    document.body.classList.toggle('layout-edit', layoutEditMode);
    updateLayoutEditButton();
}

function onStatDragStart(e) {
    if (!layoutEditMode) return e.preventDefault();
    draggingStat = e.currentTarget.getAttribute('data-stat');
    e.dataTransfer.effectAllowed = 'move';
}

function onStatDragOver(e) {
    if (!layoutEditMode || !draggingStat) return;
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function onStatDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function onStatDrop(e) {
    if (!layoutEditMode || !draggingStat) return;
    e.preventDefault();
    const targetKey = e.currentTarget.getAttribute('data-stat');
    e.currentTarget.classList.remove('drag-over');
    if (draggingStat === targetKey) return;
    const order = normalizeOrder(UI_PREFS.statOrder, STAT_KEYS);
    const fromIdx = order.indexOf(draggingStat);
    const toIdx = order.indexOf(targetKey);
    if (fromIdx === -1 || toIdx === -1) return;
    order.splice(fromIdx, 1);
    order.splice(toIdx, 0, draggingStat);
    UI_PREFS.statOrder = order;
    applyStatOrder();
    persistUiPrefs();
}

function getBlockContainerKey(el) {
    const container = el ? el.closest('[data-block-container]') : null;
    return container ? container.getAttribute('data-block-container') : null;
}

function createDragPreview(el) {
    const clone = el.cloneNode(true);
    clone.querySelectorAll('.edit-controls, .edit-hint').forEach(n => n.remove());
    const rect = el.getBoundingClientRect();
    clone.style.width = `${rect.width}px`;
    clone.style.maxWidth = `${rect.width}px`;
    clone.style.height = `${Math.min(rect.height, 260)}px`;
    clone.style.maxHeight = `${Math.min(rect.height, 260)}px`;
    clone.style.margin = '0';
    clone.style.overflow = 'hidden';
    clone.style.borderRadius = '14px';
    clone.classList.add('drag-ghost');
    document.body.appendChild(clone);
    return clone;
}

function clearBlockDragState() {
    document.querySelectorAll('.drag-over, .block-drop-target').forEach(el => {
        el.classList.remove('drag-over');
        el.classList.remove('block-drop-target');
    });
    if (dragPreview?.parentNode) dragPreview.remove();
    if (draggingBlock?.el) draggingBlock.el.classList.remove('dragging');
    draggingBlock = null;
    dragPreview = null;
}

function onBlockDragStart(e) {
    if (!layoutEditMode) return e.preventDefault();
    const block = e.currentTarget;
    const key = block.getAttribute('data-block-key');
    draggingBlock = { key, el: block, from: getBlockContainerKey(block) };
    block.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', key);
    dragPreview = createDragPreview(block);
    e.dataTransfer.setDragImage(dragPreview, dragPreview.offsetWidth / 2, dragPreview.offsetHeight / 2);
}

function onBlockDragEnd() {
    clearBlockDragState();
}

function onBlockDragOverBlock(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function onBlockDragLeaveBlock(e) {
    e.currentTarget.classList.remove('drag-over');
}

function onBlockDragOverContainer(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    e.currentTarget.classList.add('block-drop-target');
}

function onBlockDragLeaveContainer(e) {
    e.currentTarget.classList.remove('block-drop-target');
}

function moveBlockTo(zone, beforeKey = null) {
    if (!draggingBlock || !zone || !BLOCK_CONTAINERS.includes(zone)) return;
    const key = draggingBlock.key;
    const order = normalizeBlockOrder(UI_PREFS.blockOrder, DEFAULT_BLOCK_ORDER);
    Object.keys(order).forEach(k => {
        order[k] = order[k].filter(item => item !== key);
    });
    order[zone] = order[zone] || [];
    if (beforeKey && order[zone].includes(beforeKey)) {
        const idx = order[zone].indexOf(beforeKey);
        order[zone].splice(idx, 0, key);
    } else {
        order[zone].push(key);
    }
    UI_PREFS.blockOrder = normalizeBlockOrder(order, DEFAULT_BLOCK_ORDER);
    applyBlockOrder();
    persistUiPrefs();
}

function onBlockDropOnBlock(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    const target = e.currentTarget;
    const targetKey = target.getAttribute('data-block-key');
    const zone = getBlockContainerKey(target);
    target.classList.remove('drag-over');
    if (zone && draggingBlock.key !== targetKey) {
        moveBlockTo(zone, targetKey);
    }
    clearBlockDragState();
}

function onBlockDropOnContainer(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    const zone = e.currentTarget.getAttribute('data-block-container');
    e.currentTarget.classList.remove('block-drop-target');
    if (zone) moveBlockTo(zone, null);
    clearBlockDragState();
}

function toggleLayoutEditMode() {
    layoutEditMode = !layoutEditMode;
    layoutEditSnapshot = layoutEditMode ? JSON.parse(JSON.stringify(UI_PREFS)) : null;
    setupEditableBlocks();
    if (!layoutEditMode) {
        clearBlockDragState();
    }
}

function updateLayoutEditButton() {
    const iconUse = document.querySelector('#layoutEditIcon use');
    const label = document.getElementById('layoutEditLabel');
    const cancelBtn = document.getElementById('layoutEditCancel');
    if (iconUse) iconUse.setAttribute('href', layoutEditMode ? '#icon-check' : '#icon-pen');
    if (label) label.textContent = layoutEditMode ? '–ì–æ—Ç–æ–≤–æ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫–∏';
    if (cancelBtn) cancelBtn.style.display = layoutEditMode ? 'flex' : 'none';
}

function cancelLayoutEditMode() {
    if (!layoutEditMode) return;
    if (layoutEditSnapshot) {
        UI_PREFS = JSON.parse(JSON.stringify(layoutEditSnapshot));
        persistUiPrefs();
        applyBlockOrder();
        applyBlockVisibility();
        applyTableVisibility();
        applyStatOrder();
        applyStatVisibility();
    }
    layoutEditMode = false;
    clearBlockDragState();
    setupEditableBlocks();
    layoutEditSnapshot = null;
}

function activateSettingsPane(pane) {
    document.querySelectorAll('.settings-nav-btn').forEach(btn => {
        const target = btn.getAttribute('data-target');
        btn.classList.toggle('active', target === pane);
    });
    document.querySelectorAll('.settings-pane').forEach(p => {
        const target = p.getAttribute('data-pane');
        p.classList.toggle('active', target === pane);
    });
}

function isTableEnabled(key) {
    const visibility = UI_PREFS.tableVisibility || {};
    return visibility[key] !== false;
}

function getEnabledTabs() {
    return ['all','active','waiting','potential','requests','paused','archive','trash'].filter(tab => {
        if (['waiting','requests','paused'].includes(tab)) return isTableEnabled(tab);
        return true;
    });
}

function applyTableVisibility() {
    ['waiting','requests','paused'].forEach(key => {
        const tabEl = document.getElementById(`tab-${key}`);
        const viewEl = document.getElementById(`view-${key}`);
        const enabled = isTableEnabled(key);
        if (tabEl) tabEl.classList.toggle('is-hidden', !enabled);
        if (viewEl) viewEl.style.display = enabled ? (currentTab === key ? 'block' : 'none') : 'none';
    });
    updateBulkMoveOptions();
    updateStatusSelectOptions();
    const available = getEnabledTabs();
    if (!available.includes(currentTab) && available.length) {
        const fallback = available.includes('active') ? 'active' : available[0];
        if (fallback !== currentTab) switchTab(fallback);
    }
}

function updateBulkMoveOptions() {
    const select = document.getElementById('bulkMoveSelect');
    if (!select) return;
    const visibility = UI_PREFS.tableVisibility || {};
    Array.from(select.options).forEach(opt => {
        if (['waiting','paused','requests'].includes(opt.value)) {
            const enabled = visibility[opt.value] !== false;
            opt.hidden = !enabled;
        }
    });
    if (select.selectedOptions.length && select.selectedOptions[0].hidden) {
        select.value = '';
    }
}

function updateStatusSelectOptions() {
    const visibility = UI_PREFS.tableVisibility || {};
    const select = document.getElementById('add-proj-type');
    if (select) {
        Array.from(select.options).forEach(opt => {
            if (['waiting','paused','requests'].includes(opt.value)) {
                opt.hidden = visibility[opt.value] === false;
            }
        });
        if (select.selectedOptions.length && select.selectedOptions[0].hidden) {
            select.value = 'active';
            handleStatusChange('active');
        }
    }
}

function toggleScrollDirection() {
    const btn = document.getElementById('scrollToggle');
    if (!btn) return;
    const dir = btn.dataset.dir || 'down';
    if (dir === 'down') {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function updateScrollToggle() {
    const btn = document.getElementById('scrollToggle');
    if (!btn) return;
    const nearTop = window.scrollY < 120;
    const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 160;
    const iconId = nearTop ? '#icon-arrow-down' : '#icon-arrow-up';
    btn.innerHTML = `<svg><use href="${iconId}"/></svg>`;
    btn.dataset.dir = nearTop ? 'down' : 'up';
    btn.setAttribute('aria-label', nearTop ? '–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑' : '–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–≤–µ—Ä—Ö');
    btn.style.display = nearTop && nearBottom ? 'none' : 'grid';
}

let scrollbarVisibilityTimer = null;
function showScrollbarsTemporarily() {
    document.body.classList.add('show-scrollbars');
    clearTimeout(scrollbarVisibilityTimer);
    scrollbarVisibilityTimer = setTimeout(() => document.body.classList.remove('show-scrollbars'), 900);
}

function setupScrollbarAutoHide() {
    document.addEventListener('scroll', showScrollbarsTemporarily, true);
    document.addEventListener('wheel', showScrollbarsTemporarily, { passive: true });
}

function formatNumberInput(inputEl) {
    if (!inputEl) return;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    if (!inputEl.__calcState) {
        inputEl.__calcState = { timeout: null };

        const applyCalculation = () => {
            const raw = String(inputEl.value || '').replace(/\s+/g, '').replace(/,/g, '.');
            if (!raw || /[^0-9+\-*/().k–∫]/i.test(raw)) return;
            const result = toNumeric(raw);
            if (result !== undefined && isFinite(result)) {
                inputEl.value = formatPlainNumber(result);
            }
        };

        inputEl.addEventListener('blur', applyCalculation);
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                applyCalculation();
                inputEl.blur();
            }
        });
    }

    const val = String(inputEl.value || '');
    const state = inputEl.__calcState;

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –æ—Å—Ç–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∏ —Å—á–∏—Ç–∞–µ–º –ø–æ–∑–∂–µ
    if (/[+\-*/]/.test(val)) {
        const cleaned = val.replace(/[^0-9+\-*/().,k–∫]/gi, '');
        inputEl.value = cleaned;
        clearTimeout(state.timeout);
        state.timeout = setTimeout(() => {
            if (document.activeElement === inputEl) return;
            state.timeout = null;
            inputEl.dispatchEvent(new Event('blur'));
        }, 1000);
        return;
    }

    const numeric = toNumeric(val.replace(/\s+/g, '').replace(/,/g, '.'));
    inputEl.value = val ? formatPlainNumber(numeric) : '';
}

const DEFAULT_NAME_TEMPLATES = [
    '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –í–ö–æ–Ω—Ç–∞–∫—Ç–µ',
    '–î–∏–∑–∞–π–Ω –±–∞–Ω–Ω–µ—Ä–æ–≤',
    '–î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ –í–ë',
    '–î–∏–∑–∞–π–Ω –ª–æ–≥–æ—Ç–∏–ø–∞',
    '–î–∏–∑–∞–π–Ω –ª–µ–Ω–¥–∏–Ω–≥–∞'
];
const TEMPLATE_HELPER_DEFAULT = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ —à–∞–±–ª–æ–Ω.';

let NAME_TEMPLATES = [...DEFAULT_NAME_TEMPLATES];
let draggedTemplate = null;
let draggedTemplateIndex = null;
let activeTemplateSelection = '';

function loadNameTemplates() {
    try {
        const raw = localStorage.getItem(NAME_TEMPLATES_KEY);
        if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) NAME_TEMPLATES = parsed;
        }
    } catch(e) { console.warn('Template load failed', e); }
    refreshTemplateSelects();
}

function refreshTemplateSelects() {
    const list = document.getElementById('project-name-templates');
    if (!list) return;
    list.innerHTML = NAME_TEMPLATES.map(t=>`<option value="${t}">`).join('');
    renderTemplatePills();
    renderTemplateManagerList();
}

function persistNameTemplates() {
    localStorage.setItem(NAME_TEMPLATES_KEY, JSON.stringify(NAME_TEMPLATES.slice(0, 20)));
    save();
}

function setTemplateHelper(message, state = '', autoReset = false) {
    const helper = document.getElementById('template-helper');
    if (!helper) return;
    if (templateHelperTimeout) { clearTimeout(templateHelperTimeout); templateHelperTimeout = null; }
    helper.textContent = message;
    helper.classList.remove('error', 'success');
    if (state) helper.classList.add(state);
    if (autoReset) {
        templateHelperTimeout = setTimeout(() => {
            helper.textContent = TEMPLATE_HELPER_DEFAULT;
            helper.classList.remove('error', 'success');
        }, 3200);
    }
}

function setTemplateManagerHelper(message, state = '') {
    const helper = document.getElementById('template-manager-helper');
    if (!helper) return;
    helper.textContent = message;
    helper.classList.remove('error', 'success');
    if (state) helper.classList.add(state);
}

function renderTemplatePills() {
    const pills = document.getElementById('saved-template-pills');
    if (!pills) return;
    if (!NAME_TEMPLATES.length) {
        pills.innerHTML = '<span style="color: var(--muted);">–®–∞–±–ª–æ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</span>';
        pills.classList.remove('can-scroll', 'scrolled', 'scroll-end');
        return;
    }
    pills.innerHTML = NAME_TEMPLATES.map(t => {
        const safe = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const safeArg = t.replace(/'/g,"\\'");
        return `
        <span class="template-pill" draggable="true"
            ondragstart="onTemplateDragStart('${safeArg}')"
            ondragover="onTemplateDragOver(event, '${safeArg}')"
            ondragleave="onTemplateDragLeave(event)"
            ondrop="onTemplateDrop(event, '${safeArg}')"
            ondragend="onTemplateDragEnd()">
            <button class="template-fill-btn" type="button" onclick="applyNameTemplate('${safeArg}')">${safe}</button>
            <button aria-label="–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω" class="template-delete-btn" onclick="deleteNameTemplate('${safeArg}')">√ó</button>
        </span>`;
    }).join('');
    attachTemplateScrollHandler(pills);
    updateTemplateScrollState(pills);
}

function renderTemplateManagerList() {
    const list = document.getElementById('template-manager-list');
    if (!list) return;
    if (!NAME_TEMPLATES.length) {
        list.innerHTML = '<div class="template-empty">–®–∞–±–ª–æ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω¬ª.</div>';
        return;
    }
    const currentName = (document.getElementById('add-proj-name')?.value || '').trim();
    list.innerHTML = NAME_TEMPLATES.map((t, idx) => {
        const safe = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        const safeArg = t.replace(/'/g,"\\'");
        const isSelected = currentName === t || activeTemplateSelection === t;
        const rowClass = isSelected ? 'template-row selected' : 'template-row';
        const selectBtnClass = isSelected ? 'template-select-btn is-active' : 'template-select-btn';
        return `
        <div class="${rowClass}" draggable="true"
            ondragstart="templateRowDragStart(${idx})"
            ondragover="templateRowDragOver(event, ${idx})"
            ondragleave="templateRowDragLeave(event)"
            ondrop="templateRowDrop(event, ${idx})"
            ondragend="templateRowDragEnd()">
            <span class="template-drag-handle">‚â°</span>
            <button class="${selectBtnClass}" type="button" onclick="selectTemplateFromManager('${safeArg}')">‚úì</button>
            <input type="text" value="${safe}" onblur="commitTemplateEdit(${idx}, this)" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞">
            <button aria-label="–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω" class="template-delete-btn" onclick="deleteNameTemplate('${safeArg}')">√ó</button>
        </div>`;
    }).join('');
}

function toggleProjectNameClear() {
    const input = document.getElementById('add-proj-name');
    const btn = document.getElementById('project-name-clear');
    if (!input || !btn) return;
    const hasValue = !!input.value.trim();
    btn.classList.toggle('hidden', !hasValue);
}

function clearProjectName() {
    const input = document.getElementById('add-proj-name');
    if (!input) return;
    input.value = '';
    toggleProjectNameClear();
    input.focus();
}

function applyNameTemplate(val) {
    if (!val) return;
    const input = document.getElementById('add-proj-name');
    if (input) {
        input.value = val;
        input.focus();
        toggleProjectNameClear();
        activeTemplateSelection = val;
        setTemplateHelper('–®–∞–±–ª–æ–Ω –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ –ø–æ–ª–µ.', 'success', true);
    }
}

function saveNameTemplate() {
    const input = document.getElementById('add-proj-name');
    if (!input) return;
    const val = input.value.trim();
    if (!val) {
        input.classList.add('input-error');
        setTemplateHelper('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω.', 'error');
        input.focus();
        return;
    }
    if (!NAME_TEMPLATES.includes(val)) {
        NAME_TEMPLATES.unshift(val);
        persistNameTemplates();
        refreshTemplateSelects();
        showToast('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        setTemplateHelper('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫.', 'success', true);
        setTemplateManagerHelper('–®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫.', 'success');
    } else {
        setTemplateHelper('–¢–∞–∫–æ–π —à–∞–±–ª–æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ.', '');
    }
}

function addTemplateFromModal() {
    const input = document.getElementById('template-manager-input');
    if (!input) return;
    const val = input.value.trim();
    if (!val) {
        setTemplateManagerHelper('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω.', 'error');
        input.focus();
        return;
    }
    if (!NAME_TEMPLATES.includes(val)) {
        NAME_TEMPLATES.unshift(val);
        persistNameTemplates();
        refreshTemplateSelects();
        setTemplateManagerHelper('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫.', 'success');
    } else {
        setTemplateManagerHelper('–¢–∞–∫–æ–π —à–∞–±–ª–æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ.', 'error');
    }
    applyNameTemplate(val);
    renderTemplateManagerList();
    input.value = '';
}

function deleteNameTemplate(val) {
    NAME_TEMPLATES = NAME_TEMPLATES.filter(t => t !== val);
    if (activeTemplateSelection === val) activeTemplateSelection = '';
    persistNameTemplates();
    refreshTemplateSelects();
}

function onTemplateDragStart(val) {
    draggedTemplate = val;
}

function onTemplateDragOver(event, targetVal) {
    event.preventDefault();
    if (!draggedTemplate || draggedTemplate === targetVal) return;
    event.currentTarget.classList.add('drag-over');
}

function onTemplateDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

function onTemplateDrop(event, targetVal) {
    event.preventDefault();
    const fromIdx = NAME_TEMPLATES.indexOf(draggedTemplate);
    const toIdx = NAME_TEMPLATES.indexOf(targetVal);
    if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
    NAME_TEMPLATES.splice(fromIdx, 1);
    NAME_TEMPLATES.splice(toIdx, 0, draggedTemplate);
    persistNameTemplates();
    refreshTemplateSelects();
}

function onTemplateDragEnd() {
    draggedTemplate = null;
    document.querySelectorAll('.template-pill.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function templateRowDragStart(idx) {
    draggedTemplateIndex = idx;
}

function templateRowDragOver(event, idx) {
    if (draggedTemplateIndex === null || draggedTemplateIndex === idx) return;
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function templateRowDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

function templateRowDrop(event, idx) {
    event.preventDefault();
    if (draggedTemplateIndex === null || draggedTemplateIndex === idx) return;
    const [moved] = NAME_TEMPLATES.splice(draggedTemplateIndex, 1);
    NAME_TEMPLATES.splice(idx, 0, moved);
    draggedTemplateIndex = null;
    persistNameTemplates();
    refreshTemplateSelects();
    renderTemplateManagerList();
}

function templateRowDragEnd() {
    draggedTemplateIndex = null;
    document.querySelectorAll('.template-row.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function commitTemplateEdit(idx, inputEl) {
    if (!inputEl || idx < 0 || idx >= NAME_TEMPLATES.length) return;
    const val = inputEl.value.trim();
    if (!val) {
        inputEl.value = NAME_TEMPLATES[idx];
        return;
    }
    const duplicateIdx = NAME_TEMPLATES.findIndex((t, i) => t === val && i !== idx);
    if (duplicateIdx !== -1) {
        inputEl.value = NAME_TEMPLATES[idx];
        setTemplateHelper('–¢–∞–∫–æ–π —à–∞–±–ª–æ–Ω —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ.', '');
        return;
    }
    NAME_TEMPLATES[idx] = val;
    persistNameTemplates();
    refreshTemplateSelects();
    renderTemplateManagerList();
}

function openTemplateManagerModal() {
    const modal = document.getElementById('templateManagerModal');
    if (!modal) return;
    modal.style.display = 'flex';
    const inlineInput = document.getElementById('add-proj-name');
    const modalInput = document.getElementById('template-manager-input');
    if (modalInput && inlineInput) modalInput.value = inlineInput.value.trim();
    setTemplateManagerHelper('–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ.');
    renderTemplateManagerList();
}

function closeTemplateManagerModal() {
    document.getElementById('templateManagerModal').style.display = 'none';
}

function selectTemplateFromManager(val) {
    applyNameTemplate(val);
    closeTemplateManagerModal();
    renderTemplateManagerList();
    setTemplateManagerHelper('–®–∞–±–ª–æ–Ω –≤—ã–±—Ä–∞–Ω.', 'success');
}

function attachTemplateScrollHandler(pills) {
    if (!pills || pills.dataset.scrollBound) return;
    const handler = () => updateTemplateScrollState(pills);
    pills.addEventListener('scroll', handler, { passive: true });
    window.addEventListener('resize', handler);
    pills.dataset.scrollBound = '1';
}

function updateTemplateScrollState(pills) {
    if (!pills) return;
    const hasOverflow = pills.scrollWidth > pills.clientWidth + 2;
    const atStart = pills.scrollLeft <= 4;
    const atEnd = pills.scrollLeft + pills.clientWidth >= pills.scrollWidth - 4;
    pills.classList.toggle('can-scroll', hasOverflow);
    pills.classList.toggle('scrolled', hasOverflow && !atStart);
    pills.classList.toggle('scroll-end', hasOverflow && atEnd);
}

function handleNewContractorModeChange(mode) {
    const input = document.getElementById('add-proj-contractor');
    const helper = document.getElementById('add-contractor-helper');
    const wrapper = document.getElementById('contractor-amount-wrap');
    const suffix = document.getElementById('contractor-suffix');
    if (!input || !helper || !wrapper || !suffix) return;
    const showInput = mode !== 'none';
    wrapper.classList.toggle('is-hidden', !showInput);
    helper.textContent = '';
    helper.classList.add('is-hidden');
    input.disabled = !showInput;
    if (!showInput) {
        input.value = '';
        suffix.textContent = '';
        return;
    }
    const isPercent = mode === 'percent';
    input.placeholder = isPercent ? '–ù–∞–ø—Ä–∏–º–µ—Ä, 20' : '–ù–∞–ø—Ä–∏–º–µ—Ä, 30 000';
    suffix.textContent = isPercent ? '%' : '‚ÇΩ';
    input.focus();
}

let DATA = {
    settings: { record: 0 },
    monthlyGoals: { [currentMonth]: 250000 },
    active: [], archive: [], paused: [], waiting: [], potential: [], requests: [], trash: []
};

let SORT = { active: 'dl', archive: 'date', potential: 'p', waiting: 'p', paused: 'dl', requests: 'created' };
let queue = { type: null, idx: null, field: null, targetId: null };
let previousDeadlineValue = '';
let deadlineUnset = false;
let editContext = null;
let toastTimeout = null;
let templateHelperTimeout = null;
let lastPermanentDeletion = null;
let lastTrashMove = null;
let completionContext = null;
let projectFormSnapshot = null;
let newProjectLink = '';
let newProjectLinkTitle = '';
let lastFetchedLinkForTitle = '';
let datePicker = null;
let timePicker = null;

function buildBackupSnapshot() {
    return {
        version: 2,
        data: DATA,
        uiPrefs: UI_PREFS,
        nameTemplates: NAME_TEMPLATES,
        theme: UI_PREFS.themeMode
    };
}

function showToast(message, actionText = '', actionHandler = null, duration = 3500) {
    const toast = document.getElementById('toast');
    const msgEl = document.getElementById('toast-message');
    const actionBtn = document.getElementById('toast-action');

    msgEl.textContent = message;

    if (actionText && actionHandler) {
        actionBtn.textContent = actionText;
        actionBtn.style.display = 'inline-flex';
        actionBtn.onclick = () => { actionHandler(); hideToast(); };
    } else {
        actionBtn.style.display = 'none';
        actionBtn.onclick = null;
    }

    toast.classList.add('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => hideToast(), duration);
}

function hideToast() {
    const toast = document.getElementById('toast');
    toast.classList.remove('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = null;
}

function undoPermanentDelete() {
    if (!lastPermanentDeletion) return;

    const entries = Array.isArray(lastPermanentDeletion) ? lastPermanentDeletion : [lastPermanentDeletion];

    entries.forEach(({ type, items }) => {
        const targetList = DATA[type];
        if (!Array.isArray(targetList) || !Array.isArray(items)) return;

        items
            .slice()
            .sort((a, b) => a.index - b.index)
            .forEach(({ item, index }) => {
                targetList.splice(index, 0, item);
            });
    });

    lastPermanentDeletion = null;
    save();
    upd();
    showToast('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
}

function undoMoveToTrash() {
    if (!lastTrashMove) return;

    const entries = Array.isArray(lastTrashMove) ? lastTrashMove : [lastTrashMove];

    entries.forEach(({ type, items }) => {
        if (!Array.isArray(DATA[type]) || !Array.isArray(items)) return;

        items
            .slice()
            .sort((a, b) => a.index - b.index)
            .forEach(({ item, index }) => {
                const trashIndex = DATA.trash.indexOf(item);
                if (trashIndex > -1) DATA.trash.splice(trashIndex, 1);
                delete item.deletedAt;
                DATA[type].splice(Math.max(0, Math.min(index, DATA[type].length)), 0, item);
            });
    });

    lastTrashMove = null;
    save();
    upd();
    showToast('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
}

// --- BULK ACTIONS ---
let selectedRows = {}; // {active: Set(), waiting: Set(), ...}
const TRASH_RETENTION_DAYS = 30;

function renderLinkControls(item, idx, type) {
    const hasLink = !!item.link;
    const editBtn = `<button class="link-btn ${hasLink ? 'link-btn-active' : ''}" onclick="openLink('${type}',${idx})" title="${hasLink ? '–ò–∑–º–µ–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É' : '–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É'}"><svg><use href="#icon-link"/></svg></button>`;
    const goBtn = hasLink ? `<button class="link-btn link-btn-go" onclick="openProjectLink(${idx}, '${type}')" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É"><svg><use href="#icon-external"/></svg></button>` : '';
    return editBtn + goBtn;
}

function normalizeLinkValue(raw, isTelegram = false) {
    let url = (raw || '').trim();
    const isTg = isTelegram || url.startsWith('@') || url.match(/t\.me\//);

    if (isTg) {
        url = url.replace(/^https?:\/\/t\.me\//, '').replace(/^@+/, '');
        return url ? `https://t.me/${url}` : '';
    }

    if (url && !url.match(/^(https?:\/\/|mailto:)/)) {
        url = 'https://' + url;
    }

    return url;
}

function getClientNameClass(item) {
    return `client-name${item.link ? ' has-link' : ''}`;
}

function toggleSelect(type, idx, checkbox) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    const row = checkbox.closest('tr');
    const indexStr = type === 'all' ? (checkbox.dataset.key || idx.toString()) : idx.toString();

    if (checkbox.checked) {
        selectedRows[type].add(indexStr);
        if (row) row.classList.add('row-selected');
    } else {
        selectedRows[type].delete(indexStr);
        if (row) row.classList.remove('row-selected');
    }
    updateBulkToolbar(type);

    const totalRows = type === 'all' ? document.querySelectorAll('#t-all tbody tr').length : DATA[type].length;
    const allChecked = selectedRows[type].size === totalRows && totalRows > 0;
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if(selectAllCheckbox) selectAllCheckbox.checked = allChecked;
}

function toggleSelectAll(type) {
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (!selectAllCheckbox) return;

    const isChecked = selectAllCheckbox.checked;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);

    if (!selectedRows[type]) selectedRows[type] = new Set();
    
    checkboxes.forEach((cb, i) => {
        cb.checked = isChecked;
        const row = cb.closest('tr');
        const indexStr = type === 'all' ? (cb.dataset.key || row?.dataset.index) : row?.dataset.index;
        if (row && indexStr) {
            row.classList.toggle('row-selected', isChecked);
            if (isChecked) {
                selectedRows[type].add(indexStr);
            } else {
                selectedRows[type].delete(indexStr);
            }
        }
    });
    updateBulkToolbar(type);
}

function toggleFooterSelection(type) {
    if (type !== 'all' && !DATA[type]) return;
    const rows = document.querySelectorAll(`#t-${type} tbody tr`);
    const totalRows = rows.length;
    if (!selectedRows[type]) selectedRows[type] = new Set();
    if (totalRows === 0) { clearSelection(type); return; }

    const shouldSelectAll = selectedRows[type].size !== totalRows;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);

    if (checkboxes.length > 0) {
        checkboxes.forEach(cb => {
            cb.checked = shouldSelectAll;
            const row = cb.closest('tr');
            if (row && row.dataset.index) {
                const indexStr = row.dataset.index;
                row.classList.toggle('row-selected', shouldSelectAll);
                if (shouldSelectAll) {
                    selectedRows[type].add(indexStr);
                } else {
                    selectedRows[type].delete(indexStr);
                }
            }
        });
    } else {
        rows.forEach(row => {
            const indexStr = type === 'all' ? row.dataset.index : row.dataset.index;
            row.classList.toggle('row-selected', shouldSelectAll);
            if (indexStr) {
                if (shouldSelectAll) {
                    selectedRows[type].add(indexStr);
                } else {
                    selectedRows[type].delete(indexStr);
                }
            }
        });
    }

    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (selectAllCheckbox) selectAllCheckbox.checked = shouldSelectAll;
    updateBulkToolbar(type);
}

function updateBulkToolbar(type) {
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    const toolbar = document.getElementById('bulkToolbar');
    
    document.getElementById('bulkCount').textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
    document.getElementById('bulkMoveSelect').value = ''; 

    toolbar.style.display = count > 0 ? 'flex' : 'none';
}

function attachRowSelection(tr, type, idx, checkboxId) {
    tr.addEventListener('click', (e) => {
        if (e.target.closest('input, select, button, .action-btn-base, .del-btn, .date-input-wrap, .dup-icon, [contenteditable], .trash-action-btns, .link-btn, .inline-link-btn')) return;
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox) return;
        checkbox.checked = !checkbox.checked;
        toggleSelect(type, idx, checkbox);
    });
}

function clearSelection(type = currentTab) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    selectedRows[type].clear();

    document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`).forEach(cb => cb.checked = false);
    document.querySelectorAll(`#t-${type} tbody tr`).forEach(tr => tr.classList.remove('row-selected'));

    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    updateBulkToolbar(type);
}

function getAllSelectionEntries() {
    if (!selectedRows.all || selectedRows.all.size === 0) return [];
    return Array.from(selectedRows.all).map(key => {
        const [srcType, idxStr] = key.split(':');
        return { type: srcType, idx: Number(idxStr) };
    }).filter(entry => DATA[entry.type] && Number.isInteger(entry.idx) && entry.idx >= 0 && entry.idx < DATA[entry.type].length);
}

function formatItemsWord(count) {
    const mod10 = count % 10;
    const mod100 = count % 100;
    if (mod10 === 1 && mod100 !== 11) return '—ç–ª–µ–º–µ–Ω—Ç';
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return '—ç–ª–µ–º–µ–Ω—Ç–∞';
    return '—ç–ª–µ–º–µ–Ω—Ç–æ–≤';
}

function askBulkDelete(type = currentTab) {
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    if (count === 0) return;

    const isTrash = type === 'trash';
    const word = formatItemsWord(count);
    document.getElementById('del-modal-title').innerText = isTrash ? `–£–¥–∞–ª–∏—Ç—å ${count} ${word} –Ω–∞–≤—Å–µ–≥–¥–∞?` : `–£–¥–∞–ª–∏—Ç—å ${count} ${word} –≤ –∫–æ—Ä–∑–∏–Ω—É?`;
    document.getElementById('del-modal-desc').innerText = isTrash ? "–≠–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ." : `–û–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è ${TRASH_RETENTION_DAYS} –¥–Ω–µ–π.`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = isTrash ? '–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞' : '–£–¥–∞–ª–∏—Ç—å';
    document.getElementById('finalDeleteBtn').onclick = () => bulkDelete(type, isTrash);
}

function bulkDelete(type = currentTab, deleteForever = false) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;

    const processDeletion = (sourceType, indices) => {
        const deletedItems = [];
        indices.sort((a, b) => b - a).forEach(idx => {
            const itemIndex = DATA[sourceType].findIndex((_, i) => i === idx);
            if (itemIndex > -1) {
                const item = DATA[sourceType].splice(itemIndex, 1)[0];
                deletedItems.push({ item, index: itemIndex });
                if (!deleteForever) {
                    item.deletedAt = Date.now();
                    DATA.trash.unshift(item);
                }
            }
        });
        return deletedItems;
    };

    const deletionsLog = [];
    if (type === 'all') {
        const grouped = {};
        getAllSelectionEntries().forEach(({ type: src, idx }) => {
            if (!grouped[src]) grouped[src] = [];
            grouped[src].push(idx);
        });
        Object.entries(grouped).forEach(([src, list]) => {
            const removed = processDeletion(src, list);
            if (removed.length) deletionsLog.push({ type: src, items: removed });
        });
    } else {
        const indicesToDelete = Array.from(selectedRows[type]).map(Number);
        const removed = processDeletion(type, indicesToDelete);
        if (removed.length) deletionsLog.push({ type, items: removed });
    }

    lastPermanentDeletion = deleteForever ? deletionsLog : null;
    lastTrashMove = deleteForever ? null : deletionsLog;

    selectedRows[type].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    save(); upd();
    if (deleteForever) {
        showToast('–£–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞', '–û—Ç–º–µ–Ω–∞', undoPermanentDelete);
    } else {
        const movedCount = deletionsLog.reduce((acc, entry) => acc + entry.items.length, 0);
        showToast(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É: ${movedCount}`, '–û—Ç–º–µ–Ω–∏—Ç—å', undoMoveToTrash);
    }
}

function bulkDuplicate(type = currentTab) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;

    const addCopies = (sourceType, indices) => {
        const newItems = [];
        indices.sort((a, b) => a - b).forEach(idx => {
            const item = JSON.parse(JSON.stringify(DATA[sourceType].find((_, i) => i === idx)));
            if(item) {
                 item.n = item.n + " (–ö–æ–ø–∏—è)";
                 newItems.push(item);
            }
        });
        if (newItems.length) {
            DATA[sourceType].unshift(...newItems);
        }
    };

    if (type === 'all') {
        const grouped = {};
        getAllSelectionEntries().forEach(({ type: src, idx }) => {
            if (!grouped[src]) grouped[src] = [];
            grouped[src].push(idx);
        });
        Object.entries(grouped).forEach(([src, list]) => addCopies(src, list));
    } else {
        const indicesToDuplicate = Array.from(selectedRows[type]).map(Number);
        addCopies(type, indicesToDuplicate);
    }

    selectedRows[type].clear();
    save(); upd();
}

function askBulkMove(targetType) {
    const currentType = currentTab;
    const count = selectedRows[currentType] ? selectedRows[currentType].size : 0;
    
    if (count === 0 || !targetType) {
        document.getElementById('bulkMoveSelect').value = '';
        return;
    }
    
    const targetName = document.querySelector(`#bulkMoveSelect option[value="${targetType}"]`).text;
    const tabNames = {
        active: '–í —Ä–∞–±–æ—Ç–µ',
        waiting: '–û–∂–∏–¥–∞–µ—Ç',
        potential: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª',
        paused: '–ù–∞ –ø–∞—É–∑–µ',
        archive: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
        requests: '–í –∑–∞—è–≤–∫–∏',
        all: '–í—Å–µ',
        trash: '–ö–æ—Ä–∑–∏–Ω–∞'
    };
    const sourceName = tabNames[currentType] || document.getElementById(`tab-${currentType}`)?.textContent.replace(/\s+\d+$/, '').trim();

    const word = formatItemsWord(count);
    document.getElementById('del-modal-title').innerText = `–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ${count} ${word} –≤ "${targetName}"?`;
    document.getElementById('del-modal-desc').innerText = `–ü—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "${sourceName || ''}".`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').innerText = '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏';
    
    document.getElementById('finalDeleteBtn').onclick = () => bulkMove(currentType, targetType);
}

function bulkMove(from, to) {
    if (!selectedRows[from] || selectedRows[from].size === 0) return;

    const moveItemToTarget = (item) => {
        if (to === 'requests') {
            DATA.requests.unshift({
                name: item.c || item.n || '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞',
                source: item.n ? `–ü—Ä–æ–µ–∫—Ç: ${item.n}` : '–ü—Ä–æ–µ–∫—Ç',
                note: item.n || '‚Äî',
                link: normalizeLinkValue(item.link || ''),
                budget: toNumeric(item.p),
                created: new Date().toISOString()
            });
            return null;
        }
        if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
        if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
        if(to === 'potential' || to === 'waiting' || to === 'paused') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
        return item;
    };

    const processMoves = (sourceType, indices) => {
        indices.sort((a, b) => b - a).forEach(idx => {
            const itemIndex = DATA[sourceType].findIndex((_, i) => i === idx);
            if (itemIndex > -1) {
                const item = DATA[sourceType].splice(itemIndex, 1)[0];
                const prepared = moveItemToTarget(item);
                if (prepared) {
                    DATA[to].unshift(prepared);
                }
            }
        });
    };

    if (from === 'all') {
        const grouped = {};
        getAllSelectionEntries().forEach(({ type: src, idx }) => {
            if (!grouped[src]) grouped[src] = [];
            grouped[src].push(idx);
        });
        Object.entries(grouped).forEach(([src, list]) => processMoves(src, list));
    } else {
        const indicesToMove = Array.from(selectedRows[from]).map(Number);
        processMoves(from, indicesToMove);
    }

    selectedRows[from].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.getElementById('bulkMoveSelect').value = '';
    save();
    if(from === to) {
        upd();
    } else {
        switchTab(to);
    }
}

function init(){
    let exist = localStorage.getItem(K);
    if(!exist) { const v4 = localStorage.getItem('grok_design_v4'); if(v4) exist = v4; }

    if (exist) {
        try {
            const parsed = JSON.parse(exist);
            const payload = parsed?.data ? parsed : { data: parsed };
            DATA = { ...DATA, ...(payload.data || {}) };
            if(!DATA.trash) DATA.trash = [];
            if(!DATA.requests) DATA.requests = [];
            ['active', 'archive', 'paused', 'waiting', 'potential'].forEach(type => {
                 DATA[type].forEach(i => {
                    if(i.contractor === undefined) i.contractor = 0;
                    if(i.taxPrc === undefined) i.taxPrc = 0;
                    if(!i.contractorMode) i.contractorMode = i.contractor ? 'amount' : 'none';
                 });
            });
            if (payload.uiPrefs) {
                localStorage.setItem(UI_PREFS_KEY, JSON.stringify(payload.uiPrefs));
            }
            if (Array.isArray(payload.nameTemplates)) {
                NAME_TEMPLATES = payload.nameTemplates;
                localStorage.setItem(NAME_TEMPLATES_KEY, JSON.stringify(NAME_TEMPLATES));
            }
            if (!payload.uiPrefs && payload.theme) {
                const themed = { ...UI_PREFS, themeMode: payload.theme };
                localStorage.setItem(UI_PREFS_KEY, JSON.stringify(themed));
            }
        } catch(e) { console.error("Data load error", e); }
    }

    hydrateArchiveCompletionMeta();
    loadUiPrefs();
    initTheme();
    loadNameTemplates();
    setTemplateHelper(TEMPLATE_HELPER_DEFAULT);
    const nameInput = document.getElementById('add-proj-name');
    if (nameInput) {
        nameInput.addEventListener('input', () => {
            nameInput.classList.remove('input-error');
            setTemplateHelper(TEMPLATE_HELPER_DEFAULT);
            toggleProjectNameClear();
        });
        toggleProjectNameClear();
    }
    cleanupTrash();
    applyBlockVisibility();
    updateSettingsPreviewStates();
    applyStatVisibility();
    applyStatOrder();
    applyBlockOrder();
    applyTableVisibility();
    setupEditableBlocks();
    renderMonthSelect();
    setupModalsBackgroundCheck();
    setupDatePickers();
    document.getElementById('saveLinkBtn').onclick = saveLink;
    document.getElementById('add-proj-start-val').value = today;
    document.getElementById('add-proj-dl-val').value = '';
    sortData('active', 'dl', 'date', true);
    ['active','waiting','potential','paused','archive'].forEach(t => {
        DATA[t].sortDirection = DATA[t].sortDirection || 1;
        updateSortIndicators(t);
    });
    const scrollBtn = document.getElementById('scrollToggle');
    if (scrollBtn) scrollBtn.addEventListener('click', toggleScrollDirection);
    setupScrollbarAutoHide();
    showScrollbarsTemporarily();
    updateScrollToggle();
    window.addEventListener('scroll', updateScrollToggle);
    window.addEventListener('resize', updateScrollToggle);
    upd();
}

function save(){
    persistUiPrefs();
    localStorage.setItem(K, JSON.stringify(buildBackupSnapshot()));
}

function cleanupTrash(){
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    const nowMs = Date.now();
    const initLen = DATA.trash.length;
    DATA.trash = DATA.trash.filter(i => (nowMs - (i.deletedAt || 0)) < sevenDays);
    if(DATA.trash.length !== initLen) save();
}

function formatCurrency(n) { return new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ'; }

function formatPrice(value) {
    return formatCurrency(value || 0);
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const parsed = new Date(dateStr);
    if (Number.isNaN(parsed.getTime())) return dateStr;
    const day = String(parsed.getDate()).padStart(2, '0');
    const month = String(parsed.getMonth() + 1).padStart(2, '0');
    const year = parsed.getFullYear();
    return `${day}.${month}.${year}`;
}

function formatDateDisplay(str) {
    if (!str || str.startsWith('0000')) return '‚Äî';
    const hasTime = str.includes('T') && str.length > 10;
    const dateObj = new Date(str.replace(' ', 'T'));
    if(isNaN(dateObj.getTime())) return '‚Äî';
    const d = dateObj.toLocaleDateString('ru', { day: 'numeric', month: 'short' }).replace('.', '');
    if(hasTime) {
        const t = dateObj.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
        return `${d} <span class="time-text">${t}</span>`;
    }
    return d;
}

function formatDeadlineDisplay(str) {
    if (!str) return '<span class="deadline-infinity">‚àû –ù–µ—Ç —Å—Ä–æ–∫–∞</span>';
    const dateObj = new Date(str.replace(' ', 'T'));
    if (isNaN(dateObj.getTime())) return '‚Äî';
    const delta = formatDeadlineDelta(dateObj);
    const dateText = formatDateDisplay(str);
    const overdue = dateObj.getTime() < Date.now();
    if (!delta || overdue) return `<div class="deadline-display"><span class="date-text">${dateText}</span></div>`;
    return `<div class="deadline-display"><span class="date-text">${dateText}</span><span class="deadline-delta ${overdue ? 'overdue' : ''}">${delta}</span></div>`;
}

function formatDeadlineDelta(dateObj) {
    if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return '';
    const now = new Date();
    let diffMs = dateObj.getTime() - now.getTime();
    const overdue = diffMs < 0;
    diffMs = Math.abs(diffMs);

    const days = Math.floor(diffMs / (24 * 60 * 60 * 1000));
    const hours = Math.floor((diffMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));

    if (!days && !hours) return overdue ? '–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' : '—Å–µ–≥–æ–¥–Ω—è';

    const parts = [];
    if (days) parts.push(`${days} –¥`);
    if (hours) parts.push(`${hours} —á`);

    const sign = overdue ? '‚àí' : '';
    return `${sign}${parts.join(' ')}`.trim();
}

function formatDateWithTime(dateObj, timeStr) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    const base = `${y}-${m}-${d}`;
    return timeStr ? `${base}T${timeStr}` : base;
}

// 1. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ (—É–ª—É—á—à–µ–Ω –ê—Ä—Ö–∏–≤)
const getProjectCard = (item, type, index) => {
    // –õ–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –¥–Ω–µ–π (–¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–ª–∏ –∞—Ä—Ö–∏–≤–∞)
    const today = new Date();
    today.setHours(0,0,0,0);
    const dlDate = item.dl ? new Date(item.dl) : null;
    let daysLeftText = '';
    let daysClass = '';

    if (type !== 'archive' && dlDate) {
        const diff = Math.ceil((dlDate - today) / (1000 * 60 * 60 * 24));
        if (diff < 0) { daysLeftText = `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ${Math.abs(diff)} –¥–Ω.`; daysClass = 'text-red'; }
        else if (diff === 0) { daysLeftText = '–°–¥–∞—á–∞ —Å–µ–≥–æ–¥–Ω—è'; daysClass = 'text-orange'; }
        else { daysLeftText = `${diff} –¥–Ω.`; daysClass = 'text-green'; }
    }

    // –õ–æ–≥–∏–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ê–†–•–ò–í–ê (–ù–æ–≤–∞—è)
    let archiveHtml = '';
    if (type === 'archive') {
        const doneDateStr = item.date || formatDate(today); // –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        const doneDateObj = new Date(doneDateStr.split('.').reverse().join('-')); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        
        let statusDot = '';
        
        if (dlDate) {
            // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –î–µ–¥–ª–∞–π–Ω–æ–º –∏ –°–¥–∞—á–µ–π
            const diffTime = dlDate - doneDateObj;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            // –ï—Å–ª–∏ diffDays >= 0 -> –°–¥–∞–ª–∏ –≤–æ–≤—Ä–µ–º—è –∏–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ. –ï—Å–ª–∏ < 0 -> –ü—Ä–æ—Å—Ä–æ—á–∏–ª–∏
            if (diffDays >= 0) {
                const tip = diffDays === 0 ? "–°–¥–∞–Ω–æ —Ä–æ–≤–Ω–æ –≤ —Å—Ä–æ–∫" : `–í –∑–∞–ø–∞—Å–µ –±—ã–ª–æ: ${diffDays} –¥–Ω.`;
                statusDot = `<span class="archive-status-dot status-ok" data-tooltip="${tip}"></span>`;
            } else {
                const overdue = Math.abs(diffDays);
                const tip = `–ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${overdue} –¥–Ω.`;
                statusDot = `<span class="archive-status-dot status-late" data-tooltip="${tip}"></span>`;
            }
        }
        
        archiveHtml = `
            <div class="archive-date-wrapper">
                <span>–°–¥–∞–Ω–æ: ${doneDateStr}</span>
                ${statusDot}
            </div>
        `;
    }

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–ª–æ–∫–∏ (–ø—Ä–æ–≥—Ä–µ—Å—Å, –¥–∞—Ç—ã –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö)
    const showProgress = (type === 'active' || type === 'active_pinned');
    const progressHtml = showProgress ? 
        `<div class="progress-bar"><div class="fill" style="width:${item.progress||0}%"></div></div>` : '';
    
    const dateHtml = (type !== 'archive' && item.dl) ? 
        `<div class="card-meta">
           <span><i class="fa-regular fa-clock"></i> ${formatDate(item.dl)}</span>
           <span class="${daysClass}" style="font-weight:600">${daysLeftText}</span>
         </div>` : '';

    // –ë–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∫–æ–¥)
    let btns = '';
    if(type === 'waiting') btns = `<button onclick="moveItem('waiting','active',${index})" title="–í —Ä–∞–±–æ—Ç—É">‚ñ∂</button>`;
    if(type.startsWith('active')) btns = `<button onclick="completeProject('${type}',${index})" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">‚úî</button>`;
    if(type === 'paused') btns = `<button onclick="moveItem('paused','active',${index})" title="–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å">‚ñ∂</button>`;
    if(type === 'potential') btns = `<button onclick="moveItem('potential','active',${index})" title="–ü—Ä–∏–Ω—è—Ç—å">‚úö</button>`;
    if(type === 'archive') btns = `<button onclick="moveItem('archive','active',${index})" title="–í–µ—Ä–Ω—É—Ç—å">‚Ü∫</button>`;

    // –ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    const prioIcon = item.prio ? `<span class="prio-star">‚òÖ</span>` : '';
    const pinIcon = (item.pinned) ? `<span style="color:var(--accent);margin-right:5px">üìå</span>` : '';

    return `
    <div class="card" draggable="true" 
         ondragstart="drag(event, '${type}', ${index})" 
         ondblclick="editItem('${type}', ${index})">
      <div class="card-header">
        <span class="card-title">${pinIcon}${prioIcon}${item.name}</span>
        <div class="card-actions">
            ${btns}
            <button class="danger" onclick="delItem('${type}',${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
        </div>
      </div>
      <div class="card-client">${item.client || ''}</div>
      <div class="card-price">${formatPrice(item.price)}</div>
      ${progressHtml}
      ${dateHtml}
      ${archiveHtml} </div>
    `;
};

// 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã" (–†–µ–¥–∏–∑–∞–π–Ω —Å Grid)
function renderAllProjectsModal() {
  const modal = document.getElementById('allProjectsModal');
  const list = document.getElementById('allProjectsList');
  if(!modal || !list) return;

  const all = [];
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤
  ['active','active_pinned','waiting','paused','potential','archive'].forEach(k => {
    const src = (k === 'active_pinned') ? DATA.active.filter(x=>x.pinned) : 
                (k === 'active') ? DATA.active.filter(x=>!x.pinned) : DATA[k];
    if(src) src.forEach(i => all.push({...i, _status: k}));
  });

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (—Å–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É)
  all.sort((a,b) => new Date(b.date||b.dl||0) - new Date(a.date||a.dl||0));

  let html = `
    <div class="all-projects-table all-projects-header">
        <div class="apt-status">–°–¢–ê–¢–£–°</div>
        <div>–ü–†–û–ï–ö–¢ / –ö–õ–ò–ï–ù–¢</div>
        <div style="text-align:right">–î–ê–¢–ê</div>
        <div style="text-align:right">–°–£–ú–ú–ê</div>
    </div>
  `;

  let total = 0;

  all.forEach(p => {
    total += (parseInt(p.price) || 0);
    
    // –ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    let stIcon = '‚Ä¢';
    let stColor = 'var(--muted)';
    if(p._status.includes('active')) { stIcon = '‚ñ∂'; stColor = '#3fb950'; }
    if(p._status === 'archive') { stIcon = '‚úî'; stColor = 'var(--accent)'; }
    if(p._status === 'waiting') { stIcon = 'clock'; stColor = '#e3b341'; }
    if(p._status === 'paused') { stIcon = '||'; stColor = '#f85149'; }

    // –î–∞—Ç–∞: –¥–ª—è –∞—Ä—Ö–∏–≤–∞ - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –¥–µ–¥–ª–∞–π–Ω
    let dLabel = p.dl ? formatDate(p.dl) : '-';
    if(p._status === 'archive' && p.date) dLabel = p.date;

    html += `
    <div class="all-projects-table">
        <div class="apt-status" style="color:${stColor}; font-size:16px;">${stIcon}</div>
        <div class="apt-name">
            <strong title="${p.name}">${p.name}</strong>
            <span>${p.client || '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞'}</span>
        </div>
        <div class="apt-date">${dLabel}</div>
        <div class="apt-price">${formatPrice(p.price)}</div>
    </div>
    `;
  });

  document.getElementById('allProjectsTotal').innerText = formatPrice(total);
  list.innerHTML = html;
  modal.style.display = 'flex';
}

function calcContractorAmount(item) {
    const gross = toNumeric(item.p);
    const mode = item.contractorMode || 'amount';
    const raw = toNumeric(item.contractor);
    if (mode === 'none') return 0;
    return mode === 'percent' ? gross * (raw / 100) : raw;
}

function calcNet(item){
    const gross = toNumeric(item.p);
    const contr = calcContractorAmount(item);
    const tax = toNumeric(item.taxPrc);
    const taxAmt = gross * (tax / 100);
    return Math.round(gross - taxAmt - contr);
}

function calcGross(item) {
    return toNumeric(item.p);
}
function calcMarginPrc(item) {
    const gross = toNumeric(item.p);
    if (gross === 0) return 0;
    const net = calcNet(item);
    return Math.round((net / gross) * 100);
}

function setupModalsBackgroundCheck() {
    window.onclick = function(event) {
        if (!event.target.classList.contains('modal')) return;
        if (event.target.id === 'addProjectModal') {
            attemptCloseProjectModal();
            return;
        }
        if (event.target.id === 'settingsModal') {
            attemptCloseSettings();
            return;
        }
        event.target.style.display = 'none';
    }
}

function switchTab(t){
    const enabledTabs = getEnabledTabs();
    if (!enabledTabs.includes(t)) {
        const fallback = enabledTabs.includes('active') ? 'active' : enabledTabs[0];
        if (fallback && fallback !== t) {
            return switchTab(fallback);
        }
        return;
    }
    currentTab = t;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
    ['active','waiting','potential','requests','paused','archive','all','trash'].forEach(k => {
        const el = document.getElementById(`view-${k}`);
        if(el) el.style.display = (k === t) ? 'block' : 'none';
        const cb = document.getElementById(`selectAll${k.charAt(0).toUpperCase() + k.slice(1)}`);
        if(cb) cb.checked = false;
        if(selectedRows[k]) selectedRows[k].clear();
    });

    const desc = document.getElementById('tab-description');
    desc.innerHTML = getTabSummary(t, TAB_DESCRIPTIONS[t]);
    const dashboard = document.querySelector('.dashboard');
    if (dashboard) dashboard.style.display = t === 'trash' ? 'none' : 'block';
    updateSortIndicators(t);
    updateBulkToolbar(t);
    upd();
}

function getTabSummary(type, baseText) {
    if (type === 'trash') {
        return `${baseText} ¬∑ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ.`;
    }
    return baseText;
}

function updateTabCounts() {
    const counts = {
        active: DATA.active.length,
        waiting: DATA.waiting.length,
        potential: DATA.potential.length,
        requests: DATA.requests.length,
        paused: DATA.paused.length,
        archive: DATA.archive.length,
        all: DATA.active.length + DATA.waiting.length + DATA.potential.length + DATA.paused.length + DATA.archive.length,
        trash: DATA.trash.length
    };
    Object.entries(counts).forEach(([key, val]) => {
        const el = document.getElementById(`count-${key}`);
        if (el) el.innerText = val;
    });
}

function sortData(type, key, dataType, initial = false) {
    if (!DATA[type]) return;
    let direction = 1;
    if (SORT[type] === key && !initial) {
        direction = DATA[type].sortDirection === 1 ? -1 : 1; 
    }
    DATA[type].sort((a, b) => {
        let va = a[key], vb = b[key];
        if (type === 'active' && (key === 'dl' || initial)) {
             const remA = getTimeRemaining(a.dl).days || Infinity;
             const remB = getTimeRemaining(b.dl).days || Infinity;
             if (remA !== remB) return direction * (remA - remB);
        }
        if (dataType === 'date') return direction * (new Date((va || '9999').replace(' ', 'T')) - new Date((vb || '9999').replace(' ', 'T')));
        if (dataType === 'number') return direction * (toNumeric(va) - toNumeric(vb));
        return direction * String(va).localeCompare(String(vb));
    });
    DATA[type].sortDirection = direction;
    SORT[type] = key;
    save();
    updateSortIndicators(type);
    if(!initial) upd();
}

function updateSortIndicators(type) {
    const activeKey = SORT[type];
    const dir = DATA[type].sortDirection || 1;
    document.querySelectorAll(`th[data-type="${type}"]`).forEach(th => th.classList.remove('sorted', 'asc', 'desc'));
    const activeTh = document.querySelector(`th[data-type="${type}"][data-key="${activeKey}"]`);
    if (activeTh) {
        activeTh.classList.add('sorted');
        activeTh.classList.add(dir === 1 ? 'asc' : 'desc');
    }
}

function upd(){
    renderActive();
    renderSimple('waiting');
    renderSimple('paused');
    renderPotential();
    renderRequests();
    renderArchive();
    renderAll();
    renderTrash();
    calcStats();
    const desc = document.getElementById('tab-description');
    if (desc) desc.innerHTML = getTabSummary(currentTab, TAB_DESCRIPTIONS[currentTab]);
    updateBulkToolbar(currentTab);
    updateTabCounts();
}

function renderActive(){
    const tbody = document.querySelector('#t-active tbody');
    tbody.innerHTML = '';
    let totalP = 0, totalPr = 0, totalContr = 0, totalTax = 0, totalPaidGross = 0;
    
    DATA.active.forEach((item, i) => {
        item.pr = calcNet(item);
        const gross = toNumeric(item.p);
        totalP += gross; totalPr += item.pr || 0;
        const contractorAmount = calcContractorAmount(item);
        totalContr += contractorAmount;
        totalTax += gross * ((toNumeric(item.taxPrc) || 0) / 100);

        const rem = getTimeRemaining(item.dl);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.active?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');

        const linkIcon = renderLinkControls(item, i, 'active');
        const paidAmount = Math.round(gross * ((toNumeric(item.paid) || 0) / 100));
        totalPaidGross += paidAmount;
        const contractorMode = item.contractorMode || 'none';
        const contractorSymbol = contractorMode === 'percent' ? '%' : contractorMode === 'none' ? '' : '‚ÇΩ';
        const contractorSymbolClass = contractorSymbol ? '' : 'symbol-empty';
        const contractorValue = contractorMode === 'none' ? '' : formatPlainNumber(item.contractor ?? 0);
        const contractorHelper = contractorMode === 'none' ? '–†–∞—Å—Ö–æ–¥—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è' : `‚âà ${formatCurrency(contractorAmount)}`;
        const actionButtons = [
            `<div class="done-btn action-btn-base" onclick="mv(${i},'active','archive')" title="–í—ã–ø–æ–ª–Ω–µ–Ω–æ"><svg class="btn-icon"><use href="#icon-check"/></svg></div>`
        ];
        actionButtons.push(`<div class="edit-active-btn action-btn-base" onclick="startProjectEdit('active',${i})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><svg class="btn-icon"><use href="#icon-pen"/></svg></div>`);
        if (isTableEnabled('waiting')) actionButtons.push(`<div class="wait-active-btn action-btn-base" onclick="mv(${i},'active','waiting')" title="–í –æ–∂–∏–¥–∞–Ω–∏–∏"><svg class="btn-icon"><use href="#icon-waiting"/></svg></div>`);
        const overdueIcon = rem && rem.days < 0 ? `<span class="deadline-warning-icon" title="${rem.overdueTooltip}">‚óè</span>` : '';

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('active',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-active-${i}" onchange="toggleSelect('active', ${i}, this)" ${selectedRows.active?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-active-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('active',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('active',${i},'n',this.innerText)">${item.n}</span>
            </td>
            
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('active',${i},'start')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.start)}</span></div></td>
            <td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('active',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDeadlineDisplay(item.dl)}</span></div></td>

            <td class="mono"><div class="${rem.cls}">${rem.txt} ${overdueIcon}</div></td>
            
            <td><select class="tax-select" onchange="updVal('active',${i},'taxPrc',this.value)">
                <option value="0" ${+item.taxPrc===0?'selected':''}>0%</option>
                <option value="4" ${+item.taxPrc===4?'selected':''}>4%</option>
                <option value="6" ${+item.taxPrc===6?'selected':''}>6%</option>
                <option value="13" ${+item.taxPrc===13?'selected':''}>13%</option>
            </select></td>
            
            <td style="text-align:right;">
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${contractorValue}" ${contractorMode === 'none' ? 'disabled' : ''} oninput="formatNumberInput(this)" onblur="updateContractorValue('active',${i},this.value)">
                    <span class="currency-symbol ${contractorSymbolClass}">${contractorSymbol || '–Ω–µ—Ç'}</span>
                    <select class="expense-mode" onchange="updateContractorMode('active',${i},this.value)">
                        <option value="none" ${contractorMode==='none'?'selected':''}>–ù–µ—Ç</option>
                        <option value="amount" ${contractorMode==='amount'?'selected':''}>‚ÇΩ</option>
                        <option value="percent" ${contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">${contractorHelper}</div>
            </td>

            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('active',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            
            <td class="paid-cell">
                <select class="paid-select" onchange="updVal('active',${i},'paid',this.value)">
                    <option value="0" ${+item.paid===0?'selected':''}>0%</option>
                    <option value="50" ${+item.paid===50?'selected':''}>50%</option>
                    <option value="100" ${+item.paid===100?'selected':''}>100%</option>
                </select>
                <div class="paid-amount">${formatCurrency(paidAmount)}</div>
            </td>
            
            <td><div class="action-btns">
                ${actionButtons.join('')}
                <button class="del-btn" onclick="askDel('active',${i})" title="–£–¥–∞–ª–∏—Ç—å" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'active', i, `check-active-${i}`);
        tbody.appendChild(tr);
    });
    
    const footer = document.querySelector('#total-row-active');
    const repState = analyzeReputation();
    footer.innerHTML = `<tr>
        <td colspan="6" class="footer-total-toggle" onclick="toggleFooterSelection('active')">–í—Å–µ–≥–æ ${DATA.active.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td style="text-align:right;">
            <div class="footer-note">–ù–∞–ª–æ–≥–∏</div>
            <div>${formatCurrency(totalTax)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–†–∞—Å—Ö–æ–¥—ã</div>
            <div>${formatCurrency(totalContr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(totalP)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–ß–∏—Å—Ç—ã–º–∏</div>
            <div>${formatCurrency(totalPr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–û–ø–ª–∞—á–µ–Ω–æ</div>
            <div>${formatCurrency(totalPaidGross)}</div>
        </td>
        <td></td>
    </tr>`;

    updatePaceReputation(repState);

    const paceBlock = document.getElementById('pace-indicator');
    const urgent = DATA.active.filter(x => getTimeRemaining(x.dl).cls.includes('critical')).length;
    
    if (currentTab === 'active') {
        if (urgent > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.add('critical');
            document.getElementById('pace-icon').innerHTML = 'üî•';
            document.getElementById('pace-title').innerText = '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!';
            document.getElementById('pace-desc').innerText = `–ì–æ—Ä–∏—Ç –¥–µ–¥–ª–∞–π–Ω–æ–≤: ${urgent}. –ü–æ–¥–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å!`;
            document.getElementById('pace-status').className='pace-status pace-hurry'; 
            document.getElementById('pace-status').innerText='–ö—Ä–∏—Ç–∏—á–Ω–æ';
        } else if (DATA.active.length > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.remove('critical');
            document.getElementById('pace-icon').innerHTML = 'üö¶';
            document.getElementById('pace-title').innerText = '–ê–Ω–∞–ª–∏–∑';
            document.getElementById('pace-desc').innerText = `–í—Å–µ —Å–ø–æ–∫–æ–π–Ω–æ.`;
            document.getElementById('pace-status').className='pace-status pace-chill'; 
            document.getElementById('pace-status').innerText='–ù–æ—Ä–º–∞';
        } else {
            paceBlock.style.display = 'none';
        }
    } else {
        paceBlock.style.display = 'none';
    }
}

function renderSimple(type){
    const tbody = document.querySelector(`#t-${type} tbody`);
    tbody.innerHTML = '';
    let tot = 0;
    const hasDeadline = type !== 'waiting';
    DATA[type].forEach((item, i) => {
        tot += toNumeric(item.p);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows[type]?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');

        const linkIcon = renderLinkControls(item, i, type);
        const rem = hasDeadline ? getTimeRemaining(item.dl) : null;
        const deadlineText = hasDeadline ? formatDeadlineDisplay(item.dl) : '';
        const remSuffix = hasDeadline && rem && !rem.isInfinite ? ` (${rem.txt})` : '';

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('${type}',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-${type}-${i}" onchange="toggleSelect('${type}', ${i}, this)" ${selectedRows[type]?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-${type}-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('${type}',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('${type}',${i},'n',this.innerText)">${item.n}</span>
            </td>
            ${hasDeadline ? `<td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('${type}',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${deadlineText}${remSuffix}</span></div></td>` : ''}
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('${type}',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" onclick="startProjectEdit('${type}',${i})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><svg class="btn-icon"><use href="#icon-pen"/></svg></div>
                <div class="action-btn-base" onclick="mv(${i},'${type}','active')" title="–í —Ä–∞–±–æ—Ç—É"><svg class="btn-icon"><use href="#icon-arrow-right"/></svg></div>
                <button class="del-btn" onclick="askDel('${type}',${i})" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, type, i, `check-${type}-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector(`#total-row-${type}`);
    footer.innerHTML = `<tr>
        <td colspan="${hasDeadline ? 4 : 3}" class="footer-total-toggle" onclick="toggleFooterSelection('${type}')">–í—Å–µ–≥–æ ${DATA[type].length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td>
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(tot)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderPotential(){
    const tbody = document.querySelector('#t-potential tbody');
    tbody.innerHTML = '';
    let tot = 0;
    DATA.potential.forEach((item, i) => {
        tot += toNumeric(item.p);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.potential?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        
        const linkIcon = renderLinkControls(item, i, 'potential');
                                      
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('potential',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-potential-${i}" onchange="toggleSelect('potential', ${i}, this)" ${selectedRows.potential?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-potential-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('potential',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('potential',${i},'n',this.innerText)">${item.n}</span>
            </td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('potential',${i},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" onclick="startProjectEdit('potential',${i})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><svg class="btn-icon"><use href="#icon-pen"/></svg></div>
                <div class="done-btn action-btn-base" onclick="mv(${i},'potential','active')" title="–í —Ä–∞–±–æ—Ç—É"><svg class="btn-icon"><use href="#icon-arrow-right"/></svg><span class="btn-label">–í —Ä–∞–±–æ—Ç—É</span></div>
                <button class="del-btn" onclick="askDel('potential',${i})" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'potential', i, `check-potential-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-potential');
    footer.innerHTML = `<tr>
        <td colspan="3" class="footer-total-toggle" onclick="toggleFooterSelection('potential')">–í—Å–µ–≥–æ ${DATA.potential.length} –ª–∏–¥–æ–≤</td>
        <td>
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(tot)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderRequests(){
    const tbody = document.querySelector('#t-requests tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    let total = 0;
    DATA.requests.forEach((item, i) => {
        const budget = toNumeric(item.budget);
        total += budget;
        const tr = document.createElement('tr');
        const linkBtns = renderLinkControls(item, i, 'requests');
        tr.innerHTML = `
            <td class="select-col"><div class="row-index">${i + 1}</div></td>
            <td><span contenteditable onblur="updateRequestField(${i},'name',this.innerText)">${item.name || '‚Äî'}</span></td>
            <td><span contenteditable onblur="updateRequestField(${i},'source',this.innerText)">${item.source || '‚Äî'}</span></td>
            <td><span contenteditable onblur="updateRequestField(${i},'note',this.innerText)">${item.note || '‚Äî'}</span></td>
            <td><div class="trash-action-btns">${linkBtns}</div></td>
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(budget)}" oninput="formatNumberInput(this)" onblur="updateRequestField(${i},'budget',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td>
                <div class="trash-action-btns">
                    <div class="restore-trash-btn" onclick="convertRequestToPotential(${i})">–í –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>
                    <div class="delete-forever-text" onclick="deleteRequest(${i})" title="–£–¥–∞–ª–∏—Ç—å">–£–¥–∞–ª–∏—Ç—å</div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-requests');
    if (footer) {
        footer.innerHTML = `<tr><td colspan="5" class="footer-total-toggle">–í—Å–µ–≥–æ ${DATA.requests.length} –∑–∞—è–≤–æ–∫</td><td style="text-align:right;">${formatCurrency(total)}</td><td></td></tr>`;
    }
}

function addRequest() {
    const name = document.getElementById('req-name').value.trim();
    const source = document.getElementById('req-source').value.trim();
    const note = document.getElementById('req-note').value.trim();
    const link = document.getElementById('req-link').value.trim();
    const budget = toNumeric(document.getElementById('req-budget').value);
    if (!name && !note) return;
    DATA.requests.unshift({ name, source, note, link: normalizeLinkValue(link), budget, created: new Date().toISOString() });
    ['req-name','req-source','req-note','req-link','req-budget'].forEach(id => document.getElementById(id).value = '');
    save(); upd();
    showToast('–ó–∞—è–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
}

function updateRequestField(idx, key, val) {
    if (!DATA.requests[idx]) return;
    DATA.requests[idx][key] = key === 'budget'
        ? toNumeric(val)
        : key === 'link'
            ? normalizeLinkValue(val)
            : val;
    save(); upd();
}

function deleteRequest(idx) {
    DATA.requests.splice(idx, 1);
    save(); upd();
}

function convertRequestToPotential(idx) {
    const req = DATA.requests.splice(idx, 1)[0];
    if (!req) return;
    DATA.potential.unshift({ n: req.note || req.name || '–ù–æ–≤—ã–π –ª–∏–¥', c: req.name || '‚Äî', p: req.budget || 0, contractor: 0, contractorMode: 'none', taxPrc: 0, paid: 0, link: req.link || '' });
    save();
    showToast('–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª');
    switchTab('potential');
}

function renderArchive(){
    const tbody = document.querySelector('#t-archive tbody');
    tbody.innerHTML = '';
    let tP = 0, tPr = 0, tContr = 0, tTax = 0;
    const visibleItems = getArchiveByMonth();
    visibleItems.forEach((item, i) => {
        const realIdx = DATA.archive.indexOf(item);
        item.pr = calcNet(item);
        tP += toNumeric(item.p); tPr += +item.pr || 0;
        const contractorAmount = calcContractorAmount(item);
        tContr += contractorAmount;
        tTax += toNumeric(item.p) * ((toNumeric(item.taxPrc) || 0) / 100);
        const tr = document.createElement('tr');
        tr.dataset.index = realIdx;

        const isSelected = selectedRows.archive?.has(realIdx.toString());
        if (isSelected) tr.classList.add('row-selected');

        const linkIcon = renderLinkControls(item, realIdx, 'archive');

        const completionStatus = analyzeCompletionStatus(item);
        const completionText = formatDateDisplay(item.date);
        const completionBadge = completionStatus.onTime
            ? `<span class="deadline-success-badge" title="–°–¥–∞–Ω–æ –≤ —Å—Ä–æ–∫">${completionText}</span>`
            : `<span class="date-text-display">${completionText}</span>`;
        const overdueIcon = completionStatus.delayDays > 0
            ? `<span class="deadline-warning-icon" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${completionStatus.delayDays} ${pluralize(completionStatus.delayDays, ['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'])}">‚óè</span>`
            : '';
        const dateCls = completionStatus.onTime ? 'days-normal' : '';
        const deadlineSnapshot = item.deadlineSnapshot || item.dl || null;
        const deadlineBadge = deadlineSnapshot
            ? `<span class="date-text-display">${formatDateDisplay(deadlineSnapshot)}</span>`
            : `<span class="date-text-display">‚Äî</span>`;

        const contractorMode = item.contractorMode || 'none';
        const contractorSymbol = contractorMode === 'percent' ? '%' : contractorMode === 'none' ? '' : '‚ÇΩ';
        const contractorSymbolClass = contractorSymbol ? '' : 'symbol-empty';
        const contractorValue = contractorMode === 'none' ? '' : formatPlainNumber(item.contractor ?? 0);
        const contractorHelper = contractorMode === 'none' ? '–†–∞—Å—Ö–æ–¥—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è' : `‚âà ${formatCurrency(contractorAmount)}`;

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('archive',${realIdx})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-archive-${realIdx}" onchange="toggleSelect('archive', ${realIdx}, this)" ${selectedRows.archive?.has(realIdx.toString()) ? 'checked' : ''}>
                    <label for="check-archive-${realIdx}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('archive',${realIdx},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('archive',${realIdx},'n',this.innerText)">${item.n}</span>
            </td>
            <td class="date-cell archive-date-cell">
                <div class="deadline-block">
                    <div class="deadline-row">
                        <div class="deadline-label">–î–µ–¥–ª–∞–π–Ω</div>
                        <div class="deadline-value ${deadlineSnapshot ? '' : 'muted'}">${deadlineBadge}</div>
                    </div>
                    <div class="deadline-row">
                        <div class="deadline-label">–°–¥–∞–Ω–æ</div>
                        <div class="date-input-wrap ${dateCls}" onclick="openDate('archive',${realIdx},'date')">
                            <svg class="date-icon"><use href="#icon-calendar"/></svg>${completionBadge}${overdueIcon}
                        </div>
                    </div>
                </div>
            </td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('archive',${realIdx},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td>
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${contractorValue}" ${contractorMode === 'none' ? 'disabled' : ''} oninput="formatNumberInput(this)" onblur="updateContractorValue('archive',${realIdx},this.value)">
                    <span class="currency-symbol ${contractorSymbolClass}">${contractorSymbol || '–Ω–µ—Ç'}</span>
                    <select class="expense-mode" onchange="updateContractorMode('archive',${realIdx},this.value)">
                        <option value="none" ${contractorMode==='none'?'selected':''}>–ù–µ—Ç</option>
                        <option value="amount" ${contractorMode==='amount'?'selected':''}>‚ÇΩ</option>
                        <option value="percent" ${contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">${contractorHelper}</div>
            </td>
            <td><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" title="–í–µ—Ä–Ω—É—Ç—å" onclick="mv(${realIdx},'archive','active')">
                    <svg style="width:16px;height:16px;"><use href="#icon-undo"/></svg>
                </div>
                <button class="del-btn" onclick="askDel('archive',${realIdx})" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'archive', realIdx, `check-archive-${realIdx}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-archive');
    footer.innerHTML = `<tr>
        <td colspan="4" class="footer-total-toggle" onclick="toggleFooterSelection('archive')">–í—Å–µ–≥–æ ${visibleItems.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
        <td style="text-align:right;">
            <div class="footer-note">–°—É–º–º–∞</div>
            <div>${formatCurrency(tP)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–†–∞—Å—Ö–æ–¥—ã</div>
            <div>${formatCurrency(tContr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">–ß–∏—Å—Ç—ã–º–∏</div>
            <div>${formatCurrency(tPr)}</div>
            <div class="footer-note">–ù–∞–ª–æ–≥–∏: ${formatCurrency(tTax)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderAll(){
    const tbody = document.querySelector('#t-all tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const allItems = [];
    ['active','waiting','paused'].forEach(type => {
        DATA[type].forEach((item, idx) => allItems.push({ item, __type: type, idx }));
    });
    getArchiveByMonth().forEach(item => allItems.push({ item, __type: 'archive', idx: DATA.archive.indexOf(item) }));

    let totalGross = 0, totalNet = 0, totalExp = 0, totalTax = 0, totalPaid = 0;

    allItems.forEach((wrap, i) => {
        const item = wrap.item;
        const status = STATUS_META[wrap.__type] || { label: wrap.__type, cls: '' };
        const contractorAmount = calcContractorAmount(item);
        const net = calcNet(item);
        const gross = toNumeric(item.p);
        const taxAmount = gross * ((toNumeric(item.taxPrc) || 0) / 100);
        totalGross += gross;
        totalNet += net;
        totalExp += contractorAmount;
        totalTax += taxAmount;
        const paidPct = toNumeric(item.paid) || 0;
        const paidAmount = Math.round(gross * (paidPct / 100));
        totalPaid += paidAmount;

        const tr = document.createElement('tr');
        const isArchiveRow = wrap.__type === 'archive';
        const deadlineValue = isArchiveRow ? item.date : (item.dl || item.date || item.start);
        const dateField = isArchiveRow ? 'date' : 'dl';
        const rem = isArchiveRow ? null : getTimeRemaining(deadlineValue);
        const remText = (!rem || (rem && rem.isInfinite) || (rem && rem.days < 0)) ? '' : ` (${rem.txt})`;
        const dateDisplay = isArchiveRow
            ? (deadlineValue ? formatDateDisplay(deadlineValue) : '‚Äî')
            : formatDeadlineDisplay(deadlineValue);
        const completionStatus = isArchiveRow ? analyzeCompletionStatus(item) : null;
        const dateCls = isArchiveRow ? (completionStatus?.onTime ? 'days-normal' : '') : (rem?.cls || '');
        let dateBadge = `<span class="date-text-display">${dateDisplay}${remText}</span>`;
        if (isArchiveRow && deadlineValue) {
            dateBadge = completionStatus?.onTime
                ? `<span class="deadline-success-badge" title="–°–¥–∞–Ω–æ –≤ —Å—Ä–æ–∫">${dateDisplay}</span>`
                : `<span class="date-text-display">${dateDisplay}</span>`;
        }
        const linkIcon = renderLinkControls(item, wrap.idx, wrap.__type);

        const contractorMode = item.contractorMode || 'none';
        const contractorSymbol = contractorMode === 'percent' ? '%' : contractorMode === 'none' ? '' : '‚ÇΩ';
        const contractorSymbolClass = contractorSymbol ? '' : 'symbol-empty';
        const contractorValue = contractorMode === 'none' ? '' : formatPlainNumber(item.contractor ?? 0);
        const contractorHelper = contractorMode === 'none' ? '–†–∞—Å—Ö–æ–¥—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è' : `‚âà ${formatCurrency(contractorAmount)}`;

        const overdueIcon = isArchiveRow
            ? (completionStatus?.delayDays ? `<span class="deadline-warning-icon" title="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${completionStatus.delayDays} ${pluralize(completionStatus.delayDays, ['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'])}">‚óè</span>` : '')
            : (!rem || !rem.overdueTooltip) ? '' : `<span class="deadline-warning-icon" title="${rem.overdueTooltip}">‚óè</span>`;
        const selectionKey = `${wrap.__type}:${wrap.idx}`;
        const isSelected = selectedRows.all?.has(selectionKey);
        tr.dataset.index = selectionKey;
        tr.dataset.type = wrap.__type;
        tr.dataset.sourceIndex = wrap.idx;
        if (isSelected) tr.classList.add('row-selected');

        const statusIcon = status.icon ? `<svg class="status-pill-icon"><use href="#${status.icon}"/></svg>` : '';

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('${wrap.__type}',${wrap.idx})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-all-${i}" data-key="${selectionKey}" onchange="toggleSelect('all', '${selectionKey}', this)" ${isSelected ? 'checked' : ''}>
                    <label for="check-all-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><span class="status-pill ${status.cls}" title="${status.label}">${statusIcon}</span></td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('${wrap.__type}',${wrap.idx},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c || ''}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap"><span class="project-name" contenteditable onblur="updVal('${wrap.__type}',${wrap.idx},'n',this.innerText)">${item.n || ''}</span></td>
            <td class="date-cell"><div class="date-input-wrap ${dateCls}" onclick="openDate('${wrap.__type}',${wrap.idx},'${dateField}')"><svg class="date-icon"><use href="#icon-calendar"/></svg>${dateBadge}${overdueIcon}</div></td>
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(gross)}" oninput="formatNumberInput(this)" onblur="updVal('${wrap.__type}',${wrap.idx},'p',this.value)"><span class="currency-symbol">‚ÇΩ</span></div></td>
            <td style="text-align:right;">
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${contractorValue}" ${contractorMode === 'none' ? 'disabled' : ''} oninput="formatNumberInput(this)" onblur="updateContractorValue('${wrap.__type}',${wrap.idx},this.value)">
                    <span class="currency-symbol ${contractorSymbolClass}">${contractorSymbol || '–Ω–µ—Ç'}</span>
                    <select class="expense-mode" onchange="updateContractorMode('${wrap.__type}',${wrap.idx},this.value)">
                        <option value="none" ${contractorMode==='none'?'selected':''}>–ù–µ—Ç</option>
                        <option value="amount" ${contractorMode==='amount'?'selected':''}>‚ÇΩ</option>
                        <option value="percent" ${contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">${contractorHelper}</div>
            </td>
            <td style="text-align:right;">
                <select class="tax-select" onchange="updVal('${wrap.__type}',${wrap.idx},'taxPrc',this.value)">
                    <option value="0" ${+item.taxPrc===0?'selected':''}>0%</option>
                    <option value="4" ${+item.taxPrc===4?'selected':''}>4%</option>
                    <option value="6" ${+item.taxPrc===6?'selected':''}>6%</option>
                    <option value="13" ${+item.taxPrc===13?'selected':''}>13%</option>
                </select>
            </td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(net)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            <td style="text-align:right;">
                <div class="paid-summary">
                    <span class="paid-chip">${paidPct}%</span>
                    <span class="paid-amount">${formatCurrency(paidAmount)}</span>
                </div>
            </td>
            <td class="actions-cell" style="text-align:right;">
                <button class="link-btn" onclick="startProjectEdit('${wrap.__type}', ${wrap.idx})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    <svg class="btn-icon"><use href="#icon-pen"/></svg>
                </button>
                <button class="del-btn" onclick="askDel('${wrap.__type}',${wrap.idx})" title="–£–¥–∞–ª–∏—Ç—å" aria-label="–£–¥–∞–ª–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </td>
        `;
        attachRowSelection(tr, 'all', selectionKey, `check-all-${i}`);
        tbody.appendChild(tr);
    });

    const footer = document.querySelector('#total-row-all');
    if (footer) {
        footer.innerHTML = `<tr>
            <td colspan="5" class="footer-total-toggle" onclick="toggleFooterSelection('all')">–í—Å–µ–≥–æ ${allItems.length} –ø—Ä–æ–µ–∫—Ç–æ–≤</td>
            <td style="text-align:right;">
                <div class="footer-note">–°—É–º–º–∞</div>
                <div>${formatCurrency(totalGross)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–†–∞—Å—Ö–æ–¥—ã</div>
                <div>${formatCurrency(totalExp)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–ù–∞–ª–æ–≥–∏</div>
                <div>${formatCurrency(totalTax)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–ß–∏—Å—Ç—ã–º–∏</div>
                <div>${formatCurrency(totalNet)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">–û–ø–ª–∞—á–µ–Ω–æ</div>
                <div>${formatCurrency(totalPaid)}</div>
            </td>
            <td></td>
        </tr>`;
    }
}

function formatTrashExpire(item) {
    const fallback = { text: '–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞', tone: 'danger' };
    if (!item.deletedAt) return fallback;
    const retentionMs = TRASH_RETENTION_DAYS * 24 * 60 * 60 * 1000;
    const expiresAt = new Date(item.deletedAt + retentionMs);
    const remainingMs = expiresAt - Date.now();
    if (remainingMs <= 0) return fallback;
    const days = Math.floor(remainingMs / (24 * 60 * 60 * 1000));
    const hours = Math.ceil((remainingMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
    const plural = (n, one, few, many) => {
        const mod10 = n % 10, mod100 = n % 100;
        if (mod10 === 1 && mod100 !== 11) return one;
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return few;
        return many;
    };
    const relative = days > 0
        ? `–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ ${days} ${plural(days, '–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π')}`
        : `–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ ${Math.max(hours, 1)} ${plural(Math.max(hours, 1), '—á–∞—Å', '—á–∞—Å–∞', '—á–∞—Å–æ–≤')}`;
    const tone = remainingMs <= 24 * 60 * 60 * 1000 ? 'danger' : remainingMs <= 3 * 24 * 60 * 60 * 1000 ? 'warn' : 'neutral';
    return { text: relative, tone };
}

function formatTrashDate(ts) {
    if (!ts) return '?';
    const d = new Date(ts);
    const day = d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' }).replace('.', '');
    const time = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', hour12: false });
    return `${day}, ${time}`;
}

function renderTrash(){
    const tbody = document.querySelector('#t-trash tbody');
    tbody.innerHTML = '';
    DATA.trash.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.classList.add('trash-row');
        tr.dataset.index = i;

        const isSelected = selectedRows.trash?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        const delDate = formatTrashDate(item.deletedAt);
        const expireInfo = formatTrashExpire(item);
        const linkBtns = renderLinkControls(item, i, 'trash');
        const gross = toNumeric(item.p);
        const net = calcNet(item);
        const paidPct = toNumeric(item.paid) || 0;
        const paidAmount = Math.round(gross * (paidPct / 100));
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('trash',${i})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-trash-${i}" onchange="toggleSelect('trash', ${i}, this)" ${selectedRows.trash?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-trash-${i}" style="display:none;"></label>
                </div>
            </td>
            <td class="trash-date-cell">
                <div class="trash-deleted-label">–£–¥–∞–ª–µ–Ω–æ: ${delDate}</div>
                <div class="trash-expire ${expireInfo.tone}">${expireInfo.text}</div>
            </td>
            <td><div class="trash-text">${item.c || '‚Äî'}</div></td>
            <td>
                <div class="trash-text">${item.n || '‚Äî'}</div>
                <div class="trash-action-btns" style="justify-content:flex-start;">${linkBtns}</div>
            </td>
            <td><div class="trash-amount">${formatCurrency(gross)}</div></td>
            <td><div class="trash-amount">${formatCurrency(net)}</div></td>
            <td>
                <div class="paid-summary">
                    <span class="paid-chip">${paidPct}%</span>
                    <span class="paid-amount">${formatCurrency(paidAmount)}</span>
                </div>
            </td>
            <td>
                <div class="trash-action-btns">
                    <div class="restore-trash-btn" onclick="restoreFromTrash(${i})">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</div>
                    <div class="delete-forever-text" onclick="deleteForeverCheck(${i})" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞">–£–¥–∞–ª–∏—Ç—å</div>
                </div>
            </td>
        `;
        attachRowSelection(tr, 'trash', i, `check-trash-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#t-trash tfoot td:first-child');
    if (footer) {
        footer.className = 'footer-total-toggle';
        footer.onclick = () => toggleFooterSelection('trash');
        footer.innerText = `–í—Å–µ–≥–æ ${DATA.trash.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`;
    }
}

function updVal(type, idx, key, val){
    if(key==='p' || key==='contractor' || key==='paid' || key==='taxPrc') val = toNumeric(val);
    DATA[type][idx][key] = val;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function updateContractorValue(type, idx, val) {
    DATA[type][idx].contractor = toNumeric(val);
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function updateContractorMode(type, idx, mode) {
    DATA[type][idx].contractorMode = mode;
    if (mode === 'none') DATA[type][idx].contractor = 0;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function mv(idx, from, to){
    if (to === 'archive') {
        openCompleteModal(idx, from);
        return;
    }
    const item = DATA[from][idx];
    if (!item) return;
    DATA[from].splice(idx, 1);
    if(to === 'active') {
        if (!item.start) item.start = item.start || today;
        if (!item.dl) item.dl = item.dl || today;
        if (item.paid === undefined || item.paid === null) item.paid = 50;
    }
    if(to === 'potential') { if (item.paid === undefined || item.paid === null) item.paid = 0; }
    if(to === 'waiting' || to === 'paused') { if (item.paid === undefined || item.paid === null) item.paid = 0; }

    DATA[to].unshift(item);
    sortData('active', 'dl', 'date', true);
    save();
    setTimeout(() => { switchTab(to); }, 10);
}

function openCompleteModal(idx, from) {
    const item = DATA[from]?.[idx];
    if (!item) return;
    completionContext = { idx, from };
    const dateInput = document.getElementById('completeDateInput');
    const timeInput = document.getElementById('completeTimeInput');
    const now = new Date();
    const isoNow = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString();
    if (dateInput) dateInput.value = isoNow.slice(0, 10);
    if (timeInput) timeInput.value = isoNow.slice(11, 16);

    const sourceLabel = STATUS_META[from]?.label || '–¢–µ–∫—É—â–∏–π —Ä–∞–∑–¥–µ–ª';
    const sourcePill = document.getElementById('completeSourcePill');
    if (sourcePill) sourcePill.innerText = sourceLabel;
    updateCompleteHint();
    document.getElementById('completeModal').style.display = 'flex';
}

function closeCompleteModal() {
    completionContext = null;
    document.getElementById('completeModal').style.display = 'none';
}

function getCompletionDateTime() {
    const dateVal = document.getElementById('completeDateInput')?.value || today;
    const timeVal = document.getElementById('completeTimeInput')?.value || '00:00';
    return `${dateVal}T${timeVal}`;
}

function parseLocalDateTime(value, fallbackToEndOfDay = false) {
    if (!value) return null;
    const normalized = value.replace(' ', 'T');
    const [datePart, timePartRaw = ''] = normalized.split('T');
    const [year, month, day] = (datePart || '').split('-').map(Number);
    if (![year, month, day].every(Number.isFinite)) return null;

    const [hoursRaw, minutesRaw] = timePartRaw.split(':').map(Number);
    const hours = Number.isFinite(hoursRaw) ? hoursRaw : (fallbackToEndOfDay ? 23 : 0);
    const minutes = Number.isFinite(minutesRaw) ? minutesRaw : (fallbackToEndOfDay ? 59 : 0);
    const seconds = fallbackToEndOfDay ? 59 : 0;

    return new Date(year, month - 1, day, hours, minutes, seconds, fallbackToEndOfDay ? 999 : 0);
}

  function buildCompletionMessage(item, completedAt) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π –¥–µ–¥–ª–∞–π–Ω –∏–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫, —á—Ç–æ–±—ã
      // –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ —Å—Ä–æ–∫–∞ –Ω–µ —Å—á–∏—Ç–∞–ª–∏—Å—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º–∏ –∏–∑-–∑–∞ –¥—Ä—É–≥–∏—Ö –¥–∞—Ç
      const deadline = item.dl || item.deadlineSnapshot;
      if (!deadline) {
          return { status: 'info', message: '–î–µ–¥–ª–∞–π–Ω –Ω–µ –±—ã–ª —É–∫–∞–∑–∞–Ω ‚Äî –æ—Ç–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é.' };
      }

      const deadlineDate = normalizeDateTimeValue(deadline, { endOfDayIfDateOnly: true });
      const doneDate = normalizeDateTimeValue(completedAt, { endOfDayIfDateOnly: true });
      if (!deadlineDate || !doneDate) {
          return { status: 'warning', message: '–ü—Ä–æ–≤–µ—Ä—å –¥–∞—Ç—É ‚Äî –µ—Å–ª–∏ –≤—Å–µ –æ–∫, —Å–æ—Ö—Ä–∞–Ω—è–µ–º.' };
      }

      return doneDate.getTime() <= deadlineDate.getTime()
          ? { status: 'success', message: '–°—Ä–æ–∫ —Å–æ–±–ª—é–¥—ë–Ω ‚Äî –æ—Ç–ª–∏—á–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–Ω–æ!' }
          : { status: 'warning', message: '–ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∞. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π –¥–∞—Ç—É –∏ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å.' };
  }

function updateCompleteHint() {
    if (!completionContext) return;
    const { idx, from } = completionContext;
    const item = DATA[from]?.[idx];
    if (!item) return;
    const val = getCompletionDateTime();
    const { status, message } = buildCompletionMessage(item, val);
    const hint = document.getElementById('completeHint');
    const feedback = document.getElementById('completeFeedback');
    const icon = document.getElementById('completeFeedbackIcon');
    const title = document.getElementById('completeHintTitle');
    if (hint) hint.innerText = message;
    if (title) {
        const titles = {
            success: '–û—Ç–ª–∏—á–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–Ω–æ!',
            warning: '–ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∞',
            info: '–ù–µ—Ç –¥–µ–¥–ª–∞–π–Ω–∞'
        };
        title.innerText = titles[status] || '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞';
    }
    if (feedback) {
        feedback.classList.remove('success', 'warning', 'info');
        feedback.classList.add(status || 'info');
    }
    if (icon) {
        const iconId = status === 'success' ? '#icon-check' : status === 'warning' ? '#icon-alert' : '#icon-info';
        icon.innerHTML = `<svg class="feedback-icon"><use href="${iconId}"/></svg>`;
    }
}

function confirmCompletion() {
    if (!completionContext) return;
    const { idx, from } = completionContext;
    const item = DATA[from]?.[idx];
    if (!item) { closeCompleteModal(); return; }

    const completedAt = getCompletionDateTime();
    const deadlineSnapshot = item.dl || item.date || null;
    const normalizedCompletion = normalizeDateTimeValue(completedAt, { endOfDayIfDateOnly: true });
    const normalizedDeadline = normalizeDateTimeValue(deadlineSnapshot, { endOfDayIfDateOnly: true });
    const completedOnTime = (normalizedCompletion && normalizedDeadline)
        ? normalizedCompletion.getTime() <= normalizedDeadline.getTime()
        : null;
    item.deadlineSnapshot = deadlineSnapshot;
    item.completedOnTime = completedOnTime;
    DATA[from].splice(idx, 1);
    item.date = completedAt;
    item.paid = 100;
    delete item.start;
    delete item.dl;

    DATA.archive.unshift(item);
    completionContext = null;
    closeCompleteModal();
    sortData('active', 'dl', 'date', true);
    save();
    setTimeout(() => { switchTab('archive'); }, 10);
    showToast('–ü—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
}

function duplicateRow(type, idx){
    const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
    if(!item) return;
    item.n = item.n + " (–ö–æ–ø–∏—è)";
    DATA[type].unshift(item);
    save(); upd();
}

function askDel(type, idx){
    const itemIndex = DATA[type].findIndex((_, i) => i === idx);
    if (itemIndex > -1) {
        const item = DATA[type].splice(itemIndex, 1)[0];
        item.deletedAt = Date.now();
        DATA.trash.unshift(item);
        lastPermanentDeletion = null;
        lastTrashMove = { type, items: [{ item, index: itemIndex }] };
        save(); upd();
        showToast('–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É', '–û—Ç–º–µ–Ω–∏—Ç—å', undoMoveToTrash);
    }
}

function deleteForeverCheck(idx) {
    document.getElementById('del-modal-title').innerText = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ";
    document.getElementById('del-modal-desc').innerText = "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
        document.getElementById('finalDeleteBtn').innerText = '–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞';

    document.getElementById('finalDeleteBtn').onclick = () => {
        const item = DATA.trash.splice(idx, 1)[0];
        lastPermanentDeletion = item ? { type: 'trash', items: [{ item, index: idx }] } : null;
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
        showToast('–£–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞', '–û—Ç–º–µ–Ω–∞', undoPermanentDelete);
    };
}

function clearTrashForever() {
    if (!DATA.trash.length) return;
    document.getElementById('del-modal-title').innerText = "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É";
    document.getElementById('del-modal-desc').innerText = `–£–¥–∞–ª–∏—Ç—å ${DATA.trash.length} –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è?`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = '–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É';

    document.getElementById('finalDeleteBtn').onclick = () => {
        lastPermanentDeletion = { type: 'trash', items: DATA.trash.map((item, index) => ({ item, index })) };
        DATA.trash = [];
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
        showToast('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', '–û—Ç–º–µ–Ω–∞', undoPermanentDelete);
    };
}

function formatLinkDisplay(url) {
    return (url || '').replace(/^https?:\/\//, '');
}

function buildFallbackLinkTitle(url) {
    try {
        const parsed = new URL(url);
        const cleanPath = parsed.pathname.replace(/\/+$/, '').replace(/^\//, '');
        return cleanPath ? `${parsed.hostname} ‚Ä¢ ${cleanPath}` : parsed.hostname;
    } catch (e) {
        return formatLinkDisplay(url);
    }
}

function setLinkPreviewTitle(titleText) {
    const titleEl = document.getElementById('new-project-link-title');
    if (!titleEl) return;
    titleEl.textContent = titleText;
    titleEl.style.display = titleText ? 'block' : 'none';
}

async function fetchPageTitle(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) return '';
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('text/html')) return '';
        const html = await response.text();
        const match = html.match(/<title[^>]*>([^<]*)<\/title>/i);
        return match ? match[1].trim() : '';
    } catch (e) {
        return '';
    }
}

async function refreshNewProjectLinkTitle() {
    if (!newProjectLink) {
        newProjectLinkTitle = '';
        lastFetchedLinkForTitle = '';
        setLinkPreviewTitle('');
        return;
    }

    const fallback = buildFallbackLinkTitle(newProjectLink);

    if (newProjectLink === lastFetchedLinkForTitle && newProjectLinkTitle) {
        setLinkPreviewTitle(newProjectLinkTitle || fallback);
        return;
    }

    lastFetchedLinkForTitle = newProjectLink;
    const resolvedTitle = await fetchPageTitle(newProjectLink);
    newProjectLinkTitle = resolvedTitle || fallback;

    if (newProjectLink === lastFetchedLinkForTitle) {
        const anchor = document.getElementById('new-project-link-text');
        if (anchor) anchor.title = newProjectLinkTitle || fallback;
        setLinkPreviewTitle(newProjectLinkTitle);
    }
}

function updateNewProjectLinkButton() {
    const btn = document.getElementById('new-project-link-btn');
    const preview = document.getElementById('new-project-link-preview');
    const text = document.getElementById('new-project-link-text');
    const previewLabel = document.getElementById('new-project-link-label');
    if (!btn) return;
    const hasLink = !!newProjectLink;
    btn.classList.toggle('link-active', hasLink);
    btn.style.display = hasLink ? 'none' : 'inline-flex';
    const label = btn.querySelector('span');
    if (label) label.textContent = '–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª—ã';
    if (previewLabel) previewLabel.textContent = hasLink ? '–°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç/–º–∞—Ç–µ—Ä–∏–∞–ª—ã';
    if (preview && text) {
        const displayText = hasLink ? formatLinkDisplay(newProjectLink) : '';
        preview.style.display = hasLink ? 'flex' : 'none';
        text.textContent = displayText;
        text.href = hasLink ? newProjectLink : '#';
        text.title = hasLink ? (newProjectLinkTitle || buildFallbackLinkTitle(newProjectLink)) : '';
        setLinkPreviewTitle(hasLink ? (newProjectLinkTitle || buildFallbackLinkTitle(newProjectLink)) : '');
        if (hasLink) refreshNewProjectLinkTitle();
    }
}

function clearNewProjectLink() {
    newProjectLink = '';
    newProjectLinkTitle = '';
    lastFetchedLinkForTitle = '';
    updateNewProjectLinkButton();
}

function wipeAllData() {
    const ok = confirm('–°—Ç–µ—Ä–µ—Ç—å –≤—Å—é –±–∞–∑—É, –≤–∫–ª—é—á–∞—è —à–∞–±–ª–æ–Ω—ã? –û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è.');
    if (!ok) return;
    localStorage.removeItem(K);
    localStorage.removeItem(NAME_TEMPLATES_KEY);
    location.reload();
}

function collectProjectFormState() {
    return {
        type: document.getElementById('add-proj-type')?.value,
        name: document.getElementById('add-proj-name')?.value,
        client: document.getElementById('add-proj-client')?.value,
        price: document.getElementById('add-proj-price')?.value,
        contractorMode: document.getElementById('add-proj-contractor-mode')?.value,
        contractor: document.getElementById('add-proj-contractor')?.value,
        tax: document.getElementById('add-proj-tax')?.value,
        paid: document.getElementById('add-proj-paid')?.value,
        start: document.getElementById('add-proj-start-val')?.value,
        deadline: document.getElementById('add-proj-dl-val')?.value,
        link: newProjectLink || ''
    };
}

function captureProjectFormSnapshot() {
    projectFormSnapshot = JSON.stringify(collectProjectFormState());
}

function hasProjectFormChanges() {
    if (!projectFormSnapshot) return false;
    return JSON.stringify(collectProjectFormState()) !== projectFormSnapshot;
}

function closeProjectModal() {
    document.getElementById('addProjectModal').style.display = 'none';
    projectFormSnapshot = null;
}

function attemptCloseProjectModal(force = false) {
    if (force || !hasProjectFormChanges()) {
        closeProjectModal();
        return;
    }
    const ok = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ? –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
    if (ok) closeProjectModal();
}

function restoreFromTrash(idx){
    const item = DATA.trash.splice(idx, 1)[0];
    delete item.deletedAt;
    DATA.active.unshift(item);
    save(); switchTab('active');
}

function openAddModal(type = null, idx = null){
    const isEdit = typeof type === 'string' && typeof idx === 'number';
    editContext = isEdit ? { type, idx } : null;
    const titleEl = document.querySelector('#addProjectModal h2');
    const saveBtn = document.querySelector('.add-modal-actions .save-stg');

    updateStatusSelectOptions();

    if (titleEl) titleEl.textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç' : '–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç';
    if (saveBtn) saveBtn.textContent = isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç';

    const presetTimeInput = document.getElementById('add-proj-dl-time');

    if (isEdit) {
        const item = DATA[type][idx];
        document.getElementById('add-proj-name').value = item.n || '';
        document.getElementById('add-proj-client').value = item.c || '';
        document.getElementById('add-proj-price').value = formatPlainNumber(item.p || 0);
        const mode = item.contractorMode || 'none';
        document.getElementById('add-proj-contractor-mode').value = mode;
        handleNewContractorModeChange(mode);
        document.getElementById('add-proj-contractor').value = formatPlainNumber(item.contractor || 0);
        document.getElementById('add-proj-tax').value = String(item.taxPrc ?? 0);
        document.getElementById('add-proj-paid').value = String(item.paid ?? (type === 'archive' ? 100 : type === 'active' ? 50 : 0));
        document.getElementById('add-proj-type').value = type;
        document.getElementById('add-proj-start-val').value = item.start || '';
        document.getElementById('add-proj-dl-val').value = item.dl || '';
        previousDeadlineValue = item.dl || '';
        deadlineUnset = !item.dl;
        document.getElementById('add-proj-start-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(item.start || today);
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay(item.dl);
        document.getElementById('add-proj-dl-days').value = '';
        document.getElementById('add-proj-dl-custom').value = '';
        if (presetTimeInput) presetTimeInput.value = item.dl && item.dl.includes('T') ? item.dl.slice(11, 16) : '';
        newProjectLink = item.link || '';
        newProjectLinkTitle = item.linkTitle || '';
        lastFetchedLinkForTitle = newProjectLinkTitle && newProjectLink ? newProjectLink : '';
        toggleProjectNameClear();
        handleStatusChange(type, { preservePaid: true });
    } else {
        ['name','client','price','contractor'].forEach(id => document.getElementById(`add-proj-${id}`).value = '');
        toggleProjectNameClear();
        document.getElementById('add-proj-tax').value = '0';
        document.getElementById('add-proj-contractor-mode').value = 'none';
        handleNewContractorModeChange('none');
        document.getElementById('add-proj-paid').value = '50';
        document.getElementById('add-proj-type').value = 'active';
        document.getElementById('add-proj-start-val').value = today;
        document.getElementById('add-proj-dl-val').value = '';
        previousDeadlineValue = '';
        deadlineUnset = true;
        document.getElementById('add-proj-dl-days').value = '';
        document.getElementById('add-proj-dl-custom').value = '';
        if (presetTimeInput) presetTimeInput.value = '';
        document.getElementById('add-proj-start-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(today);
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay('');
        handleStatusChange('active');
        newProjectLink = '';
        newProjectLinkTitle = '';
        lastFetchedLinkForTitle = '';
    }
    updateNewProjectLinkButton();
    captureProjectFormSnapshot();
    document.getElementById('addProjectModal').style.display = 'flex';
}
function saveNewProject(){
    const nameInput = document.getElementById('add-proj-name');
    const clientInput = document.getElementById('add-proj-client');
    const name = (nameInput?.value || '').trim();
    const client = (clientInput?.value || '').trim();
    [nameInput, clientInput].forEach(el => el?.classList.remove('input-error'));
    if (!name || !client) {
        nameInput?.classList.toggle('input-error', !name);
        clientInput?.classList.toggle('input-error', !client);
        alert('–£–∫–∞–∂–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞.');
        return;
    }
    const price = toNumeric(document.getElementById('add-proj-price').value);
    const contrMode = document.getElementById('add-proj-contractor-mode').value || 'none';
    const contr = contrMode === 'none' ? 0 : toNumeric(document.getElementById('add-proj-contractor').value);
    const tax = +document.getElementById('add-proj-tax').value || 0;
    const paid = +document.getElementById('add-proj-paid').value || 0;
    const type = document.getElementById('add-proj-type').value;
    const start = document.getElementById('add-proj-start-val').value || today;
    const rawDeadline = (document.getElementById('add-proj-dl-val').value || '').trim();
    const isDeadlineCleared = deadlineUnset || rawDeadline === '';
    const finalDeadline = isDeadlineCleared ? '' : rawDeadline;

    const isEdit = !!editContext;
    const base = isEdit ? { ...DATA[editContext.type][editContext.idx] } : {};

    const item = {
        ...base,
        n: name, c: client, p: price, contractor: contr, contractorMode: contrMode, taxPrc: tax, link: newProjectLink,
        linkTitle: newProjectLink ? (newProjectLinkTitle || buildFallbackLinkTitle(newProjectLink)) : undefined,
        start: type==='active'? start : base.start,
        dl: type==='active' || type==='waiting' || type==='paused'
            ? (isDeadlineCleared ? '' : (finalDeadline || base.dl || ''))
            : undefined,
        paid: type==='archive' ? 100 : paid,
        date: type==='archive' ? today : base.date
    };

    if (type === 'potential') {
        delete item.start;
        delete item.dl;
    }

    if (isEdit) {
        const fromType = editContext.type;
        DATA[fromType].splice(editContext.idx, 1);
        if (fromType === type) {
            DATA[type].splice(editContext.idx, 0, item);
        } else {
            DATA[type].unshift(item);
        }
        editContext = null;
    } else {
        DATA[type].unshift(item);
    }
    closeProjectModal();
    showToast(isEdit ? '–ü—Ä–æ–µ–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω');
    sortData('active', 'dl', 'date', true);
    save(); switchTab(type);
}

function applyDeadlinePreset() {
    const select = document.getElementById('add-proj-dl-days');
    const customInput = document.getElementById('add-proj-dl-custom');
    const timeInput = document.getElementById('add-proj-dl-time');

    const isCustomPreset = select.value === 'custom';
    // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ 'custom' –ò–õ–ò —É–∂–µ –≤–≤–µ–¥–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ custom, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ
    if (isCustomPreset) {
        customInput.style.display = 'block';
        // –ù–µ –¥–µ–ª–∞–µ–º focus –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∏–Ω–∞—á–µ —Å–±–∏–≤–∞–µ—Ç—Å—è –≤–≤–æ–¥
    } else {
        customInput.style.display = customInput.value ? 'block' : 'none';
    }

    deadlineUnset = false;
    const currentStart = document.getElementById('add-proj-start-val').value || today;
    const currentDl = document.getElementById('add-proj-dl-val').value || currentStart || today;
    const startTime = currentStart && currentStart.includes('T') ? currentStart.slice(11, 16) : '';
    const manualTime = (timeInput?.value || '').trim();
    const finalTime = manualTime || startTime;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏
    if (!previousDeadlineValue) {
        previousDeadlineValue = currentDl;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –≤ –∏–Ω–ø—É—Ç, –Ω–æ —Å–µ–ª–µ–∫—Ç –Ω–µ custom (–±—ã–≤–∞–µ—Ç —Ä–µ–¥–∫–æ), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º
    if (document.activeElement === customInput && select.value !== 'custom') {
        select.value = 'custom';
    }

    // –ï—Å–ª–∏ "–ë—ã—Å—Ç—Ä—ã–π —Å—Ä–æ–∫" (–ø—É—Å—Ç–æ), –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∏–ª–∏ —Ç–µ–∫—É—â–µ–µ
    if (select.value === '') {
        customInput.value = '';
        customInput.style.display = 'none';
        const restoreValue = previousDeadlineValue || '';
        document.getElementById('add-proj-dl-val').value = restoreValue;
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay(restoreValue);
        deadlineUnset = !restoreValue;
        return;
    }

    let days = 0;
    if (isCustomPreset) {
        days = parseInt(customInput.value, 10);
    } else {
        days = parseInt(select.value, 10);
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–µ—Å–µ—Ç, –æ—á–∏—â–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ –Ω–∞—Å–∏–ª—å–Ω–æ, –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç
        customInput.value = '';
    }

    if (!days || isNaN(days) || days <= 0) return; // –ñ–¥–µ–º –≤–∞–ª–∏–¥–Ω–æ–≥–æ —á–∏—Å–ª–∞

    const startRaw = document.getElementById('add-proj-start-val').value || today;
    const baseDate = new Date(startRaw.replace(' ', 'T'));
    if (isNaN(baseDate)) return;
    
    const dlDate = new Date(baseDate);
    dlDate.setDate(dlDate.getDate() + days);
    
    const deadlineValue = formatDateWithTime(dlDate, finalTime);
    document.getElementById('add-proj-dl-val').value = deadlineValue;
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay(deadlineValue);
}

function clearNewProjectDeadline() {
    deadlineUnset = true;
    document.getElementById('add-proj-dl-val').value = '';
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay('');
    document.getElementById('add-proj-dl-days').value = '';
    document.getElementById('add-proj-dl-custom').value = '';
    previousDeadlineValue = '';
    const presetTimeInput = document.getElementById('add-proj-dl-time');
    if (presetTimeInput) presetTimeInput.value = '';
}

function handleStatusChange(status, options = {}) {
    const { preservePaid = false } = options;
    const dateBlocks = document.querySelectorAll('.status-dates');
    dateBlocks.forEach(block => block.style.display = status === 'potential' ? 'none' : '');
    if (status === 'potential') {
        document.getElementById('add-proj-dl-days').value = '';
        document.getElementById('add-proj-dl-custom').value = '';
    }

    const paidSelect = document.getElementById('add-proj-paid');
    if (paidSelect && status === 'archive') {
        paidSelect.value = '100';
    } else if (paidSelect && !preservePaid) {
        const defaultPaid = status === 'archive' ? 100 : status === 'active' ? 50 : 0;
        paidSelect.value = String(defaultPaid);
    }
}

function getPresetBaseDate() {
    if (queue.targetId) {
        if (queue.targetId === 'add-proj-dl-val') {
            return document.getElementById('add-proj-start-val').value || today;
        }
        return document.getElementById(queue.targetId)?.value || today;
    }
    if (queue.type && typeof queue.idx === 'number') {
        const item = DATA[queue.type][queue.idx] || {};
        if (queue.field === 'dl') return item.start || item.dl || item.date || today;
        return item[queue.field] || item.start || today;
    }
    return today;
}

function applyDateModalPreset() {
    const select = document.getElementById('date-modal-preset');
    const customInput = document.getElementById('date-modal-custom');
    if (!select) return;

    const isCustom = select.value === 'custom';
    customInput.style.display = isCustom ? 'block' : 'none';

    if (document.activeElement === customInput && select.value !== 'custom') {
        select.value = 'custom';
    }

    if (select.value === '') {
        customInput.value = '';
        return;
    }

    let days = parseInt(select.value, 10);
    if (select.value === 'custom') {
        days = parseInt(customInput.value, 10);
    }
    if (!days || days <= 0) return;

    const baseRaw = (getPresetBaseDate() || today).slice(0, 10);
    const baseDate = new Date(baseRaw + 'T00:00:00');
    if (isNaN(baseDate)) return;
    baseDate.setDate(baseDate.getDate() + days);
    const nextDate = baseDate.toISOString().slice(0, 10);

    if (datePicker) datePicker.setDate(nextDate, true);
    else document.getElementById('date-input-val').value = nextDate;
}

function openDate(type, idx, field){
    queue = {type, idx, field, targetId: null};
    const val = DATA[type][idx][field];
    openDateBase(val);
}
function openDateInModal(targetInputId){
    const val = document.getElementById(targetInputId).value;
    if (targetInputId === 'add-proj-dl-val') deadlineUnset = false;
    queue = {type: null, idx: null, field: null, targetId: targetInputId};
    openDateBase(val);
}
function setupDatePickers(){
    if (typeof flatpickr !== 'function') return;

    datePicker = flatpickr('#date-input-val', {
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'j M',
        defaultDate: today,
        locale: flatpickr.l10ns.ru,
        disableMobile: true,
    });

    timePicker = flatpickr('#time-input-val', {
        enableTime: true,
        noCalendar: true,
        dateFormat: 'H:i',
        defaultDate: '12:00',
        time_24hr: true,
        minuteIncrement: 5,
        disableMobile: true,
    });
}
function openDateBase(val) {
    const hasTime = val && val.includes('T') && val.length > 10;
    document.getElementById('date-has-time').checked = hasTime;

    const dateVal = val ? val.slice(0, 10) : today;
    const timeVal = hasTime ? val.slice(11, 16) : '12:00';

    const modalPreset = document.getElementById('date-modal-preset');
    const modalCustom = document.getElementById('date-modal-custom');
    if (modalPreset) modalPreset.value = '';
    if (modalCustom) modalCustom.value = '';

    if (datePicker) datePicker.setDate(dateVal, true);
    else document.getElementById('date-input-val').value = dateVal;

    if (timePicker) timePicker.setDate(timeVal, true, 'H:i');
    else document.getElementById('time-input-val').value = timeVal;

    toggleTimeInput();

    const clearBtn = document.getElementById('date-modal-clear');
    const isDeadlineContext = (queue?.targetId && queue.targetId.includes('dl')) || queue?.field === 'dl';
    const presetBlock = document.querySelector('.modal-deadline-presets');
    if (clearBtn) {
        clearBtn.style.display = isDeadlineContext ? 'inline-flex' : 'none';
    }
    if (presetBlock) {
        presetBlock.style.display = isDeadlineContext ? 'flex' : 'none';
    }
    document.getElementById('dateModal').style.display = 'flex';
}
function toggleTimeInput(){
    const chk = document.getElementById('date-has-time');
    const baseInput = document.getElementById('time-input-val');
    const inputs = [baseInput, timePicker?.input, timePicker?.altInput].filter(Boolean);

    inputs.forEach(inp => {
        inp.disabled = !chk.checked;
        inp.style.opacity = chk.checked ? '1' : '0.3';
    });

    if (timePicker) {
        timePicker.set('clickOpens', chk.checked);
    }
}
function clearDateModalDeadline() {
    const dateInput = document.getElementById('date-input-val');
    const timeInput = document.getElementById('time-input-val');
    const isDeadlineContext = (queue?.targetId && queue.targetId.includes('dl')) || queue?.field === 'dl';
    if (!isDeadlineContext) return;

    if (datePicker) datePicker.clear();
    else if (dateInput) dateInput.value = '';
    if (timePicker) timePicker.clear();
    if (timeInput) timeInput.value = '';

    const timeToggle = document.getElementById('date-has-time');
    if (timeToggle) {
        timeToggle.checked = false;
        toggleTimeInput();
    }

    if (queue?.targetId) {
        const displayId = queue.targetId.replace('-val', '-display');
        const displayNode = document.getElementById(displayId)?.querySelector('.date-text-display');
        document.getElementById(queue.targetId).value = '';
        if (displayNode) displayNode.innerHTML = formatDeadlineDisplay('');
        if (queue.targetId === 'add-proj-dl-val') deadlineUnset = true;
        closeDateModal();
        return;
    }

    if (queue?.type && typeof queue.idx === 'number') {
        DATA[queue.type][queue.idx].dl = '';
        closeDateModal();
        save();
        upd();
    }
}
function closeDateModal(){ document.getElementById('dateModal').style.display = 'none'; }
function saveDate(){
    const d = document.getElementById('date-input-val').value;
    const t = document.getElementById('time-input-val').value;
    const useTime = document.getElementById('date-has-time').checked;
    if(!d) return;
    const result = useTime ? `${d}T${t}` : d;

    if (queue.targetId) {
        document.getElementById(queue.targetId).value = result;
        const displayId = queue.targetId.replace('-val', '-display');
        const formatter = queue.targetId.includes('dl') ? formatDeadlineDisplay : formatDateDisplay;
        document.getElementById(displayId).querySelector('.date-text-display').innerHTML = formatter(result);
        if (queue.targetId === 'add-proj-dl-val') { previousDeadlineValue = result; deadlineUnset = false; }
        if (queue.targetId === 'add-proj-start-val') {
            const presetTimeInput = document.getElementById('add-proj-dl-time');
            if (presetTimeInput && result.includes('T')) {
                presetTimeInput.value = result.slice(11, 16);
            }
            const presetDays = parseInt(document.getElementById('add-proj-dl-days').value, 10);
            if (presetDays) applyDeadlinePreset();
        }
    } else {
        DATA[queue.type][queue.idx][queue.field] = result;
        sortData('active', 'dl', 'date', true);
    }
    
    closeDateModal(); save(); upd();
}

function openProjectLink(idx, type) {
    const link = DATA[type][idx].link;
    if (link) {
        window.open(link, '_blank');
    } else {
        openLink(type, idx);
    }
}
function openLink(type, idx){
    queue = {type, idx};
    const currentLink = type === 'new' ? newProjectLink : (DATA[type][idx]?.link || '');
    const tgCheckbox = document.getElementById('link-is-telegram');
    let displayValue = currentLink;

    if (currentLink.match(/t\.me\//)) {
        tgCheckbox.checked = true;
        displayValue = currentLink.replace(/^https?:\/\/t\.me\//, '').replace(/^@+/, '');
    } else {
        tgCheckbox.checked = false;
    }

    document.getElementById('link-input').value = displayValue;
    document.getElementById('linkModal').style.display = 'flex';
}
function closeLinkModal(){ document.getElementById('linkModal').style.display = 'none'; }
function saveLink(){
    const isTelegram = document.getElementById('link-is-telegram').checked;
    const raw = document.getElementById('link-input').value;
    const normalized = normalizeLinkValue(raw, isTelegram);
    const fallbackTitle = normalized ? buildFallbackLinkTitle(normalized) : '';

    lastFetchedLinkForTitle = '';

    if (queue.type === 'new') {
        newProjectLink = normalized;
        newProjectLinkTitle = fallbackTitle;
        updateNewProjectLinkButton();
        queue = { type: null, idx: null, field: null, targetId: null };
        closeLinkModal();
        return;
    }

    const queueType = queue.type;
    const queueIdx = queue.idx;
    const targetItem = DATA[queueType][queueIdx];
    if (targetItem) {
        targetItem.link = normalized;
        targetItem.linkTitle = normalized ? fallbackTitle : undefined;

        if (normalized) {
            fetchPageTitle(normalized).then(title => {
                const updatedItem = DATA[queueType]?.[queueIdx];
                if (!title || !updatedItem || updatedItem.link !== normalized) return;
                updatedItem.linkTitle = title;
                save();
            });
        }
    }
    closeLinkModal(); save(); upd();
}

function startProjectEdit(type, idx) {
    openAddModal(type, idx);
}

function collectSettingsFormState() {
    const selectedMode = document.querySelector('input[name="theme-mode"]:checked');
    const readToggle = (id) => document.getElementById(id)?.checked !== false;
    return {
        mode: selectedMode ? selectedMode.value : (UI_PREFS.themeMode || 'dark'),
        blockVisibility: {
            backup: readToggle('block-toggle-backup'),
            pace: readToggle('block-toggle-pace'),
            dashboard: readToggle('block-toggle-dashboard'),
            efficiency: readToggle('block-toggle-efficiency'),
            topClients: readToggle('block-toggle-top-clients'),
            record: readToggle('block-toggle-record'),
            reputation: readToggle('block-toggle-reputation'),
        },
        tableVisibility: {
            requests: readToggle('table-toggle-requests'),
            waiting: readToggle('table-toggle-waiting'),
            paused: readToggle('table-toggle-paused'),
        },
        statVisibility: {
            goal: readToggle('stat-toggle-goal'),
            fact: readToggle('stat-toggle-fact'),
            activeFact: readToggle('stat-toggle-active-fact'),
            paidGross: readToggle('stat-toggle-paid-gross'),
            totalGross: readToggle('stat-toggle-total-gross'),
            plan: readToggle('stat-toggle-plan'),
            forecast: readToggle('stat-toggle-forecast'),
            expenses: readToggle('stat-toggle-expenses'),
            taxes: readToggle('stat-toggle-taxes'),
        },
        goal: toNumeric(document.getElementById('stg-goal')?.value),
        record: toNumeric(document.getElementById('stg-rec')?.value)
    };
}

function captureSettingsSnapshot() {
    settingsSnapshot = collectSettingsFormState();
    settingsInitialState = {
        prefs: JSON.parse(JSON.stringify(UI_PREFS)),
        mode: UI_PREFS.themeMode,
        storedTheme: localStorage.getItem(THEME_KEY),
        overrideTheme: localStorage.getItem(THEME_OVERRIDE_KEY),
    };
}

function hasSettingsChanges() {
    if (!settingsSnapshot) return false;
    return JSON.stringify(collectSettingsFormState()) !== JSON.stringify(settingsSnapshot);
}

function closeSettingsModal() {
    document.getElementById('settingsModal').style.display = 'none';
    document.getElementById('settingsUnsavedModal').style.display = 'none';
    settingsSnapshot = null;
    settingsInitialState = null;
}

function attemptCloseSettings(force = false) {
    if (force || !hasSettingsChanges()) {
        closeSettingsModal();
        return;
    }
    const ok = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ? –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
    if (ok) discardSettingsChanges();
}

function discardSettingsChanges() {
    if (settingsInitialState) {
        UI_PREFS = JSON.parse(JSON.stringify(settingsInitialState.prefs));
        persistUiPrefs();
        if (settingsInitialState.storedTheme) localStorage.setItem(THEME_KEY, settingsInitialState.storedTheme); else localStorage.removeItem(THEME_KEY);
        if (settingsInitialState.overrideTheme) localStorage.setItem(THEME_OVERRIDE_KEY, settingsInitialState.overrideTheme); else localStorage.removeItem(THEME_OVERRIDE_KEY);
        applyThemeMode(settingsInitialState.mode || 'dark', { silent: true, skipSave: true, respectOverride: false });
        applyBlockVisibility();
        applyTableVisibility();
        applyStatVisibility();
        applyStatOrder();
        applyBlockOrder();
    }
    closeSettingsModal();
}

function previewThemeMode(mode) {
    applyThemeMode(mode || UI_PREFS.themeMode || 'dark', { skipSave: true });
}

function openSettings(){
    activateSettingsPane('appearance');
    document.getElementById('stg-goal').value = formatPlainNumber(DATA.monthlyGoals[currentMonth] || 250000);
    document.getElementById('stg-rec').value = formatPlainNumber(DATA.settings.record || 0);
    const mode = UI_PREFS.themeMode || 'dark';
    ['auto', 'light', 'dark'].forEach(m => {
        const radio = document.getElementById(`theme-mode-${m}`);
        if (radio) radio.checked = mode === m;
        if (radio && !radio.dataset.previewBound) {
            radio.addEventListener('change', (e) => previewThemeMode(e.target.value));
            radio.dataset.previewBound = '1';
        }
    });
    const visibility = UI_PREFS.blockVisibility || {};
    const toggleMap = [
        ['block-toggle-backup', 'backup'],
        ['block-toggle-pace', 'pace'],
        ['block-toggle-dashboard', 'dashboard'],
        ['block-toggle-efficiency', 'efficiency'],
        ['block-toggle-top-clients', 'topClients'],
        ['block-toggle-record', 'record'],
        ['block-toggle-reputation', 'reputation']
    ];
    toggleMap.forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) {
            el.checked = visibility[key] !== false;
            if (!el.dataset.previewBound) {
                el.addEventListener('change', updateSettingsPreviewStates);
                el.dataset.previewBound = '1';
            }
        }
    });
    const tableVisibility = UI_PREFS.tableVisibility || {};
    [
        ['table-toggle-requests', 'requests'],
        ['table-toggle-waiting', 'waiting'],
        ['table-toggle-paused', 'paused'],
    ].forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.checked = tableVisibility[key] !== false;
    });
    const statVisibility = UI_PREFS.statVisibility || {};
    [
        ['stat-toggle-goal', 'goal'],
        ['stat-toggle-fact', 'fact'],
        ['stat-toggle-active-fact', 'activeFact'],
        ['stat-toggle-paid-gross', 'paidGross'],
        ['stat-toggle-total-gross', 'totalGross'],
        ['stat-toggle-plan', 'plan'],
        ['stat-toggle-forecast', 'forecast'],
        ['stat-toggle-expenses', 'expenses'],
        ['stat-toggle-taxes', 'taxes'],
    ].forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.checked = statVisibility[key] !== false;
    });
    updateSettingsPreviewStates();
    captureSettingsSnapshot();
    document.getElementById('settingsModal').style.display = 'flex';
}
function openGoalSettings(){
    openSettings();
    activateSettingsPane('data');
    const goalInput = document.getElementById('stg-goal');
    if (goalInput) {
        goalInput.focus();
        goalInput.select();
    }
}
function openRecordSettings(){
    openSettings();
    activateSettingsPane('data');
    const recordInput = document.getElementById('stg-rec');
    if (recordInput) {
        recordInput.focus();
        recordInput.select();
    }
}
function saveSettings(){
    const selectedMode = document.querySelector('input[name="theme-mode"]:checked');
    UI_PREFS.blockVisibility = {
        backup: document.getElementById('block-toggle-backup')?.checked !== false,
        pace: document.getElementById('block-toggle-pace')?.checked !== false,
        dashboard: document.getElementById('block-toggle-dashboard')?.checked !== false,
        efficiency: document.getElementById('block-toggle-efficiency')?.checked !== false,
        topClients: document.getElementById('block-toggle-top-clients')?.checked !== false,
        record: document.getElementById('block-toggle-record')?.checked !== false,
        reputation: document.getElementById('block-toggle-reputation')?.checked !== false,
    };
    UI_PREFS.tableVisibility = {
        requests: document.getElementById('table-toggle-requests')?.checked !== false,
        waiting: document.getElementById('table-toggle-waiting')?.checked !== false,
        paused: document.getElementById('table-toggle-paused')?.checked !== false,
    };
    UI_PREFS.statVisibility = {
        goal: document.getElementById('stat-toggle-goal')?.checked !== false,
        fact: document.getElementById('stat-toggle-fact')?.checked !== false,
        activeFact: document.getElementById('stat-toggle-active-fact')?.checked !== false,
        paidGross: document.getElementById('stat-toggle-paid-gross')?.checked !== false,
        totalGross: document.getElementById('stat-toggle-total-gross')?.checked !== false,
        plan: document.getElementById('stat-toggle-plan')?.checked !== false,
        forecast: document.getElementById('stat-toggle-forecast')?.checked !== false,
        expenses: document.getElementById('stat-toggle-expenses')?.checked !== false,
        taxes: document.getElementById('stat-toggle-taxes')?.checked !== false,
    };
    if (selectedMode) {
        applyThemeMode(selectedMode.value);
    } else {
        persistUiPrefs();
    }
    applyBlockVisibility();
    applyTableVisibility();
    applyStatVisibility();
    DATA.monthlyGoals[currentMonth] = toNumeric(document.getElementById('stg-goal').value);
    DATA.settings.record = toNumeric(document.getElementById('stg-rec').value);
    closeSettingsModal();
    save(); upd();
}

function resetInterface() {
    const ok = confirm('–í–µ—Ä–Ω—É—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º? –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ç–µ–º—ã –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã, –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ –Ω–µ –ø–æ–≤–ª–∏—è–µ—Ç ‚Äî –ø—Ä–æ–µ–∫—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.');
    if (!ok) return;
    UI_PREFS = JSON.parse(JSON.stringify(DEFAULT_UI_PREFS));
    persistUiPrefs();
    applyThemeMode(UI_PREFS.themeMode || 'dark', { silent: true });
    applyBlockVisibility();
    applyBlockOrder();
    applyTableVisibility();
    applyStatVisibility();
    applyStatOrder();
    layoutEditMode = false;
    updateLayoutEditButton();
    setupEditableBlocks();
    upd();
    openSettings();
    showToast('–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–±—Ä–æ—à–µ–Ω');
}

function pluralize(num, forms){
    const n = Math.abs(num) % 100;
    const n1 = n % 10;
    if (n > 10 && n < 20) return forms[2];
    if (n1 > 1 && n1 < 5) return forms[1];
    if (n1 === 1) return forms[0];
    return forms[2];
}

  function normalizeDateTimeValue(val, { endOfDayIfDateOnly = true } = {}) {
      if (!val) return null;
      const normalized = val.replace(' ', 'T');
      const hasTime = normalized.includes('T') && normalized.length > 10;
      const base = normalized.slice(0, 10);
      if (!base) return null;
      const dateString = hasTime ? normalized : `${base}T${endOfDayIfDateOnly ? '23:59:59' : '00:00:00'}`;
      const parsed = new Date(dateString);
      return isNaN(parsed.getTime()) ? null : parsed;
  }

  function normalizeToMidnight(dateObj) {
      return new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
  }

  function getTimeRemaining(dl){
      const targetExact = normalizeDateTimeValue(dl, { endOfDayIfDateOnly: true });
      if(!targetExact) return {txt:'‚àû', cls:'days-infinite', days: Infinity, isInfinite: true};
      const now = new Date();
      const dayMs = 1000 * 60 * 60 * 24;
      const hourMs = 1000 * 60 * 60;
      const dayDiff = Math.ceil((normalizeToMidnight(targetExact).getTime() - normalizeToMidnight(now).getTime()) / dayMs);
      const msLeft = targetExact.getTime() - now.getTime();
      const hoursRemainder = Math.max(0, Math.floor((msLeft % dayMs) / hourMs));
      const shortHours = Math.max(1, hoursRemainder);

      if(msLeft < 0) {
          const overdueDays = Math.floor(Math.abs(msLeft) / dayMs);
          const overdueHours = Math.floor((Math.abs(msLeft) % dayMs) / hourMs);
          const overdueText = `${overdueDays} ${pluralize(overdueDays, ['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'])} ${overdueHours} ${pluralize(overdueHours || 1, ['—á–∞—Å','—á–∞—Å–∞','—á–∞—Å–æ–≤'])}`.trim();
          return {
              txt:'–°—Ä–æ–∫ –≤—ã—à–µ–ª',
              cls:'days-critical',
              days: -1,
              overdue: true,
              overdueTooltip: `–°—Ä–æ–∫ –≤—ã—à–µ–ª: –ø—Ä–æ—Å—Ä–æ—á–∫–∞ ${overdueText}`
          };
      }
      const hoursText = dayDiff === 0 ? shortHours : hoursRemainder;
      const text = `${Math.max(0, dayDiff)}–¥ ${hoursText}—á`;

      if(dayDiff === 0) return {txt: text, cls:'days-critical', days: dayDiff};
      if(dayDiff <= 3) return {txt: text, cls:'days-warning', days: dayDiff};
      return {txt: text, cls:'days-normal', days: dayDiff};
  }

  function hydrateArchiveCompletionMeta() {
      if (!Array.isArray(DATA.archive)) return;
      DATA.archive.forEach((item = {}) => {
          if (!item.deadlineSnapshot && item.dl) {
              item.deadlineSnapshot = item.dl;
          }
          if (item.completedOnTime === undefined) {
              const status = analyzeCompletionStatus(item);
              if (status.onTime !== null) item.completedOnTime = status.onTime;
          }
      });
  }

  function analyzeCompletionStatus(item) {
      if (!item) return { completionDate: null };

      const completionDate = normalizeDateTimeValue(item.date, { endOfDayIfDateOnly: true });
      const deadlineRaw = item.deadlineSnapshot || item.dl || null;
      const deadlineDate = normalizeDateTimeValue(deadlineRaw, { endOfDayIfDateOnly: true });

      let onTime = null;
      if (typeof item.completedOnTime === 'boolean') {
          onTime = item.completedOnTime;
      } else if (completionDate && deadlineDate) {
          onTime = completionDate.getTime() <= deadlineDate.getTime();
      }

      const delayMs = (completionDate && deadlineDate) ? completionDate.getTime() - deadlineDate.getTime() : 0;
      const delayDays = delayMs > 0 ? Math.ceil(delayMs / (1000 * 60 * 60 * 24)) : 0;

      return {
          completionDate,
          deadlineDate,
          onTime,
          delayDays
      };
  }

function getArchiveByMonth(month = currentMonth) {
    return DATA.archive.filter(i => (i.date || '').startsWith(month));
}

function changeMonth(m){ 
    currentMonth = m; 
    if (!DATA.monthlyGoals[currentMonth]) {
        DATA.monthlyGoals[currentMonth] = 250000;
        save();
    }
    upd();
}
function renderMonthSelect(){
    const sel = document.getElementById('monthSelect');
    const months = new Set([today.slice(0,7)]);
    [...DATA.archive, ...DATA.active].forEach(i => {
        if(i.date) months.add(i.date.slice(0,7));
        if(i.start) months.add(i.start.slice(0,7));
    });
    Object.keys(DATA.monthlyGoals).forEach(m => months.add(m));

    sel.innerHTML = '';
    Array.from(months).sort().reverse().forEach(m => {
        const d = new Date(m + '-01');
        const name = d.toLocaleString('ru', {month:'long', year:'numeric'});
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        if(m===currentMonth) opt.selected = true;
        sel.appendChild(opt);
    });
}

const repCenterText = {
    id: 'repCenterText',
    afterDraw(chart, args, opts) {
        const { ctx, chartArea: { width, height } } = chart;
        const styles = getComputedStyle(document.body);
        const textColor = (styles.getPropertyValue('--text') || '#f0f6fc').trim();
        const mutedColor = (styles.getPropertyValue('--muted') || '#8b949e').trim();
        ctx.save();
        ctx.font = '900 22px -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif';
        ctx.fillStyle = textColor;
        ctx.textAlign = 'center';
        ctx.fillText(opts.text || '', width / 2, height / 2 + 6);
        ctx.font = '600 12px -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif';
        ctx.fillStyle = mutedColor;
        ctx.fillText(opts.subText || '', width / 2, height / 2 + 22);
        ctx.restore();
    }
};

function analyzeReputation(){
    const projectTypes = ['active', 'waiting', 'paused', 'potential'];
    const overdue = [];
    projectTypes.forEach(type => {
        DATA[type].forEach(item => {
            const rem = getTimeRemaining(item.dl);
            if (rem.days < 0) {
                overdue.push({
                    name: item.n || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                    client: item.c || '–ë–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞',
                    days: Math.abs(rem.days)
                });
            }
        });
    });

    const total = overdue.length;
    const worst = overdue.reduce((acc, cur) => Math.max(acc, cur.days), 0);
    const avg = total ? Math.round(overdue.reduce((acc, cur) => acc + cur.days, 0) / total) : 0;
    const activeCount = DATA.active.length;
    const nearDeadline = DATA.active.filter(item => {
        const rem = getTimeRemaining(item.dl);
        return rem.days >= 0 && rem.days <= 2;
    }).length;
    const onTime = Math.max(activeCount - total - nearDeadline, 0);
    const score = Math.max(0, Math.min(100, 100 - total * 12 - Math.max(0, worst - 2) * 3 - nearDeadline * 2));

    let level = 'good';
    let headline = '–í—Å—ë –æ–∫ ‚Äî —Ç—ã –¥–µ—Ä–∂–∏—à—å —Å—Ä–æ–∫–∏';
    let hint = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.';
    let chip = '–°—Ç–∞–±–∏–ª—å–Ω–æ';
    let detail = '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–∫ —É—Å–∏–ª–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤. –î–µ—Ä–∂–∏ —Ç–µ–º–ø –∏ —Ñ–∏–∫—Å–∏—Ä—É–π —É—Å–ø–µ—Ö–∏ –≤ –∞—Ä—Ö–∏–≤–µ.';
    let fallout = '–°–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–∏–≤—ã—á–∫—É –æ–ø–µ—Ä–µ–∂–∞—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã ‚Äî —ç—Ç–æ –ª–∏—á–Ω—ã–π –±—Ä–µ–Ω–¥ –∏ –ø–æ—Ç–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.';
    let tips = [
        '–§–∏–∫—Å–∏—Ä—É–π –¥–µ–¥–ª–∞–π–Ω—ã –ø—Ä–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–¥–∞—á, —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É.',
        '–ó–∞–∫—Ä—ã–≤–∞–π –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ –∞—Ä—Ö–∏–≤ ‚Äî —ç—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥.',
    ];

    if (total > 0) {
        const overdueWord = `${total} ${pluralize(total, ['–ø—Ä–æ—Å—Ä–æ—á–∫–∞', '–ø—Ä–æ—Å—Ä–æ—á–∫–∏', '–ø—Ä–æ—Å—Ä–æ—á–µ–∫'])}`;
        const daysWord = `${worst} ${pluralize(worst, ['–¥–µ–Ω—å', '–¥–Ω—è', '–¥–Ω–µ–π'])}`;
        if (total <= 2 && worst <= 5) {
            level = 'warn';
            headline = '–ï—Å—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏ ‚Äî –ø–æ–ø—Ä–∞–≤—å —Å—Ä–æ–∫–∏';
            hint = `${overdueWord} –¥–æ ${daysWord}. –û–±–Ω–æ–≤–∏ –ø–ª–∞–Ω –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.`;
            chip = '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è';
            detail = '–ü–∞—Ä–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ –µ—â—ë –ø–æ–ø—Ä–∞–≤–∏–º–∞: –¥–æ–≥–æ–≤–æ—Ä–∏—Å—å –æ –Ω–æ–≤—ã—Ö —Å—Ä–æ–∫–∞—Ö –∏ –∑–∞–∫—Ä–æ–π –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–æ–≤–µ—Ä–∏–µ.';
            fallout = '–ï—Å–ª–∏ —Ç–∞–∫ —Ç—è–Ω—É—Ç—å –∏ –¥–∞–ª—å—à–µ, –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–Ω—É—Ç –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –∏ —É–π–¥—É—Ç –∫ —Ç–µ–º, –∫—Ç–æ –¥–µ—Ä–∂–∏—Ç —Å—Ä–æ–∫–∏.';
            tips = [
                '–î–æ–≥–æ–≤–æ—Ä–∏—Å—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –æ –Ω–æ–≤—ã—Ö —Å—Ä–æ–∫–∞—Ö –∏ –æ—Ç–º–µ—Ç—å –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ.',
                '–°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ –∑–∞–¥–∞—á–∞—Ö —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Å—Ä–æ—á–∫–æ–π, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å –∫—Ä–∞—Å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã.',
                '–û—Ç–ª–æ–∂–∏ –Ω–æ–≤—ã–µ –±—Ä–æ–Ω–∏ –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—É—â–∏—Ö —Ö–≤–æ—Å—Ç–æ–≤.',
            ];
        } else {
            level = 'bad';
            headline = '–†–µ–ø—É—Ç–∞—Ü–∏—è –ø—Ä–æ—Å–µ–¥–∞–µ—Ç';
            hint = `${overdueWord} –¥–æ ${daysWord} ‚Äî –ø–æ—Ä–∞ —Å–ø–∞—Å–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é.`;
            chip = '–ö—Ä–∏—Ç–∏—á–Ω–æ';
            detail = '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ —É–∂–µ –±—å—é—Ç –ø–æ –∏–º–µ–Ω–∏. –ù–∞–≤–µ–¥–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö –∏ –≤–µ—Ä–Ω–∏ —Å—Ä–æ–∫–∏ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—å.';
            fallout = '–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å—Ä—ã–≤–æ–≤ = —à—Ç—Ä–∞—Ñ—ã, –≤–æ–∑–≤—Ä–∞—Ç—ã –∏ –∂—ë—Å—Ç–∫–∏–µ –æ—Ç–∑—ã–≤—ã. –õ–∏–¥—ã –±—É–¥—É—Ç –æ–±—Ö–æ–¥–∏—Ç—å —Ç–µ–±—è —Å—Ç–æ—Ä–æ–Ω–æ–π.';
            tips = [
                '–°–æ—Å—Ç–∞–≤—å –∞–Ω—Ç–∏–∫—Ä–∏–∑–∏—Å–Ω—ã–π —Å–ø–∏—Å–æ–∫: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–π —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –∏ –¥–æ—Ä–æ–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã.',
                '–†–∞–∑–±–µ–π –æ–±—ä—ë–º –Ω–∞ –∫—Ä–∞—Ç–∫–∏–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –æ—Ç–º–µ—á–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å.',
                '–û–ø–æ–≤–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ —Å—Ç–∞—Ç—É—Å–µ ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤ –ø–æ –ø—Ä–æ—Å—Ä–æ—á–∫–∞–º.',
            ];
        }
    } else if (nearDeadline > 0) {
        fallout = '–ï—Å–ª–∏ –ø—Ä–æ–º–æ—Ä–≥–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –¥–Ω—è ‚Äî –æ–Ω–∏ —É–π–¥—É—Ç –≤ –∫—Ä–∞—Å–Ω—É—é –∑–æ–Ω—É –∏ –ø–æ—Ç—è–Ω—É—Ç —Ä–µ–π—Ç–∏–Ω–≥ –≤–Ω–∏–∑.';
        tips.push('–ù–∞ —Ä–∞–¥–∞—Ä–µ –µ—Å—Ç—å –∑–∞–¥–∞—á–∏ —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –¥–Ω—è ‚Äî –≤—ã–¥–µ–ª–∏ –ø–æ–¥ –Ω–∏—Ö —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã.');
    }

    return { level, headline, hint, chip, detail, fallout, score, total, worst, avg, activeCount, nearDeadline, tips, onTime };
}

function openReputationTasks() {
    if (isTableEnabled('active')) {
        switchTab('active');
        const tabBtn = document.getElementById('tab-active');
        if (tabBtn) tabBtn.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        openSettings();
        activateSettingsPane('tables');
    }
}

function updateReputationUI(){
    const state = analyzeReputation();
    const strip = document.getElementById('reputation-strip');
    if (strip) {
        strip.classList.remove('good', 'warn', 'bad');
        strip.classList.add(state.level);
    }

    const headline = document.getElementById('reputation-headline');
    if (headline) headline.innerText = state.headline;

    const hint = document.getElementById('reputation-hint');
    if (hint) hint.innerText = state.hint;

    const severity = document.getElementById('reputation-severity');
    if (severity) {
        severity.classList.remove('good', 'warn', 'bad');
        severity.classList.add(state.level);
        severity.innerText = state.chip;
    }

    const score = document.getElementById('reputation-score');
    if (score) score.innerText = `${state.score} / 100`;
    const scoreLabel = document.getElementById('rep-score-label');
    if (scoreLabel) scoreLabel.innerText = state.score;

    const grade = document.getElementById('reputation-grade');
    if (grade) {
        grade.innerText = state.total
            ? `${state.total} ${pluralize(state.total, ['–ø—Ä–æ—Å—Ä–æ—á–∫–∞', '–ø—Ä–æ—Å—Ä–æ—á–∫–∏', '–ø—Ä–æ—Å—Ä–æ—á–µ–∫'])} (–¥–æ ${state.worst} ${pluralize(state.worst, ['–¥–Ω—è', '–¥–Ω–µ–π', '–¥–Ω–µ–π'])})`
            : '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç';
    }

    const detail = document.getElementById('reputation-detail');
    if (detail) detail.innerText = state.detail;

    const fallout = document.getElementById('reputation-fallout');
    if (fallout) {
        fallout.style.display = state.level === 'good' ? 'none' : 'block';
        fallout.innerText = state.level === 'good' ? '' : state.fallout;
    }

    const activeCount = document.getElementById('rep-active-count');
    if (activeCount) activeCount.innerText = state.activeCount;

    const repOnTime = document.getElementById('rep-on-time');
    if (repOnTime) {
        const onTime = Math.max(state.onTime, 0);
        repOnTime.innerText = onTime > 0 ? `${onTime} –±–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–µ–∫` : '–í—Å–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã';
    }

    const repOverdue = document.getElementById('rep-overdue');
    if (repOverdue) repOverdue.innerText = state.total;

    const repDelayMax = document.getElementById('rep-delay-max');
    const repDelayAvg = document.getElementById('rep-delay-avg');

    if (repDelayMax) repDelayMax.innerText = state.worst > 0 ? state.worst : '0';
    if (repDelayAvg) repDelayAvg.innerText = state.avg > 0 ? state.avg : '0';

    const tipsEl = document.getElementById('reputation-tips');
    if (tipsEl) {
        // –ú—ã –º–µ–Ω—è–µ–º class="rep-tip" –Ω–∞ class="rep-tip-card" —á—Ç–æ–±—ã –ø–æ–¥—Ö–≤–∞—Ç–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏
        tipsEl.innerHTML = state.tips.map(tip => `
            <div class="rep-tip-card">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span>${tip}</span>
            </div>
        `).join('');
    }

    updatePaceReputation(state);

    const repOnTimePill = document.getElementById('rep-on-time-pill');
    if (repOnTimePill) repOnTimePill.innerText = Math.max(state.onTime, 0);

    const repNearPill = document.getElementById('rep-near-pill');
    if (repNearPill) repNearPill.innerText = state.nearDeadline;

    const repOverduePill = document.getElementById('rep-overdue-pill');
    if (repOverduePill) repOverduePill.innerText = state.total;

    const repChartEl = document.getElementById('reputationChart');
    if (repChartEl) {
        if (chRep) chRep.destroy();
        const onTimeVal = Math.max(state.onTime, 0);
        const nearVal = state.nearDeadline;
        const overdueVal = state.total;
        const totalVal = onTimeVal + nearVal + overdueVal;
        const hasData = totalVal > 0;
        const labels = hasData ? ['–í —Å—Ä–æ–∫', '–ù–∞ –≥—Ä–∞–Ω–∏', '–ü—Ä–æ—Å—Ä–æ—á–∫–∏'] : ['–†–µ–ø—É—Ç–∞—Ü–∏—è'];
        const data = hasData ? [onTimeVal, nearVal, overdueVal] : [1];
        const colors = hasData ? ['#2ea043', '#d29922', '#f85149'] : ['#2ea043'];
        chRep = new Chart(repChartEl.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.1,
                cutout: '72%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${hasData ? ctx.parsed : 0}`
                        }
                    },
                    repCenterText: {
                        text: `${state.score} / 100`,
                        subText: state.level === 'good' ? '–î–æ–≤–µ—Ä–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ' : '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è'
                    }
                }
            },
            plugins: [repCenterText]
        });
    }
}

function updatePaceReputation(state){
    const chip = document.getElementById('pace-rep-chip');
    const text = document.getElementById('pace-rep-text');
    const dot = document.getElementById('pace-rep-dot');
    const caption = document.getElementById('pace-rep-caption');

    if (chip) {
        chip.classList.remove('good', 'warn', 'bad');
        chip.classList.add(state.level);
    }

    if (text) text.innerText = `${state.score} / 100`;
    if (dot) dot.className = `rep-dot ${state.level}`;
    if (caption) caption.innerText = state.level === 'good' ? '–î–æ–≤–µ—Ä–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ' : '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è';
}

function scrollToReputation(){
    const card = document.getElementById('reputation-card');
    if (card && !card.classList.contains('is-hidden')) {
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        openSettings();
        activateSettingsPane('blocks');
        const toggle = document.getElementById('block-toggle-reputation');
        if (toggle) toggle.focus();
    }
}

function getScopedDataForStats() {
    return {
        active: DATA.active,
        archive: getArchiveByMonth(),
        paused: DATA.paused,
        waiting: DATA.waiting,
        potential: DATA.potential,
    };
}

function calcStats(){
    const scope = getScopedDataForStats();
    const goal = toNumeric(DATA.monthlyGoals[currentMonth]) || 250000;
    let fact = 0, activeFact = 0, plan = 0, totalGross = 0, totalNet = 0;
    let totalExpenses = 0, totalTaxes = 0, totalPaidGross = 0;

    ['active','archive','paused','waiting','potential'].forEach(type => {
        scope[type].forEach(i => {
            totalExpenses += calcContractorAmount(i);
            totalTaxes += toNumeric(i.p) * ((toNumeric(i.taxPrc) || 0) / 100);
        });
    });

    const archiveThisMonth = scope.archive;
    archiveThisMonth.forEach(i => {
        const net = calcNet(i);
        fact += net;
        totalGross += toNumeric(i.p);
        totalNet += net;
        totalPaidGross += toNumeric(i.p);
    });

    scope.active.forEach(i => {
        const net = calcNet(i);
        const gross = toNumeric(i.p);
        const paidPrc = (toNumeric(i.paid)||0)/100;
        const paidGross = gross * paidPrc;
        activeFact += net * paidPrc;
        plan += net * (1 - paidPrc);
        totalGross += gross;
        totalNet += net;
        totalPaidGross += paidGross;
    });

    scope.paused.forEach(i => plan += calcNet(i));
    scope.waiting.forEach(i => plan += calcNet(i));
    scope.potential.forEach(i => plan += calcNet(i));

    const totalFact = fact + activeFact;
    const forecast = totalFact + plan;
    
    const totalMargin = totalNet;
    const totalGrossCombined = totalGross;
    const goalProgress = goal ? Math.round((totalFact/goal)*100) : 0;

    document.getElementById('val-fact').innerText = formatCurrency(totalFact);
    document.getElementById('val-fact-prc').innerText = `${goalProgress}% –æ—Ç —Ü–µ–ª–∏`;
    document.getElementById('val-active-fact').innerText = formatCurrency(activeFact);
    document.getElementById('val-margin').innerText = formatCurrency(totalMargin);
    document.getElementById('val-margin-prc').innerText = `${totalGrossCombined > 0 ? Math.round((totalMargin/totalGrossCombined)*100) : 0}%`;
    document.getElementById('val-plan').innerText = formatCurrency(plan);
    document.getElementById('val-total').innerText = formatCurrency(forecast);
    document.getElementById('val-total-gross').innerText = formatCurrency(totalGrossCombined);
    document.getElementById('val-expenses').innerText = formatCurrency(totalExpenses);
    document.getElementById('val-taxes').innerText = formatCurrency(totalTaxes);
    document.getElementById('val-paid-gross').innerText = formatCurrency(totalPaidGross);
    document.getElementById('goal-text').innerText = `${formatCurrency(totalFact)} / ${formatCurrency(goal)}`;
    document.getElementById('goal-pill').innerText = `–¶–µ–ª—å: ${formatCurrency(goal)}`;

    const record = DATA.settings.record || 0;
    const recordProgress = record > 0 ? Math.min(100, (totalFact/record)*100) : 0;
    const recordRemaining = Math.max(0, record - totalFact);
    let motivText = '–û–±–Ω–æ–≤–∏–º —Ü–∏—Ñ—Ä—ã!';
    if (!record) motivText = '–ó–∞–¥–∞–π —Ü–µ–ª—å –∏ –∑–∞–±–µ—Ä–∏ —Ä–µ–∫–æ—Ä–¥.';
    else if (recordRemaining <= 0) motivText = '–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å.';
    else if (recordProgress >= 70) motivText = '–ß—É—Ç—å-—á—É—Ç—å –¥–æ —Ä–µ–∫–æ—Ä–¥–∞!';
    else motivText = '–î–≤–∏–∂–µ–º—Å—è –∫ —Ä–µ–∫–æ—Ä–¥—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.';

    document.getElementById('record-motiv').innerText = motivText;
    document.getElementById('record-remaining').innerText = record ? (recordRemaining > 0 ? `–î–æ —Ä–µ–∫–æ—Ä–¥–∞ ${formatCurrency(recordRemaining)}` : '–†–µ–∫–æ—Ä–¥ –ø–æ–±–∏—Ç!') : '–ó–∞–¥–∞–π—Ç–µ —Ä–µ–∫–æ—Ä–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö';
    document.getElementById('record-amount').innerText = formatCurrency(record);
    const recCurrentFact = document.getElementById('rec-current-fact');
    if (recCurrentFact) recCurrentFact.innerText = formatCurrency(totalFact);
    document.getElementById('record-progress').style.width = record ? Math.min(100, (totalFact/record)*100) + '%' : '0%';

    document.getElementById('p-bar').style.width = goal > 0 ? Math.min(100, (totalFact/goal)*100) + '%' : '0%';
    document.getElementById('dash-month-name').innerText = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex]?.text || '';
    const scopeNote = '–°—Ä–µ–∑: –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã';
    const scopeHint = '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏';
    const scopeEl = document.getElementById('stat-scope-note');
    if (scopeEl) {
        scopeEl.innerText = scopeNote;
        scopeEl.title = scopeHint;
    }
    updateReputationUI();
    updateCharts(totalFact, plan, scope);
    updateTopClientsChart(scope);
}

let chL = null, chP = null, chB = null, chRep = null, chTopClients = null;
let topClientsMode = 'net';
let lastTopClientsScope = null;
function updateCharts(fact, plan, scope){
    const ctxL = document.getElementById('lineChart').getContext('2d');
    const ctxP = document.getElementById('pieChart').getContext('2d');
    const ctxB = document.getElementById('barChart').getContext('2d');

    // Line Chart (–æ—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É)
    const daysInM = new Date(currentMonth.split('-')[0], currentMonth.split('-')[1], 0).getDate();
    const labelsL = Array.from({length:daysInM},(_,i)=>i+1);
    const dataL = new Array(daysInM).fill(0);
    scope.archive.forEach(i => {
        const d = parseInt(i.date.split('-')[2]) - 1;
        if(d>=0 && d<daysInM) dataL[d] += calcNet(i);
    });
    let acc = 0; 
    const dataAcc = dataL.map(v => acc+=v);
    
    if(chL) chL.destroy();
    chL = new Chart(ctxL, {
        type: 'line',
        data: { labels: labelsL, datasets: [{label:'–§–∞–∫—Ç', data:dataAcc, borderColor:'#2ea043', backgroundColor:'rgba(46,160,67,0.1)', fill:true, tension:0.4, pointRadius:0}] },
        options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color: getCssVar('--border')}}}}
    });
    
    // PIE CHART - –ù–æ–≤—ã–π —Å—Ç–∏–ª—å–Ω—ã–π –≤–∏–¥ (Gradient Ring)
    if(chP) chP.destroy();
    chP = new Chart(ctxP, {
        type: 'doughnut',
        data: { 
            labels: ['–ü–æ–ª—É—á–µ–Ω–æ', '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª/–û—Å—Ç–∞—Ç–æ–∫'], 
            datasets: [{
                data: [fact, plan],
                backgroundColor: [getCssVar('--green'), getCssVar('--efficiency-potential')],
                borderWidth: 0,
                borderRadius: 20, // –ó–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
                hoverOffset: 4
            }] 
        },
        options: {
            responsive:true, 
            maintainAspectRatio:false, 
            cutout:'85%', // –û—á–µ–Ω—å —Ç–æ–Ω–∫–æ–µ –∫–æ–ª—å—Ü–æ
            plugins:{
                legend:{display:false},
                tooltip: {
                    backgroundColor: getCssVar('--card'),
                    titleColor: getCssVar('--text'),
                    bodyColor: getCssVar('--muted'),
                    borderColor: getCssVar('--border'),
                    borderWidth: 1,
                    displayColors: true,
                    boxPadding: 4
                }
            }
        }
    });
    
    // BAR CHART - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ)
    const h = {};
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞
    scope.archive.forEach(i => { const m = (i.date||'').slice(0,7); if(m) h[m] = (h[m]||0) + calcNet(i); });

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    const barLabels = [];
    const barData = [];
    const barColors = [];
    
    // –ë–µ—Ä–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –∫–∞–∫ —Ç–æ—á–∫—É –æ—Ç—Å—á–µ—Ç–∞ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü
    const anchorDate = new Date(); 
    anchorDate.setDate(1); // –ü–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å 31-–º —á–∏—Å–ª–æ–º
    
    // –¶–∏–∫–ª –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
    for (let i = 5; i >= 0; i--) {
        const d = new Date(anchorDate);
        d.setMonth(d.getMonth() - i);
        
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const key = `${y}-${m}`;
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞
        const monthName = d.toLocaleString('ru', {month:'short'});
        barLabels.push(monthName);
        barData.push(h[key] || 0);
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const isCurrent = key === currentMonth;
        barColors.push(isCurrent ? getCssVar('--accent') : getCssVar('--chart-bar-bg'));
    }

    if(chB) chB.destroy();
    chB = new Chart(ctxB, {
        type: 'bar',
        data: { 
            labels: barLabels, 
            datasets: [{
                data: barData, 
                backgroundColor: barColors, 
                borderRadius: 4,
                barPercentage: 0.6
            }] 
        },
        options: {
            responsive: true, 
            maintainAspectRatio: false, 
            plugins:{legend:{display:false}}, 
            scales:{
                x:{
                    grid:{display:false},
                    ticks: { color: getCssVar('--muted'), font: {size: 11}, autoSkip: false } 
                }, 
                y:{display:false}
            }
        }
    });
}

function updateTopClientsChart(scope) {
    const canvas = document.getElementById('topClientsChart');
    if (!canvas) return;

    lastTopClientsScope = scope;

    const modeLabel = document.getElementById('top-clients-mode-label');
    const sub = document.getElementById('top-clients-sub');
    const isGross = topClientsMode === 'gross';
    if (modeLabel) modeLabel.innerText = isGross ? '–ì—Ä—è–∑–Ω–∞—è –ø—Ä–∏–±—ã–ª—å' : '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å';
    if (sub) sub.innerText = isGross
        ? '–ë–µ–∑ —É—á—ë—Ç–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –Ω–∞–ª–æ–≥–æ–≤ ‚Äî –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã'
        : '–ú–∞—Ä–∂–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º, –∞—Ä—Ö–∏–≤–Ω—ã–º, –Ω–∞ –ø–∞—É–∑–µ –∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏';

    const valueGetter = isGross ? calcGross : calcNet;
    const datasetLabel = isGross ? '–ì—Ä—è–∑–Ω–∞—è –ø—Ä–∏–±—ã–ª—å' : '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å';

    const totals = {};
    ['active','archive','paused','waiting'].forEach(type => {
        (scope[type] || []).forEach(item => {
            const client = (item.c || '–ë–µ–∑ –∏–º–µ–Ω–∏').trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            const value = valueGetter(item);
            totals[client] = (totals[client] || 0) + value;
        });
    });

    const entries = Object.entries(totals)
        .filter(([,val]) => val > 0)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 5);

    const labels = entries.length ? entries.map(([name]) => name) : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
    const data = entries.length ? entries.map(([,val]) => val) : [0];

    if (chTopClients) chTopClients.destroy();

    chTopClients = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: getCssVar('--purple') || '#a371f7',
                borderRadius: 10,
                barThickness: 18,
                hoverBackgroundColor: '#c084fc'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${datasetLabel}: ${formatCurrency(ctx.parsed.x)}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    ticks: {
                        color: getCssVar('--muted') || '#8b949e',
                        callback: value => formatCurrency(value)
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: getCssVar('--text') || '#c9d1d9' }
                }
            }
        }
    });
}

function toggleTopClientsMode() {
    topClientsMode = topClientsMode === 'net' ? 'gross' : 'net';
    if (lastTopClientsScope) {
        updateTopClientsChart(lastTopClientsScope);
    }
}

function exp(){
  const payload = buildBackupSnapshot();
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(payload, null, 2)],{type:'application/json'}));
  a.download=`DesignFlow-Backup-${today}.json`;
  a.click();
}
function expCSV(){
    const escape = v => `"${(v || '').toString().replace(/"/g, '""')}"`;
    let csv = ['–°—Ç–∞—Ç—É—Å', '–ö–ª–∏–µ–Ω—Ç', '–ü—Ä–æ–µ–∫—Ç', '–°—É–º–º–∞', '–ß–∏—Å—Ç—ã–º–∏', '–û–ø–ª–∞—á–µ–Ω–æ (%)', '–ù–∞–ª–æ–≥ (%)', '–†–∞—Å—Ö–æ–¥—ã', '–î–∞—Ç–∞ –°—Ç–∞—Ä—Ç–∞', '–î–µ–¥–ª–∞–π–Ω/–°–¥–∞—á–∏', '–°—Å—ã–ª–∫–∞'].map(escape).join(';') + '\n';
    const addRows = (list, status) => list.forEach(i => csv += [status, i.c, i.n, i.p, calcNet(i), i.paid||0, i.taxPrc||0, calcContractorAmount(i), i.start||'', i.dl||i.date||'', i.link||''].map(escape).join(';') + '\n');
    addRows(DATA.active, '–í —Ä–∞–±–æ—Ç–µ'); addRows(DATA.waiting, '–û–∂–∏–¥–∞–µ—Ç'); addRows(DATA.potential, '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª');
    addRows(DATA.paused, '–ù–∞ –ø–∞—É–∑–µ'); addRows(DATA.archive, '–í—ã–ø–æ–ª–Ω–µ–Ω–æ');
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `DesignFlow-Export-${today}.csv`; a.click();
}
function imp(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try {
      const parsed = JSON.parse(e.target.result);
      const payload = parsed?.data ? parsed : { data: parsed };
      const normalized = {
        version: payload.version || 2,
        data: { ...DATA, ...(payload.data || {}) },
        uiPrefs: payload.uiPrefs || UI_PREFS,
        nameTemplates: Array.isArray(payload.nameTemplates) ? payload.nameTemplates : NAME_TEMPLATES,
        theme: (payload.uiPrefs || UI_PREFS).themeMode || payload.theme
      };
      localStorage.setItem(K, JSON.stringify(normalized));
      if (payload.uiPrefs) localStorage.setItem(UI_PREFS_KEY, JSON.stringify(payload.uiPrefs));
      if (Array.isArray(normalized.nameTemplates)) localStorage.setItem(NAME_TEMPLATES_KEY, JSON.stringify(normalized.nameTemplates));
    } catch(err) {
      localStorage.setItem(K, e.target.result);
    }
    location.reload();
  };
  r.readAsText(f);
}

window.onload = init;
</script>
</body>
</html>
