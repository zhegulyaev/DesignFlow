<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DesignFlow — Трекер проектов</title>

<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' ry='6' fill='%230d1117'/%3E%3Cpath d='M11 2 L5 14 H10 L9 22 L19 8 H13 L14 2 Z' fill='%23facc15'/%3E%3C/svg%3E">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<style>
  :root{
    --bg:#0d1117;--card:#161b22;--card-alt:#0f141b;--text:#c9d1d9;--muted:#8b949e;--accent:#58a6ff;--green:#2ea043;--red:#da3633;
    --gold:#d29922;--border:#30363d;--blue:#238636;--btn-blue:#2f81f7;--link-blue:#007bff;--purple:#a371f7;--btn-hover:#30363d;
    --button-bg:#21262d;--row-hover:#1c2128;--table-border:#21262d;--input-bg:#21262d;--chart-bar-bg:#21262d;--date-hover-bg:#161b22;
    --date-hover-border:#3a3f4b;--tab-hover:#30363d;--pill-bg:#1a1f26;--chip-bg:#121720;--link-go-bg:#1a1f26;--modal-overlay:rgba(0,0,0,0.7);
    --date-focus-bg:#111722;--help-bg:#121720;--help-hover-bg:#1c2128;--help-border:rgba(255,255,255,0.12);--help-text:var(--muted);
    --del-hover-bg:#1c2128;--del-hover-border:var(--border);
    --progress-bg:linear-gradient(90deg,#11151c,#0b1017);
    --progress-border:rgba(88,166,255,0.2);
    --progress-shadow:inset 0 1px 0 rgba(255,255,255,0.04),0 0 0 1px rgba(15,20,27,0.65);
    --progress-fill-start:#2ea043;
    --progress-fill-end:#3fb950;
    --progress-fill-shadow:0 0 14px rgba(46,160,67,0.3);
    --record-bg:linear-gradient(90deg,#1c2128,#11151c);
    --record-border:rgba(250,204,21,0.25);
    --record-shadow:inset 0 1px 0 rgba(255,255,255,0.03);
    --record-fill-start:#facc15;
    --record-fill-end:#f9a825;
    --record-fill-shadow:0 0 12px rgba(250,204,21,0.4);
    --goal-pill-bg:linear-gradient(120deg,rgba(88,166,255,0.22),rgba(163,113,247,0.22));
    --goal-pill-border:rgba(163,113,247,0.4);
    --goal-pill-color:#dce7ff;
    --goal-pill-shadow:0 4px 18px rgba(88,166,255,0.22);
    --status-bg:var(--pill-bg);
    --status-border:var(--border);
    --status-text:var(--muted);
  }
  body.light{
    --bg:#f8fbff;--card:#ffffff;--card-alt:#f4f7fb;--text:#1f2937;--muted:#56657d;--accent:#3b82f6;--green:#22b46d;--red:#de3f57;
    --gold:#c48b2e;--border:#d8e1f0;--blue:#3b82f6;--btn-blue:#3b82f6;--link-blue:#3b82f6;--purple:#7c52e4;--btn-hover:#eaf1ff;
    --button-bg:#f2f6fd;--row-hover:#f5f8ff;--table-border:#e4ebf7;--input-bg:#f6f8fd;--chart-bar-bg:#e9f0fb;--date-hover-bg:#eef3ff;
    --date-hover-border:#d4dff5;--tab-hover:#eef3ff;--pill-bg:#f1f5fd;--chip-bg:#f1f5fd;--link-go-bg:#e8f0ff;--modal-overlay:rgba(0,0,0,0.35);
    --date-focus-bg:#e1e9ff;--help-bg:#e8f0ff;--help-hover-bg:#dfe8ff;--help-border:#cbd8f1;--help-text:#43526b;
    --del-hover-bg:#fde8e8;--del-hover-border:#f3c5c5;
    --progress-bg:linear-gradient(90deg,#eef3ff,#f8fbff);
    --progress-border:#d5dff0;
    --progress-shadow:inset 0 1px 0 rgba(255,255,255,0.92),0 0 0 1px rgba(213,223,240,0.65);
    --progress-fill-start:#26c06d;
    --progress-fill-end:#35d691;
    --progress-fill-shadow:0 0 12px rgba(53,214,145,0.28);
    --record-bg:linear-gradient(90deg,#fff7e3,#fffaf1);
    --record-border:#f3dfb5;
    --record-shadow:inset 0 1px 0 rgba(255,255,255,0.95);
    --record-fill-start:#f6b21a;
    --record-fill-end:#ffd45c;
    --record-fill-shadow:0 0 12px rgba(255,212,92,0.4);
    --goal-pill-bg:linear-gradient(120deg,#e7f0ff,#f3e9ff);
    --goal-pill-border:#d3ddf5;
    --goal-pill-color:#1f3158;
    --goal-pill-shadow:0 6px 18px rgba(137,170,255,0.26);
    --status-bg:#f6f8fd;
    --status-border:#e2e8f5;
    --status-text:#1f2d45;
  }
  body.light .reputation-card { background: #fff; box-shadow: 0 8px 26px rgba(17,24,39,0.04); border-color: #e0e7f5; }
  body.light .record-motiv { color: #1f2937; }
  body.light .reputation-strip { background: linear-gradient(90deg, rgba(34, 180, 109, 0.08), rgba(210, 153, 34, 0.06)); box-shadow: none; }
  *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;}
  
  body{background:var(--bg);color:var(--text);padding-bottom:100px;min-height:100vh;display:flex;flex-direction:column;}
  .c{max-width:1600px;margin:0 auto;padding:20px;width:100%;} 
  
  /* Header */
  h1{font-size:42px;font-weight:800;margin:0;letter-spacing: -1px;}
  .brand-grad { background:linear-gradient(90deg,#58a6ff,#a371f7,#d29922);-webkit-background-clip:text;-webkit-text-fill-color:transparent; }
  .brand-white { color: var(--muted); font-weight: 400; letter-spacing: -0.4px; }
  
  /* Исправлен отступ в шапке */
  .header-row{display:flex;justify-content:space-between;align-items:center;margin:20px 0 16px; gap: 16px; padding: 12px 18px; border-radius: 16px; background: transparent; border: none; box-shadow: none;}
  .brand-wrap { display: flex; align-items: center; gap: 12px; }
  .brand-logo { width: 44px; height: 44px; border-radius: 14px; display: grid; place-items: center; background: #7c52e4; border: 2px solid rgba(255,255,255,0.18); font-size: 22px; color: #f5f1ff; font-weight: 900; box-shadow: 0 10px 28px rgba(124,82,228,0.35); }
  .brand-text { display: flex; flex-direction: column; line-height: 1.05; }
  .brand-title { display: flex; align-items: baseline; gap: 8px; font-size: 30px; font-weight: 900; letter-spacing: -0.8px; color: #7c52e4; }
  .brand-version { font-size: 14px; font-weight: 800; color: #9aa3b8; letter-spacing: -0.3px; }
  .brand-sub { font-size: 14px; color: var(--muted); font-weight: 700; }
  .month-select{background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 15px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;outline:none;transition:.2s;}
  .month-select:hover{border-color:var(--muted);}

  #themeToggle { padding:10px 20px; gap:10px; min-height: 44px; }
  #themeToggleIcon { font-size: 16px; }
  #themeToggleLabel { font-weight: 700; font-size: 13px; }
  .btn-icon { width: 16px; height: 16px; }
  .btn-icon.lg { width: 18px; height: 18px; }
  .btn-label { font-weight: 700; letter-spacing: -0.1px; }


      .date-cell:not(:last-child) .date-input-wrap {
    margin-right: 8px;
}

  /* Warning Block */
  .top-panel{background:var(--card);padding:16px 18px;border-radius:14px;border:1px solid var(--border);margin-bottom:30px;display:flex;align-items:center;flex-wrap:wrap;gap:16px;box-shadow:none;}
  .backup-alert{display:flex;align-items:center;gap:12px;flex:1;min-width:280px;}
  .backup-icon{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(248,81,73,0.12);border:1px solid rgba(248,81,73,0.45);color:#f85149;box-shadow:0 8px 20px rgba(0,0,0,0.08);}
  .backup-icon svg{width:18px;height:18px;}
  .backup-info{color:var(--muted);font-size:13px;line-height:1.5;display:flex;flex-direction:column;gap:4px;}
  .backup-info b{color:#f85149;}
  .backup-info .backup-title{font-weight:800;letter-spacing:-0.15px;color:var(--text);}
  .backup-info .backup-sub{max-width:640px;}
  
  .btns{display:flex;gap:15px;flex-wrap:wrap; align-items: center;} 
  
  button{padding:10px 20px;background:var(--button-bg);border:1px solid var(--border);color:var(--text);border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:.2s;display:flex;align-items:center;gap:8px;white-space: normal;}
  button:hover{border-color:var(--accent);color:var(--accent);}

  .toast { position: fixed; top: 15px; right: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px; display: none; align-items: center; gap: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); z-index: 1200; min-width: 260px; }
  .toast.show { display: flex; animation: fadeIn .2s ease; }
  .toast-message { flex: 1; font-weight: 600; color: var(--text); }
  .toast-action { background: var(--btn-blue); color: #fff; border: 1px solid var(--btn-blue); border-radius: 6px; padding: 6px 10px; font-weight: 700; cursor: pointer; }
  .toast-close { background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 16px; padding: 0 4px; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Tabs */
  .tabs-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .tabs{display:flex;gap:10px;overflow-x: auto; padding-bottom: 5px; flex-shrink: 1;}
  .tab{flex-shrink: 0; padding:8px 14px;border-radius:10px;cursor:pointer;font-size:15px; background:transparent;border:1px solid transparent;transition:.2s; font-weight: 600; color:var(--muted); display: flex; align-items: center; gap: 8px; letter-spacing: -0.2px;}
  .tab svg { width: 14px; height: 14px; opacity: 0.7; transition: opacity .2s; }
  .tab:hover{background:var(--tab-hover);border-color:var(--tab-hover);color:var(--text);}
  .tab.active{background:var(--card); border-color:var(--border); font-weight: 700; color: var(--text) !important;}
  .tab.active svg { opacity: 1; color: var(--text); }
  .tab.tab-trash { margin-left: auto; }
  .tab-count { min-width: 22px; height: 22px; border-radius: 8px; background: var(--button-bg); border: 1px solid var(--border); display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: var(--muted); padding: 0 6px; }
  .tab.active .tab-count { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* New Project Button (Notion Style) */
  #newProjectButton { background: var(--btn-blue); color: #fff; border: 1px solid var(--btn-blue); font-weight: 700; padding: 8px 16px; margin-left: 20px;}
  #newProjectButton:hover { background: #3c82f6; border-color: #3c82f6; color: #fff; }

  /* Tab Description - Увеличен отступ перед Pace Block */
  .tab-desc-block { margin-bottom: 15px; } 

  /* Main Layout & Tables */
  .table-wrap{overflow:visible;background:var(--card);border-radius:12px;border:1px solid var(--border);padding:5px 12px 5px 18px; margin-top: 10px; position: relative;}
  table{width:100%;border-collapse:collapse; min-width: 1380px;}
  th{text-align:left;color:var(--muted);font-size:12px;text-transform:uppercase;padding:11px 8px;border-bottom:1px solid var(--border);user-select:none; white-space: nowrap; cursor: pointer;}
  
  /* Выравнивание заголовков для Active */
  #t-active th:nth-child(8), /* Расходы */
  #t-active th:nth-child(9), /* Сумма */
  #t-active th:nth-child(10) { /* Чистыми */
      text-align: right;
  }
  #t-active th:nth-child(6),
  #t-active td:nth-child(6) { text-align: center; }

  th:first-child, td:first-child { width: 24px; cursor: default; text-align: center; }
  td.select-col { position: relative; }
  td{ padding: 5px 8px; border-bottom:1px solid var(--table-border); vertical-align:middle; font-size:15px; position: relative; }
  tr:last-child td{border-bottom:none;}
  tr:hover td{background:var(--row-hover);}

  tr { position: relative; }

  /* Checkbox column */
  th.select-col { width: 5%; cursor: default; }
  td.select-col { width: 5%; padding: 0; text-align: center; }
  
  /* Контейнер для чекбокса и иконки дублирования - для выравнивания */
  .select-action-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      height: 100%;
      padding: 0 5px;
  }
  .bulk-checkbox { width: 16px; height: 16px; margin: 0; cursor: pointer; background: transparent; border: 1px solid var(--muted); border-radius: 4px; appearance: none; transition: background .1s, border-color .1s; flex-shrink: 0;}
  .bulk-checkbox:checked { background: var(--accent); border-color: var(--accent); }

  /* Table Footer (Totals) */
  tfoot td { padding: 15px 10px; border-top: 1px solid var(--border); background: transparent; font-weight: 600; color: var(--muted); text-align: right; font-size: 14px; white-space: nowrap; }
  tfoot td:first-child { text-align: left; color: var(--text); font-size: 15px; }
  tfoot td:nth-last-child(3) { color: var(--gold); } /* Total gross (Archive) */
  tfoot td:nth-last-child(2) { color: var(--green); } /* Total net (Archive) */
  /* Active table footer fix */
  #total-row-active td:nth-child(2) { color: var(--green); } /* Total net (Active) */
  .footer-total-toggle { cursor: pointer; color: var(--accent); font-weight: 700; }
  .footer-total-toggle:hover { color: #8ab4ff; }

  
  /* Inputs & Selects */
  [contenteditable]{ outline:none; background: transparent; border: 1px solid transparent; padding: 5px 8px; border-radius: 6px; transition:.2s; display:inline-block; width: 100%; white-space: pre-wrap; word-break: break-word; overflow: visible; text-overflow: unset; }
  [contenteditable]:focus, [contenteditable]:hover { border-color: var(--border); background: var(--input-bg); cursor: text; }
  [contenteditable]:focus { white-space: pre-wrap; -webkit-line-clamp: initial; overflow: visible; text-overflow: unset; }
  
  .date-cell { padding: 0 !important; } 
  .date-input-wrap { width: 100%; padding: 6px 8px; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: flex-start; transition: .2s; border-radius: 10px; gap: 6px; border: 1px solid var(--border); background: transparent; box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
  .date-input-wrap:hover { background: var(--date-hover-bg); border-color: var(--date-hover-border); }
  .date-text-display { font-size: 14px; font-weight: 600; color: var(--text); white-space: nowrap; display: inline-flex; align-items: center; gap: 8px; letter-spacing: -0.1px; }
  .date-icon { display: inline-flex; width: 14px; height: 14px; color: var(--muted); opacity: 0.85; }
  .time-text { color: var(--muted); font-weight: 700; font-size: 12px; }

  /* Deadline Colors */
  .days-critical { color: var(--red); font-weight: 700; }
  .days-warning { color: var(--gold); font-weight: 700; }
  .days-normal { color: var(--muted); }
  .days-infinite { color: var(--muted); font-weight: 800; display: inline-flex; align-items: center; gap: 6px; }
  .deadline-infinity { color: var(--muted); font-weight: 800; display: inline-flex; align-items: center; gap: 6px; }
  
  /* Price/Contractor/Net Styling */
  .price-cell-wrap { display: flex; align-items: center; justify-content: flex-end; gap: 4px; height: 100%; padding: 2px 0;}
  .price-cell-wrap input {
    background: transparent;
    border: none;
    color: var(--text);
    width: 100%;
    max-width: 110px;
    min-width: 64px;
    flex: 1 1 70px;
    font-family: monospace;
    font-weight: 600;
    outline: none;
    text-align: right;
    padding: 4px 0; /* Добавлен отступ для кликабельности */
    margin: 0;
    -moz-appearance: textfield;
  }
  .price-cell-wrap:focus-within { border-color: var(--border); background: var(--input-bg); border-radius: 6px; }
  .price-cell-wrap input::-webkit-outer-spin-button, .price-cell-wrap input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .currency-symbol { color: var(--muted); font-size: 14px; font-weight: 600; font-family: monospace; min-width: 15px; }
  .currency-symbol.symbol-empty { font-size: 12px; font-weight: 800; color: var(--muted); text-transform: lowercase; }

  /* Net Column Fix */
  .net-display-wrap { display: flex; flex-direction: column; align-items: flex-end; padding: 5px 0; }
  .net-main-val { font-weight: 600; color: var(--text); }
  .net-prc-val {
      font-size: 12px;
      font-weight: 500; /* Не жирный */
      opacity: 0.6; /* Полупрозрачность */
      color: var(--muted);
      margin-top: 2px;
  }

  .expense-cell { gap: 4px; }
  .expense-mode { background: var(--pill-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 4px 6px; font-size: 12px; cursor: pointer; min-width: 54px; }
  .expense-helper { color: var(--muted); font-size: 11px; margin-top: 2px; text-align: right; line-height: 1.2; }

  .paid-amount { font-size: 12px; color: var(--muted); margin-top: 4px; text-align: right; }

  .paid-cell { text-align: right; }
  .paid-cell .paid-select { margin-left: auto; display: inline-flex; }
  .paid-cell .paid-amount { text-align: right; width: 100%; }


  .paid-select, .tax-select { background: transparent; color: var(--text); border: 1px solid transparent; padding: 5px; border-radius: 6px; font-size: 13px; cursor: pointer; outline: none; transition: .2s; text-align: center;}
  .paid-select:hover, .tax-select:hover { background: var(--btn-hover); border-color: var(--border); }
  .paid-select option, .tax-select option { background: var(--card); }

  /* Actions */
  .client-wrap{display:flex;align-items:center;gap:8px; width: 100%;}
  .client-name, .project-name { display:block; line-height:1.3; white-space:pre-wrap; -webkit-line-clamp:unset; -webkit-box-orient:vertical; overflow:visible; text-overflow:unset; word-break: break-word; }
  .client-name { max-width: 210px; font-weight:700; color:var(--text); }
  .project-name-wrap { display: flex; align-items: center; gap: 8px; overflow: visible; }
  .project-name { max-width: 320px; font-weight:600; }

  .sort-icon { color: var(--muted); font-size: 11px; margin-left: 6px; opacity: 0.5; }
  th.sorted .sort-icon { opacity: 1; color: var(--text); }
  th.sorted.asc .sort-icon::after { content: '↑'; }
  th.sorted.desc .sort-icon::after { content: '↓'; }
  th .sort-icon::after { content: '↕'; }
  
  .dup-icon { opacity: 0; transition: opacity 0.2s; cursor: pointer; color: var(--muted); width: 16px; height: 16px; flex-shrink: 0;}
  tr:hover .dup-icon { opacity: 1; }

  .select-col { position: relative; min-width: 44px; }
  .row-index { color: var(--muted); font-weight: 700; font-size: 12px; text-align: center; }
  .row-selected .row-index { color: var(--text); }

  .row-controls { position:absolute; left:-28px; top:50%; transform:translate(-140%,-50%); display:flex; gap:10px; align-items:center; opacity:0; transition:opacity .2s; }
  tr:hover .row-controls, .row-selected .row-controls { opacity:1; }
  .row-controls .bulk-checkbox { width: 18px; height: 18px; }

  .client-name.has-link { color: var(--link-blue); font-weight: 700; }


  .action-btns{display:flex;gap:6px;align-items:center;}
  .action-btn-base { padding: 6px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; user-select: none; min-width: 32px; text-align: center; }
  .done-btn:hover { background: var(--green); color: #fff; border-color: var(--green);}
  .edit-active-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  .wait-btn:hover { background: var(--purple); color: #fff; border-color: var(--purple);}
  .pause-btn:hover { background: var(--link-blue); color: #fff; border-color: var(--link-blue);}
  /* New hover styles for wait and pause in active table */
  .wait-active-btn:hover { background: var(--purple); color: #fff; border-color: var(--purple);}
  .pause-active-btn:hover { background: var(--link-blue); color: #fff; border-color: var(--link-blue);}

  .link-btn { padding: 6px; margin: 0; background: var(--chip-bg); border: 1px solid var(--border); color: var(--muted); cursor: pointer; font-size: 12px; flex-shrink: 0; border-radius: 8px; transition: .2s; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
  .link-btn svg { width: 14px; height: 14px; }
  .link-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--link-go-bg); box-shadow: 0 4px 10px rgba(59,130,246,0.12); }
  .link-btn-active { color: var(--accent); border-color: var(--border); background: var(--link-go-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(17,24,39,0.08); }
  .link-btn-go { border: 1px solid var(--border); border-radius: 8px; background: var(--link-go-bg); color: var(--accent); font-weight: 700; box-shadow: 0 4px 12px rgba(17,24,39,0.06); }
  .link-btn-go:hover { border-color: var(--accent); color: var(--accent); background: #f0f4ff; box-shadow: 0 6px 16px rgba(59,130,246,0.18); }
  .client-wrap .link-btn { opacity: 0; pointer-events: none; }
  tr:hover .client-wrap .link-btn, .row-selected .client-wrap .link-btn { opacity: 1; pointer-events: auto; }
  
  .del-btn{color:var(--text);cursor:pointer;opacity:0.7; margin-left: 8px; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; padding: 6px; border: 1px solid transparent; border-radius: 8px; transition: .2s; background: transparent;}
  .del-btn svg { width: 16px; height: 16px; }
  .del-btn:hover{opacity:1; border-color: var(--del-hover-border); background: var(--del-hover-bg); color: var(--red);}
  
  /* --- Modern Pace Block (Темп недели) --- */
  .pace-block {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 6px; /* Тонкая рамка вокруг контента */
    margin-bottom: 24px;
    margin-top: 20px;
    display: flex;
    gap: 0;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    transition: all 0.3s ease;
  }
  
  /* Статус "Критично" меняет обводку и фон */
  .pace-block.critical {
    border-color: rgba(248,81,73,0.4);
    background: linear-gradient(to right, rgba(248,81,73,0.05), var(--card) 40%);
  }

  .pace-layout {
    display: flex;
    width: 100%;
    align-items: stretch;
    background: var(--card-alt);
    border-radius: 12px;
    overflow: hidden;
  }
  
  /* Левая часть - Основной статус */
  .pace-main {
    flex: 1;
    display: flex;
    align-items: center;
    padding: 16px 24px;
    gap: 18px;
    border-right: 1px solid var(--border);
    position: relative;
  }
  
  .pace-icon-box {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    background: var(--card);
    border: 1px solid var(--border);
    display: grid;
    place-items: center;
    font-size: 24px;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  
  .pace-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .pace-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 800;
    color: var(--muted);
  }
  
  .pace-title-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .pace-title {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
  }
  
  .pace-status {
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .pace-chill { background: rgba(46,160,67,0.15); color: var(--green); }
  .pace-hurry { background: rgba(248,81,73,0.15); color: var(--red); }
  
  .pace-desc {
    font-size: 13px;
    color: var(--muted);
    font-weight: 500;
  }

  /* Правая часть - Мини репутация */
  .pace-side {
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 20px;
    background: rgba(255,255,255,0.01);
  }

  .pace-mini-stat {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
  }
  
  .pace-rep-val {
    font-size: 20px;
    font-weight: 900;
    font-variant-numeric: tabular-nums;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .rep-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .rep-dot.good { background: #2ea043; box-shadow: 0 0 0 2px rgba(46,160,67,0.2); }
  .rep-dot.warn { background: #d29922; box-shadow: 0 0 0 2px rgba(210,153,34,0.2); }
  .rep-dot.bad { background: #f85149; box-shadow: 0 0 0 2px rgba(248,81,73,0.2); }

  .pace-rep-sub {
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }
  
  .pace-btn-wrap button {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--muted);
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: .2s;
  }
  .pace-btn-wrap button:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--button-bg);
  }

  @media(max-width: 768px) {
    .pace-layout { flex-direction: column; }
    .pace-main { border-right: none; border-bottom: 1px solid var(--border); }
    .pace-side { padding: 16px 24px; justify-content: space-between; }
    .pace-mini-stat { align-items: flex-start; text-align: left; }
  }

  /* --- Modern Reputation Block (Репутация) --- */
  .reputation-card {
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 0;
    background: var(--card);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  /* Шапка репутации */
  .rep-header-modern {
    padding: 24px;
    background: linear-gradient(180deg, var(--card-alt) 0%, var(--card) 100%);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  
  .rep-main-score {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .rep-badge-large {
    width: 64px;
    height: 64px;
    border-radius: 20px;
    background: var(--card);
    border: 1px solid var(--border);
    display: grid;
    place-items: center;
    font-size: 28px;
    color: var(--gold);
    box-shadow: 0 8px 24px rgba(0,0,0,0.06);
  }
  
  .rep-header-texts h3 {
    font-size: 32px;
    font-weight: 900;
    margin: 0;
    line-height: 1;
    letter-spacing: -1px;
    color: var(--text);
  }
  
  .rep-header-texts .rep-subtitle {
    font-size: 14px;
    color: var(--muted);
    margin-top: 6px;
    font-weight: 600;
  }

  .rep-status-badge {
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
  }
  .rep-status-badge.good { background: rgba(46,160,67,0.1); color: var(--green); border-color: rgba(46,160,67,0.2); }
  .rep-status-badge.warn { background: rgba(210,153,34,0.1); color: var(--gold); border-color: rgba(210,153,34,0.2); }
  .rep-status-badge.bad { background: rgba(248,81,73,0.1); color: var(--red); border-color: rgba(248,81,73,0.2); }

  /* Сетка метрик */
  .rep-metrics-modern {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    padding: 18px 20px;
    background: var(--card);
    border-bottom: 1px solid var(--border);
  }

  .rep-metric-item {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 14px;
    background: var(--card-alt);
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .rm-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    font-weight: 800;
  }

  .rm-value {
    font-size: 22px;
    font-weight: 900;
    color: var(--text);
  }

  .rm-sub {
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }

  /* Основное тело: график + советы */
  .rep-body-split {
    display: grid;
    grid-template-columns: 1.4fr 1fr;
    gap: 0;
  }

  .rep-chart-area {
    padding: 20px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
  }

  .rep-legend-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 12px;
    font-weight: 700;
    color: var(--muted);
  }

  .rep-legend-pill {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--card-alt);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
  }

  .rep-legend-pill .rep-dot { box-shadow: 0 0 0 3px rgba(255,255,255,0.06); }

  .rep-legend-text { display: flex; flex-direction: column; line-height: 1.1; gap: 2px; }
  .rep-legend-count { font-weight: 800; color: var(--text); font-size: 14px; }
  .rep-legend-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--muted); }

  .rep-advice-area {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    background: var(--card);
  }

  .rep-fallout-banner {
    border: 1px dashed rgba(248,81,73,0.5);
    background: rgba(248,81,73,0.08);
    color: var(--red);
    padding: 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    display: none;
  }

  .rep-advice-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 2px;
  }

  .rep-chart-area canvas {
    width: 100% !important;
    max-width: 280px;
    aspect-ratio: 1 / 1;
    height: auto !important;
  }

  .rep-tip-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: var(--card-alt);
    font-size: 13px;
    color: var(--muted);
    line-height: 1.45;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
  }

  #reputation-tips {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .rep-tip-card svg {
    width: 18px;
    height: 18px;
    color: var(--accent);
    flex-shrink: 0;
  }

  @media(max-width: 900px) {
    .rep-body-split { grid-template-columns: 1fr; }
    .rep-chart-area { border-right: none; border-bottom: 1px solid var(--border); }
  }

  body.light .rep-legend-pill .rep-dot { box-shadow: 0 0 0 3px rgba(0,0,0,0.03); }
  body.light .rep-fallout-banner { background: #fff1f0; color: #b42318; border-color: rgba(248,81,73,0.4); }
  body.light .rep-tip-card { background: #f6f8fd; border-color: #d8e1f0; color: #1f2937; }
  body.light .rep-legend-pill { background: #f6f8fd; border-color: #d8e1f0; }
  body.light .pace-block { box-shadow: 0 10px 24px rgba(17,24,39,0.06); }
  body.light .pace-icon-box { background: #f7faff; }

      .date-input-wrap:not(:last-child) {
    margin-right: 10px;
}

  /* Stats Dashboard fixes */
  .stats-full { margin-top: 50px; display: flex; flex-direction: column; gap: 20px; }
  .stats-two-columns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; align-items: start; }
  .stats-main { display: flex; flex-direction: column; gap: 16px; }
  .side-stack { display: flex; flex-direction: column; gap: 16px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .card-head { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
  .finance-title { font-size: 20px; font-weight: 800; color: #fff; }
  body.light .finance-title { color: #0f172a; }
  .finance-sub { color: var(--muted); font-size: 13px; margin-top: 4px; }
  .goal-wrap { margin-bottom: 18px; }
  .goal-info { display: flex; justify-content: space-between; font-size: 13px; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
  .card-head-actions { display: flex; align-items: center; gap: 10px; }
  .top-clients-card { margin-top: 0; overflow: hidden; position: relative; }
  .top-clients-card::before { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 12% 20%, rgba(88,166,255,0.05), transparent 32%), radial-gradient(circle at 92% 8%, rgba(163,113,247,0.08), transparent 28%); pointer-events: none; }
  .top-clients-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 14px; }
  .top-clients-title { font-size: 18px; font-weight: 800; letter-spacing: -0.3px; color: var(--text); }
  .top-clients-sub { color: var(--muted); font-weight: 600; font-size: 14px; }
  .top-clients-legend { display: inline-flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px; font-weight: 700; background: var(--pill-bg); border: 1px solid var(--border); padding: 8px 10px; border-radius: 10px; }
  .top-clients-controls { display: flex; align-items: center; gap: 8px; }
  .top-clients-mode-btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--button-bg); border: 1px solid var(--border); color: var(--text); border-radius: 10px; font-weight: 800; font-size: 13px; letter-spacing: -0.2px; cursor: pointer; transition: .2s; }
  .top-clients-mode-btn:hover { border-color: var(--accent); color: var(--accent); }
  .top-clients-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--purple); box-shadow: 0 0 0 4px rgba(163,113,247,0.12); }
  .top-clients-chart { height: 260px; margin-top: 12px; }
  .inline-link-btn { padding: 8px 12px; background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; font-weight: 700; font-size: 13px; cursor: pointer; transition: .2s; }
  .inline-link-btn:hover { color: var(--accent); border-color: var(--accent); background: var(--button-bg); }
  body.light .inline-link-btn { color: #2d3a55; border-color: #cbd8f1; background: #f7faff; box-shadow: 0 4px 14px rgba(17,24,39,0.05); }
  body.light .inline-link-btn:hover { color: #1f4cad; border-color: #3b82f6; background: #eaf2ff; }
  .progress-bg { height: 14px; background: var(--progress-bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--progress-border); margin-top: 8px; width: 100%; box-shadow: var(--progress-shadow); }
  .progress-fill { height: 100%; width: 0; background: linear-gradient(90deg, var(--progress-fill-start), var(--progress-fill-end)); transition: width 0.5s; box-shadow: var(--progress-fill-shadow); border-radius: 12px; }
  .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
  .stat-box { padding: 14px; border: 1px solid var(--border); border-radius: 10px; background: var(--card-alt); }
  .stat-label-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 6px; }
  .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
  .stat-pill { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; background: rgba(88,166,255,0.12); color: var(--accent); border: 1px solid rgba(88,166,255,0.3); }
  #goal-pill { background: var(--goal-pill-bg); border-color: var(--goal-pill-border); color: var(--goal-pill-color); padding: 6px 12px; font-size: 13px; box-shadow: var(--goal-pill-shadow); display: inline-flex; gap: 6px; align-items: center; }
  #goal-pill::before { content: "⚡"; }
  .stat-val { font-size: 30px; font-weight: 800; }
  .stat-helper { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .text-green { color: var(--green); }
  .text-gold { color: var(--gold); }
  .mono { font-family: monospace; }
  .stat-scope-note { margin-top: 6px; color: var(--muted); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; }
  .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; background: var(--status-bg); border: 1px solid var(--status-border); color: var(--status-text); white-space: nowrap; }
  .status-pill.active { color: #58ffb3; border-color: rgba(88,255,179,0.25); background: rgba(88,255,179,0.05); }
  .status-pill.waiting { color: #facc15; border-color: rgba(250,204,21,0.25); background: rgba(250,204,21,0.05); }
  .status-pill.potential { color: #58a6ff; border-color: rgba(88,166,255,0.25); background: rgba(88,166,255,0.05); }
  .status-pill.paused { color: #a371f7; border-color: rgba(163,113,247,0.25); background: rgba(163,113,247,0.05); }
  .status-pill.archive { color: #8b949e; border-color: rgba(139,148,158,0.25); background: rgba(139,148,158,0.08); }
  body.light .status-pill.active { color: #0f6b3f; border-color: rgba(31,158,76,0.35); background: rgba(31,158,76,0.12); }
  body.light .status-pill.waiting { color: #a06c00; border-color: rgba(160,108,0,0.35); background: rgba(255,202,58,0.16); }
  body.light .status-pill.potential { color: #1f65c0; border-color: rgba(31,101,192,0.28); background: rgba(31,101,192,0.12); }
  body.light .status-pill.paused { color: #5a3ba6; border-color: rgba(90,59,166,0.32); background: rgba(90,59,166,0.12); }
  body.light .status-pill.archive { color: #5b6575; border-color: rgba(91,101,117,0.35); background: rgba(91,101,117,0.12); }
  .record-texts { flex:1; min-width: 0; }
  .record-title { color: var(--muted); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .record-motiv { color: #f0f6fc; font-weight: 700; margin-top: 4px; font-size: 15px; }
  .record-progress-bg { margin-top: 10px; height: 10px; background: var(--record-bg); border-radius: 10px; overflow: hidden; border: 1px solid var(--record-border); width: 100%; box-shadow: var(--record-shadow); }
  .record-progress-fill { height: 100%; width: 0; background: linear-gradient(90deg, var(--record-fill-start), var(--record-fill-end)); box-shadow: var(--record-fill-shadow); transition: width .4s ease; border-radius: 999px; }
  .record-value { font-size: 24px; font-weight: 900; color: var(--gold); text-align: right; }
  .record-remaining { color: var(--muted); font-weight: 700; font-size: 12px; text-align: right; margin-top: 4px; }
  .record-side { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
  .reputation-card { max-width: 100%; width: 100%; overflow: hidden; }
  .rep-chart-area canvas { width: 100% !important; height: 240px !important; }
  .rep-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; }
  .rep-chip.good { background: rgba(46,160,67,0.15); color: #2ea043; }
  .rep-chip.warn { background: rgba(210,153,34,0.15); color: #d29922; }
  .rep-chip.bad { background: rgba(248,81,73,0.15); color: #f85149; }
  .reputation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
  .rep-metric { padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--card-alt); }
  .rep-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; font-weight: 800; }
  .rep-value { font-size: 18px; font-weight: 800; color: #f0f6fc; margin-top: 6px; }
  .rep-helper { font-size: 12px; color: var(--muted); margin-top: 4px; line-height: 1.4; }
  body.light .rep-metric { background: #f6f8fd; border-color: #d8e1f0; }
  body.light .rep-value { color: #1f2937; }
  body.light .rep-helper { color: #4b5563; }
  .reputation-mini { display: grid; grid-template-columns: 1fr 1.1fr; gap: 12px; align-items: stretch; }
  .rep-chart-box { border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: var(--card-alt); min-height: 140px; display: flex; flex-direction: column; gap: 8px; position: relative; overflow: visible; }
  .rep-chart-box::after { content: ""; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(circle at 30% 20%, rgba(88,166,255,0.12), transparent 45%); opacity: 0.5; }
  .rep-chart-legend { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; gap: 8px; }
  .rep-chart-legend .legend-title { display: flex; align-items: center; gap: 6px; }
  .rep-chart-legend .legend-score { display: inline-flex; align-items: center; gap: 6px; font-weight: 800; color: var(--text); background: rgba(46,160,67,0.1); padding: 4px 10px; border-radius: 999px; }
  .rep-chart-caption { display: flex; gap: 6px; flex-wrap: wrap; font-size: 12px; color: var(--muted); margin-top: 6px; }
  .rep-chart-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); }
  .rep-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  .rep-dot.good { background: #2ea043; box-shadow: 0 0 0 3px rgba(46,160,67,0.15); }
  .rep-dot.warn { background: #d29922; box-shadow: 0 0 0 3px rgba(210,153,34,0.15); }
  .rep-dot.bad { background: #f85149; box-shadow: 0 0 0 3px rgba(248,81,73,0.18); }
  .rep-tips { border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: var(--card-alt); display: flex; flex-direction: column; gap: 8px; }
  .rep-tips-title { font-weight: 800; color: #f0f6fc; font-size: 13px; letter-spacing: 0.3px; text-transform: uppercase; }
  .rep-tip { display: flex; gap: 8px; color: var(--muted); font-size: 13px; line-height: 1.4; }
  .rep-tip svg { width: 16px; height: 16px; color: #58a6ff; flex-shrink: 0; }
  body.light .rep-chart-box { background: #f6f8fd; border-color: #d8e1f0; }
  body.light .rep-chart-box::after { background: radial-gradient(circle at 30% 20%, rgba(59,130,246,0.12), transparent 45%); }
  body.light .rep-chart-pill { background: #f7faff; border-color: #d8e1f0; color: #374151; }
  body.light .rep-tips { background: #f6f8fd; border-color: #d8e1f0; }
  body.light .rep-tips-title { color: #1f2d45; }
  .reputation-top-row { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: center; }
  .rep-score-chip { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-alt); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
  .rep-score-icon { width: 32px; height: 32px; border-radius: 10px; display: grid; place-items: center; background: var(--pill-bg); color: var(--accent); border: 1px solid var(--border); font-weight: 900; }
  .rep-score-meta { display: flex; flex-direction: column; line-height: 1.2; }
  .rep-score-label { color: var(--muted); font-size: 12px; font-weight: 800; letter-spacing: 0.4px; text-transform: uppercase; }
  .rep-score-main { font-size: 18px; font-weight: 900; }
  .rep-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .rep-severity { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); font-weight: 800; text-transform: uppercase; letter-spacing: 0.4px; }
  .rep-severity.good { background: rgba(46,160,67,0.1); color: #2ea043; border-color: rgba(46,160,67,0.35); }
  .rep-severity.warn { background: rgba(210,153,34,0.1); color: #d29922; border-color: rgba(210,153,34,0.4); }
  .rep-severity.bad { background: rgba(248,81,73,0.1); color: #f85149; border-color: rgba(248,81,73,0.4); }
  .rep-cta { padding: 9px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-weight: 800; display: inline-flex; align-items: center; gap: 6px; }
  .rep-cta:hover { border-color: var(--accent); color: var(--accent); }
  .rep-cta svg { width: 16px; height: 16px; }
  .link-preview { margin-top: 10px; padding: 10px 12px; border: 1px dashed var(--border); border-radius: 12px; background: var(--card-alt); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
  .link-preview-body { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 0; }
  .link-preview-head { display: flex; align-items: center; gap: 10px; min-width: 0; flex-wrap: wrap; }
  .link-preview-label { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: var(--pill-bg); border: 1px solid var(--border); color: var(--muted); font-size: 12px; font-weight: 800; letter-spacing: -0.2px; white-space: nowrap; }
  .link-preview-info { display: inline-flex; align-items: center; gap: 8px; min-width: 0; flex: 1; }
  .link-preview-url { font-weight: 800; color: var(--accent); text-decoration: underline; transition: color .2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; word-break: normal; flex: 1; min-width: 0; }
  .link-preview-url:hover { color: #8ab4ff; }
  .link-preview-title { color: var(--muted); font-size: 13px; line-height: 1.4; word-break: break-word; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .link-preview-actions { display: flex; gap: 8px; }
  .link-preview button { padding: 8px 12px; min-height: 36px; }
  /* Bulk Toolbar */
  .bulk-toolbar {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
      background: var(--card); padding: 10px 20px; border-radius: 12px; 
      border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex; gap: 15px; z-index: 999; align-items: center;
  }
  .bulk-action-btn {
      background: var(--button-bg); border: 1px solid var(--border); color: var(--text);
      padding: 8px 15px; font-size: 14px; border-radius: 6px; cursor: pointer;
      transition: .2s; white-space: nowrap;
  }
  .bulk-action-btn.delete { color: var(--red); border-color: var(--red); }
  .bulk-action-btn:hover { background: var(--btn-hover); border-color: var(--accent); color: var(--accent); }
  .bulk-action-btn.delete:hover { background: var(--del-hover-bg); color: var(--red); border-color: var(--del-hover-border); }
  
  /* Bulk Move Select */
  .bulk-move-select {
      padding: 8px 15px;
      background: var(--button-bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      transition: .2s;
  }
  .bulk-move-select:hover { border-color: var(--accent); }
  .bulk-move-select option { background: var(--card); }


  /* Modals */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:var(--modal-overlay);z-index:1000;justify-content:center;align-items:flex-start;backdrop-filter: blur(4px); overflow-y: auto; padding: 30px 12px;}
  .modal-content{background:var(--card);padding:30px;border-radius:16px;width:460px;max-width:95%;border:1px solid var(--border);text-align:center; position: relative; box-shadow: 0 18px 60px rgba(0,0,0,0.35);}
  .modal-content.modal-wide {
    width: 920px;
    max-width: 96vw;
    text-align: left;
    overflow: hidden;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
  }
  
  /* Inputs & Selects inside modal */
  .inp-group{margin-bottom:15px;text-align:left;}
  .inp-group label{display:block;margin-bottom:5px;font-size:13px;color:var(--muted);font-weight:600;}
  .inp-group input, .inp-group select {background-color: var(--input-bg);border:1px solid var(--border);padding:9px 10px;width:100%;color:var(--text);border-radius:8px; outline: none; box-sizing: border-box;}
  .row-inputs{display:flex;gap:14px;margin-bottom:15px;flex-wrap:wrap; align-items:flex-start;}
  .row-inputs > div {flex: 1 1 180px;}
  .contractor-row { align-items: flex-end; column-gap: 14px; }
  .contractor-row .contractor-group { min-width: 260px; display: flex; flex-direction: column; gap: 10px; }
  .contractor-row .tax-group { min-width: 140px; }
  .requests-row { align-items: flex-end; }
  .requests-row .inp-group { margin-bottom: 0; }
  .input-with-clear { position: relative; flex: 1 1 260px; display: flex; align-items: center; }
  .input-with-clear input { padding-right: 40px; width: 100%; }
  .clear-input-btn { position: absolute; right: 8px; display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 7px; border: 1px solid transparent; background: var(--button-bg); color: var(--muted); cursor: pointer; transition: .12s; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); }
  .clear-input-btn:hover { color: var(--text); border-color: transparent; background: var(--input-bg); }
  .clear-input-btn.hidden { opacity: 0; pointer-events: none; }
  .input-error { border-color: var(--red) !important; box-shadow: 0 0 0 2px rgba(218,54,51,0.12); }
  .deadline-presets { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .deadline-presets select,
  .deadline-presets input { background: var(--input-bg); border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px; color: var(--text); min-height: 44px; font-weight: 800; transition: .15s; }
  .deadline-presets select:focus,
  .deadline-presets input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(88,166,255,0.14); }
  .deadline-presets select { min-width: 130px; max-width: 160px; white-space: nowrap; flex: 0 0 150px; }
  .deadline-presets input { min-width: 100px; max-width: 140px; flex: 0 1 120px; }
  .deadline-time { min-width: 110px; max-width: 140px; flex: 0 0 120px; padding: 10px 12px; }
  .modal-deadline-presets { flex-wrap: wrap; justify-content: flex-start; margin: 12px 0 6px; }
  .modal-deadline-presets select { min-width: 170px; }
  .modal-deadline-presets input { flex: 0 1 160px; }
  .date-modal-footer { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 6px; gap: 10px; flex-wrap: wrap; }
  .date-duo { display: flex; gap: 12px; align-items: stretch; margin-bottom: 12px; flex-wrap: wrap; }
  .date-duo .inp-group { margin-bottom: 0; }
  .date-duo-card { flex: 1 1 220px; min-width: 0; padding: 0; border-radius: 14px; border: none; background: transparent; box-shadow: none; }
  .date-duo .inp-group label { display: flex; align-items: center; gap: 6px; color: var(--muted); font-weight: 700; }
  .date-chip { margin-top: 8px; }
  .deadline-display { display: inline-flex; align-items: center; gap: 8px; line-height: 1.2; }
  .deadline-display .date-text { display: inline-flex; align-items: center; gap: 6px; flex-wrap: nowrap; }
  .deadline-delta { color: var(--muted); font-size: 12px; font-weight: 750; letter-spacing: -0.1px; }
  .deadline-delta.overdue { color: var(--red); }

  .timeline-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; margin-bottom: 10px; align-items: start; }
  .timeline-pair { display: grid; grid-template-columns: repeat(2, minmax(200px, 1fr)); column-gap: 12px; row-gap: 0; align-items: stretch; }
  .timeline-row .inp-group { margin-bottom: 0; display: flex; flex-direction: column; gap: 6px; align-items: flex-start; }
  .timeline-row .deadline-presets { justify-content: flex-start; flex-wrap: nowrap; }
  .timeline-row .date-input-wrap { width: 100%; }

  .currency-symbol { pointer-events: none; }
  
  .close-modal-x { 
      position: absolute; 
      top: 10px; 
      right: 15px; 
      font-size: 24px; 
      color: var(--muted); 
      cursor: pointer; 
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s;
  }
  .close-modal-x:hover { opacity: 1; }
  .save-stg { padding: 12px 16px; border-radius: 12px; font-weight: 800; letter-spacing: 0.1px; background: var(--btn-blue); border: 1px solid var(--btn-blue); color: #fff; transition: transform .1s, box-shadow .1s, background .1s; cursor: pointer; justify-content: center; text-align: center; line-height: 1.35; }
  .save-stg:hover { transform: translateY(-1px); box-shadow: none; color: #fff; background: #2f81f7; }
  .modal .save-stg { width: 100%; margin-top: 20px; }
  .request-add-btn { width: auto; align-self: flex-end; min-width: 140px; height: 46px; margin-top: 0; }
  .request-add-btn:hover { box-shadow: none; transform: none; }
  
  /* Settings Modal specific padding fix */
  #settingsModal .modal-content {
      padding: 32px; /* Увеличен отступ для заголовка */
  }
  #settingsModal .modal-content h2 { margin-bottom: 15px; }

  /* --- Clean Settings Modal (Redesign) --- */
  #settingsModal .modal-content {
      padding: 0 !important;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--bg); /* Фон подложки */
      max-height: 85vh;
      height: 700px;
      width: 900px;
      border-radius: 20px;
      border: 1px solid var(--border);
  }
  .settings-top-bar {
      padding: 18px 24px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
  }
  .settings-top-title { font-size: 18px; font-weight: 800; color: var(--text); }
  .settings-layout-clean {
      display: flex;
      flex: 1;
      overflow: hidden;
  }
  .settings-sidebar {
      width: 240px;
      background: var(--card-alt);
      border-right: 1px solid var(--border);
      padding: 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
  }
  .settings-nav-item {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: .2s;
      display: flex;
      align-items: center;
      gap: 10px;
  }
  .settings-nav-item:hover { background: var(--button-bg); color: var(--text); }
  .settings-nav-item.active { background: var(--button-bg); color: var(--accent); font-weight: 700; }
  
  .settings-body {
      flex: 1;
      background: var(--bg);
      padding: 30px;
      overflow-y: auto;
  }
  
  /* Карточки внутри настроек */
  .stg-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
  }
  .stg-card-title { font-size: 16px; font-weight: 800; margin-bottom: 6px; color: var(--text); }
  .stg-card-desc { font-size: 13px; color: var(--muted); margin-bottom: 20px; line-height: 1.4; }
  
  .stg-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--table-border);
  }
  .stg-row:last-child { border-bottom: none; padding-bottom: 0; }
  .stg-row:first-child { padding-top: 0; }
  
  .stg-info h4 { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
  .stg-info p { font-size: 12px; color: var(--muted); max-width: 400px; }

  /* Input group в настройках */
  .stg-input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
  }

  /* --- Fixed Record Block (Premium Clean) --- */
  .record-clean {
      position: relative;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  }
  /* Градиентный фон для красоты */
  .record-clean::before {
      content: "";
      position: absolute;
      top: 0; right: 0; width: 150px; height: 150px;
      background: radial-gradient(circle at top right, rgba(250, 204, 21, 0.12), transparent 60%);
      pointer-events: none;
  }
  
  .rec-top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      z-index: 2;
  }
  .rec-meta { display: flex; flex-direction: column; gap: 4px; }
  .rec-label-sm { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--muted); letter-spacing: 0.5px; }
  .rec-big-val { font-size: 32px; font-weight: 900; color: var(--text); line-height: 1.1; }
  
  .rec-target-badge {
      font-size: 12px; font-weight: 700; color: var(--gold); 
      background: rgba(250, 204, 21, 0.1); padding: 6px 10px; border-radius: 8px;
      border: 1px solid rgba(250, 204, 21, 0.2);
      display: flex; align-items: center; gap: 6px;
  }
  .rec-edit-icon { cursor: pointer; opacity: 0.6; transition: .2s; }
  .rec-edit-icon:hover { opacity: 1; color: var(--text); }

  .rec-bar-area { display: flex; flex-direction: column; gap: 6px; z-index: 2; margin-top: 4px; }
  .rec-track { height: 8px; background: var(--card-alt); border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
  .rec-fill { height: 100%; background: linear-gradient(90deg, #facc15, #f59e0b); border-radius: 6px; transition: width 0.6s ease; }
  .rec-sub-text { font-size: 12px; color: var(--muted); font-weight: 600; display: flex; justify-content: space-between; }

  /* --- Eff Card Fix --- */
  .eff-card-modern {
      background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
  }
  .eff-chart-canvas-wrap {
      position: relative;
      width: 100%;
  }

  /* --- Toggle Switch Clean --- */
  .switch-clean { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
  .switch-clean input { opacity: 0; width: 0; height: 0; }
  .slider-clean {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--border); transition: .3s; border-radius: 22px;
  }
  .slider-clean:before {
    position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
    background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .switch-clean input:checked + .slider-clean { background-color: var(--accent); }
  .switch-clean input:checked + .slider-clean:before { transform: translateX(18px); }

  /* Скроллбар для настроек */
  .settings-body::-webkit-scrollbar { width: 6px; }
  .settings-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

</style>
</head>
<body>

<div class="toast" id="toast">
    <div class="toast-message" id="toast-message"></div>
    <button class="toast-action" id="toast-action" style="display:none"></button>
    <button class="toast-close" onclick="hideToast()">×</button>
</div>

<svg style="display: none;">
    <symbol id="icon-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4.5a1 1 0 0 1-1-1V2a1 1 0 1 1 2 0v1.5a1 1 0 0 1-1 1Zm0 17a1 1 0 0 1-1 1V24a1 1 0 1 1 2 0v-1.5a1 1 0 0 1-1-1Zm7.424-14.924a1 1 0 0 1 0-1.414l1.06-1.06a1 1 0 1 1 1.415 1.414l-1.06 1.06a1 1 0 0 1-1.415 0ZM2.1 20.4a1 1 0 0 1 0-1.415l1.06-1.06a1 1 0 1 1 1.414 1.414l-1.06 1.061A1 1 0 0 1 2.1 20.4Zm19.8-1.414a1 1 0 0 1-1.415 0l-1.06-1.06a1 1 0 1 1 1.414-1.415l1.06 1.06a1 1 0 0 1 0 1.415ZM2.1 3.6a1 1 0 0 1 1.414 0l1.06 1.06A1 1 0 0 1 3.16 6.074L2.1 5.014A1 1 0 0 1 2.1 3.6ZM4.5 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h1.5a1 1 0 0 1 1 1Zm18 0a1 1 0 0 1-1 1H20a1 1 0 1 1 0-2h1.5a1 1 0 0 1 1 1Zm-7 0a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0Z"/></symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M21.74 15.34a1 1 0 0 0-1.11-.27A7.5 7.5 0 0 1 9.06 4.5a1 1 0 0 0-.76-1.2a9 9 0 1 0 13.44 12.36Z"/></symbol>
    <symbol id="icon-pen" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="m5 15.5 9.9-9.9a1.8 1.8 0 0 1 2.55 0l1.95 1.95a1.8 1.8 0 0 1 0 2.55L9.5 20H4v-5.5Z"/><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M14 6l4 4"/></symbol>
    <symbol id="icon-check" viewBox="0 0 20 20"><path fill="currentColor" d="m16.707 6.293-7.25 7.25a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L8.5 11.672l6.543-6.543a1 1 0 0 1 1.414 1.164a.99.99 0 0 1-.25.293Z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" d="M4 7.5h10.5M4 12h12M4 16.5h10.5"/>
      <circle cx="16.5" cy="7.5" r="1.8" fill="none" stroke="currentColor" stroke-width="1.7"/>
      <circle cx="9" cy="12" r="1.8" fill="none" stroke="currentColor" stroke-width="1.7"/>
      <circle cx="15" cy="16.5" r="1.8" fill="none" stroke="currentColor" stroke-width="1.7"/>
    </symbol>
    <symbol id="icon-drag" viewBox="0 0 24 24"><path fill="currentColor" d="M10 4a2 2 0 1 1-4 0a2 2 0 0 1 4 0Zm4 0a2 2 0 1 1 4 0a2 2 0 0 1-4 0ZM8 12a2 2 0 1 0-4 0a2 2 0 0 0 4 0Zm8 0a2 2 0 1 0-4 0a2 2 0 0 0 4 0Zm-6 6a2 2 0 1 1-4 0a2 2 0 0 1 4 0Zm4 0a2 2 0 1 1 4 0a2 2 0 0 1-4 0Z"/></symbol>
    <symbol id="icon-grip" viewBox="0 0 24 24"><path fill="currentColor" d="M10 5a1 1 0 0 1-1 1H7a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1Zm7-1h-2a1 1 0 1 0 0 2h2a1 1 0 0 0 0-2Zm0 6h-2a1 1 0 1 0 0 2h2a1 1 0 0 0 0-2Zm0 6h-2a1 1 0 1 0 0 2h2a1 1 0 0 0 0-2Zm-8-4H7a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2Zm0 6H7a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2Zm0-12H7a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2Z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M6.34 4.93a1 1 0 0 0-1.41 1.41L10.59 12l-5.66 5.66a1 1 0 1 0 1.41 1.41L12 13.41l5.66 5.66a1 1 0 0 0 1.41-1.41L13.41 12l5.66-5.66a1 1 0 1 0-1.41-1.41L12 10.59Z"/></symbol>
    <symbol id="icon-hide" viewBox="0 0 24 24"><path fill="currentColor" d="M4.52 3.1a1 1 0 0 0-1.42 1.41l16 16a1 1 0 0 0 1.42-1.41l-2.03-2.03A11.3 11.3 0 0 0 21.89 12a11.29 11.29 0 0 0-3.67-4.91A9.3 9.3 0 0 0 12 5A9.4 9.4 0 0 0 8.6 5.6Zm5.58 5.58l2.11 2.1a2 2 0 0 0-2.1-2.1Zm-5.42-1.5A9.27 9.27 0 0 0 2.11 12a11.29 11.29 0 0 0 3.67 4.91A9.3 9.3 0 0 0 12 19a9.4 9.4 0 0 0 1.61-.14l-2.44-2.45A4 4 0 0 1 7.6 9.18Z"/></symbol>
    <symbol id="icon-active" viewBox="0 0 16 16"><path fill="currentColor" d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0ZM3 8a5 5 0 0 1 10 0 5 5 0 0 1-10 0Z"/></symbol>
    <symbol id="icon-all" viewBox="0 0 16 16"><path fill="currentColor" d="M2.5 2.5A.5.5 0 0 1 3 2h4.5a.5.5 0 0 1 .5.5V7a.5.5 0 0 1-.5.5H3A.5.5 0 0 1 2.5 7Zm6 0A.5.5 0 0 1 9 2h4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-.5.5H9a.5.5 0 0 1-.5-.5Zm-6 6A.5.5 0 0 1 3 8h4.5a.5.5 0 0 1 .5.5V13a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5Zm8 0A.5.5 0 0 1 11 8h2a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5Z"/></symbol>
    <symbol id="icon-waiting" viewBox="0 0 16 16"><path fill="currentColor" d="M8 1.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13Zm0 1.5a5 5 0 1 1 0 10a5 5 0 0 1 0-10Zm-.5 1.25c0-.276.224-.5.5-.5s.5.224.5.5v2.6l2 1.2a.5.5 0 1 1-.5.866l-2.25-1.35A.5.5 0 0 1 7.5 7V4.25Z"/></symbol>
    <symbol id="icon-potential" viewBox="0 0 16 16"><path fill="currentColor" d="M3 1.5A.5.5 0 0 1 3.5 1h7a.5.5 0 0 1 .4.8L9.6 4l1.3 2.2a.5.5 0 0 1-.43.8H5.5V14a.5.5 0 0 1-1 0z"/></symbol>
    <symbol id="icon-paused" viewBox="0 0 16 16"><path fill="currentColor" d="M5 2.5a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Zm6 0a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5Z"/></symbol>
    <symbol id="icon-archive" viewBox="0 0 16 16"><path fill="currentColor" d="M13 1.75a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v12.5c0 .414.336.75.75.75h8.5a.75.75 0 0 0 .75-.75Zm-1.5 8.75a.5.5 0 0 1-1 0V6.707L6.464 10.464a.5.5 0 0 1-.708-.708L10.793 6H7.5a.5.5 0 0 1 0-1h4.5a.5.5 0 0 1 .5.5v4.5Z"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 3.5 8 5H5.5a1 1 0 0 0 0 2h13a1 1 0 0 0 0-2H16l-1-1.5a1 1 0 0 0-.83-.45H9.83a1 1 0 0 0-.83.45Zm-2 5.5h10l-.6 9.01a1 1 0 0 1-1 .94H7.6a1 1 0 0 1-1-.94L6 9Z"/>
      <path fill="currentColor" d="M10 11a1 1 0 0 0-1 1v4a1 1 0 1 0 2 0v-4a1 1 0 0 0-1-1Zm4 0a1 1 0 0 0-1 1v4a1 1 0 1 0 2 0v-4a1 1 0 0 0-1-1Z"/>
    </symbol>
    <symbol id="icon-duplicate" viewBox="0 0 16 16"><path fill="currentColor" d="M2.25 1.75a.75.75 0 0 1 .75-.75h7.25a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0V2.5h-6.5v8h2a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1-.75-.75Zm4.5 4a.75.75 0 0 1 .75-.75h6a.75.75 0 0 1 .75.75v8a.75.75 0 0 1-.75.75h-6a.75.75 0 0 1-.75-.75v-8Z"/></symbol>
    <symbol id="icon-link" viewBox="0 0 24 24"><path fill="currentColor" d="M13.06 3.94a5.5 5.5 0 0 1 7.78 7.78l-2.12 2.12a5.5 5.5 0 0 1-7.78 0a1 1 0 0 1 1.42-1.42a3.5 3.5 0 0 0 4.94 0l2.12-2.12a3.5 3.5 0 0 0-4.94-4.94l-.88.88a1 1 0 1 1-1.42-1.42Zm-6.72 6.72a5.5 5.5 0 0 1 7.78 0a1 1 0 1 1-1.42 1.42a3.5 3.5 0 0 0-4.94 0l-2.12 2.12a3.5 3.5 0 0 0 4.94 4.94l.88-.88a1 1 0 0 1 1.42 1.42l-.88.88a5.5 5.5 0 0 1-7.78-7.78Z"/></symbol>
    <symbol id="icon-external" viewBox="0 0 24 24"><path fill="currentColor" d="M14 4a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v5a1 1 0 1 1-2 0V6.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L17.586 5H15a1 1 0 0 1-1-1Z"/><path fill="currentColor" d="M5 6a1 1 0 0 1 1-1h5a1 1 0 1 1 0 2H7v10h10v-4a1 1 0 1 1 2 0v5a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1Z"/></symbol>
    <symbol id="icon-calendar-off" viewBox="0 0 24 24"><path fill="currentColor" d="M7 2a1 1 0 0 0-1 1v1H5a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-1V3a1 1 0 1 0-2 0v1H8V3a1 1 0 0 0-1-1Zm12 6v10a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V8h14Z"/><path fill="currentColor" d="M9.7 10.3a1 1 0 0 0-1.4 1.4L10.6 14l-2.3 2.3a1 1 0 0 0 1.4 1.4L12 15.4l2.3 2.3a1 1 0 0 0 1.4-1.4L13.4 14l2.3-2.3a1 1 0 1 0-1.4-1.4L12 12.6Z"/></symbol>
    <symbol id="icon-calendar" viewBox="0 0 16 16"><path fill="currentColor" d="M3 2.75A.75.75 0 0 1 3.75 2h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 2.75ZM12.25 2a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5c0-.414.336-.75.75-.75ZM2 5.5a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 5.5Zm12.5 2.25v7.25c0 .414-.336.75-.75.75H2.25a.75.75 0 0 1-.75-.75V7.75c0-.414.336-.75.75-.75h11.5c.414 0 .75.336.75.75Z"/></symbol>
    <symbol id="icon-clock" viewBox="0 0 16 16"><path fill="currentColor" d="M8 1.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13Zm0 1.5a5 5 0 1 1 0 10a5 5 0 0 1 0-10Zm-.5 1.25c0-.276.224-.5.5-.5s.5.224.5.5v2.6l2 1.2a.5.5 0 1 1-.5.866l-2.25-1.35A.5.5 0 0 1 7.5 7V4.25Z"/></symbol>
    <symbol id="icon-undo" viewBox="0 0 20 20"><path fill="currentColor" d="M9.5 3a7.5 7.5 0 1 1-5.303 12.803a.75.75 0 0 1 1.06-1.061A6 6 0 1 0 7 5.233V7.5a.75.75 0 0 1-1.28.53l-3-3a.75.75 0 0 1 0-1.06l3-3A.75.75 0 0 1 7 1.97V4.2A7.47 7.47 0 0 1 9.5 3Z"/></symbol>
    <symbol id="icon-arrow-right" viewBox="0 0 24 24"><path fill="currentColor" d="M5 12a1 1 0 0 1 1-1h9.586l-3.293-3.293a1 1 0 1 1 1.414-1.414l5 5a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414-1.414L15.586 13H6a1 1 0 0 1-1-1Z"/></symbol>
    <symbol id="icon-upload" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3a1 1 0 0 1 .707.293l4 4a1 1 0 0 1-1.414 1.414L13 6.414V16a1 1 0 1 1-2 0V6.414L8.707 8.707A1 1 0 0 1 7.293 7.293l4-4A1 1 0 0 1 12 3Z"/><path fill="currentColor" d="M5 15a1 1 0 0 1 1 1v3h12v-3a1 1 0 1 1 2 0v3a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-3a1 1 0 0 1 1-1Z"/></symbol>
    <symbol id="icon-download" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17a1 1 0 0 1-.707-.293l-4-4a1 1 0 0 1 1.414-1.414L11 13.586V4a1 1 0 1 1 2 0v9.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4A1 1 0 0 1 12 17Z"/><path fill="currentColor" d="M5 18a1 1 0 0 1 1 1v2h12v-2a1 1 0 1 1 2 0v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2a1 1 0 0 1 1-1Z"/></symbol>
    <symbol id="icon-csv" viewBox="0 0 24 24"><path fill="currentColor" d="M5 3a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9.414a2 2 0 0 0-.586-1.414l-4.414-4.414A2 2 0 0 0 14.586 3ZM5 5h9v4a2 2 0 0 0 2 2h4v8H5Zm11 0.414L18.586 8H16Z"/><path fill="currentColor" d="M7.5 13c-1.105 0-1.9.726-1.9 1.75S6.41 16.5 7.5 16.5c.57 0 1.06-.18 1.43-.51a.75.75 0 0 0-.99-1.12c-.12.1-.25.13-.44.13-.37 0-.65-.24-.65-.75s.28-.75.65-.75c.17 0 .31.04.44.14a.75.75 0 0 0 .99-1.12c-.37-.33-.86-.48-1.43-.48Zm2.43.1a.75.75 0 0 0-.57.9l.6 2.4a.75.75 0 1 0 1.46-.36l-.6-2.4a.75.75 0 0 0-.89-.54Zm3.93 0c-.62 0-1.07.29-1.31.66a1.6 1.6 0 0 0-.25.82c0 .36.12.67.31.93a1.88 1.88 0 0 0 1.53.79c.59 0 1.05-.17 1.39-.5a.75.75 0 1 0-1.02-1.09c-.08.08-.2.14-.38.14-.23 0-.44-.16-.44-.32c0-.12.03-.2.08-.26c.07-.1.19-.17.36-.17c.16 0 .26.04.35.12c.3.26.82.24 1.06-.1c.27-.35.1-.8-.1-1.02c-.27-.29-.7-.5-1.38-.5Z"/></symbol>
    <symbol id="icon-arrow-up" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5a1 1 0 0 1 .707.293l5 5a1 1 0 0 1-1.414 1.414L13 8.414V19a1 1 0 1 1-2 0V8.414l-3.293 3.293A1 1 0 0 1 6.293 10.293l5-5A1 1 0 0 1 12 5Z"/></symbol>
    <symbol id="icon-arrow-down" viewBox="0 0 24 24"><path fill="currentColor" d="M12 19a1 1 0 0 1-.707-.293l-5-5a1 1 0 0 1 1.414-1.414L11 15.586V5a1 1 0 1 1 2 0v10.586l3.293-3.293a1 1 0 0 1 1.414 1.414l-5 5A1 1 0 0 1 12 19Z"/></symbol>
</svg>

<div class="c">
  
  <div class="header-row">
    <div class="brand-wrap">
      <div class="brand-logo" aria-hidden="true">⚡</div>
      <div class="brand-text">
        <div class="brand-title">DesignFlow <span class="brand-version">v0.8</span></div>
        <div class="brand-sub">Трекер проектов и бюджета</div>
      </div>
    </div>
    <div style="display:flex;gap:15px;align-items:center">


          <style>
      .header-btn {
  position: relative; /* Обязательно для позиционирования бейджика */
  padding-right: 40px; /* Дополнительное место справа для бейджика */
}

/* Прямоугольный синий бейджик "New" */
.header-new-badge {
  position: absolute;
  top: -8px;
  right: -12px;
  background: var(--accent); /* Синий акцент из твоей темы */
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 8px; /* Закруглённые углы — прямоугольник */
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  pointer-events: none;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: background 0.3s;
}

/* В светлой теме — подходящий синий */
body:not([data-theme="dark"]) .header-new-badge {
  background: #3b82f6;
}

/* Ховер — чуть ярче */
.header-btn:hover .header-new-badge {
  background: var(--accent-hover, #6a4bff);
}
</style>





<!-- Кнопка "Трекер целей" с прямоугольным синим бейджиком "New" -->
<button class="header-btn" onclick="window.location.href='Goal.html'" title="Трекер целей">
  <i class="fa-solid fa-bullseye"></i>
  <span class="header-btn-text">Трекер целей</span>
  <!-- Прямоугольный бейджик "New" -->
  <span class="header-new-badge">New</span>
</button>
          
          
        <button onclick="openSettings()" id="openSettingsBtn">
            <svg class="btn-icon lg"><use href="#icon-settings"/></svg>
            <span class="btn-label">Настройки</span>
        </button>
        <select id="monthSelect" class="month-select" onchange="changeMonth(this.value)"></select>
    </div>
  </div>


<div class="top-panel">
  <div class="backup-alert">
      <div class="backup-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
      </div>
      <div class="backup-info">
          <div class="backup-title"><b>Важно:</b> Данные хранятся только в вашем браузере.</div>
          <div class="backup-sub">Обязательно скачивайте резервную копию перед очисткой кэша или переустановкой системы.</div>
      </div>
  </div>

  <div class="btns">
    <button class="btn-outline" onclick="exp()" title="Сохранить JSON">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      <span>Скачать базу</span>
    </button>

    <button class="btn-outline" onclick="document.getElementById('importFile').click()" title="Загрузить из JSON">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
      <span>Загрузить базу</span>
    </button>

    <input type="file" id="importFile" style="display:none" onchange="imp(this.files[0])">
  </div>
</div>

  <div class="tabs-container">
    <div class="tabs">
        <div class="tab" id="tab-all" onclick="switchTab('all')"><svg><use href="#icon-all"/></svg> Все проекты <span class="tab-count" id="count-all">0</span></div>
        <div class="tab active" id="tab-active" onclick="switchTab('active')"><svg><use href="#icon-active"/></svg> В работе <span class="tab-count" id="count-active">0</span></div>
        <div class="tab" id="tab-waiting" onclick="switchTab('waiting')"><svg><use href="#icon-waiting"/></svg> Ожидает <span class="tab-count" id="count-waiting">0</span></div>
        <div class="tab" id="tab-potential" onclick="switchTab('potential')"><svg><use href="#icon-potential"/></svg> Потенциал <span class="tab-count" id="count-potential">0</span></div>
        <div class="tab" id="tab-requests" onclick="switchTab('requests')"><svg><use href="#icon-all"/></svg> Заявки <span class="tab-count" id="count-requests">0</span></div>
        <div class="tab" id="tab-paused" onclick="switchTab('paused')"><svg><use href="#icon-paused"/></svg> На паузе <span class="tab-count" id="count-paused">0</span></div>
        <div class="tab" id="tab-archive" onclick="switchTab('archive')"><svg><use href="#icon-archive"/></svg> Выполнено <span class="tab-count" id="count-archive">0</span></div>
        <div class="tab tab-trash" id="tab-trash" onclick="switchTab('trash')"><svg><use href="#icon-trash"/></svg> Корзина <span class="tab-count" id="count-trash">0</span></div>
    </div>
    <button id="newProjectButton" onclick="openAddModal()">＋ Новый проект</button>
  </div>
  
  <div class="tab-desc-block" id="tab-description">Проекты в работе. Следите за дедлайнами и фиксируйте предоплату.</div>

<div class="pace-block" id="pace-indicator" style="display:none;" data-editable data-block-key="pace">
      <div class="pace-layout">
          <div class="pace-main">
              <div class="pace-icon-box">
                  <div id="pace-icon">🔥</div>
              </div>
              <div class="pace-info">
                  <div class="pace-label">Темп недели</div>
                  <div class="pace-title-row">
                      <div class="pace-title" id="pace-title">Нужно ускориться!</div>
                      <div class="pace-status pace-hurry" id="pace-status">Критично</div>
                  </div>
                  <div class="pace-desc" id="pace-desc">Горит дедлайнов: 2. Поднажми!</div>
              </div>
          </div>
          
          <div class="pace-side">
              <div class="pace-mini-stat">
                  <div class="pace-rep-val">
                      <span class="rep-dot good" id="pace-rep-dot"></span>
                      <span id="pace-rep-text">100 / 100</span>
                  </div>
                  <div class="pace-rep-sub" id="pace-rep-caption">Доверие стабильно</div>
                  <div id="pace-rep-chip" style="display:none"></div> 
              </div>
              <div class="pace-btn-wrap">
                  <button id="pace-details-btn" onclick="scrollToReputation()" title="Открыть детали репутации">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17L17 7"/><path d="M7 7h10v10"/></svg>
                  </button>
              </div>
          </div>
      </div>
  </div>

  <div class="main-layout">
    
    <div id="view-active">
      <div class="table-wrap">
        <table id="t-active">
          <thead>
            <tr>
              <th class="select-col">№</th>
              <th width="18%" data-type="active" data-key="c" onclick="sortData('active', 'c', 'string')">Клиент <span class="sort-icon"></span></th>
              <th width="19%" data-type="active" data-key="n" onclick="sortData('active', 'n', 'string')">Проект <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="start" onclick="sortData('active', 'start', 'date')">Старт <span class="sort-icon"></span></th>
              <th width="8%" data-type="active" data-key="dl" onclick="sortData('active', 'dl', 'date')">Дедлайн <span class="sort-icon"></span></th>
              <th width="6%" data-type="active" data-key="rem" onclick="sortData('active', 'rem', 'number')">Осталось <span class="sort-icon"></span></th>
              <th width="4%" data-type="active" data-key="taxPrc" onclick="sortData('active', 'taxPrc', 'number')">Налог % <span class="sort-icon"></span></th>
              <th width="6%" data-type="active" data-key="contractor" onclick="sortData('active', 'contractor', 'number')" style="text-align:right;">Расходы <span class="sort-icon"></span></th>
              <th width="10%" data-type="active" data-key="p" onclick="sortData('active', 'p', 'number')" style="text-align:right;">Сумма <span class="sort-icon"></span></th>
              <th width="8%" style="text-align:right;">Чистыми</th>
              <th width="4%" style="text-align:right;">Оплачено</th>
              <th width="4%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-active">
            <tr><td colspan="8">Итого:</td><td></td><td></td><td></td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div id="view-waiting" style="display:none">
        <div class="table-wrap">
          <table id="t-waiting">
            <thead>
              <tr>
                <th class="select-col">№</th>
              <th width="20%" data-type="waiting" data-key="c" onclick="sortData('waiting', 'c', 'string')">Клиент <span class="sort-icon"></span></th>
              <th width="30%" data-type="waiting" data-key="n" onclick="sortData('waiting', 'n', 'string')">Проект <span class="sort-icon"></span></th>
              <th width="18%" data-type="waiting" data-key="p" onclick="sortData('waiting', 'p', 'number')">Сумма <span class="sort-icon"></span></th>
              <th width="22%"></th>
            </tr>
          </thead>
          <tbody></tbody>
            <tfoot id="total-row-waiting"><tr><td colspan="3">Итого:</td><td></td><td></td></tr></tfoot>
          </table>
        </div>
    </div>
    
    <div id="view-potential" style="display:none">
        <div class="table-wrap">
          <table id="t-potential">
            <thead>
              <tr>
                <th class="select-col">№</th>
              <th width="25%" data-type="potential" data-key="c" onclick="sortData('potential', 'c', 'string')">Клиент <span class="sort-icon"></span></th>
              <th width="40%" data-type="potential" data-key="n" onclick="sortData('potential', 'n', 'string')">Проект <span class="sort-icon"></span></th>
              <th width="15%" data-type="potential" data-key="p" onclick="sortData('potential', 'p', 'number')">Сумма <span class="sort-icon"></span></th>
              <th width="20%"></th>
              </tr>
            </thead>
            <tbody></tbody>
          <tfoot id="total-row-potential"><tr><td colspan="3">Итого:</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-requests" style="display:none">
      <div class="table-wrap">
        <div class="row-inputs requests-row" style="padding: 15px; gap: 10px;">
            <div class="inp-group" style="flex:1">
                <label>Кто обращается</label>
                <input type="text" id="req-name" placeholder="Имя или компания">
            </div>
            <div class="inp-group" style="flex:1">
                <label>Источник</label>
                <input type="text" id="req-source" placeholder="Телеграм, сайт, рекомендация">
            </div>
            <div class="inp-group" style="flex:1">
                <label>Описание</label>
                <input type="text" id="req-note" placeholder="Что нужно сделать">
            </div>
            <div class="inp-group" style="flex:1">
                <label>Ссылка</label>
                <input type="text" id="req-link" placeholder="Ссылка на ТЗ или профиль">
            </div>
            <div class="inp-group" style="flex:0 0 140px">
                <label>Бюджет</label>
                <input type="text" id="req-budget" placeholder="0" oninput="formatNumberInput(this)">
            </div>
            <button class="save-stg request-add-btn" onclick="addRequest()">Добавить</button>
        </div>
        <table id="t-requests">
            <thead>
                <tr>
                    <th class="select-col">№</th>
                    <th width="17%">Клиент</th>
                    <th width="17%">Источник</th>
                    <th width="30%">Описание</th>
                    <th width="12%">Ссылка</th>
                    <th width="12%">Бюджет</th>
                    <th width="12%">Действия</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot id="total-row-requests"><tr><td colspan="5">Всего заявок</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-paused" style="display:none">
      <div class="table-wrap">
        <table id="t-paused">
          <thead>
            <tr>
              <th class="select-col">№</th>
              <th width="20%" data-type="paused" data-key="c" onclick="sortData('paused', 'c', 'string')">Клиент <span class="sort-icon"></span></th>
              <th width="30%" data-type="paused" data-key="n" onclick="sortData('paused', 'n', 'string')">Проект <span class="sort-icon"></span></th>
              <th width="15%" data-type="paused" data-key="dl" onclick="sortData('paused', 'dl', 'date')">Дедлайн <span class="sort-icon"></span></th>
              <th width="15%" data-type="paused" data-key="p" onclick="sortData('paused', 'p', 'number')">Сумма <span class="sort-icon"></span></th>
              <th width="15%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-paused"><tr><td colspan="4">Итого:</td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-archive" style="display:none">
      <div class="table-wrap">
        <table id="t-archive">
          <thead>
            <tr>
              <th class="select-col">№</th>
              <th width="15%" data-type="archive" data-key="c" onclick="sortData('archive', 'c', 'string')">Клиент <span class="sort-icon"></span></th>
              <th width="25%" data-type="archive" data-key="n" onclick="sortData('archive', 'n', 'string')">Проект <span class="sort-icon"></span></th>
              <th width="15%" data-type="archive" data-key="date" onclick="sortData('archive', 'date', 'date')">Дата сдачи <span class="sort-icon"></span></th>
              <th width="10%" data-type="archive" data-key="p" onclick="sortData('archive', 'p', 'number')">Сумма <span class="sort-icon"></span></th>
              <th width="10%" data-type="archive" data-key="contractor" onclick="sortData('archive', 'contractor', 'number')">Расходы <span class="sort-icon"></span></th>
              <th width="10%">Чистыми</th>
              <th width="10%"></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-archive"><tr><td colspan="4">Итого:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>

    <div id="view-all" style="display:none">
      <div class="table-wrap">
        <table id="t-all">
          <thead>
            <tr>
              <th class="select-col">№</th>
              <th width="12%">Статус</th>
              <th width="16%">Клиент</th>
              <th width="24%">Проект</th>
              <th width="14%">Срок</th>
              <th width="10%">Сумма</th>
              <th width="10%">Расходы</th>
              <th width="8%">Налог</th>
              <th width="12%">Чистыми</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-all"><tr><td colspan="5">Итого:</td><td></td><td></td><td></td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
    
    <div id="view-trash" style="display:none">
      <div class="table-wrap">
        <table id="t-trash">
          <thead>
            <tr>
              <th class="select-col">№</th>
              <th width="20%">Удалено</th>
              <th width="20%">Клиент</th>
              <th width="30%">Проект</th>
              <th width="15%">Сумма</th>
              <th width="15%">Действия</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot id="total-row-trash"><tr><td colspan="6">Итого</td></tr></tfoot>
        </table>
      </div>
      <div class="trash-toolbar">
          <div style="color: var(--muted); font-size: 13px;">Объекты хранятся здесь 7 дней, затем удаляются навсегда.</div>
          <button class="trash-clean-btn" onclick="clearTrashForever()">
              <svg class="btn-icon"><use href="#icon-trash"/></svg>
              <span class="btn-label">Очистить корзину</span>
          </button>
      </div>
    </div>
  </div>
  
  <div class="dashboard" id="analytics-dashboard">
    <div class="stats-full">
      <div class="stats-two-columns">
          <div class="stats-main" data-block-container="main">
              <div class="card">
              <div class="card-head">
                  <div>
                      <div class="finance-title">Финансы: <span class="text-green" id="dash-month-name">...</span></div>
                      <div class="finance-sub">Дашборд по чистой прибыли и платежам</div>
                      <div class="stat-scope-note" id="stat-scope-note" title="Данные собираются по всем разделам">Срез: все проекты</div>
                  </div>
                  <div class="card-head-actions">
                      <div class="stat-pill" id="goal-pill">Цель: 0 ₽</div>
                      <button class="inline-link-btn" onclick="openGoalSettings()">Редактировать</button>
                  </div>
              </div>
              <div class="goal-wrap" id="goal-progress">
                  <div class="goal-info">
                      <span class="stat-label-with-help">Прогресс цели <span class="help-icon" data-tooltip="Соотношение текущей чистой прибыли к месячной цели. Значение обновляется при изменении статусов проектов и оплат.">?</span></span>
                      <span id="goal-text">0 / 0 ₽</span>
                  </div>
                  <div class="progress-bg"><div class="progress-fill" id="p-bar"></div></div>
              </div>
              <div class="stats-grid">
                  <div class="stat-box" data-stat="fact" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">ФАКТ</span><span class="help-icon" data-tooltip="Чистая прибыль за выбранный месяц с учётом всех статусов.">?</span></div>
                          <div class="stat-pill">Чистыми</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-fact">0 ₽</div>
                      <div class="stat-helper" id="val-fact-prc">0%</div>
                  </div>
                  <div class="stat-box" data-stat="active-fact" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">ПОЛУЧЕНО</span><span class="help-icon" data-tooltip="Чистая сумма, уже поступившая по проектам в работе (статус ‘В работе’).">?</span></div>
                          <div class="stat-pill">Чистыми (в работе)</div>
                      </div>
                      <div class="stat-val text-green mono" id="val-active-fact">0 ₽</div>
                      <div class="stat-helper">Оплачено в текущих проектах</div>
                  </div>
                  <div class="stat-box" data-stat="paid-gross" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">ОПЛАЧЕНО</span><span class="help-icon" data-tooltip="Все полученные платежи без вычета налогов и расходов (грязными).">?</span></div>
                          <div class="stat-pill">Все поступления</div>
                      </div>
                      <div class="stat-val mono" id="val-paid-gross" style="color:var(--accent)">0 ₽</div>
                      <div class="stat-helper">Полученные платежи (грязными)</div>
                  </div>
                  <div class="stat-box" data-stat="total-gross" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">ОБЩАЯ СУММА</span><span class="help-icon" data-tooltip="Все бюджеты проектов (грязными) во всех разделах, включая архив и паузу.">?</span></div>
                          <div class="stat-pill">Грязными</div>
                      </div>
                      <div class="stat-val mono" id="val-total-gross" style="color:var(--accent)">0 ₽</div>
                      <div class="stat-helper">Бюджеты по всем статусам</div>
                  </div>
                  <div class="stat-box" data-stat="plan" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">ПЛАН</span><span class="help-icon" data-tooltip="Сколько ещё нужно получить до достижения цели месяца.">?</span></div>
                          <div class="stat-pill">Остаток до цели</div>
                      </div>
                      <div class="stat-val text-gold mono" id="val-plan">0 ₽</div>
                      <div class="stat-helper">Осталось получить</div>
                  </div>
                  <div class="stat-box" data-stat="forecast" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">ПРОГНОЗ ИТОГА</span><span class="help-icon" data-tooltip="Оценка конца месяца: текущий факт + ожидаемые платежи по проектам.">?</span></div>
                          <div class="stat-pill">Факт + ожидаемое</div>
                      </div>
                      <div class="stat-val mono" id="val-total" style="color:var(--accent)">0 ₽</div>
                      <div class="stat-helper">Маржа: <span id="val-margin">0 ₽</span> (<span id="val-margin-prc">0%</span>)</div>
                  </div>
                  <div class="stat-box" data-stat="expenses" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">РАСХОДЫ</span><span class="help-icon" data-tooltip="Совокупные траты по всем проектам, включая архив и паузу.">?</span></div>
                          <div class="stat-pill">По всем проектам</div>
                      </div>
                      <div class="stat-val mono text-red" id="val-expenses">0 ₽</div>
                      <div class="stat-helper">Сумма затрат</div>
                  </div>
                  <div class="stat-box" data-stat="taxes" data-editable="stat">
                      <div class="stat-label-row">
                          <div class="stat-label-with-help"><span class="stat-label">НАЛОГИ</span><span class="help-icon" data-tooltip="Предварительные начисления по указанным ставкам для каждого проекта.">?</span></div>
                          <div class="stat-pill">К уплате</div>
                      </div>
                      <div class="stat-val mono" id="val-taxes">0 ₽</div>
                      <div class="stat-helper">По указанным ставкам</div>
                  </div>
              </div>
              <div style="position:relative;height:250px;width:100%"><canvas id="lineChart"></canvas></div>
          </div>
              <div class="card top-clients-card" id="top-clients-card" data-editable data-block-key="topClients">
                <div class="top-clients-header">
                  <div>
                    <div class="top-clients-title">Топ 5 клиентов</div>
                    <div class="top-clients-sub" id="top-clients-sub">Маржа по активным, архивным, на паузе и в ожидании</div>
                  </div>
                  <div class="top-clients-controls">
                    <button class="top-clients-mode-btn" id="top-clients-mode-btn" onclick="toggleTopClientsMode()" title="Переключить тип прибыли для графика">
                      <span class="top-clients-dot"></span>
                      <span id="top-clients-mode-label">Чистая прибыль</span>
                    </button>
                  </div>
                </div>
                <div class="top-clients-chart"><canvas id="topClientsChart"></canvas></div>
              </div>
          </div>

          <div class="side-stack" data-block-container="side">
              
              <div class="eff-card-modern" id="efficiency-card" data-editable data-block-key="efficiency">
                  <div class="eff-header">
                      <div class="eff-title">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                          Эффективность
                      </div>
                      <div class="help-icon" data-tooltip="Соотношение полученных денег к потенциальным.">?</div>
                  </div>
                  
                  <div class="eff-content-grid">
                      <div class="eff-chart-box">
                          <div class="eff-label">Потенциал vs Факт</div>
                          <div class="eff-chart-canvas-wrap" style="height:180px;">
                              <canvas id="pieChart"></canvas>
                          </div>
                      </div>
                      
                      <div class="eff-chart-box">
                          <div class="eff-label">Динамика (6 мес)</div>
                          <div class="eff-chart-canvas-wrap" style="height:160px;">
                              <canvas id="barChart"></canvas>
                          </div>
                      </div>
                  </div>
              </div>

              <div class="record-clean" id="record-banner" data-editable data-block-key="record">
                  <div class="rec-top-row">
                      <div class="rec-meta">
                          <span class="rec-label-sm">Заработано (Факт)</span>
                          <div class="rec-big-val" id="rec-current-fact">0 ₽</div>
                      </div>
                      <div class="rec-target-badge" title="Цель (Рекорд)">
                          <span>🏆 <span id="record-amount">0 ₽</span></span>
                          <svg class="rec-edit-icon" onclick="openRecordSettings()" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                      </div>
                  </div>
                  
                  <div class="rec-bar-area">
                      <div class="rec-track">
                          <div class="rec-fill" id="record-progress" style="width: 0%"></div>
                      </div>
                      <div class="rec-sub-text">
                          <span id="record-remaining">До рекорда: 0 ₽</span>
                          <span id="record-motiv" style="color:var(--gold);">Движемся вверх!</span>
                      </div>
                  </div>
              </div>
              
              <div class="reputation-card" id="reputation-card" data-editable data-block-key="reputation">
                  <div class="rep-header-modern">
                      <div class="rep-main-score">
                          <div class="rep-badge-large">★</div>
                          <div class="rep-header-texts">
                              <h3 id="reputation-score">100 / 100</h3>
                              <div class="rep-subtitle" id="reputation-headline">Репутация безупречна</div>
                          </div>
                      </div>
                      <div class="rep-status-badge good" id="reputation-severity">Стабильно</div>
                  </div>

                  <div class="rep-metrics-modern">
                      <div class="rep-metric-item">
                          <div class="rm-label">В работе</div>
                          <div class="rm-value" id="rep-active-count">0</div>
                          <div class="rm-sub" id="rep-on-time">Без просрочек</div>
                      </div>
                      <div class="rep-metric-item">
                          <div class="rm-label">Просрочки</div>
                          <div class="rm-value" id="rep-overdue">0</div>
                          <div class="rm-sub" id="reputation-grade">Задач нет</div>
                      </div>
                      <div class="rep-metric-item">
                          <div class="rm-label">Задержка (дни)</div>
                          <div class="rep-split-val">
                              <div class="rep-sub-item">
                                  <span class="rep-sub-val" id="rep-delay-max">0</span>
                                  <span class="rep-sub-lbl">Макс</span>
                              </div>
                              <div style="width:1px; background:var(--border);"></div>
                              <div class="rep-sub-item">
                                  <span class="rep-sub-val" id="rep-delay-avg">0</span>
                                  <span class="rep-sub-lbl">Средняя</span>
                              </div>
                          </div>
                          <div id="rep-delay" style="display:none"></div>
                      </div>
                  </div>

                  <div class="rep-body-split">
                      <div class="rep-chart-area">
                          <canvas id="reputationChart"></canvas>
                          <div class="rep-legend-row">
                              <div class="rep-legend-pill"><span class="rep-dot good"></span> <span id="rep-on-time-pill">0</span></div>
                              <div class="rep-legend-pill"><span class="rep-dot warn"></span> <span id="rep-near-pill">0</span></div>
                              <div class="rep-legend-pill"><span class="rep-dot bad"></span> <span id="rep-overdue-pill">0</span></div>
                          </div>
                          <div id="reputation-hint" style="display:none"></div>
                          <div id="reputation-detail" style="display:none"></div>
                          <div id="rep-score-label" style="display:none"></div>
                      </div>
                      <div class="rep-advice-area">
                          <div class="rep-fallout-banner" id="reputation-fallout"></div>
                          <div class="rep-advice-title">
                              <span>Что улучшить</span>
                              <span style="cursor:pointer; color:var(--accent)" onclick="openReputationTasks()">К задачам →</span>
                          </div>
                          <div id="reputation-tips"></div>
                      </div>
                  </div>
              </div>

          </div>

      </div>
    </div>
  </div>

  <footer style="text-align:center; margin-top:50px; padding-top:20px; border-top:1px solid var(--border); color:var(--muted); font-size: 14px;">
      DesignFlow Tracker by
      <a href="https://t.me/r_zhegulyaev" target="_blank" style="color:var(--accent); text-decoration:none; font-weight:600;">Zhegulyaev</a>
  </footer>
</div>

<button class="scroll-toggle" id="scrollToggle" aria-label="Прокрутить вниз"><svg><use href="#icon-arrow-down"/></svg></button>

<div class="bulk-toolbar" id="bulkToolbar" style="display: none;">
    <span style="color:var(--text); font-weight: 600;" id="bulkCount">0 выбрано</span>
    <button class="bulk-action-btn" onclick="clearSelection()">↺ Отменить выделение</button>
    <button class="bulk-action-btn" onclick="bulkDuplicate()">❐ Дублировать</button>

    <select id="bulkMoveSelect" class="bulk-move-select" onchange="askBulkMove(this.value)">
        <option value="">Перенести в...</option>
        <option value="active">В работу</option>
        <option value="waiting">Ожидает</option>
        <option value="paused">На паузе</option>
        <option value="potential">Потенциал</option>
        <option value="archive">Выполнено (Архив)</option>
    </select>
    
    <button class="bulk-action-btn delete" onclick="askBulkDelete()">× Удалить</button>
</div>

<div class="modal" id="addProjectModal">
    <div class="modal-content modal-wide">
        <span class="close-modal-x" onclick="document.getElementById('addProjectModal').style.display='none'">×</span>
        <h2 style="margin-bottom:20px; font-size: 24px;">Новый проект</h2>
        
        <div class="modal-layout-modern">

            <div>
                <div class="modal-section-title">Основное</div>
                
                <div class="form-grid-row">
                    <div class="inp-modern">
                        <label>Статус</label>
                        <select id="add-proj-type" onchange="handleStatusChange(this.value)">
                            <option value="active">В работу (Активный)</option>
                            <option value="potential">Потенциал (Лид)</option>
                            <option value="waiting">Ожидает (Материалы)</option>
                            <option value="paused">На паузе</option>
                            <option value="archive">Выполнено (Архив)</option>
                        </select>
                    </div>
                    <div class="inp-modern">
                        <label>Клиент</label>
                        <input type="text" id="add-proj-client" placeholder="Имя или Компания">
                    </div>
                </div>
                
                <div class="form-grid-row">
                    <div class="inp-modern form-grid-full" style="grid-column: 1 / -1;">
                        <label>Название проекта</label>
                        <div style="position:relative;">
                            <input type="text" id="add-proj-name" list="project-name-templates" placeholder="Например: Дизайн сайта">
                            <button type="button" class="clear-input-btn hidden" id="project-name-clear" onclick="clearProjectName()" style="top:10px; right:10px;">×</button>
                        </div>
                        <div class="template-control-group">
                            <div class="tpl-btn-chip create" onclick="saveNameTemplate()">+ В шаблоны</div>
                            <div class="tpl-btn-chip list" onclick="openTemplateManagerModal()">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                Мои шаблоны
                            </div>
                            <div class="template-helper" id="template-helper" style="margin:0; font-size:11px;"></div>
                            <datalist id="project-name-templates"></datalist>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="modal-section-title">Финансы</div>
                <div class="form-grid-row finance">
                    <div class="inp-modern">
                        <label>Сумма (₽)</label>
                        <input type="text" id="add-proj-price" placeholder="0" oninput="formatNumberInput(this)">
                    </div>
                    <div class="inp-modern">
                        <label>Оплачено</label>
                        <select id="add-proj-paid">
                            <option value="0">0%</option>
                            <option value="50" selected>50%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    <div class="inp-modern">
                        <label>Расходы</label>
                        <select id="add-proj-contractor-mode" onchange="handleNewContractorModeChange(this.value)">
                            <option value="none">Нет</option>
                            <option value="amount">Сумма (₽)</option>
                            <option value="percent">Процент (%)</option>
                        </select>
                        <div id="contractor-amount-wrap" class="is-hidden" style="margin-top:6px;">
                             <div class="input-with-suffix">
                                <input type="text" class="contractor-input" id="add-proj-contractor" placeholder="Сумма" oninput="formatNumberInput(this)">
                                <span class="input-suffix" id="contractor-suffix">₽</span>
                            </div>
                        </div>
                    </div>
                    <div class="inp-modern">
                        <label>Налог</label>
                        <select id="add-proj-tax">
                            <option value="0">0%</option>
                            <option value="4">4%</option>
                            <option value="6">6%</option>
                            <option value="13">13%</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <div class="modal-section-title">Сроки и детали</div>
                <div class="date-panel" style="display:block; padding: 16px;">
    
    <div class="date-panel-row">
        <div class="date-panel-item">
            <label>⚡ Дата старта</label>
             <div class="date-input-wrap" id="add-proj-start-display" onclick="openDateInModal('add-proj-start-val')" style="background:var(--input-bg); width:100%; height:44px;">
                <svg class="date-icon"><use href="#icon-calendar"/></svg>
                <span class="date-text-display">Сегодня</span>
             </div>
             <input type="hidden" id="add-proj-start-val" value="">
        </div>

        <div class="date-panel-item">
             <label>🏁 Дедлайн</label>
             <div class="deadline-row" style="width:100%">
                 <div class="date-input-wrap" id="add-proj-dl-display" onclick="openDateInModal('add-proj-dl-val')" style="background:var(--input-bg); width:100%; height:44px;">
                   <svg class="date-icon"><use href="#icon-calendar"/></svg>
                   <span class="date-text-display">Нет срока</span>
                </div>
                <button type="button" class="deadline-clear-btn" onclick="clearNewProjectDeadline()" title="Убрать дедлайн" style="height:44px; margin:0 0 0 6px;">
                    <svg><use href="#icon-calendar-off"/></svg>
                </button>
             </div>
            <input type="hidden" id="add-proj-dl-val" value="">
        </div>

        <div class="date-panel-item shrink">
            <label>Быстрый срок...</label>
            <select id="add-proj-dl-days" onchange="applyDeadlinePreset()" class="bulk-move-select" style="background:var(--input-bg); width:100%; height:44px; margin:0;">
                <option value="">Выбрать...</option>
                <option value="1">1 день</option>
                <option value="3">3 дня</option>
                <option value="7">Неделя</option>
                <option value="custom">Свой...</option>
            </select>
        </div>

        <div class="date-panel-item mini">
            <label>&nbsp;</label> 
            <input type="number" id="add-proj-dl-custom" placeholder="Дней" oninput="applyDeadlinePreset()" style="width: 100%; display:none; background:var(--input-bg); border:1px solid var(--border); border-radius:10px; padding:10px; height: 44px;">
        </div>
        
        <input type="time" id="add-proj-dl-time" step="300" oninput="applyDeadlinePreset()" style="display:none;">
    </div>

</div>
                <div style="margin-top: 16px;">
                    <button type="button" class="link-btn link-inline-btn" id="new-project-link-btn" onclick="openLink('new')" style="justify-content: flex-start;">
                        <svg><use href="#icon-link"/></svg>
                        <span>Ссылка на чат/материалы</span>
                    </button>
                    <div class="link-preview" id="new-project-link-preview" style="display:none; margin-top:10px;">
                        <div class="link-preview-body">
                            <div class="link-preview-head">
                                <div class="link-preview-label" id="new-project-link-label">Ссылка добавлена</div>
                                <div class="link-preview-info">
                                    <a class="link-preview-url" id="new-project-link-text" href="#" target="_blank"></a>
                                </div>
                            </div>
                            <div class="link-preview-title" id="new-project-link-title" style="display:none"></div>
                        </div>
                        <div class="link-preview-actions">
                            <button class="del-btn" type="button" onclick="clearNewProjectLink()">×</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="add-modal-actions" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
            <button class="save-stg" onclick="saveNewProject()" style="width:100%; font-size: 16px; padding: 14px;">Создать проект</button>
        </div>
    </div>
</div>

<div class="modal modal-centered" id="templateManagerModal">
    <div class="modal-content modal-wide template-manager-modal">
        <span class="close-modal-x" onclick="closeTemplateManagerModal()">×</span>
        <h3 style="margin-bottom: 8px;">Мои шаблоны</h3>
        <p class="helper-note">Перетаскивайте строки, чтобы менять порядок. Нажмите на текст, чтобы отредактировать.</p>
        <div class="template-modal-add">
            <div class="inp-group template-modal-input">
                <label>Создать шаблон</label>
                <input type="text" id="template-manager-input" placeholder="Например, Дизайн лендинга">
            </div>
            <button class="save-stg template-add-btn" type="button" onclick="addTemplateFromModal()">+ Добавить</button>
        </div>
        <div class="template-helper" id="template-manager-helper">Добавьте новый шаблон или выберите его ниже.</div>
        <div class="template-list" id="template-manager-list"></div>
    </div>
</div>

<div class="modal" id="linkModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="closeLinkModal()">×</span>
        <h3 style="margin-bottom:10px">Ссылка на чат/материалы</h3>
        <div class="inp-group">
            <input type="url" id="link-input" placeholder="https://t.me/...">
        </div>
        <label class="checkbox-wrap" style="margin-top:-5px;">
            <input type="checkbox" id="link-is-telegram">
            Открывается в Telegram (чат/канал)
        </label>
        <p class="helper-note">Если указать @username, мы уберём @ и превратим его в кликабельную ссылку.</p>
        <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" id="saveLinkBtn">Сохранить</button>
    </div>
</div>

<div class="modal" id="dateModal">
    <div class="modal-content date-modal-content">
        <span class="close-modal-x" onclick="closeDateModal()">×</span>
        <h3 style="margin-bottom: 0;" id="date-modal-title">Дата</h3>
        <p style="color:var(--muted); font-size: 13px; margin-bottom: 15px;">Изменить дату или время.</p>
        
        <label class="checkbox-wrap">
            <input type="checkbox" id="date-has-time" onchange="toggleTimeInput()"> 
            Указать точное время
        </label>
        
        <div class="date-time-inputs">
            <div class="input-with-icon">
                <svg class="input-icon"><use href="#icon-calendar"/></svg>
                <input type="text" id="date-input-val" placeholder="ДД.ММ.ГГГГ">
            </div>
            <div class="input-with-icon">
                <svg class="input-icon"><use href="#icon-clock"/></svg>
                <input type="text" id="time-input-val" placeholder="ЧЧ:ММ" disabled>
            </div>
        </div>
        <div class="deadline-presets modal-deadline-presets">
            <select id="date-modal-preset" onchange="applyDateModalPreset()">
                <option value="">Шаблон срока</option>
                <option value="1">1 день</option>
                <option value="2">2 дня</option>
                <option value="3">3 дня</option>
                <option value="5">5 дней</option>
                <option value="7">7 дней</option>
                <option value="custom">Свои дни</option>
            </select>
            <input type="number" id="date-modal-custom" placeholder="Свои дни" oninput="applyDateModalPreset()">
        </div>
        <div class="date-modal-footer">
            <button type="button" class="deadline-clear-btn" id="date-modal-clear" onclick="clearDateModalDeadline()">
                <svg><use href="#icon-calendar-off"/></svg>
                <span>Без дедлайна</span>
            </button>
            <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue);" onclick="saveDate()">Сохранить</button>
        </div>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="settings-top-bar">
            <div class="settings-top-title">Настройки DesignFlow</div>
            <span class="close-modal-x" onclick="document.getElementById('settingsModal').style.display='none'" style="position:static;">×</span>
        </div>

        <div class="settings-layout-clean">
            <div class="settings-sidebar">
                <div class="settings-nav-item active" data-target="appearance" onclick="activateSettingsPane('appearance')">🎨 Внешний вид</div>
                <div class="settings-nav-item" data-target="blocks" onclick="activateSettingsPane('blocks')">🧩 Блоки</div>
                <div class="settings-nav-item" data-target="tables" onclick="activateSettingsPane('tables')">📋 Таблицы</div>
                <div class="settings-nav-item" data-target="data" onclick="activateSettingsPane('data')">💾 Данные</div>
            </div>

            <div class="settings-body">
                
                <div class="settings-pane active" data-pane="appearance">
                    <div class="stg-card">
                        <div class="stg-card-title">Тема оформления</div>
                        <div class="stg-card-desc">Выберите тему интерфейса. Автоматический режим меняет тему в зависимости от времени суток.</div>
                        <div class="radio-grid">
                            <label class="radio-card">
                                <input type="radio" name="theme-mode" value="auto" id="theme-mode-auto">
                                <div><div class="radio-card-title">Авто</div><div class="radio-card-sub">День/Ночь</div></div>
                            </label>
                            <label class="radio-card">
                                <input type="radio" name="theme-mode" value="light" id="theme-mode-light">
                                <div><div class="radio-card-title">Светлая</div><div class="radio-card-sub">Для работы днём</div></div>
                            </label>
                            <label class="radio-card">
                                <input type="radio" name="theme-mode" value="dark" id="theme-mode-dark">
                                <div><div class="radio-card-title">Тёмная</div><div class="radio-card-sub">Для работы ночью</div></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-pane" data-pane="blocks">
                    <div class="stg-card">
                        <div class="stg-card-title">Видимость блоков</div>
                        <div class="stg-card-desc">Отключите элементы, которые вам не нужны, чтобы освободить место.</div>
                        
                        <div class="stg-row">
                            <div class="stg-info"><h4>Темп недели</h4><p>Показывает горящие дедлайны.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="block-toggle-pace"><span class="slider-clean"></span></label>
                        </div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>Эффективность</h4><p>Круговой график и динамика по месяцам.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="block-toggle-efficiency"><span class="slider-clean"></span></label>
                        </div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>Рекорд месяца</h4><p>Блок с прогресс-баром к личной цели.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="block-toggle-record"><span class="slider-clean"></span></label>
                        </div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>Репутация</h4><p>Рейтинг дедлайнов и советы.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="block-toggle-reputation"><span class="slider-clean"></span></label>
                        </div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>Топ клиентов</h4><p>График топ-5 клиентов.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="block-toggle-top-clients"><span class="slider-clean"></span></label>
                        </div>
                         <div class="stg-row">
                            <div class="stg-info"><h4>Бэкап предупреждение</h4><p>Плашка о локальном хранении.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="block-toggle-backup"><span class="slider-clean"></span></label>
                        </div>
                    </div>
                </div>

                <div class="settings-pane" data-pane="tables">
                     <div class="stg-card">
                        <div class="stg-card-title">Вкладки проектов</div>
                        <div class="stg-card-desc">Скройте разделы, которыми не пользуетесь.</div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>Заявки</h4><p>Входящие лиды.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="table-toggle-requests"><span class="slider-clean"></span></label>
                        </div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>В ожидании</h4><p>Проекты, где ждем клиента.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="table-toggle-waiting"><span class="slider-clean"></span></label>
                        </div>
                        <div class="stg-row">
                            <div class="stg-info"><h4>На паузе</h4><p>Замороженные проекты.</p></div>
                            <label class="switch-clean"><input type="checkbox" id="table-toggle-paused"><span class="slider-clean"></span></label>
                        </div>
                    </div>
                </div>

                <div class="settings-pane" data-pane="data">
                    <div class="stg-card">
                        <div class="stg-card-title">Финансовые цели</div>
                        <div class="stg-card-desc">Задайте план на этот месяц и ваш глобальный рекорд.</div>
                        <div class="stg-input-row">
                            <div class="inp-group">
                                <label>План на месяц (₽)</label>
                                <input type="text" id="stg-goal" oninput="formatNumberInput(this)">
                            </div>
                            <div class="inp-group">
                                <label>Рекорд (₽)</label>
                                <input type="text" id="stg-rec" oninput="formatNumberInput(this)">
                            </div>
                        </div>
                    </div>

                    <div class="stg-card">
                        <div class="stg-card-title">Резервное копирование</div>
                        <div class="stg-card-desc">Скачайте файл с базой, чтобы не потерять данные при очистке кэша.</div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="save-stg" onclick="exp()" style="background:var(--card-alt); border-color:var(--border); color:var(--text); width:auto;">Скачать Backup</button>
                            <button class="save-stg" onclick="document.getElementById('imp').click()" style="background:var(--card-alt); border-color:var(--border); color:var(--text); width:auto;">Загрузить Backup</button>
                            <button class="save-stg" onclick="expCSV()" style="background:var(--card-alt); border-color:var(--border); color:var(--text); width:auto;">Экспорт CSV</button>
                        </div>
                        <input type="file" id="imp" accept=".json" style="display:none" onchange="imp(this.files[0])">
                    </div>
                    
                    <div style="margin-top:20px; text-align:right;">
                         <button class="btn-ghost" type="button" onclick="resetInterface()" style="color:var(--red); border-color:var(--red);">Сброс интерфейса</button>
                    </div>
                </div>

            </div>
        </div>
        
        <div style="padding: 16px 24px; border-top:1px solid var(--border); background:var(--card); display:flex; justify-content:flex-end;">
            <button class="save-stg" style="background:var(--btn-blue); border-color:var(--btn-blue); width:auto; padding: 10px 24px;" onclick="saveSettings()">Сохранить настройки</button>
        </div>
    </div>
</div>
<div class="modal" id="deleteConfirmModal">
    <div class="modal-content">
        <span class="close-modal-x" onclick="document.getElementById('deleteConfirmModal').style.display='none'">×</span>
        <h3 style="color:var(--text); margin-bottom:10px;" id="del-modal-title">Удалить в корзину?</h3>
        <p style="color:var(--muted); margin-bottom: 20px; font-size:14px;" id="del-modal-desc">Объект будет храниться 7 дней.</p>
        <div style="display:flex;gap:15px;">
            <button onclick="document.getElementById('deleteConfirmModal').style.display='none'" style="flex:1">Отмена</button>
            <button class="confirm-del-btn" style="background:var(--red); border-color:var(--red);" id="finalDeleteBtn" style="flex:1">Удалить</button>
        </div>
    </div>
</div>

<script>
const K = 'grok_design_v5';
const THEME_KEY = 'designflow_theme';
const THEME_OVERRIDE_KEY = 'designflow_theme_override';
const NAME_TEMPLATES_KEY = 'designflow_name_templates';
const UI_PREFS_KEY = 'designflow_ui_prefs';
const STAT_KEYS = ['fact','active-fact','paid-gross','total-gross','plan','forecast','expenses','taxes'];
const SIDE_BLOCK_KEYS = ['efficiency','record','reputation'];
const LAYOUT_BLOCK_KEYS = ['topClients','efficiency','record','reputation'];
const BLOCK_CONTAINERS = ['main','side'];
const DEFAULT_BLOCK_ORDER = {
    main: ['topClients'],
    side: ['efficiency','record','reputation']
};
const DEFAULT_UI_PREFS = {
    themeMode: 'dark',
    blockVisibility: {
        backup: true,
        pace: true,
        dashboard: true,
        efficiency: true,
        topClients: true,
        record: true,
        reputation: true
    },
    blockOrder: { ...DEFAULT_BLOCK_ORDER },
    tableVisibility: {
        waiting: true,
        requests: true,
        paused: true
    },
    statVisibility: {
        goal: true,
        fact: true,
        activeFact: true,
        paidGross: true,
        totalGross: true,
        plan: true,
        forecast: true,
        expenses: true,
        taxes: true
    },
    statOrder: [...STAT_KEYS],
    sideOrder: [...SIDE_BLOCK_KEYS]
};
let UI_PREFS = JSON.parse(JSON.stringify(DEFAULT_UI_PREFS));
let autoThemeInterval = null;
const now = new Date();
const today = now.toISOString().slice(0, 10);
let currentMonth = today.slice(0,7);
let currentTab = 'active';
const TAB_DESCRIPTIONS = {
    active: "Проекты в работе. Следите за дедлайнами и фиксируйте предоплату.",
    waiting: "Ожидают реакции клиента или материалов.",
    potential: "Лиды и переговоры. Ещё не начаты.",
    requests: "Новые заявки и обращения с каналов.",
    paused: "Замороженные проекты.",
    archive: "Успешно завершенные заказы.",
    all: "Все проекты и архив в одном месте.",
    trash: "Удаленные объекты. Хранятся 7 дней."
};

const STATUS_META = {
    active: { label: 'В работе', cls: 'active' },
    waiting: { label: 'Ожидает', cls: 'waiting' },
    potential: { label: 'Потенциал', cls: 'potential' },
    paused: { label: 'На паузе', cls: 'paused' },
    archive: { label: 'Выполнено', cls: 'archive' },
};

const toNumeric = (val) => {
    const cleaned = String(val || '').replace(/\s+/g, '').replace(/,/g, '.');
    if (!cleaned) return 0;

    // Поддержка короткой записи "10k/10к" для тысяч
    const normalized = cleaned.replace(/(\d*\.?\d+)[kк]/gi, '($1*1000)');

    // Разрешаем простые математические выражения (+ - * / и скобки)
    if (/[^0-9+\-*/().]/.test(normalized)) return 0;

    try {
        const result = new Function('return ' + normalized)();
        const num = typeof result === 'number' ? result : parseFloat(result);
        return isFinite(num) ? num : 0;
    } catch {
        return 0;
    }
};

function formatPlainNumber(val) {
    const raw = String(val ?? '').replace(/\s+/g, '').trim();
    if (raw === '') return '';
    const isNegative = raw.startsWith('-');
    const normalized = raw.replace(/[^\d.,]/g, '').replace(/^-/, '');
    const [intPartRaw, fracRaw] = normalized.split(/[.,]/);
    const intPart = (intPartRaw || '0').replace(/\D/g, '');
    const formattedInt = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    const frac = fracRaw ? fracRaw.replace(/\D/g, '') : '';
    const formatted = frac ? `${formattedInt},${frac}` : formattedInt;
    return isNegative ? `-${formatted}` : formatted;
}

function getCssVar(name) {
    return getComputedStyle(document.body).getPropertyValue(name).trim();
}

function normalizeOrder(order, defaults) {
    const fallback = Array.isArray(defaults) ? defaults : [];
    const incoming = Array.isArray(order) ? order.filter(Boolean) : [];
    const seen = new Set();
    const result = [];
    [...incoming, ...fallback].forEach(key => {
        if (!key || seen.has(key)) return;
        seen.add(key);
        result.push(key);
    });
    return result;
}

function normalizeBlockOrder(orderMap, fallback = DEFAULT_BLOCK_ORDER) {
    const result = {};
    const seen = new Set();
    Object.keys(fallback).forEach(zone => result[zone] = []);
    Object.entries({ ...fallback, ...(orderMap || {}) }).forEach(([zone, list]) => {
        if (!result[zone]) result[zone] = [];
        (list || []).forEach(key => {
            if (!LAYOUT_BLOCK_KEYS.includes(key) || seen.has(key)) return;
            result[zone].push(key);
            seen.add(key);
        });
    });
    LAYOUT_BLOCK_KEYS.forEach(key => {
        if (seen.has(key)) return;
        const fallbackZone = fallback.main.includes(key) ? 'main' : fallback.side.includes(key) ? 'side' : Object.keys(fallback)[0];
        result[fallbackZone] = result[fallbackZone] || [];
        result[fallbackZone].push(key);
    });
    return result;
}

function loadUiPrefs() {
    try {
        const storedTheme = localStorage.getItem(THEME_KEY);
        let stored = JSON.parse(localStorage.getItem(UI_PREFS_KEY));
        if (!stored) {
            const snapshot = JSON.parse(localStorage.getItem(K) || 'null');
            stored = snapshot?.uiPrefs || null;
        }
        if (stored) {
            UI_PREFS = {
                ...DEFAULT_UI_PREFS,
                ...stored,
                blockVisibility: {
                    ...DEFAULT_UI_PREFS.blockVisibility,
                    ...(stored.blockVisibility || {})
                },
                tableVisibility: {
                    ...DEFAULT_UI_PREFS.tableVisibility,
                    ...(stored.tableVisibility || {})
                },
                statVisibility: {
                    ...DEFAULT_UI_PREFS.statVisibility,
                    ...(stored.statVisibility || {})
                },
                statOrder: normalizeOrder(stored.statOrder, STAT_KEYS),
                sideOrder: normalizeOrder(stored.sideOrder, SIDE_BLOCK_KEYS),
                blockOrder: normalizeBlockOrder(stored.blockOrder, DEFAULT_BLOCK_ORDER)
            };
            if (stored?.blockVisibility?.reputation === false && stored?.blockVisibility?.record === undefined) {
                UI_PREFS.blockVisibility.record = false;
            }
        } else {
            UI_PREFS = { ...DEFAULT_UI_PREFS };
            // FIX: Если тема не выбрана, ставим LIGHT по умолчанию
            if (!storedTheme) UI_PREFS.themeMode = 'light';
            else if (storedTheme === 'light' || storedTheme === 'dark') {
                UI_PREFS.themeMode = storedTheme;
            }
        }
    } catch (e) {
        console.warn('UI prefs load failed', e);
    }
    UI_PREFS.statOrder = normalizeOrder(UI_PREFS.statOrder, STAT_KEYS);
    UI_PREFS.sideOrder = normalizeOrder(UI_PREFS.sideOrder, SIDE_BLOCK_KEYS);
    UI_PREFS.blockOrder = normalizeBlockOrder(UI_PREFS.blockOrder, DEFAULT_BLOCK_ORDER);
    if (!UI_PREFS.themeMode) UI_PREFS.themeMode = 'light'; // FIX: страхуемся здесь тоже
    persistUiPrefs();
}

function persistUiPrefs() {
    localStorage.setItem(UI_PREFS_KEY, JSON.stringify(UI_PREFS));
}

function resolveTheme(mode = UI_PREFS.themeMode, { respectOverride = true } = {}) {
    if (mode === 'light' || mode === 'dark') return mode;
    if (respectOverride) {
        const override = localStorage.getItem(THEME_OVERRIDE_KEY);
        if (override === 'light' || override === 'dark') return override;
    }
    const hour = new Date().getHours();
    return hour >= 7 && hour < 20 ? 'light' : 'dark';
}

function startAutoThemeWatcher() {
    stopAutoThemeWatcher();
    autoThemeInterval = setInterval(() => applyThemeMode('auto', { silent: true, skipSave: true, respectOverride: false }), 5 * 60 * 1000);
}

function stopAutoThemeWatcher() {
    if (autoThemeInterval) {
        clearInterval(autoThemeInterval);
        autoThemeInterval = null;
    }
}

function applyTheme(theme) {
    const isLight = theme === 'light';
    document.body.classList.toggle('light', isLight);
    const icon = document.getElementById('themeToggleIcon');
    const label = document.getElementById('themeToggleLabel');
    if (icon) {
        const use = icon.querySelector('use');
        if (use) use.setAttribute('href', isLight ? '#icon-moon' : '#icon-sun');
    }
    if (label) {
        const mode = UI_PREFS.themeMode || 'dark';
        label.textContent = mode === 'auto'
            ? (isLight ? 'Авто · Светлая' : 'Авто · Тёмная')
            : (isLight ? 'Тёмная тема' : 'Светлая тема');
    }
}

function applyThemeMode(mode, { silent = false, skipSave = false, respectOverride = true, overrideTheme } = {}) {
    UI_PREFS.themeMode = mode || 'dark';
    if (UI_PREFS.themeMode !== 'auto') {
        localStorage.removeItem(THEME_OVERRIDE_KEY);
    } else {
        if (!respectOverride) localStorage.removeItem(THEME_OVERRIDE_KEY);
        if (overrideTheme === 'light' || overrideTheme === 'dark') {
            localStorage.setItem(THEME_OVERRIDE_KEY, overrideTheme);
        }
    }
    const actual = resolveTheme(UI_PREFS.themeMode, { respectOverride });
    localStorage.setItem(THEME_KEY, actual);
    if (!skipSave) persistUiPrefs();
    applyTheme(actual);
    document.querySelectorAll('input[name="theme-mode"]').forEach(r => r.checked = r.value === UI_PREFS.themeMode);
    if (UI_PREFS.themeMode === 'auto') {
        startAutoThemeWatcher();
    } else {
        stopAutoThemeWatcher();
    }
    if (!silent && typeof calcStats === 'function') {
        calcStats();
    }
}

function toggleTheme() {
    if (UI_PREFS.themeMode === 'auto') {
        const current = resolveTheme('auto');
        const nextActual = current === 'light' ? 'dark' : 'light';
        applyThemeMode('auto', { overrideTheme: nextActual });
        return;
    }
    const next = UI_PREFS.themeMode === 'light' ? 'dark' : 'light';
    applyThemeMode(next);
}

function initTheme() {
    const storedTheme = localStorage.getItem(THEME_KEY);
    if (!localStorage.getItem(UI_PREFS_KEY) && (storedTheme === 'light' || storedTheme === 'dark')) {
        UI_PREFS.themeMode = storedTheme;
    }
    applyThemeMode(UI_PREFS.themeMode || storedTheme || 'dark', { silent: true });
    if (UI_PREFS.themeMode === 'auto') startAutoThemeWatcher();
}

function applyBlockVisibility() {
    const visibility = UI_PREFS.blockVisibility || {};
    const backup = document.getElementById('backup-panel');
    const pace = document.getElementById('pace-indicator');
    const dashboard = document.getElementById('analytics-dashboard');
    const record = document.getElementById('record-banner');
    const reputation = document.getElementById('reputation-card');
    const efficiency = document.getElementById('efficiency-card');
    const topClients = document.getElementById('top-clients-card');
    const paceDetails = document.getElementById('pace-details-btn');

    if (backup) backup.classList.toggle('is-hidden', visibility.backup === false);
    if (pace) pace.classList.toggle('is-hidden', visibility.pace === false);
    if (dashboard) dashboard.classList.toggle('is-hidden', visibility.dashboard === false);
    const hideAnalytics = visibility.dashboard === false;
    if (efficiency) efficiency.classList.toggle('is-hidden', hideAnalytics || visibility.efficiency === false);
    if (topClients) topClients.classList.toggle('is-hidden', hideAnalytics || visibility.topClients === false);
    if (record) record.classList.toggle('is-hidden', hideAnalytics || visibility.record === false);
    if (reputation) reputation.classList.toggle('is-hidden', hideAnalytics || visibility.reputation === false);
    if (paceDetails) paceDetails.classList.toggle('is-hidden', visibility.reputation === false || hideAnalytics);
}

function updateSettingsPreviewStates() {
    document.querySelectorAll('.block-setting').forEach(block => {
        const toggle = block.querySelector('input[type="checkbox"]');
        const enabled = toggle ? toggle.checked !== false : true;
        block.classList.toggle('is-off', !enabled);
    });
}

function applyStatVisibility() {
    const visibility = UI_PREFS.statVisibility || {};
    document.querySelectorAll('[data-stat]').forEach(el => {
        const key = el.getAttribute('data-stat');
        const camelKey = key.replace(/-([a-z])/g, (_, ch) => ch.toUpperCase());
        const enabled = (visibility[key] ?? visibility[camelKey] ?? true) !== false;
        el.classList.toggle('is-hidden', !enabled);
    });
    const goal = document.getElementById('goal-progress');
    const goalPill = document.getElementById('goal-pill');
    if (goal) goal.classList.toggle('is-hidden', visibility.goal === false);
    if (goalPill) goalPill.classList.toggle('is-hidden', visibility.goal === false);
}

function applyStatOrder() {
    const grid = document.querySelector('.stats-grid');
    if (!grid) return;
    UI_PREFS.statOrder = normalizeOrder(UI_PREFS.statOrder, STAT_KEYS);
    const map = Object.fromEntries([...grid.children].map(el => [el.getAttribute('data-stat'), el]));
    UI_PREFS.statOrder.forEach(key => {
        if (map[key]) grid.appendChild(map[key]);
    });
}

function applyBlockOrder() {
    const containers = Object.fromEntries([...document.querySelectorAll('[data-block-container]')]
        .map(el => [el.getAttribute('data-block-container'), el]));
    UI_PREFS.blockOrder = normalizeBlockOrder(UI_PREFS.blockOrder, DEFAULT_BLOCK_ORDER);
    const lookup = Object.fromEntries([...document.querySelectorAll('[data-block-key]')]
        .map(el => [el.getAttribute('data-block-key'), el]));
    BLOCK_CONTAINERS.forEach(zone => {
        const container = containers[zone];
        if (!container) return;
        UI_PREFS.blockOrder[zone].forEach(key => {
            if (lookup[key]) {
                container.appendChild(lookup[key]);
            }
        });
    });
}

let layoutEditMode = false;
let draggingStat = null;
let draggingBlock = null;
let dragPreview = null;
let layoutEditSnapshot = null;

function createEditControls(type, key) {
    const wrap = document.createElement('div');
    wrap.className = 'edit-controls';
    const handle = document.createElement('span');
    handle.className = 'edit-handle';
    handle.innerHTML = '<svg class="btn-icon lg"><use href="#icon-grip"/></svg>';
    handle.title = 'Переместить блок';
    const remove = document.createElement('button');
    remove.type = 'button';
    remove.className = 'edit-remove';
    remove.title = 'Скрыть блок';
    remove.innerHTML = '<svg aria-hidden="true" class="btn-icon"><use href="#icon-trash"/></svg>';
    remove.onclick = (e) => {
        e.stopPropagation();
        hideEditableBlock(type, key);
    };
    wrap.appendChild(handle);
    wrap.appendChild(remove);
    return wrap;
}

function hideEditableBlock(type, key) {
    if (type === 'stat') {
        UI_PREFS.statVisibility[key] = false;
        applyStatVisibility();
    } else {
        UI_PREFS.blockVisibility[key] = false;
        applyBlockVisibility();
    }
    persistUiPrefs();
}

function setupEditableBlocks() {
    document.querySelectorAll('[data-stat]').forEach(el => {
        const key = el.getAttribute('data-stat');
        el.setAttribute('draggable', layoutEditMode ? 'true' : 'false');
        el.removeEventListener('dragstart', onStatDragStart);
        el.removeEventListener('dragover', onStatDragOver);
        el.removeEventListener('dragleave', onStatDragLeave);
        el.removeEventListener('drop', onStatDrop);
        if (layoutEditMode) {
            el.addEventListener('dragstart', onStatDragStart);
            el.addEventListener('dragover', onStatDragOver);
            el.addEventListener('dragleave', onStatDragLeave);
            el.addEventListener('drop', onStatDrop);
        }
        if (!el.dataset.controlsReady) {
            const controls = createEditControls('stat', key);
            el.appendChild(controls);
            const hint = document.createElement('div');
            hint.className = 'edit-hint';
            hint.textContent = 'Тяни, чтобы переставить';
            el.appendChild(hint);
            el.dataset.controlsReady = '1';
        }
    });

    document.querySelectorAll('[data-block-key]').forEach(el => {
        const key = el.getAttribute('data-block-key');
        el.dataset.editable = el.dataset.editable || 'block';
        const canDragBlock = LAYOUT_BLOCK_KEYS.includes(key);
        el.setAttribute('draggable', layoutEditMode && canDragBlock ? 'true' : 'false');
        const handle = el.querySelector('.edit-handle');
        if (handle) handle.style.display = canDragBlock && layoutEditMode ? 'inline-flex' : 'none';
        el.removeEventListener('dragstart', onBlockDragStart);
        el.removeEventListener('dragend', onBlockDragEnd);
        el.removeEventListener('dragover', onBlockDragOverBlock);
        el.removeEventListener('dragleave', onBlockDragLeaveBlock);
        el.removeEventListener('drop', onBlockDropOnBlock);
        if (!el.dataset.controlsReady) {
            const controls = createEditControls('block', key);
            el.appendChild(controls);
            el.dataset.controlsReady = '1';
        }
        if (layoutEditMode && canDragBlock) {
            el.addEventListener('dragstart', onBlockDragStart);
            el.addEventListener('dragend', onBlockDragEnd);
            el.addEventListener('dragover', onBlockDragOverBlock);
            el.addEventListener('dragleave', onBlockDragLeaveBlock);
            el.addEventListener('drop', onBlockDropOnBlock);
        }
    });

    document.querySelectorAll('[data-block-container]').forEach(container => {
        container.removeEventListener('dragover', onBlockDragOverContainer);
        container.removeEventListener('dragleave', onBlockDragLeaveContainer);
        container.removeEventListener('drop', onBlockDropOnContainer);
        if (layoutEditMode) {
            container.addEventListener('dragover', onBlockDragOverContainer);
            container.addEventListener('dragleave', onBlockDragLeaveContainer);
            container.addEventListener('drop', onBlockDropOnContainer);
        }
    });

    document.body.classList.toggle('layout-edit', layoutEditMode);
    updateLayoutEditButton();
}

function onStatDragStart(e) {
    if (!layoutEditMode) return e.preventDefault();
    draggingStat = e.currentTarget.getAttribute('data-stat');
    e.dataTransfer.effectAllowed = 'move';
}

function onStatDragOver(e) {
    if (!layoutEditMode || !draggingStat) return;
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function onStatDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function onStatDrop(e) {
    if (!layoutEditMode || !draggingStat) return;
    e.preventDefault();
    const targetKey = e.currentTarget.getAttribute('data-stat');
    e.currentTarget.classList.remove('drag-over');
    if (draggingStat === targetKey) return;
    const order = normalizeOrder(UI_PREFS.statOrder, STAT_KEYS);
    const fromIdx = order.indexOf(draggingStat);
    const toIdx = order.indexOf(targetKey);
    if (fromIdx === -1 || toIdx === -1) return;
    order.splice(fromIdx, 1);
    order.splice(toIdx, 0, draggingStat);
    UI_PREFS.statOrder = order;
    applyStatOrder();
    persistUiPrefs();
}

function getBlockContainerKey(el) {
    const container = el ? el.closest('[data-block-container]') : null;
    return container ? container.getAttribute('data-block-container') : null;
}

function createDragPreview(el) {
    const clone = el.cloneNode(true);
    clone.querySelectorAll('.edit-controls, .edit-hint').forEach(n => n.remove());
    const rect = el.getBoundingClientRect();
    clone.style.width = `${rect.width}px`;
    clone.style.maxWidth = `${rect.width}px`;
    clone.style.height = `${Math.min(rect.height, 260)}px`;
    clone.style.maxHeight = `${Math.min(rect.height, 260)}px`;
    clone.style.margin = '0';
    clone.style.overflow = 'hidden';
    clone.style.borderRadius = '14px';
    clone.classList.add('drag-ghost');
    document.body.appendChild(clone);
    return clone;
}

function clearBlockDragState() {
    document.querySelectorAll('.drag-over, .block-drop-target').forEach(el => {
        el.classList.remove('drag-over');
        el.classList.remove('block-drop-target');
    });
    if (dragPreview?.parentNode) dragPreview.remove();
    if (draggingBlock?.el) draggingBlock.el.classList.remove('dragging');
    draggingBlock = null;
    dragPreview = null;
}

function onBlockDragStart(e) {
    if (!layoutEditMode) return e.preventDefault();
    const block = e.currentTarget;
    const key = block.getAttribute('data-block-key');
    draggingBlock = { key, el: block, from: getBlockContainerKey(block) };
    block.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', key);
    dragPreview = createDragPreview(block);
    e.dataTransfer.setDragImage(dragPreview, dragPreview.offsetWidth / 2, dragPreview.offsetHeight / 2);
}

function onBlockDragEnd() {
    clearBlockDragState();
}

function onBlockDragOverBlock(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function onBlockDragLeaveBlock(e) {
    e.currentTarget.classList.remove('drag-over');
}

function onBlockDragOverContainer(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    e.currentTarget.classList.add('block-drop-target');
}

function onBlockDragLeaveContainer(e) {
    e.currentTarget.classList.remove('block-drop-target');
}

function moveBlockTo(zone, beforeKey = null) {
    if (!draggingBlock || !zone || !BLOCK_CONTAINERS.includes(zone)) return;
    const key = draggingBlock.key;
    const order = normalizeBlockOrder(UI_PREFS.blockOrder, DEFAULT_BLOCK_ORDER);
    Object.keys(order).forEach(k => {
        order[k] = order[k].filter(item => item !== key);
    });
    order[zone] = order[zone] || [];
    if (beforeKey && order[zone].includes(beforeKey)) {
        const idx = order[zone].indexOf(beforeKey);
        order[zone].splice(idx, 0, key);
    } else {
        order[zone].push(key);
    }
    UI_PREFS.blockOrder = normalizeBlockOrder(order, DEFAULT_BLOCK_ORDER);
    applyBlockOrder();
    persistUiPrefs();
}

function onBlockDropOnBlock(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    const target = e.currentTarget;
    const targetKey = target.getAttribute('data-block-key');
    const zone = getBlockContainerKey(target);
    target.classList.remove('drag-over');
    if (zone && draggingBlock.key !== targetKey) {
        moveBlockTo(zone, targetKey);
    }
    clearBlockDragState();
}

function onBlockDropOnContainer(e) {
    if (!layoutEditMode || !draggingBlock) return;
    e.preventDefault();
    const zone = e.currentTarget.getAttribute('data-block-container');
    e.currentTarget.classList.remove('block-drop-target');
    if (zone) moveBlockTo(zone, null);
    clearBlockDragState();
}

function toggleLayoutEditMode() {
    layoutEditMode = !layoutEditMode;
    layoutEditSnapshot = layoutEditMode ? JSON.parse(JSON.stringify(UI_PREFS)) : null;
    setupEditableBlocks();
    if (!layoutEditMode) {
        clearBlockDragState();
    }
}

function updateLayoutEditButton() {
    const iconUse = document.querySelector('#layoutEditIcon use');
    const label = document.getElementById('layoutEditLabel');
    const cancelBtn = document.getElementById('layoutEditCancel');
    if (iconUse) iconUse.setAttribute('href', layoutEditMode ? '#icon-check' : '#icon-pen');
    if (label) label.textContent = layoutEditMode ? 'Готово' : 'Редактировать блоки';
    if (cancelBtn) cancelBtn.style.display = layoutEditMode ? 'flex' : 'none';
}

function cancelLayoutEditMode() {
    if (!layoutEditMode) return;
    if (layoutEditSnapshot) {
        UI_PREFS = JSON.parse(JSON.stringify(layoutEditSnapshot));
        persistUiPrefs();
        applyBlockOrder();
        applyBlockVisibility();
        applyTableVisibility();
        applyStatOrder();
        applyStatVisibility();
    }
    layoutEditMode = false;
    clearBlockDragState();
    setupEditableBlocks();
    layoutEditSnapshot = null;
}

function activateSettingsPane(pane) {
    document.querySelectorAll('.settings-nav-btn').forEach(btn => {
        const target = btn.getAttribute('data-target');
        btn.classList.toggle('active', target === pane);
    });
    document.querySelectorAll('.settings-pane').forEach(p => {
        const target = p.getAttribute('data-pane');
        p.classList.toggle('active', target === pane);
    });
}

function isTableEnabled(key) {
    const visibility = UI_PREFS.tableVisibility || {};
    return visibility[key] !== false;
}

function getEnabledTabs() {
    return ['all','active','waiting','potential','requests','paused','archive','trash'].filter(tab => {
        if (['waiting','requests','paused'].includes(tab)) return isTableEnabled(tab);
        return true;
    });
}

function applyTableVisibility() {
    ['waiting','requests','paused'].forEach(key => {
        const tabEl = document.getElementById(`tab-${key}`);
        const viewEl = document.getElementById(`view-${key}`);
        const enabled = isTableEnabled(key);
        if (tabEl) tabEl.classList.toggle('is-hidden', !enabled);
        if (viewEl) viewEl.style.display = enabled ? (currentTab === key ? 'block' : 'none') : 'none';
    });
    updateBulkMoveOptions();
    const available = getEnabledTabs();
    if (!available.includes(currentTab) && available.length) {
        const fallback = available.includes('active') ? 'active' : available[0];
        if (fallback !== currentTab) switchTab(fallback);
    }
}

function updateBulkMoveOptions() {
    const select = document.getElementById('bulkMoveSelect');
    if (!select) return;
    const visibility = UI_PREFS.tableVisibility || {};
    Array.from(select.options).forEach(opt => {
        if (['waiting','paused','requests'].includes(opt.value)) {
            const enabled = visibility[opt.value] !== false;
            opt.hidden = !enabled;
        }
    });
    if (select.selectedOptions.length && select.selectedOptions[0].hidden) {
        select.value = '';
    }
}

function toggleScrollDirection() {
    const btn = document.getElementById('scrollToggle');
    if (!btn) return;
    const dir = btn.dataset.dir || 'down';
    if (dir === 'down') {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function updateScrollToggle() {
    const btn = document.getElementById('scrollToggle');
    if (!btn) return;
    const nearTop = window.scrollY < 120;
    const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 160;
    const iconId = nearTop ? '#icon-arrow-down' : '#icon-arrow-up';
    btn.innerHTML = `<svg><use href="${iconId}"/></svg>`;
    btn.dataset.dir = nearTop ? 'down' : 'up';
    btn.setAttribute('aria-label', nearTop ? 'Прокрутить вниз' : 'Вернуться наверх');
    btn.style.display = nearTop && nearBottom ? 'none' : 'grid';
}

function formatNumberInput(inputEl) {
    if (!inputEl) return;

    // Инициализация состояния для таймера калькулятора
    if (!inputEl.__calcState) {
        inputEl.__calcState = { timeout: null };

        const applyCalculation = () => {
            const raw = String(inputEl.value || '').replace(/\s+/g, '').replace(/,/g, '.');
            if (!raw || /[^0-9+\-*/().kк]/i.test(raw)) return;
            const result = toNumeric(raw);
            if (result !== undefined && isFinite(result)) {
                inputEl.value = formatPlainNumber(result);
            }
        };

        inputEl.addEventListener('blur', applyCalculation);
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                applyCalculation();
                inputEl.blur();
            }
        });
    }

    const val = String(inputEl.value || '');
    const state = inputEl.__calcState;

    // Если пользователь вводит выражение, оставляем операторы и считаем позже
    if (/[+\-*/]/.test(val)) {
        const cleaned = val.replace(/[^0-9+\-*/().,kк]/gi, '');
        inputEl.value = cleaned;
        clearTimeout(state.timeout);
        state.timeout = setTimeout(() => {
            if (document.activeElement === inputEl) return;
            state.timeout = null;
            inputEl.dispatchEvent(new Event('blur'));
        }, 1000);
        return;
    }

    const numeric = toNumeric(val.replace(/\s+/g, '').replace(/,/g, '.'));
    inputEl.value = val ? formatPlainNumber(numeric) : '';
}

const DEFAULT_NAME_TEMPLATES = [
    'Оформление группы ВКонтакте',
    'Дизайн баннеров',
    'Дизайн карточки ВБ',
    'Дизайн логотипа',
    'Дизайн лендинга'
];
const TEMPLATE_HELPER_DEFAULT = 'Введите название проекта, затем сохраните как шаблон.';

let NAME_TEMPLATES = [...DEFAULT_NAME_TEMPLATES];
let draggedTemplate = null;
let draggedTemplateIndex = null;
let activeTemplateSelection = '';

function loadNameTemplates() {
    try {
        const raw = localStorage.getItem(NAME_TEMPLATES_KEY);
        if (raw) {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) NAME_TEMPLATES = parsed;
        }
    } catch(e) { console.warn('Template load failed', e); }
    refreshTemplateSelects();
}

function refreshTemplateSelects() {
    const list = document.getElementById('project-name-templates');
    if (!list) return;
    list.innerHTML = NAME_TEMPLATES.map(t=>`<option value="${t}">`).join('');
    renderTemplatePills();
    renderTemplateManagerList();
}

function persistNameTemplates() {
    localStorage.setItem(NAME_TEMPLATES_KEY, JSON.stringify(NAME_TEMPLATES.slice(0, 20)));
    save();
}

function setTemplateHelper(message, state = '', autoReset = false) {
    const helper = document.getElementById('template-helper');
    if (!helper) return;
    if (templateHelperTimeout) { clearTimeout(templateHelperTimeout); templateHelperTimeout = null; }
    helper.textContent = message;
    helper.classList.remove('error', 'success');
    if (state) helper.classList.add(state);
    if (autoReset) {
        templateHelperTimeout = setTimeout(() => {
            helper.textContent = TEMPLATE_HELPER_DEFAULT;
            helper.classList.remove('error', 'success');
        }, 3200);
    }
}

function setTemplateManagerHelper(message, state = '') {
    const helper = document.getElementById('template-manager-helper');
    if (!helper) return;
    helper.textContent = message;
    helper.classList.remove('error', 'success');
    if (state) helper.classList.add(state);
}

function renderTemplatePills() {
    const pills = document.getElementById('saved-template-pills');
    if (!pills) return;
    if (!NAME_TEMPLATES.length) {
        pills.innerHTML = '<span style="color: var(--muted);">Шаблонов пока нет</span>';
        pills.classList.remove('can-scroll', 'scrolled', 'scroll-end');
        return;
    }
    pills.innerHTML = NAME_TEMPLATES.map(t => {
        const safe = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const safeArg = t.replace(/'/g,"\\'");
        return `
        <span class="template-pill" draggable="true"
            ondragstart="onTemplateDragStart('${safeArg}')"
            ondragover="onTemplateDragOver(event, '${safeArg}')"
            ondragleave="onTemplateDragLeave(event)"
            ondrop="onTemplateDrop(event, '${safeArg}')"
            ondragend="onTemplateDragEnd()">
            <button class="template-fill-btn" type="button" onclick="applyNameTemplate('${safeArg}')">${safe}</button>
            <button aria-label="Удалить шаблон" class="template-delete-btn" onclick="deleteNameTemplate('${safeArg}')">×</button>
        </span>`;
    }).join('');
    attachTemplateScrollHandler(pills);
    updateTemplateScrollState(pills);
}

function renderTemplateManagerList() {
    const list = document.getElementById('template-manager-list');
    if (!list) return;
    if (!NAME_TEMPLATES.length) {
        list.innerHTML = '<div class="template-empty">Шаблонов пока нет. Создайте первый через кнопку «Создать шаблон».</div>';
        return;
    }
    const currentName = (document.getElementById('add-proj-name')?.value || '').trim();
    list.innerHTML = NAME_TEMPLATES.map((t, idx) => {
        const safe = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        const safeArg = t.replace(/'/g,"\\'");
        const isSelected = currentName === t || activeTemplateSelection === t;
        const rowClass = isSelected ? 'template-row selected' : 'template-row';
        const selectBtnClass = isSelected ? 'template-select-btn is-active' : 'template-select-btn';
        return `
        <div class="${rowClass}" draggable="true"
            ondragstart="templateRowDragStart(${idx})"
            ondragover="templateRowDragOver(event, ${idx})"
            ondragleave="templateRowDragLeave(event)"
            ondrop="templateRowDrop(event, ${idx})"
            ondragend="templateRowDragEnd()">
            <span class="template-drag-handle">≡</span>
            <button class="${selectBtnClass}" type="button" onclick="selectTemplateFromManager('${safeArg}')">✓</button>
            <input type="text" value="${safe}" onblur="commitTemplateEdit(${idx}, this)" aria-label="Название шаблона">
            <button aria-label="Удалить шаблон" class="template-delete-btn" onclick="deleteNameTemplate('${safeArg}')">×</button>
        </div>`;
    }).join('');
}

function toggleProjectNameClear() {
    const input = document.getElementById('add-proj-name');
    const btn = document.getElementById('project-name-clear');
    if (!input || !btn) return;
    const hasValue = !!input.value.trim();
    btn.classList.toggle('hidden', !hasValue);
}

function clearProjectName() {
    const input = document.getElementById('add-proj-name');
    if (!input) return;
    input.value = '';
    toggleProjectNameClear();
    input.focus();
}

function applyNameTemplate(val) {
    if (!val) return;
    const input = document.getElementById('add-proj-name');
    if (input) {
        input.value = val;
        input.focus();
        toggleProjectNameClear();
        activeTemplateSelection = val;
        setTemplateHelper('Шаблон подставлен в поле.', 'success', true);
    }
}

function saveNameTemplate() {
    const input = document.getElementById('add-proj-name');
    if (!input) return;
    const val = input.value.trim();
    if (!val) {
        input.classList.add('input-error');
        setTemplateHelper('Введите название, чтобы сохранить шаблон.', 'error');
        input.focus();
        return;
    }
    if (!NAME_TEMPLATES.includes(val)) {
        NAME_TEMPLATES.unshift(val);
        persistNameTemplates();
        refreshTemplateSelects();
        showToast('Шаблон сохранен');
        setTemplateHelper('Шаблон сохранен и добавлен в список.', 'success', true);
        setTemplateManagerHelper('Шаблон добавлен в список.', 'success');
    } else {
        setTemplateHelper('Такой шаблон уже есть в списке.', '');
    }
}

function addTemplateFromModal() {
    const input = document.getElementById('template-manager-input');
    if (!input) return;
    const val = input.value.trim();
    if (!val) {
        setTemplateManagerHelper('Введите название, чтобы сохранить шаблон.', 'error');
        input.focus();
        return;
    }
    if (!NAME_TEMPLATES.includes(val)) {
        NAME_TEMPLATES.unshift(val);
        persistNameTemplates();
        refreshTemplateSelects();
        setTemplateManagerHelper('Шаблон сохранен и добавлен в список.', 'success');
    } else {
        setTemplateManagerHelper('Такой шаблон уже есть в списке.', 'error');
    }
    applyNameTemplate(val);
    renderTemplateManagerList();
    input.value = '';
}

function deleteNameTemplate(val) {
    NAME_TEMPLATES = NAME_TEMPLATES.filter(t => t !== val);
    if (activeTemplateSelection === val) activeTemplateSelection = '';
    persistNameTemplates();
    refreshTemplateSelects();
}

function onTemplateDragStart(val) {
    draggedTemplate = val;
}

function onTemplateDragOver(event, targetVal) {
    event.preventDefault();
    if (!draggedTemplate || draggedTemplate === targetVal) return;
    event.currentTarget.classList.add('drag-over');
}

function onTemplateDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

function onTemplateDrop(event, targetVal) {
    event.preventDefault();
    const fromIdx = NAME_TEMPLATES.indexOf(draggedTemplate);
    const toIdx = NAME_TEMPLATES.indexOf(targetVal);
    if (fromIdx === -1 || toIdx === -1 || fromIdx === toIdx) return;
    NAME_TEMPLATES.splice(fromIdx, 1);
    NAME_TEMPLATES.splice(toIdx, 0, draggedTemplate);
    persistNameTemplates();
    refreshTemplateSelects();
}

function onTemplateDragEnd() {
    draggedTemplate = null;
    document.querySelectorAll('.template-pill.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function templateRowDragStart(idx) {
    draggedTemplateIndex = idx;
}

function templateRowDragOver(event, idx) {
    if (draggedTemplateIndex === null || draggedTemplateIndex === idx) return;
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function templateRowDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

function templateRowDrop(event, idx) {
    event.preventDefault();
    if (draggedTemplateIndex === null || draggedTemplateIndex === idx) return;
    const [moved] = NAME_TEMPLATES.splice(draggedTemplateIndex, 1);
    NAME_TEMPLATES.splice(idx, 0, moved);
    draggedTemplateIndex = null;
    persistNameTemplates();
    refreshTemplateSelects();
    renderTemplateManagerList();
}

function templateRowDragEnd() {
    draggedTemplateIndex = null;
    document.querySelectorAll('.template-row.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function commitTemplateEdit(idx, inputEl) {
    if (!inputEl || idx < 0 || idx >= NAME_TEMPLATES.length) return;
    const val = inputEl.value.trim();
    if (!val) {
        inputEl.value = NAME_TEMPLATES[idx];
        return;
    }
    const duplicateIdx = NAME_TEMPLATES.findIndex((t, i) => t === val && i !== idx);
    if (duplicateIdx !== -1) {
        inputEl.value = NAME_TEMPLATES[idx];
        setTemplateHelper('Такой шаблон уже есть в списке.', '');
        return;
    }
    NAME_TEMPLATES[idx] = val;
    persistNameTemplates();
    refreshTemplateSelects();
    renderTemplateManagerList();
}

function openTemplateManagerModal() {
    const modal = document.getElementById('templateManagerModal');
    if (!modal) return;
    modal.style.display = 'flex';
    const inlineInput = document.getElementById('add-proj-name');
    const modalInput = document.getElementById('template-manager-input');
    if (modalInput && inlineInput) modalInput.value = inlineInput.value.trim();
    setTemplateManagerHelper('Добавьте новый шаблон или выберите его ниже.');
    renderTemplateManagerList();
}

function closeTemplateManagerModal() {
    document.getElementById('templateManagerModal').style.display = 'none';
}

function selectTemplateFromManager(val) {
    applyNameTemplate(val);
    closeTemplateManagerModal();
    renderTemplateManagerList();
    setTemplateManagerHelper('Шаблон выбран.', 'success');
}

function attachTemplateScrollHandler(pills) {
    if (!pills || pills.dataset.scrollBound) return;
    const handler = () => updateTemplateScrollState(pills);
    pills.addEventListener('scroll', handler, { passive: true });
    window.addEventListener('resize', handler);
    pills.dataset.scrollBound = '1';
}

function updateTemplateScrollState(pills) {
    if (!pills) return;
    const hasOverflow = pills.scrollWidth > pills.clientWidth + 2;
    const atStart = pills.scrollLeft <= 4;
    const atEnd = pills.scrollLeft + pills.clientWidth >= pills.scrollWidth - 4;
    pills.classList.toggle('can-scroll', hasOverflow);
    pills.classList.toggle('scrolled', hasOverflow && !atStart);
    pills.classList.toggle('scroll-end', hasOverflow && atEnd);
}

function handleNewContractorModeChange(mode) {
    const input = document.getElementById('add-proj-contractor');
    const helper = document.getElementById('add-contractor-helper');
    const wrapper = document.getElementById('contractor-amount-wrap');
    const suffix = document.getElementById('contractor-suffix');
    if (!input || !helper || !wrapper || !suffix) return;
    const showInput = mode !== 'none';
    wrapper.classList.toggle('is-hidden', !showInput);
    input.disabled = !showInput;
    if (!showInput) {
        input.value = '';
        suffix.textContent = '';
        helper.textContent = 'Выберите тип расходов, чтобы добавить сумму.';
        return;
    }
    const isPercent = mode === 'percent';
    helper.textContent = isPercent
        ? 'Укажите процент расходов от общей суммы.'
        : 'Укажите фиксированную сумму расходов.';
    input.placeholder = isPercent ? 'Например, 20' : 'Например, 30 000';
    suffix.textContent = isPercent ? '%' : '₽';
    input.focus();
}

let DATA = {
    settings: { record: 0 },
    monthlyGoals: { [currentMonth]: 250000 },
    active: [], archive: [], paused: [], waiting: [], potential: [], requests: [], trash: []
};

let SORT = { active: 'dl', archive: 'date', potential: 'p', waiting: 'p', paused: 'dl', requests: 'created' };
let queue = { type: null, idx: null, field: null, targetId: null };
let previousDeadlineValue = '';
let deadlineUnset = false;
let editContext = null;
let toastTimeout = null;
let templateHelperTimeout = null;
let lastPermanentDeletion = null;
let newProjectLink = '';
let newProjectLinkTitle = '';
let lastFetchedLinkForTitle = '';
let datePicker = null;
let timePicker = null;

function buildBackupSnapshot() {
    return {
        version: 2,
        data: DATA,
        uiPrefs: UI_PREFS,
        nameTemplates: NAME_TEMPLATES,
        theme: UI_PREFS.themeMode
    };
}

function showToast(message, actionText = '', actionHandler = null, duration = 3500) {
    const toast = document.getElementById('toast');
    const msgEl = document.getElementById('toast-message');
    const actionBtn = document.getElementById('toast-action');

    msgEl.textContent = message;

    if (actionText && actionHandler) {
        actionBtn.textContent = actionText;
        actionBtn.style.display = 'inline-flex';
        actionBtn.onclick = () => { actionHandler(); hideToast(); };
    } else {
        actionBtn.style.display = 'none';
        actionBtn.onclick = null;
    }

    toast.classList.add('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => hideToast(), duration);
}

function hideToast() {
    const toast = document.getElementById('toast');
    toast.classList.remove('show');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = null;
}

function undoPermanentDelete() {
    if (!lastPermanentDeletion || !Array.isArray(lastPermanentDeletion.items)) return;

    const { type, items } = lastPermanentDeletion;
    const targetList = DATA[type];
    if (!Array.isArray(targetList)) return;

    items
        .slice()
        .sort((a, b) => a.index - b.index)
        .forEach(({ item, index }) => {
            targetList.splice(index, 0, item);
        });

    lastPermanentDeletion = null;
    save();
    upd();
    showToast('Удаление отменено');
}

// --- BULK ACTIONS ---
let selectedRows = {}; // {active: Set(), waiting: Set(), ...}

function renderLinkControls(item, idx, type) {
    const hasLink = !!item.link;
    const editBtn = `<button class="link-btn ${hasLink ? 'link-btn-active' : ''}" onclick="openLink('${type}',${idx})" title="${hasLink ? 'Изменить ссылку' : 'Добавить ссылку'}"><svg><use href="#icon-link"/></svg></button>`;
    const goBtn = hasLink ? `<button class="link-btn link-btn-go" onclick="openProjectLink(${idx}, '${type}')" title="Открыть ссылку"><svg><use href="#icon-external"/></svg></button>` : '';
    return editBtn + goBtn;
}

function normalizeLinkValue(raw, isTelegram = false) {
    let url = (raw || '').trim();
    const isTg = isTelegram || url.startsWith('@') || url.match(/t\.me\//);

    if (isTg) {
        url = url.replace(/^https?:\/\/t\.me\//, '').replace(/^@+/, '');
        return url ? `https://t.me/${url}` : '';
    }

    if (url && !url.match(/^(https?:\/\/|mailto:)/)) {
        url = 'https://' + url;
    }

    return url;
}

function getClientNameClass(item) {
    return `client-name${item.link ? ' has-link' : ''}`;
}

function toggleSelect(type, idx, checkbox) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    const indexStr = idx.toString();
    const row = checkbox.closest('tr');

    if (checkbox.checked) {
        selectedRows[type].add(indexStr);
        if (row) row.classList.add('row-selected');
    } else {
        selectedRows[type].delete(indexStr);
        if (row) row.classList.remove('row-selected');
    }
    updateBulkToolbar(type);
    
    const allChecked = selectedRows[type].size === DATA[type].length && DATA[type].length > 0;
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if(selectAllCheckbox) selectAllCheckbox.checked = allChecked;
}

function toggleSelectAll(type) {
    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (!selectAllCheckbox) return;

    const isChecked = selectAllCheckbox.checked;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);
    
    if (!selectedRows[type]) selectedRows[type] = new Set();
    
    checkboxes.forEach((cb, i) => {
        cb.checked = isChecked;
        const row = cb.closest('tr');
        if (row && row.dataset.index) {
            const indexStr = row.dataset.index;
            row.classList.toggle('row-selected', isChecked);
            if (isChecked) {
                selectedRows[type].add(indexStr);
            } else {
                selectedRows[type].delete(indexStr);
            }
        }
    });
    updateBulkToolbar(type);
}

function toggleFooterSelection(type) {
    if (type !== 'all' && !DATA[type]) return;
    const rows = document.querySelectorAll(`#t-${type} tbody tr`);
    const totalRows = rows.length;
    if (!selectedRows[type]) selectedRows[type] = new Set();
    if (totalRows === 0) { clearSelection(type); return; }

    const shouldSelectAll = selectedRows[type].size !== totalRows;
    const checkboxes = document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`);

    if (checkboxes.length > 0) {
        checkboxes.forEach(cb => {
            cb.checked = shouldSelectAll;
            const row = cb.closest('tr');
            if (row && row.dataset.index) {
                const indexStr = row.dataset.index;
                row.classList.toggle('row-selected', shouldSelectAll);
                if (shouldSelectAll) {
                    selectedRows[type].add(indexStr);
                } else {
                    selectedRows[type].delete(indexStr);
                }
            }
        });
    } else {
        rows.forEach(row => {
            const indexStr = row.dataset.index;
            row.classList.toggle('row-selected', shouldSelectAll);
            if (indexStr) {
                if (shouldSelectAll) {
                    selectedRows[type].add(indexStr);
                } else {
                    selectedRows[type].delete(indexStr);
                }
            }
        });
    }

    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (selectAllCheckbox) selectAllCheckbox.checked = shouldSelectAll;
    updateBulkToolbar(type);
}

function updateBulkToolbar(type) {
    if (type === 'all') {
        const toolbar = document.getElementById('bulkToolbar');
        if (toolbar) toolbar.style.display = 'none';
        return;
    }
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    const toolbar = document.getElementById('bulkToolbar');
    
    document.getElementById('bulkCount').textContent = `${count} выбрано`;
    document.getElementById('bulkMoveSelect').value = ''; 

    toolbar.style.display = count > 0 ? 'flex' : 'none';
}

function attachRowSelection(tr, type, idx, checkboxId) {
    tr.addEventListener('click', (e) => {
        if (e.target.closest('input, select, button, .action-btn-base, .del-btn, .date-input-wrap, .dup-icon, [contenteditable], .trash-action-btns, .link-btn, .inline-link-btn')) return;
        const checkbox = document.getElementById(checkboxId);
        if (!checkbox) return;
        checkbox.checked = !checkbox.checked;
        toggleSelect(type, idx, checkbox);
    });
}

function clearSelection(type = currentTab) {
    if (!selectedRows[type]) selectedRows[type] = new Set();
    selectedRows[type].clear();

    document.querySelectorAll(`#t-${type} tbody .bulk-checkbox`).forEach(cb => cb.checked = false);
    document.querySelectorAll(`#t-${type} tbody tr`).forEach(tr => tr.classList.remove('row-selected'));

    const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    updateBulkToolbar(type);
}

function askBulkDelete(type = currentTab) {
    const count = selectedRows[type] ? selectedRows[type].size : 0;
    if (count === 0) return;

    const isTrash = type === 'trash';
    document.getElementById('del-modal-title').innerText = isTrash ? `Удалить ${count} элементов навсегда?` : `Удалить ${count} элементов в корзину?`;
    document.getElementById('del-modal-desc').innerText = isTrash ? "Элементы будут удалены безвозвратно." : "Объекты будут храниться 7 дней.";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = isTrash ? 'Удалить навсегда' : 'Удалить';
    document.getElementById('finalDeleteBtn').onclick = () => bulkDelete(type, isTrash);
}

function bulkDelete(type = currentTab, deleteForever = false) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;

    const indicesToDelete = Array.from(selectedRows[type])
        .map(Number)
        .sort((a, b) => b - a);

    const deletedItems = [];

    indicesToDelete.forEach(idx => {
        const itemIndex = DATA[type].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[type].splice(itemIndex, 1)[0];
            if (deleteForever) {
                deletedItems.push({ item, index: itemIndex });
            } else {
                item.deletedAt = Date.now();
                DATA.trash.unshift(item);
            }
        }
    });

    lastPermanentDeletion = deleteForever ? { type, items: deletedItems } : null;

    selectedRows[type].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    save(); upd();
    if (deleteForever) {
        showToast('Удалено навсегда', 'Отмена', undoPermanentDelete);
    } else {
        showToast(`Перемещено в корзину: ${indicesToDelete.length}`, 'Перейти', () => switchTab('trash'));
    }
}

function bulkDuplicate(type = currentTab) {
    if (!selectedRows[type] || selectedRows[type].size === 0) return;
    
    const indicesToDuplicate = Array.from(selectedRows[type])
        .map(Number)
        .sort((a, b) => a - b);
    
    const newItems = [];
    
    indicesToDuplicate.forEach(idx => {
        const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
        if(item) {
             item.n = item.n + " (Копия)";
             newItems.push(item);
        }
    });
    
    DATA[type].unshift(...newItems);
    selectedRows[type].clear();
    save(); upd();
}

function askBulkMove(targetType) {
    const currentType = currentTab;
    const count = selectedRows[currentType] ? selectedRows[currentType].size : 0;
    
    if (count === 0 || !targetType) {
        document.getElementById('bulkMoveSelect').value = '';
        return;
    }
    
    const targetName = document.querySelector(`#bulkMoveSelect option[value="${targetType}"]`).text;
    
    document.getElementById('del-modal-title').innerText = `Перенести ${count} элементов в "${targetName}"?`;
    document.getElementById('del-modal-desc').innerText = `Проекты будут перемещены из раздела "${document.getElementById(`tab-${currentType}`).textContent.trim()}".`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--accent)';
    document.getElementById('finalDeleteBtn').innerText = 'Перенести';
    
    document.getElementById('finalDeleteBtn').onclick = () => bulkMove(currentType, targetType);
}

function bulkMove(from, to) {
    if (!selectedRows[from] || selectedRows[from].size === 0) return;

    const indicesToMove = Array.from(selectedRows[from])
        .map(Number)
        .sort((a, b) => b - a);
    
    indicesToMove.forEach(idx => {
        const itemIndex = DATA[from].findIndex((_, i) => i === idx);
        if (itemIndex > -1) {
            const item = DATA[from].splice(itemIndex, 1)[0];
            if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
            if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
            if(to === 'potential' || to === 'waiting' || to === 'paused') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
            DATA[to].unshift(item);
        }
    });
    
    selectedRows[from].clear();
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.getElementById('bulkMoveSelect').value = '';
    save(); 
    if(from === to) {
        upd();
    } else {
        switchTab(to);
    }
}

function init(){
    let exist = localStorage.getItem(K);
    if(!exist) { const v4 = localStorage.getItem('grok_design_v4'); if(v4) exist = v4; }

    if (exist) {
        try {
            const parsed = JSON.parse(exist);
            const payload = parsed?.data ? parsed : { data: parsed };
            DATA = { ...DATA, ...(payload.data || {}) };
            if(!DATA.trash) DATA.trash = [];
            if(!DATA.requests) DATA.requests = [];
            ['active', 'archive', 'paused', 'waiting', 'potential'].forEach(type => {
                 DATA[type].forEach(i => {
                    if(i.contractor === undefined) i.contractor = 0;
                    if(i.taxPrc === undefined) i.taxPrc = 0;
                    if(!i.contractorMode) i.contractorMode = i.contractor ? 'amount' : 'none';
                 });
            });
            if (payload.uiPrefs) {
                localStorage.setItem(UI_PREFS_KEY, JSON.stringify(payload.uiPrefs));
            }
            if (Array.isArray(payload.nameTemplates)) {
                NAME_TEMPLATES = payload.nameTemplates;
                localStorage.setItem(NAME_TEMPLATES_KEY, JSON.stringify(NAME_TEMPLATES));
            }
            if (!payload.uiPrefs && payload.theme) {
                const themed = { ...UI_PREFS, themeMode: payload.theme };
                localStorage.setItem(UI_PREFS_KEY, JSON.stringify(themed));
            }
        } catch(e) { console.error("Data load error", e); }
    }

    loadUiPrefs();
    initTheme();
    loadNameTemplates();
    setTemplateHelper(TEMPLATE_HELPER_DEFAULT);
    const nameInput = document.getElementById('add-proj-name');
    if (nameInput) {
        nameInput.addEventListener('input', () => {
            nameInput.classList.remove('input-error');
            setTemplateHelper(TEMPLATE_HELPER_DEFAULT);
            toggleProjectNameClear();
        });
        toggleProjectNameClear();
    }
    cleanupTrash();
    applyBlockVisibility();
    updateSettingsPreviewStates();
    applyStatVisibility();
    applyStatOrder();
    applyBlockOrder();
    applyTableVisibility();
    setupEditableBlocks();
    renderMonthSelect();
    setupModalsBackgroundCheck();
    setupDatePickers();
    document.getElementById('saveLinkBtn').onclick = saveLink;
    document.getElementById('add-proj-start-val').value = today;
    document.getElementById('add-proj-dl-val').value = '';
    sortData('active', 'dl', 'date', true);
    ['active','waiting','potential','paused','archive'].forEach(t => {
        DATA[t].sortDirection = DATA[t].sortDirection || 1;
        updateSortIndicators(t);
    });
    const scrollBtn = document.getElementById('scrollToggle');
    if (scrollBtn) scrollBtn.addEventListener('click', toggleScrollDirection);
    updateScrollToggle();
    window.addEventListener('scroll', updateScrollToggle);
    window.addEventListener('resize', updateScrollToggle);
    upd();
}

function save(){
    persistUiPrefs();
    localStorage.setItem(K, JSON.stringify(buildBackupSnapshot()));
}

function cleanupTrash(){
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    const nowMs = Date.now();
    const initLen = DATA.trash.length;
    DATA.trash = DATA.trash.filter(i => (nowMs - (i.deletedAt || 0)) < sevenDays);
    if(DATA.trash.length !== initLen) save();
}

function formatCurrency(n) { return new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ₽'; }

function formatDateDisplay(str) {
    if (!str || str.startsWith('0000')) return '—';
    const hasTime = str.includes('T') && str.length > 10;
    const dateObj = new Date(str.replace(' ', 'T'));
    if(isNaN(dateObj.getTime())) return '—';
    const d = dateObj.toLocaleDateString('ru', { day: 'numeric', month: 'short' }).replace('.', '');
    if(hasTime) {
        const t = dateObj.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
        return `${d} <span class="time-text">${t}</span>`;
    }
    return d;
}

function formatDeadlineDisplay(str) {
    if (!str) return '<span class="deadline-infinity">∞ Нет срока</span>';
    const dateObj = new Date(str.replace(' ', 'T'));
    if (isNaN(dateObj.getTime())) return '—';
    const delta = formatDeadlineDelta(dateObj);
    const dateText = formatDateDisplay(str);
    if (!delta) return dateText;
    const overdue = dateObj.getTime() < Date.now();
    return `<div class="deadline-display"><span class="date-text">${dateText}</span><span class="deadline-delta ${overdue ? 'overdue' : ''}">${delta}</span></div>`;
}

function formatDeadlineDelta(dateObj) {
    if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return '';
    const now = new Date();
    let diffMs = dateObj.getTime() - now.getTime();
    const overdue = diffMs < 0;
    diffMs = Math.abs(diffMs);

    const days = Math.floor(diffMs / (24 * 60 * 60 * 1000));
    const hours = Math.floor((diffMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));

    if (!days && !hours) return overdue ? 'просрочено' : 'сегодня';

    const parts = [];
    if (days) parts.push(`${days} д`);
    if (hours) parts.push(`${hours} ч`);

    const sign = overdue ? '−' : '';
    return `${sign}${parts.join(' ')}`.trim();
}

function formatDateWithTime(dateObj, timeStr) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    const base = `${y}-${m}-${d}`;
    return timeStr ? `${base}T${timeStr}` : base;
}

function calcContractorAmount(item) {
    const gross = toNumeric(item.p);
    const mode = item.contractorMode || 'amount';
    const raw = toNumeric(item.contractor);
    if (mode === 'none') return 0;
    return mode === 'percent' ? gross * (raw / 100) : raw;
}

function calcNet(item){
    const gross = toNumeric(item.p);
    const contr = calcContractorAmount(item);
    const tax = toNumeric(item.taxPrc);
    const taxAmt = gross * (tax / 100);
    return Math.round(gross - taxAmt - contr);
}

function calcGross(item) {
    return toNumeric(item.p);
}
function calcMarginPrc(item) {
    const gross = toNumeric(item.p);
    if (gross === 0) return 0;
    const net = calcNet(item);
    return Math.round((net / gross) * 100);
}

function setupModalsBackgroundCheck() {
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
}

function switchTab(t){
    const enabledTabs = getEnabledTabs();
    if (!enabledTabs.includes(t)) {
        const fallback = enabledTabs.includes('active') ? 'active' : enabledTabs[0];
        if (fallback && fallback !== t) {
            return switchTab(fallback);
        }
        return;
    }
    currentTab = t;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${t}`).classList.add('active');
    ['active','waiting','potential','requests','paused','archive','all','trash'].forEach(k => {
        const el = document.getElementById(`view-${k}`);
        if(el) el.style.display = (k === t) ? 'block' : 'none';
        const cb = document.getElementById(`selectAll${k.charAt(0).toUpperCase() + k.slice(1)}`);
        if(cb) cb.checked = false;
        if(selectedRows[k]) selectedRows[k].clear();
    });

    const desc = document.getElementById('tab-description');
    desc.innerHTML = getTabSummary(t, TAB_DESCRIPTIONS[t]);
    const dashboard = document.querySelector('.dashboard');
    if (dashboard) dashboard.style.display = t === 'trash' ? 'none' : 'block';
    updateSortIndicators(t);
    updateBulkToolbar(t);
    upd();
}

function getTabSummary(type, baseText) {
    if (type === 'trash') {
        return `${baseText} · Статистика скрыта в корзине.`;
    }
    return baseText;
}

function updateTabCounts() {
    const counts = {
        active: DATA.active.length,
        waiting: DATA.waiting.length,
        potential: DATA.potential.length,
        requests: DATA.requests.length,
        paused: DATA.paused.length,
        archive: DATA.archive.length,
        all: DATA.active.length + DATA.waiting.length + DATA.potential.length + DATA.paused.length + DATA.archive.length,
        trash: DATA.trash.length
    };
    Object.entries(counts).forEach(([key, val]) => {
        const el = document.getElementById(`count-${key}`);
        if (el) el.innerText = val;
    });
}

function sortData(type, key, dataType, initial = false) {
    if (!DATA[type]) return;
    let direction = 1;
    if (SORT[type] === key && !initial) {
        direction = DATA[type].sortDirection === 1 ? -1 : 1; 
    }
    DATA[type].sort((a, b) => {
        let va = a[key], vb = b[key];
        if (type === 'active' && (key === 'dl' || initial)) {
             const remA = getTimeRemaining(a.dl).days || Infinity;
             const remB = getTimeRemaining(b.dl).days || Infinity;
             if (remA !== remB) return direction * (remA - remB);
        }
        if (dataType === 'date') return direction * (new Date((va || '9999').replace(' ', 'T')) - new Date((vb || '9999').replace(' ', 'T')));
        if (dataType === 'number') return direction * (toNumeric(va) - toNumeric(vb));
        return direction * String(va).localeCompare(String(vb));
    });
    DATA[type].sortDirection = direction;
    SORT[type] = key;
    save();
    updateSortIndicators(type);
    if(!initial) upd();
}

function updateSortIndicators(type) {
    const activeKey = SORT[type];
    const dir = DATA[type].sortDirection || 1;
    document.querySelectorAll(`th[data-type="${type}"]`).forEach(th => th.classList.remove('sorted', 'asc', 'desc'));
    const activeTh = document.querySelector(`th[data-type="${type}"][data-key="${activeKey}"]`);
    if (activeTh) {
        activeTh.classList.add('sorted');
        activeTh.classList.add(dir === 1 ? 'asc' : 'desc');
    }
}

function upd(){
    renderActive();
    renderSimple('waiting');
    renderSimple('paused');
    renderPotential();
    renderRequests();
    renderArchive();
    renderAll();
    renderTrash();
    calcStats();
    const desc = document.getElementById('tab-description');
    if (desc) desc.innerHTML = getTabSummary(currentTab, TAB_DESCRIPTIONS[currentTab]);
    updateBulkToolbar(currentTab);
    updateTabCounts();
}

function renderActive(){
    const tbody = document.querySelector('#t-active tbody');
    tbody.innerHTML = '';
    let totalP = 0, totalPr = 0, totalContr = 0, totalTax = 0, totalPaidGross = 0;
    
    DATA.active.forEach((item, i) => {
        item.pr = calcNet(item);
        const gross = toNumeric(item.p);
        totalP += gross; totalPr += item.pr || 0;
        const contractorAmount = calcContractorAmount(item);
        totalContr += contractorAmount;
        totalTax += gross * ((toNumeric(item.taxPrc) || 0) / 100);

        const rem = getTimeRemaining(item.dl);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.active?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');

        const linkIcon = renderLinkControls(item, i, 'active');
        const paidAmount = Math.round(gross * ((toNumeric(item.paid) || 0) / 100));
        totalPaidGross += paidAmount;
        const contractorMode = item.contractorMode || 'none';
        const contractorSymbol = contractorMode === 'percent' ? '%' : contractorMode === 'none' ? '' : '₽';
        const contractorSymbolClass = contractorSymbol ? '' : 'symbol-empty';
        const contractorValue = contractorMode === 'none' ? '' : formatPlainNumber(item.contractor ?? 0);
        const contractorHelper = contractorMode === 'none' ? 'Расходы не учитываются' : `≈ ${formatCurrency(contractorAmount)}`;
        const actionButtons = [
            `<div class="done-btn action-btn-base" onclick="mv(${i},'active','archive')" title="Выполнено"><svg class="btn-icon"><use href="#icon-check"/></svg></div>`
        ];
        actionButtons.push(`<div class="edit-active-btn action-btn-base" onclick="startProjectEdit('active',${i})" title="Редактировать"><svg class="btn-icon"><use href="#icon-pen"/></svg></div>`);
        if (isTableEnabled('waiting')) actionButtons.push(`<div class="wait-active-btn action-btn-base" onclick="mv(${i},'active','waiting')" title="В ожидании"><svg class="btn-icon"><use href="#icon-waiting"/></svg></div>`);

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('active',${i})" title="Дублировать"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-active-${i}" onchange="toggleSelect('active', ${i}, this)" ${selectedRows.active?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-active-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('active',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('active',${i},'n',this.innerText)">${item.n}</span>
            </td>
            
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('active',${i},'start')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.start)}</span></div></td>
            <td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('active',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDeadlineDisplay(item.dl)}</span></div></td>
            
            <td class="mono"><div class="${rem.cls}">${rem.txt}</div></td>
            
            <td><select class="tax-select" onchange="updVal('active',${i},'taxPrc',this.value)">
                <option value="0" ${+item.taxPrc===0?'selected':''}>0%</option>
                <option value="4" ${+item.taxPrc===4?'selected':''}>4%</option>
                <option value="6" ${+item.taxPrc===6?'selected':''}>6%</option>
                <option value="13" ${+item.taxPrc===13?'selected':''}>13%</option>
            </select></td>
            
            <td style="text-align:right;">
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${contractorValue}" ${contractorMode === 'none' ? 'disabled' : ''} oninput="formatNumberInput(this)" onblur="updateContractorValue('active',${i},this.value)">
                    <span class="currency-symbol ${contractorSymbolClass}">${contractorSymbol || 'нет'}</span>
                    <select class="expense-mode" onchange="updateContractorMode('active',${i},this.value)">
                        <option value="none" ${contractorMode==='none'?'selected':''}>Нет</option>
                        <option value="amount" ${contractorMode==='amount'?'selected':''}>₽</option>
                        <option value="percent" ${contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">${contractorHelper}</div>
            </td>

            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('active',${i},'p',this.value)"><span class="currency-symbol">₽</span></div></td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            
            <td class="paid-cell">
                <select class="paid-select" onchange="updVal('active',${i},'paid',this.value)">
                    <option value="0" ${+item.paid===0?'selected':''}>0%</option>
                    <option value="50" ${+item.paid===50?'selected':''}>50%</option>
                    <option value="100" ${+item.paid===100?'selected':''}>100%</option>
                </select>
                <div class="paid-amount">${formatCurrency(paidAmount)}</div>
            </td>
            
            <td><div class="action-btns">
                ${actionButtons.join('')}
                <button class="del-btn" onclick="askDel('active',${i})" title="Удалить" aria-label="Удалить в корзину">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'active', i, `check-active-${i}`);
        tbody.appendChild(tr);
    });
    
    const footer = document.querySelector('#total-row-active');
    const repState = analyzeReputation();
    footer.innerHTML = `<tr>
        <td colspan="6" class="footer-total-toggle" onclick="toggleFooterSelection('active')">Всего ${DATA.active.length} проектов</td>
        <td style="text-align:right;">
            <div class="footer-note">Налоги</div>
            <div>${formatCurrency(totalTax)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">Расходы</div>
            <div>${formatCurrency(totalContr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">Сумма</div>
            <div>${formatCurrency(totalP)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">Чистыми</div>
            <div>${formatCurrency(totalPr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">Оплачено</div>
            <div>${formatCurrency(totalPaidGross)}</div>
        </td>
        <td></td>
    </tr>`;

    updatePaceReputation(repState);

    const paceBlock = document.getElementById('pace-indicator');
    const urgent = DATA.active.filter(x => getTimeRemaining(x.dl).cls.includes('critical')).length;
    
    if (currentTab === 'active') {
        if (urgent > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.add('critical');
            document.getElementById('pace-icon').innerHTML = '🔥';
            document.getElementById('pace-title').innerText = 'Нужно ускориться!';
            document.getElementById('pace-desc').innerText = `Горит дедлайнов: ${urgent}. Поднажми, чтобы успеть!`;
            document.getElementById('pace-status').className='pace-status pace-hurry'; 
            document.getElementById('pace-status').innerText='Критично';
        } else if (DATA.active.length > 0) {
            paceBlock.style.display = 'flex';
            paceBlock.classList.remove('critical');
            document.getElementById('pace-icon').innerHTML = '🚦';
            document.getElementById('pace-title').innerText = 'Анализ';
            document.getElementById('pace-desc').innerText = `Все спокойно.`;
            document.getElementById('pace-status').className='pace-status pace-chill'; 
            document.getElementById('pace-status').innerText='Норма';
        } else {
            paceBlock.style.display = 'none';
        }
    } else {
        paceBlock.style.display = 'none';
    }
}

function renderSimple(type){
    const tbody = document.querySelector(`#t-${type} tbody`);
    tbody.innerHTML = '';
    let tot = 0;
    const hasDeadline = type !== 'waiting';
    DATA[type].forEach((item, i) => {
        tot += toNumeric(item.p);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows[type]?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');

        const linkIcon = renderLinkControls(item, i, type);
        const rem = hasDeadline ? getTimeRemaining(item.dl) : null;
        const deadlineText = hasDeadline ? formatDeadlineDisplay(item.dl) : '';
        const remSuffix = hasDeadline && rem && !rem.isInfinite ? ` (${rem.txt})` : '';

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('${type}',${i})" title="Дублировать"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-${type}-${i}" onchange="toggleSelect('${type}', ${i}, this)" ${selectedRows[type]?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-${type}-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('${type}',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('${type}',${i},'n',this.innerText)">${item.n}</span>
            </td>
            ${hasDeadline ? `<td class="date-cell"><div class="date-input-wrap ${rem.cls}" onclick="openDate('${type}',${i},'dl')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${deadlineText}${remSuffix}</span></div></td>` : ''}
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('${type}',${i},'p',this.value)"><span class="currency-symbol">₽</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" onclick="startProjectEdit('${type}',${i})" title="Редактировать"><svg class="btn-icon"><use href="#icon-pen"/></svg></div>
                <div class="action-btn-base" onclick="mv(${i},'${type}','active')" title="В работу"><svg class="btn-icon"><use href="#icon-arrow-right"/></svg></div>
                <button class="del-btn" onclick="askDel('${type}',${i})" aria-label="Удалить в корзину">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, type, i, `check-${type}-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector(`#total-row-${type}`);
    footer.innerHTML = `<tr>
        <td colspan="${hasDeadline ? 4 : 3}" class="footer-total-toggle" onclick="toggleFooterSelection('${type}')">Всего ${DATA[type].length} проектов</td>
        <td>
            <div class="footer-note">Сумма</div>
            <div>${formatCurrency(tot)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderPotential(){
    const tbody = document.querySelector('#t-potential tbody');
    tbody.innerHTML = '';
    let tot = 0;
    DATA.potential.forEach((item, i) => {
        tot += toNumeric(item.p);
        const tr = document.createElement('tr');
        tr.dataset.index = i;

        const isSelected = selectedRows.potential?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        
        const linkIcon = renderLinkControls(item, i, 'potential');
                                      
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('potential',${i})" title="Дублировать"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-potential-${i}" onchange="toggleSelect('potential', ${i}, this)" ${selectedRows.potential?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-potential-${i}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('potential',${i},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('potential',${i},'n',this.innerText)">${item.n}</span>
            </td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('potential',${i},'p',this.value)"><span class="currency-symbol">₽</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" onclick="startProjectEdit('potential',${i})" title="Редактировать"><svg class="btn-icon"><use href="#icon-pen"/></svg></div>
                <div class="done-btn action-btn-base" onclick="mv(${i},'potential','active')" title="В работу"><svg class="btn-icon"><use href="#icon-arrow-right"/></svg><span class="btn-label">В работу</span></div>
                <button class="del-btn" onclick="askDel('potential',${i})" aria-label="Удалить в корзину">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'potential', i, `check-potential-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-potential');
    footer.innerHTML = `<tr>
        <td colspan="3" class="footer-total-toggle" onclick="toggleFooterSelection('potential')">Всего ${DATA.potential.length} лидов</td>
        <td>
            <div class="footer-note">Сумма</div>
            <div>${formatCurrency(tot)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderRequests(){
    const tbody = document.querySelector('#t-requests tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    let total = 0;
    DATA.requests.forEach((item, i) => {
        const budget = toNumeric(item.budget);
        total += budget;
        const tr = document.createElement('tr');
        const linkBtns = renderLinkControls(item, i, 'requests');
        tr.innerHTML = `
            <td class="select-col"><div class="row-index">${i + 1}</div></td>
            <td><span contenteditable onblur="updateRequestField(${i},'name',this.innerText)">${item.name || '—'}</span></td>
            <td><span contenteditable onblur="updateRequestField(${i},'source',this.innerText)">${item.source || '—'}</span></td>
            <td><span contenteditable onblur="updateRequestField(${i},'note',this.innerText)">${item.note || '—'}</span></td>
            <td><div class="trash-action-btns">${linkBtns}</div></td>
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(budget)}" oninput="formatNumberInput(this)" onblur="updateRequestField(${i},'budget',this.value)"><span class="currency-symbol">₽</span></div></td>
            <td>
                <div class="trash-action-btns">
                    <div class="restore-trash-btn" onclick="convertRequestToPotential(${i})">В потенциал</div>
                    <div class="delete-forever-text" onclick="deleteRequest(${i})" title="Удалить">Удалить</div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-requests');
    if (footer) {
        footer.innerHTML = `<tr><td colspan="5" class="footer-total-toggle">Всего ${DATA.requests.length} заявок</td><td style="text-align:right;">${formatCurrency(total)}</td><td></td></tr>`;
    }
}

function addRequest() {
    const name = document.getElementById('req-name').value.trim();
    const source = document.getElementById('req-source').value.trim();
    const note = document.getElementById('req-note').value.trim();
    const link = document.getElementById('req-link').value.trim();
    const budget = toNumeric(document.getElementById('req-budget').value);
    if (!name && !note) return;
    DATA.requests.unshift({ name, source, note, link: normalizeLinkValue(link), budget, created: new Date().toISOString() });
    ['req-name','req-source','req-note','req-link','req-budget'].forEach(id => document.getElementById(id).value = '');
    save(); upd();
    showToast('Заявка добавлена');
}

function updateRequestField(idx, key, val) {
    if (!DATA.requests[idx]) return;
    DATA.requests[idx][key] = key === 'budget'
        ? toNumeric(val)
        : key === 'link'
            ? normalizeLinkValue(val)
            : val;
    save(); upd();
}

function deleteRequest(idx) {
    DATA.requests.splice(idx, 1);
    save(); upd();
}

function convertRequestToPotential(idx) {
    const req = DATA.requests.splice(idx, 1)[0];
    if (!req) return;
    DATA.potential.unshift({ n: req.note || req.name || 'Новый лид', c: req.name || '—', p: req.budget || 0, contractor: 0, contractorMode: 'none', taxPrc: 0, paid: 0, link: req.link || '' });
    save();
    showToast('Перенесено в потенциал');
    switchTab('potential');
}

function renderArchive(){
    const tbody = document.querySelector('#t-archive tbody');
    tbody.innerHTML = '';
    let tP = 0, tPr = 0, tContr = 0, tTax = 0;
    const visibleItems = getArchiveByMonth();
    visibleItems.forEach((item, i) => {
        const realIdx = DATA.archive.indexOf(item);
        item.pr = calcNet(item);
        tP += toNumeric(item.p); tPr += +item.pr || 0;
        const contractorAmount = calcContractorAmount(item);
        tContr += contractorAmount;
        tTax += toNumeric(item.p) * ((toNumeric(item.taxPrc) || 0) / 100);
        const tr = document.createElement('tr');
        tr.dataset.index = realIdx;

        const isSelected = selectedRows.archive?.has(realIdx.toString());
        if (isSelected) tr.classList.add('row-selected');
        
        const linkIcon = renderLinkControls(item, realIdx, 'archive');

        const contractorMode = item.contractorMode || 'none';
        const contractorSymbol = contractorMode === 'percent' ? '%' : contractorMode === 'none' ? '' : '₽';
        const contractorSymbolClass = contractorSymbol ? '' : 'symbol-empty';
        const contractorValue = contractorMode === 'none' ? '' : formatPlainNumber(item.contractor ?? 0);
        const contractorHelper = contractorMode === 'none' ? 'Расходы не учитываются' : `≈ ${formatCurrency(contractorAmount)}`;

        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('archive',${realIdx})" title="Дублировать"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-archive-${realIdx}" onchange="toggleSelect('archive', ${realIdx}, this)" ${selectedRows.archive?.has(realIdx.toString()) ? 'checked' : ''}>
                    <label for="check-archive-${realIdx}" style="display:none;"></label>
                </div>
            </td>
            <td><div class="client-wrap">
                <span contenteditable onblur="updVal('archive',${realIdx},'c',this.innerText)" class="${getClientNameClass(item)}">${item.c}</span>
                ${linkIcon}
            </div></td>
            <td class="project-name-wrap">
                <span class="project-name" contenteditable onblur="updVal('archive',${realIdx},'n',this.innerText)">${item.n}</span>
            </td>
            <td class="date-cell"><div class="date-input-wrap" onclick="openDate('archive',${realIdx},'date')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${formatDateDisplay(item.date)}</span></div></td>
            <td><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(item.p || 0)}" oninput="formatNumberInput(this)" onblur="updVal('archive',${realIdx},'p',this.value)"><span class="currency-symbol">₽</span></div></td>
            <td>
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${contractorValue}" ${contractorMode === 'none' ? 'disabled' : ''} oninput="formatNumberInput(this)" onblur="updateContractorValue('archive',${realIdx},this.value)">
                    <span class="currency-symbol ${contractorSymbolClass}">${contractorSymbol || 'нет'}</span>
                    <select class="expense-mode" onchange="updateContractorMode('archive',${realIdx},this.value)">
                        <option value="none" ${contractorMode==='none'?'selected':''}>Нет</option>
                        <option value="amount" ${contractorMode==='amount'?'selected':''}>₽</option>
                        <option value="percent" ${contractorMode==='percent'?'selected':''}>%</option>
                    </select>
                </div>
                <div class="expense-helper">${contractorHelper}</div>
            </td>
            <td><div class="net-display-wrap">${formatCurrency(item.pr)}<span class="net-prc-val">(${calcMarginPrc(item)}%)</span></div></td>
            <td><div class="action-btns" style="justify-content:flex-end">
                <div class="action-btn-base" title="Вернуть" onclick="mv(${realIdx},'archive','active')">
                    <svg style="width:16px;height:16px;"><use href="#icon-undo"/></svg>
                </div>
                <button class="del-btn" onclick="askDel('archive',${realIdx})" aria-label="Удалить в корзину">
                    <svg><use href="#icon-trash"/></svg>
                </button>
            </div></td>
        `;
        attachRowSelection(tr, 'archive', realIdx, `check-archive-${realIdx}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#total-row-archive');
    footer.innerHTML = `<tr>
        <td colspan="4" class="footer-total-toggle" onclick="toggleFooterSelection('archive')">Всего ${visibleItems.length} проектов</td>
        <td style="text-align:right;">
            <div class="footer-note">Сумма</div>
            <div>${formatCurrency(tP)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">Расходы</div>
            <div>${formatCurrency(tContr)}</div>
        </td>
        <td style="text-align:right;">
            <div class="footer-note">Чистыми</div>
            <div>${formatCurrency(tPr)}</div>
            <div class="footer-note">Налоги: ${formatCurrency(tTax)}</div>
        </td>
        <td></td>
    </tr>`;
}

function renderAll(){
    const tbody = document.querySelector('#t-all tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const allItems = [];
    ['active','waiting','paused'].forEach(type => {
        DATA[type].forEach((item, idx) => allItems.push({ item, __type: type, idx }));
    });
    getArchiveByMonth().forEach(item => allItems.push({ item, __type: 'archive', idx: DATA.archive.indexOf(item) }));

    let totalGross = 0, totalNet = 0, totalExp = 0, totalTax = 0;

    allItems.forEach((wrap, i) => {
        const item = wrap.item;
        const status = STATUS_META[wrap.__type] || { label: wrap.__type, cls: '' };
        const contractorAmount = calcContractorAmount(item);
        const net = calcNet(item);
        const gross = toNumeric(item.p);
        const taxAmount = gross * ((toNumeric(item.taxPrc) || 0) / 100);
        totalGross += gross;
        totalNet += net;
        totalExp += contractorAmount;
        totalTax += taxAmount;

        const tr = document.createElement('tr');
        const deadlineValue = wrap.__type === 'archive' ? item.date : (item.dl || item.date || item.start);
        const dateField = wrap.__type === 'archive' ? 'date' : 'dl';
        const rem = wrap.__type === 'archive' ? { cls: '', txt: '' } : getTimeRemaining(deadlineValue);
        const remText = wrap.__type === 'archive' || (rem && rem.isInfinite) ? '' : ` (${rem.txt})`;
        const dateDisplay = wrap.__type === 'archive'
            ? (deadlineValue ? formatDateDisplay(deadlineValue) : '—')
            : formatDeadlineDisplay(deadlineValue);
        const dateCls = wrap.__type === 'archive' ? '' : rem.cls;
        const linkIcon = renderLinkControls(item, wrap.idx, wrap.__type);

        const contractorMode = item.contractorMode || 'none';
        const contractorSymbol = contractorMode === 'percent' ? '%' : contractorMode === 'none' ? '' : '₽';
        const contractorSymbolClass = contractorSymbol ? '' : 'symbol-empty';
        const contractorValue = contractorMode === 'none' ? '' : formatPlainNumber(item.contractor ?? 0);
        const contractorHelper = contractorMode === 'none' ? 'Расходы не учитываются' : `≈ ${formatCurrency(contractorAmount)}`;

        tr.innerHTML = `
            <td class="select-col"><div class="row-index">${i + 1}</div></td>
            <td><span class="status-pill ${status.cls}">${status.label}</span></td>
            <td><div class="client-wrap">${item.c || '—'}${linkIcon}</div></td>
            <td class="project-name-wrap">${item.n || '—'}</td>
            <td class="date-cell"><div class="date-input-wrap ${dateCls}" onclick="openDate('${wrap.__type}',${wrap.idx},'${dateField}')"><svg class="date-icon"><use href="#icon-calendar"/></svg><span class="date-text-display">${dateDisplay}${remText}</span></div></td>
            <td style="text-align:right;"><div class="price-cell-wrap"><input type="text" value="${formatPlainNumber(gross)}" oninput="formatNumberInput(this)" onblur="updVal('${wrap.__type}',${wrap.idx},'p',this.value)"><span class="currency-symbol">₽</span></div></td>
            <td style="text-align:right;">
                <div class="price-cell-wrap expense-cell">
                    <input type="text" value="${contractorValue}" ${contractorMode === 'none' ? 'disabled' : ''} oninput="formatNumberInput(this)" onblur="updateContractorValue('${wrap.__type}',${wrap.idx},this.value)">
                    <span class="currency-symbol ${contractorSymbolClass}">${contractorSymbol || 'нет'}</span>
                </div>
                <div class="expense-helper">${contractorHelper}</div>
            </td>
            <td style="text-align:right;">${item.taxPrc || 0}%</td>
            <td style="text-align:right;"><div class="net-display-wrap">${formatCurrency(net)}</div></td>
        `;
        tbody.appendChild(tr);
    });

    const footer = document.querySelector('#total-row-all');
    if (footer) {
        footer.innerHTML = `<tr>
            <td colspan="5" class="footer-total-toggle" onclick="toggleFooterSelection('all')">Всего ${allItems.length} проектов</td>
            <td style="text-align:right;">
                <div class="footer-note">Сумма</div>
                <div>${formatCurrency(totalGross)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">Расходы</div>
                <div>${formatCurrency(totalExp)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">Налоги</div>
                <div>${formatCurrency(totalTax)}</div>
            </td>
            <td style="text-align:right;">
                <div class="footer-note">Чистыми</div>
                <div>${formatCurrency(totalNet)}</div>
            </td>
        </tr>`;
    }
}

function formatTrashExpire(item) {
    const fallback = { text: 'Будет удалено в течение часа', tone: 'danger' };
    if (!item.deletedAt) return fallback;
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    const expiresAt = new Date(item.deletedAt + sevenDays);
    const remainingMs = expiresAt - Date.now();
    if (remainingMs <= 0) return fallback;
    const days = Math.floor(remainingMs / (24 * 60 * 60 * 1000));
    const hours = Math.ceil((remainingMs % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
    const plural = (n, one, few, many) => {
        const mod10 = n % 10, mod100 = n % 100;
        if (mod10 === 1 && mod100 !== 11) return one;
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return few;
        return many;
    };
    const relative = days > 0
        ? `Будет удалено через ${days} ${plural(days, 'день', 'дня', 'дней')}`
        : `Будет удалено через ${Math.max(hours, 1)} ${plural(Math.max(hours, 1), 'час', 'часа', 'часов')}`;
    const tone = remainingMs <= 24 * 60 * 60 * 1000 ? 'danger' : remainingMs <= 3 * 24 * 60 * 60 * 1000 ? 'warn' : 'neutral';
    return { text: relative, tone };
}

function formatTrashDate(ts) {
    if (!ts) return '?';
    const d = new Date(ts);
    const day = d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' }).replace('.', '');
    const time = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', hour12: false });
    return `${day}, ${time}`;
}

function renderTrash(){
    const tbody = document.querySelector('#t-trash tbody');
    tbody.innerHTML = '';
    DATA.trash.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.classList.add('trash-row');
        tr.dataset.index = i;

        const isSelected = selectedRows.trash?.has(i.toString());
        if (isSelected) tr.classList.add('row-selected');
        const delDate = formatTrashDate(item.deletedAt);
        const expireInfo = formatTrashExpire(item);
        tr.innerHTML = `
            <td class="select-col">
                <div class="row-index">${i + 1}</div>
                <div class="row-controls">
                    <svg class="dup-icon" onclick="duplicateRow('trash',${i})" title="Дублировать"><use href="#icon-duplicate"/></svg>
                    <input type="checkbox" class="bulk-checkbox" id="check-trash-${i}" onchange="toggleSelect('trash', ${i}, this)" ${selectedRows.trash?.has(i.toString()) ? 'checked' : ''}>
                    <label for="check-trash-${i}" style="display:none;"></label>
                </div>
            </td>
            <td class="trash-date-cell">
                <div class="trash-deleted-label">Удалено: ${delDate}</div>
                <div class="trash-expire ${expireInfo.tone}">${expireInfo.text}</div>
            </td>
            <td>
                <div class="trash-row-meta">
                    <div class="trash-label">Клиент</div>
                    <div class="trash-client">${item.c}</div>
                </div>
            </td>
            <td>
                <div class="trash-row-meta">
                    <div class="trash-label">Проект</div>
                    <div class="trash-project">${item.n}</div>
                </div>
            </td>
            <td>
                <div class="trash-row-meta">
                    <div class="trash-label">Сумма</div>
                    <div class="trash-amount">${formatCurrency(item.p)}</div>
                </div>
            </td>
            <td>
                <div class="trash-action-btns">
                    <div class="restore-trash-btn" onclick="restoreFromTrash(${i})">Восстановить</div>
                    <div class="delete-forever-text" onclick="deleteForeverCheck(${i})" title="Удалить навсегда">Удалить</div>
                </div>
            </td>
        `;
        attachRowSelection(tr, 'trash', i, `check-trash-${i}`);
        tbody.appendChild(tr);
    });
    const footer = document.querySelector('#t-trash tfoot td:first-child');
    if (footer) {
        footer.className = 'footer-total-toggle';
        footer.onclick = () => toggleFooterSelection('trash');
        footer.innerText = `Всего ${DATA.trash.length} элементов`;
    }
}

function updVal(type, idx, key, val){
    if(key==='p' || key==='contractor' || key==='paid' || key==='taxPrc') val = toNumeric(val);
    DATA[type][idx][key] = val;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function updateContractorValue(type, idx, val) {
    DATA[type][idx].contractor = toNumeric(val);
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function updateContractorMode(type, idx, mode) {
    DATA[type][idx].contractorMode = mode;
    if (mode === 'none') DATA[type][idx].contractor = 0;
    sortData('active', 'dl', 'date', true);
    save(); upd();
}

function mv(idx, from, to){
    const item = DATA[from][idx];
    DATA[from].splice(idx, 1);
    if(to === 'active') { item.start = item.start || today; item.dl = item.dl || today; item.paid = item.paid || 50; delete item.date; }
    if(to === 'archive') { item.date = today; item.paid = 100; delete item.start; delete item.dl; }
    if(to === 'potential') { delete item.date; delete item.start; delete item.dl; item.paid = 0; }
    if(to === 'waiting' || to === 'paused') { delete item.date; item.paid = 0; }

    DATA[to].unshift(item);
    sortData('active', 'dl', 'date', true);
    save();
    setTimeout(() => { switchTab(to); }, 10);
}

function duplicateRow(type, idx){
    const item = JSON.parse(JSON.stringify(DATA[type].find((_, i) => i === idx)));
    if(!item) return;
    item.n = item.n + " (Копия)";
    DATA[type].unshift(item);
    save(); upd();
}

function askDel(type, idx){
    const itemIndex = DATA[type].findIndex((_, i) => i === idx);
    if (itemIndex > -1) {
        const item = DATA[type].splice(itemIndex, 1)[0];
        item.deletedAt = Date.now();
        DATA.trash.unshift(item);
        lastPermanentDeletion = null;
        save(); upd();
        showToast('Перемещено в корзину', 'Перейти', () => switchTab('trash'));
    }
}

function deleteForeverCheck(idx) {
    document.getElementById('del-modal-title').innerText = "Подтвердите действие";
    document.getElementById('del-modal-desc').innerText = "Удалить навсегда?";
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
        document.getElementById('finalDeleteBtn').innerText = 'Удалить навсегда';

    document.getElementById('finalDeleteBtn').onclick = () => {
        const item = DATA.trash.splice(idx, 1)[0];
        lastPermanentDeletion = item ? { type: 'trash', items: [{ item, index: idx }] } : null;
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
        showToast('Удалено навсегда', 'Отмена', undoPermanentDelete);
    };
}

function clearTrashForever() {
    if (!DATA.trash.length) return;
    document.getElementById('del-modal-title').innerText = "Очистить корзину";
    document.getElementById('del-modal-desc').innerText = `Удалить ${DATA.trash.length} проектов без возможности восстановления?`;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
    document.getElementById('finalDeleteBtn').style.backgroundColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').style.borderColor = 'var(--red)';
    document.getElementById('finalDeleteBtn').innerText = 'Очистить корзину';

    document.getElementById('finalDeleteBtn').onclick = () => {
        lastPermanentDeletion = { type: 'trash', items: DATA.trash.map((item, index) => ({ item, index })) };
        DATA.trash = [];
        document.getElementById('deleteConfirmModal').style.display = 'none';
        save(); upd();
        showToast('Корзина очищена', 'Отмена', undoPermanentDelete);
    };
}

function formatLinkDisplay(url) {
    return (url || '').replace(/^https?:\/\//, '');
}

function buildFallbackLinkTitle(url) {
    try {
        const parsed = new URL(url);
        const cleanPath = parsed.pathname.replace(/\/+$/, '').replace(/^\//, '');
        return cleanPath ? `${parsed.hostname} • ${cleanPath}` : parsed.hostname;
    } catch (e) {
        return formatLinkDisplay(url);
    }
}

function setLinkPreviewTitle(titleText) {
    const titleEl = document.getElementById('new-project-link-title');
    if (!titleEl) return;
    titleEl.textContent = titleText;
    titleEl.style.display = titleText ? 'block' : 'none';
}

async function fetchPageTitle(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) return '';
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('text/html')) return '';
        const html = await response.text();
        const match = html.match(/<title[^>]*>([^<]*)<\/title>/i);
        return match ? match[1].trim() : '';
    } catch (e) {
        return '';
    }
}

async function refreshNewProjectLinkTitle() {
    if (!newProjectLink) {
        newProjectLinkTitle = '';
        lastFetchedLinkForTitle = '';
        setLinkPreviewTitle('');
        return;
    }

    const fallback = buildFallbackLinkTitle(newProjectLink);

    if (newProjectLink === lastFetchedLinkForTitle && newProjectLinkTitle) {
        setLinkPreviewTitle(newProjectLinkTitle || fallback);
        return;
    }

    lastFetchedLinkForTitle = newProjectLink;
    const resolvedTitle = await fetchPageTitle(newProjectLink);
    newProjectLinkTitle = resolvedTitle || fallback;

    if (newProjectLink === lastFetchedLinkForTitle) {
        setLinkPreviewTitle(newProjectLinkTitle);
    }
}

function updateNewProjectLinkButton() {
    const btn = document.getElementById('new-project-link-btn');
    const preview = document.getElementById('new-project-link-preview');
    const text = document.getElementById('new-project-link-text');
    const previewLabel = document.getElementById('new-project-link-label');
    if (!btn) return;
    const hasLink = !!newProjectLink;
    btn.classList.toggle('link-active', hasLink);
    const label = btn.querySelector('span');
    if (label) label.textContent = 'Ссылка на чат/материалы';
    if (previewLabel) previewLabel.textContent = hasLink ? 'Ссылка добавлена' : 'Ссылка на чат/материалы';
    if (preview && text) {
        const displayText = hasLink ? formatLinkDisplay(newProjectLink) : '';
        preview.style.display = hasLink ? 'flex' : 'none';
        text.textContent = displayText;
        text.href = hasLink ? newProjectLink : '#';
        setLinkPreviewTitle(hasLink ? (newProjectLinkTitle || buildFallbackLinkTitle(newProjectLink)) : '');
        if (hasLink) refreshNewProjectLinkTitle();
    }
}

function clearNewProjectLink() {
    newProjectLink = '';
    newProjectLinkTitle = '';
    lastFetchedLinkForTitle = '';
    updateNewProjectLinkButton();
}

function wipeAllData() {
    const ok = confirm('Стереть всю базу, включая шаблоны? Отменить действие нельзя.');
    if (!ok) return;
    localStorage.removeItem(K);
    localStorage.removeItem(NAME_TEMPLATES_KEY);
    location.reload();
}

function restoreFromTrash(idx){
    const item = DATA.trash.splice(idx, 1)[0];
    delete item.deletedAt;
    DATA.active.unshift(item);
    save(); switchTab('active');
}

function openAddModal(type = null, idx = null){
    const isEdit = typeof type === 'string' && typeof idx === 'number';
    editContext = isEdit ? { type, idx } : null;
    const titleEl = document.querySelector('#addProjectModal h2');
    const saveBtn = document.querySelector('.add-modal-actions .save-stg');

    if (titleEl) titleEl.textContent = isEdit ? 'Редактировать проект' : 'Новый проект';
    if (saveBtn) saveBtn.textContent = isEdit ? 'Сохранить изменения' : 'Создать новый проект';

    const presetTimeInput = document.getElementById('add-proj-dl-time');

    if (isEdit) {
        const item = DATA[type][idx];
        document.getElementById('add-proj-name').value = item.n || '';
        document.getElementById('add-proj-client').value = item.c || '';
        document.getElementById('add-proj-price').value = formatPlainNumber(item.p || 0);
        const mode = item.contractorMode || 'none';
        document.getElementById('add-proj-contractor-mode').value = mode;
        handleNewContractorModeChange(mode);
        document.getElementById('add-proj-contractor').value = formatPlainNumber(item.contractor || 0);
        document.getElementById('add-proj-tax').value = String(item.taxPrc ?? 0);
        document.getElementById('add-proj-paid').value = String(item.paid ?? (type === 'archive' ? 100 : type === 'active' ? 50 : 0));
        document.getElementById('add-proj-type').value = type;
        document.getElementById('add-proj-start-val').value = item.start || '';
        document.getElementById('add-proj-dl-val').value = item.dl || '';
        previousDeadlineValue = item.dl || '';
        deadlineUnset = !item.dl;
        document.getElementById('add-proj-start-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(item.start || today);
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay(item.dl);
        document.getElementById('add-proj-dl-days').value = '';
        document.getElementById('add-proj-dl-custom').value = '';
        if (presetTimeInput) presetTimeInput.value = item.dl && item.dl.includes('T') ? item.dl.slice(11, 16) : '';
        newProjectLink = item.link || '';
        newProjectLinkTitle = item.linkTitle || '';
        lastFetchedLinkForTitle = newProjectLinkTitle && newProjectLink ? newProjectLink : '';
        toggleProjectNameClear();
        handleStatusChange(type, { preservePaid: true });
    } else {
        ['name','client','price','contractor'].forEach(id => document.getElementById(`add-proj-${id}`).value = '');
        toggleProjectNameClear();
        document.getElementById('add-proj-tax').value = '0';
        document.getElementById('add-proj-contractor-mode').value = 'none';
        handleNewContractorModeChange('none');
        document.getElementById('add-proj-paid').value = '50';
        document.getElementById('add-proj-type').value = 'active';
        document.getElementById('add-proj-start-val').value = today;
        document.getElementById('add-proj-dl-val').value = '';
        previousDeadlineValue = '';
        deadlineUnset = true;
        document.getElementById('add-proj-dl-days').value = '';
        document.getElementById('add-proj-dl-custom').value = '';
        if (presetTimeInput) presetTimeInput.value = '';
        document.getElementById('add-proj-start-display').querySelector('.date-text-display').innerHTML = formatDateDisplay(today);
        document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay('');
        handleStatusChange('active');
        newProjectLink = '';
        newProjectLinkTitle = '';
        lastFetchedLinkForTitle = '';
    }
    updateNewProjectLinkButton();
    document.getElementById('addProjectModal').style.display = 'flex';
}
function saveNewProject(){
    const name = document.getElementById('add-proj-name').value;
    const client = document.getElementById('add-proj-client').value;
    const price = toNumeric(document.getElementById('add-proj-price').value);
    const contrMode = document.getElementById('add-proj-contractor-mode').value || 'none';
    const contr = contrMode === 'none' ? 0 : toNumeric(document.getElementById('add-proj-contractor').value);
    const tax = +document.getElementById('add-proj-tax').value || 0;
    const paid = +document.getElementById('add-proj-paid').value || 0;
    const type = document.getElementById('add-proj-type').value;
    const start = document.getElementById('add-proj-start-val').value || today;
    const rawDeadline = (document.getElementById('add-proj-dl-val').value || '').trim();
    const isDeadlineCleared = deadlineUnset || rawDeadline === '';
    const finalDeadline = isDeadlineCleared ? '' : rawDeadline;

    const isEdit = !!editContext;
    const base = isEdit ? { ...DATA[editContext.type][editContext.idx] } : {};

    const item = {
        ...base,
        n: name, c: client, p: price, contractor: contr, contractorMode: contrMode, taxPrc: tax, link: newProjectLink,
        linkTitle: newProjectLink ? (newProjectLinkTitle || buildFallbackLinkTitle(newProjectLink)) : undefined,
        start: type==='active'? start : base.start,
        dl: type==='active' || type==='waiting' || type==='paused'
            ? (isDeadlineCleared ? '' : (finalDeadline || base.dl || ''))
            : undefined,
        paid: type==='archive' ? 100 : paid,
        date: type==='archive' ? today : base.date
    };

    if (type === 'potential') {
        delete item.start;
        delete item.dl;
    }

    if (isEdit) {
        const fromType = editContext.type;
        DATA[fromType].splice(editContext.idx, 1);
        if (fromType === type) {
            DATA[type].splice(editContext.idx, 0, item);
        } else {
            DATA[type].unshift(item);
        }
        editContext = null;
    } else {
        DATA[type].unshift(item);
    }
    document.getElementById('addProjectModal').style.display = 'none';
    showToast(isEdit ? 'Проект обновлён' : 'Проект создан');
    sortData('active', 'dl', 'date', true);
    save(); switchTab(type);
}

function applyDeadlinePreset() {
    const select = document.getElementById('add-proj-dl-days');
    const customInput = document.getElementById('add-proj-dl-custom');
    const timeInput = document.getElementById('add-proj-dl-time');

    // Логика отображения: если выбрано 'custom' ИЛИ уже введено значение в custom, показываем поле
    if (select.value === 'custom') {
        customInput.style.display = 'block';
        // Не делаем focus каждый раз, иначе сбивается ввод
    } else {
        customInput.style.display = 'none';
    }

    deadlineUnset = false;
    const currentStart = document.getElementById('add-proj-start-val').value || today;
    const currentDl = document.getElementById('add-proj-dl-val').value || currentStart || today;
    const startTime = currentStart && currentStart.includes('T') ? currentStart.slice(11, 16) : '';
    const manualTime = (timeInput?.value || '').trim();
    const finalTime = manualTime || startTime;

    // Сохраняем предыдущее значение, если еще не сохранили
    if (!previousDeadlineValue) {
        previousDeadlineValue = currentDl;
    }

    // Если пользователь пишет в инпут, но селект не custom (бывает редко), переключаем
    if (document.activeElement === customInput && select.value !== 'custom') {
        select.value = 'custom';
    }

    // Если "Быстрый срок..." (пусто), восстанавливаем старое или текущее
    if (select.value === '') {
        // Не сбрасываем, если просто кликнули, а оставляем как есть
        return; 
    }

    let days = 0;
    if (select.value === 'custom') {
        days = parseInt(customInput.value, 10);
    } else {
        days = parseInt(select.value, 10);
        // Если выбрали пресет, очищаем кастомное поле визуально, но не скрываем его насильно, если логика требует
        customInput.value = ''; 
    }

    if (!days || isNaN(days) || days <= 0) return; // Ждем валидного числа

    const startRaw = document.getElementById('add-proj-start-val').value || today;
    const baseDate = new Date(startRaw.replace(' ', 'T'));
    if (isNaN(baseDate)) return;
    
    const dlDate = new Date(baseDate);
    dlDate.setDate(dlDate.getDate() + days);
    
    const deadlineValue = formatDateWithTime(dlDate, finalTime);
    document.getElementById('add-proj-dl-val').value = deadlineValue;
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay(deadlineValue);
    previousDeadlineValue = deadlineValue;
}

function clearNewProjectDeadline() {
    deadlineUnset = true;
    document.getElementById('add-proj-dl-val').value = '';
    document.getElementById('add-proj-dl-display').querySelector('.date-text-display').innerHTML = formatDeadlineDisplay('');
    document.getElementById('add-proj-dl-days').value = '';
    document.getElementById('add-proj-dl-custom').value = '';
    previousDeadlineValue = '';
    const presetTimeInput = document.getElementById('add-proj-dl-time');
    if (presetTimeInput) presetTimeInput.value = '';
}

function handleStatusChange(status, options = {}) {
    const { preservePaid = false } = options;
    const dateBlocks = document.querySelectorAll('.status-dates');
    dateBlocks.forEach(block => block.style.display = status === 'potential' ? 'none' : '');
    if (status === 'potential') {
        document.getElementById('add-proj-dl-days').value = '';
        document.getElementById('add-proj-dl-custom').value = '';
    }

    const paidSelect = document.getElementById('add-proj-paid');
    if (paidSelect && status === 'archive') {
        paidSelect.value = '100';
    } else if (paidSelect && !preservePaid) {
        const defaultPaid = status === 'archive' ? 100 : status === 'active' ? 50 : 0;
        paidSelect.value = String(defaultPaid);
    }
}

function getPresetBaseDate() {
    if (queue.targetId) {
        if (queue.targetId === 'add-proj-dl-val') {
            return document.getElementById('add-proj-start-val').value || today;
        }
        return document.getElementById(queue.targetId)?.value || today;
    }
    if (queue.type && typeof queue.idx === 'number') {
        const item = DATA[queue.type][queue.idx] || {};
        if (queue.field === 'dl') return item.start || item.dl || item.date || today;
        return item[queue.field] || item.start || today;
    }
    return today;
}

function applyDateModalPreset() {
    const select = document.getElementById('date-modal-preset');
    const customInput = document.getElementById('date-modal-custom');
    if (!select) return;

    if (document.activeElement === customInput && select.value !== 'custom') {
        select.value = 'custom';
    }

    if (select.value === '') return;

    let days = parseInt(select.value, 10);
    if (select.value === 'custom') {
        days = parseInt(customInput.value, 10);
    }
    if (!days || days <= 0) return;

    const baseRaw = (getPresetBaseDate() || today).slice(0, 10);
    const baseDate = new Date(baseRaw + 'T00:00:00');
    if (isNaN(baseDate)) return;
    baseDate.setDate(baseDate.getDate() + days);
    const nextDate = baseDate.toISOString().slice(0, 10);

    if (datePicker) datePicker.setDate(nextDate, true);
    else document.getElementById('date-input-val').value = nextDate;
}

function openDate(type, idx, field){
    queue = {type, idx, field, targetId: null};
    const val = DATA[type][idx][field];
    openDateBase(val);
}
function openDateInModal(targetInputId){
    const val = document.getElementById(targetInputId).value;
    if (targetInputId === 'add-proj-dl-val') deadlineUnset = false;
    queue = {type: null, idx: null, field: null, targetId: targetInputId};
    openDateBase(val);
}
function setupDatePickers(){
    if (typeof flatpickr !== 'function') return;

    datePicker = flatpickr('#date-input-val', {
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'j M',
        defaultDate: today,
        locale: flatpickr.l10ns.ru,
        disableMobile: true,
    });

    timePicker = flatpickr('#time-input-val', {
        enableTime: true,
        noCalendar: true,
        dateFormat: 'H:i',
        defaultDate: '12:00',
        time_24hr: true,
        minuteIncrement: 5,
        disableMobile: true,
    });
}
function openDateBase(val) {
    const hasTime = val && val.includes('T') && val.length > 10;
    document.getElementById('date-has-time').checked = hasTime;

    const dateVal = val ? val.slice(0, 10) : today;
    const timeVal = hasTime ? val.slice(11, 16) : '12:00';

    const modalPreset = document.getElementById('date-modal-preset');
    const modalCustom = document.getElementById('date-modal-custom');
    if (modalPreset) modalPreset.value = '';
    if (modalCustom) modalCustom.value = '';

    if (datePicker) datePicker.setDate(dateVal, true);
    else document.getElementById('date-input-val').value = dateVal;

    if (timePicker) timePicker.setDate(timeVal, true, 'H:i');
    else document.getElementById('time-input-val').value = timeVal;

    toggleTimeInput();

    const clearBtn = document.getElementById('date-modal-clear');
    const isDeadlineContext = (queue?.targetId && queue.targetId.includes('dl')) || queue?.field === 'dl';
    const presetBlock = document.querySelector('.modal-deadline-presets');
    if (clearBtn) {
        clearBtn.style.display = isDeadlineContext ? 'inline-flex' : 'none';
    }
    if (presetBlock) {
        presetBlock.style.display = isDeadlineContext ? 'flex' : 'none';
    }
    document.getElementById('dateModal').style.display = 'flex';
}
function toggleTimeInput(){
    const chk = document.getElementById('date-has-time');
    const baseInput = document.getElementById('time-input-val');
    const inputs = [baseInput, timePicker?.input, timePicker?.altInput].filter(Boolean);

    inputs.forEach(inp => {
        inp.disabled = !chk.checked;
        inp.style.opacity = chk.checked ? '1' : '0.3';
    });

    if (timePicker) {
        timePicker.set('clickOpens', chk.checked);
    }
}
function clearDateModalDeadline() {
    const dateInput = document.getElementById('date-input-val');
    const timeInput = document.getElementById('time-input-val');
    const isDeadlineContext = (queue?.targetId && queue.targetId.includes('dl')) || queue?.field === 'dl';
    if (!isDeadlineContext) return;

    if (datePicker) datePicker.clear();
    else if (dateInput) dateInput.value = '';
    if (timePicker) timePicker.clear();
    if (timeInput) timeInput.value = '';

    const timeToggle = document.getElementById('date-has-time');
    if (timeToggle) {
        timeToggle.checked = false;
        toggleTimeInput();
    }

    if (queue?.targetId) {
        const displayId = queue.targetId.replace('-val', '-display');
        const displayNode = document.getElementById(displayId)?.querySelector('.date-text-display');
        document.getElementById(queue.targetId).value = '';
        if (displayNode) displayNode.innerHTML = formatDeadlineDisplay('');
        if (queue.targetId === 'add-proj-dl-val') deadlineUnset = true;
        closeDateModal();
        return;
    }

    if (queue?.type && typeof queue.idx === 'number') {
        DATA[queue.type][queue.idx].dl = '';
        closeDateModal();
        save();
        upd();
    }
}
function closeDateModal(){ document.getElementById('dateModal').style.display = 'none'; }
function saveDate(){
    const d = document.getElementById('date-input-val').value;
    const t = document.getElementById('time-input-val').value;
    const useTime = document.getElementById('date-has-time').checked;
    if(!d) return;
    const result = useTime ? `${d}T${t}` : d;

    if (queue.targetId) {
        document.getElementById(queue.targetId).value = result;
        const displayId = queue.targetId.replace('-val', '-display');
        const formatter = queue.targetId.includes('dl') ? formatDeadlineDisplay : formatDateDisplay;
        document.getElementById(displayId).querySelector('.date-text-display').innerHTML = formatter(result);
        if (queue.targetId === 'add-proj-dl-val') deadlineUnset = false;
        if (queue.targetId === 'add-proj-start-val') {
            const presetTimeInput = document.getElementById('add-proj-dl-time');
            if (presetTimeInput && result.includes('T')) {
                presetTimeInput.value = result.slice(11, 16);
            }
            const presetDays = parseInt(document.getElementById('add-proj-dl-days').value, 10);
            if (presetDays) applyDeadlinePreset();
        }
    } else {
        DATA[queue.type][queue.idx][queue.field] = result;
        sortData('active', 'dl', 'date', true);
    }
    
    closeDateModal(); save(); upd();
}

function openProjectLink(idx, type) {
    const link = DATA[type][idx].link;
    if (link) {
        window.open(link, '_blank');
    } else {
        openLink(type, idx);
    }
}
function openLink(type, idx){
    queue = {type, idx};
    const currentLink = type === 'new' ? newProjectLink : (DATA[type][idx]?.link || '');
    const tgCheckbox = document.getElementById('link-is-telegram');
    let displayValue = currentLink;

    if (currentLink.match(/t\.me\//)) {
        tgCheckbox.checked = true;
        displayValue = currentLink.replace(/^https?:\/\/t\.me\//, '').replace(/^@+/, '');
    } else {
        tgCheckbox.checked = false;
    }

    document.getElementById('link-input').value = displayValue;
    document.getElementById('linkModal').style.display = 'flex';
}
function closeLinkModal(){ document.getElementById('linkModal').style.display = 'none'; }
function saveLink(){
    const isTelegram = document.getElementById('link-is-telegram').checked;
    const raw = document.getElementById('link-input').value;
    const normalized = normalizeLinkValue(raw, isTelegram);
    const fallbackTitle = normalized ? buildFallbackLinkTitle(normalized) : '';

    lastFetchedLinkForTitle = '';

    if (queue.type === 'new') {
        newProjectLink = normalized;
        newProjectLinkTitle = fallbackTitle;
        updateNewProjectLinkButton();
        queue = { type: null, idx: null, field: null, targetId: null };
        closeLinkModal();
        return;
    }

    const queueType = queue.type;
    const queueIdx = queue.idx;
    const targetItem = DATA[queueType][queueIdx];
    if (targetItem) {
        targetItem.link = normalized;
        targetItem.linkTitle = normalized ? fallbackTitle : undefined;

        if (normalized) {
            fetchPageTitle(normalized).then(title => {
                const updatedItem = DATA[queueType]?.[queueIdx];
                if (!title || !updatedItem || updatedItem.link !== normalized) return;
                updatedItem.linkTitle = title;
                save();
            });
        }
    }
    closeLinkModal(); save(); upd();
}

function startProjectEdit(type, idx) {
    openAddModal(type, idx);
}

function openSettings(){
    activateSettingsPane('appearance');
    document.getElementById('stg-goal').value = formatPlainNumber(DATA.monthlyGoals[currentMonth] || 250000);
    document.getElementById('stg-rec').value = formatPlainNumber(DATA.settings.record || 0);
    const mode = UI_PREFS.themeMode || 'dark';
    ['auto', 'light', 'dark'].forEach(m => {
        const radio = document.getElementById(`theme-mode-${m}`);
        if (radio) radio.checked = mode === m;
    });
    const visibility = UI_PREFS.blockVisibility || {};
    const toggleMap = [
        ['block-toggle-backup', 'backup'],
        ['block-toggle-pace', 'pace'],
        ['block-toggle-dashboard', 'dashboard'],
        ['block-toggle-efficiency', 'efficiency'],
        ['block-toggle-top-clients', 'topClients'],
        ['block-toggle-record', 'record'],
        ['block-toggle-reputation', 'reputation']
    ];
    toggleMap.forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) {
            el.checked = visibility[key] !== false;
            if (!el.dataset.previewBound) {
                el.addEventListener('change', updateSettingsPreviewStates);
                el.dataset.previewBound = '1';
            }
        }
    });
    const tableVisibility = UI_PREFS.tableVisibility || {};
    [
        ['table-toggle-requests', 'requests'],
        ['table-toggle-waiting', 'waiting'],
        ['table-toggle-paused', 'paused'],
    ].forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.checked = tableVisibility[key] !== false;
    });
    const statVisibility = UI_PREFS.statVisibility || {};
    [
        ['stat-toggle-goal', 'goal'],
        ['stat-toggle-fact', 'fact'],
        ['stat-toggle-active-fact', 'activeFact'],
        ['stat-toggle-paid-gross', 'paidGross'],
        ['stat-toggle-total-gross', 'totalGross'],
        ['stat-toggle-plan', 'plan'],
        ['stat-toggle-forecast', 'forecast'],
        ['stat-toggle-expenses', 'expenses'],
        ['stat-toggle-taxes', 'taxes'],
    ].forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.checked = statVisibility[key] !== false;
    });
    updateSettingsPreviewStates();
    document.getElementById('settingsModal').style.display = 'flex';
}
function openGoalSettings(){
    openSettings();
    activateSettingsPane('data');
    const goalInput = document.getElementById('stg-goal');
    if (goalInput) {
        goalInput.focus();
        goalInput.select();
    }
}
function openRecordSettings(){
    openSettings();
    activateSettingsPane('data');
    const recordInput = document.getElementById('stg-rec');
    if (recordInput) {
        recordInput.focus();
        recordInput.select();
    }
}
function saveSettings(){
    const selectedMode = document.querySelector('input[name="theme-mode"]:checked');
    UI_PREFS.blockVisibility = {
        backup: document.getElementById('block-toggle-backup')?.checked !== false,
        pace: document.getElementById('block-toggle-pace')?.checked !== false,
        dashboard: document.getElementById('block-toggle-dashboard')?.checked !== false,
        efficiency: document.getElementById('block-toggle-efficiency')?.checked !== false,
        topClients: document.getElementById('block-toggle-top-clients')?.checked !== false,
        record: document.getElementById('block-toggle-record')?.checked !== false,
        reputation: document.getElementById('block-toggle-reputation')?.checked !== false,
    };
    UI_PREFS.tableVisibility = {
        requests: document.getElementById('table-toggle-requests')?.checked !== false,
        waiting: document.getElementById('table-toggle-waiting')?.checked !== false,
        paused: document.getElementById('table-toggle-paused')?.checked !== false,
    };
    UI_PREFS.statVisibility = {
        goal: document.getElementById('stat-toggle-goal')?.checked !== false,
        fact: document.getElementById('stat-toggle-fact')?.checked !== false,
        activeFact: document.getElementById('stat-toggle-active-fact')?.checked !== false,
        paidGross: document.getElementById('stat-toggle-paid-gross')?.checked !== false,
        totalGross: document.getElementById('stat-toggle-total-gross')?.checked !== false,
        plan: document.getElementById('stat-toggle-plan')?.checked !== false,
        forecast: document.getElementById('stat-toggle-forecast')?.checked !== false,
        expenses: document.getElementById('stat-toggle-expenses')?.checked !== false,
        taxes: document.getElementById('stat-toggle-taxes')?.checked !== false,
    };
    if (selectedMode) {
        applyThemeMode(selectedMode.value);
    } else {
        persistUiPrefs();
    }
    applyBlockVisibility();
    applyTableVisibility();
    applyStatVisibility();
    DATA.monthlyGoals[currentMonth] = toNumeric(document.getElementById('stg-goal').value);
    DATA.settings.record = toNumeric(document.getElementById('stg-rec').value);
    document.getElementById('settingsModal').style.display = 'none';
    save(); upd();
}

function resetInterface() {
    const ok = confirm('Вернуть интерфейс к заводским настройкам? Настройки отображения и темы будут сброшены.');
    if (!ok) return;
    UI_PREFS = JSON.parse(JSON.stringify(DEFAULT_UI_PREFS));
    persistUiPrefs();
    applyThemeMode(UI_PREFS.themeMode || 'dark', { silent: true });
    applyBlockVisibility();
    applyBlockOrder();
    applyTableVisibility();
    applyStatVisibility();
    applyStatOrder();
    layoutEditMode = false;
    updateLayoutEditButton();
    setupEditableBlocks();
    upd();
    openSettings();
    showToast('Интерфейс сброшен');
}

function pluralize(num, forms){
    const n = Math.abs(num) % 100;
    const n1 = n % 10;
    if (n > 10 && n < 20) return forms[2];
    if (n1 > 1 && n1 < 5) return forms[1];
    if (n1 === 1) return forms[0];
    return forms[2];
}

function getTimeRemaining(dl){
    if(!dl) return {txt:'∞', cls:'days-infinite', days: Infinity, isInfinite: true};
    const targetDay = new Date(dl.slice(0, 10) + 'T00:00:00');
    const todayNormalized = new Date(today + 'T00:00:00');

    if (isNaN(targetDay.getTime())) return {txt:'∞', cls:'days-infinite', days: Infinity, isInfinite: true};

    const dayDiff = Math.ceil((targetDay.getTime() - todayNormalized.getTime()) / (1000 * 60 * 60 * 24));
    const targetExact = dl.includes('T') ? new Date(dl.replace(' ', 'T')) : new Date(dl + 'T23:59:59');
    if (isNaN(targetExact.getTime())) return {txt:'∞', cls:'days-infinite', days: Infinity, isInfinite: true};
    const msLeft = targetExact.getTime() - Date.now();

    const dayMs = 1000 * 60 * 60 * 24;
    const hourMs = 1000 * 60 * 60;
    const hoursRemainder = Math.max(0, Math.floor((msLeft % dayMs) / hourMs));
    const shortHours = Math.max(1, hoursRemainder);

    if(msLeft < 0) return {txt:'Срок вышел', cls:'days-critical', days: -1};
    const hoursText = dayDiff === 0 ? shortHours : hoursRemainder;
    const text = `${Math.max(0, dayDiff)}д ${hoursText}ч`;

    if(dayDiff === 0) return {txt: text, cls:'days-critical', days: dayDiff};
    if(dayDiff <= 3) return {txt: text, cls:'days-warning', days: dayDiff};
    return {txt: text, cls:'days-normal', days: dayDiff};
}

function getArchiveByMonth(month = currentMonth) {
    return DATA.archive.filter(i => (i.date || '').startsWith(month));
}

function changeMonth(m){ 
    currentMonth = m; 
    if (!DATA.monthlyGoals[currentMonth]) {
        DATA.monthlyGoals[currentMonth] = 250000;
        save();
    }
    upd();
}
function renderMonthSelect(){
    const sel = document.getElementById('monthSelect');
    const months = new Set([today.slice(0,7)]);
    [...DATA.archive, ...DATA.active].forEach(i => {
        if(i.date) months.add(i.date.slice(0,7));
        if(i.start) months.add(i.start.slice(0,7));
    });
    Object.keys(DATA.monthlyGoals).forEach(m => months.add(m));

    sel.innerHTML = '';
    Array.from(months).sort().reverse().forEach(m => {
        const d = new Date(m + '-01');
        const name = d.toLocaleString('ru', {month:'long', year:'numeric'});
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = name.charAt(0).toUpperCase() + name.slice(1);
        if(m===currentMonth) opt.selected = true;
        sel.appendChild(opt);
    });
}

const repCenterText = {
    id: 'repCenterText',
    afterDraw(chart, args, opts) {
        const { ctx, chartArea: { width, height } } = chart;
        const styles = getComputedStyle(document.body);
        const textColor = (styles.getPropertyValue('--text') || '#f0f6fc').trim();
        const mutedColor = (styles.getPropertyValue('--muted') || '#8b949e').trim();
        ctx.save();
        ctx.font = '900 22px -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif';
        ctx.fillStyle = textColor;
        ctx.textAlign = 'center';
        ctx.fillText(opts.text || '', width / 2, height / 2 + 6);
        ctx.font = '600 12px -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif';
        ctx.fillStyle = mutedColor;
        ctx.fillText(opts.subText || '', width / 2, height / 2 + 22);
        ctx.restore();
    }
};

function analyzeReputation(){
    const projectTypes = ['active', 'waiting', 'paused', 'potential'];
    const overdue = [];
    projectTypes.forEach(type => {
        DATA[type].forEach(item => {
            const rem = getTimeRemaining(item.dl);
            if (rem.days < 0) {
                overdue.push({
                    name: item.n || 'Без названия',
                    client: item.c || 'Без клиента',
                    days: Math.abs(rem.days)
                });
            }
        });
    });

    const total = overdue.length;
    const worst = overdue.reduce((acc, cur) => Math.max(acc, cur.days), 0);
    const avg = total ? Math.round(overdue.reduce((acc, cur) => acc + cur.days, 0) / total) : 0;
    const activeCount = DATA.active.length;
    const nearDeadline = DATA.active.filter(item => {
        const rem = getTimeRemaining(item.dl);
        return rem.days >= 0 && rem.days <= 2;
    }).length;
    const onTime = Math.max(activeCount - total - nearDeadline, 0);
    const score = Math.max(0, Math.min(100, 100 - total * 12 - Math.max(0, worst - 2) * 3 - nearDeadline * 2));

    let level = 'good';
    let headline = 'Всё ок — ты держишь сроки';
    let hint = 'Просроченных дедлайнов нет, продолжай в том же духе.';
    let chip = 'Стабильно';
    let detail = 'Отсутствие просрочек усиливает доверие клиентов. Держи темп и фиксируй успехи в архиве.';
    let fallout = 'Сохраняй привычку опережать дедлайны — это личный бренд и поток рекомендаций.';
    let tips = [
        'Фиксируй дедлайны при постановке задач, чтобы контролировать загрузку.',
        'Закрывай готовые проекты в архив — это повышает итоговый рейтинг.',
    ];

    if (total > 0) {
        const overdueWord = `${total} ${pluralize(total, ['просрочка', 'просрочки', 'просрочек'])}`;
        const daysWord = `${worst} ${pluralize(worst, ['день', 'дня', 'дней'])}`;
        if (total <= 2 && worst <= 5) {
            level = 'warn';
            headline = 'Есть просрочки — поправь сроки';
            hint = `${overdueWord} до ${daysWord}. Обнови план и предупреди клиентов.`;
            chip = 'Нужно ускориться';
            detail = 'Пара задержек ещё поправима: договорись о новых сроках и закрой задачи, чтобы не терять доверие.';
            fallout = 'Если так тянуть и дальше, клиенты начнут замораживать платежи и уйдут к тем, кто держит сроки.';
            tips = [
                'Договорись с клиентами о новых сроках и отметь их в таблице.',
                'Сконцентрируйся на задачах с максимальной просрочкой, чтобы снять красные индикаторы.',
                'Отложи новые брони до закрытия текущих хвостов.',
            ];
        } else {
            level = 'bad';
            headline = 'Репутация проседает';
            hint = `${overdueWord} до ${daysWord} — пора спасать ситуацию.`;
            chip = 'Критично';
            detail = 'Множественные просрочки уже бьют по имени. Наведи порядок в приоритетах и верни сроки под контроль.';
            fallout = 'Продолжение срывов = штрафы, возвраты и жёсткие отзывы. Лиды будут обходить тебя стороной.';
            tips = [
                'Составь антикризисный список: сначала закрывай самые старые и дорогие проекты.',
                'Разбей объём на краткие чекпоинты и ежедневно отмечай прогресс.',
                'Оповести клиентов о статусе — прозрачность снижает негатив по просрочкам.',
            ];
        }
    } else if (nearDeadline > 0) {
        fallout = 'Если проморгать задачи на ближайшие 2 дня — они уйдут в красную зону и потянут рейтинг вниз.';
        tips.push('На радаре есть задачи с дедлайном в ближайшие 2 дня — выдели под них фиксированные слоты.');
    }

    return { level, headline, hint, chip, detail, fallout, score, total, worst, avg, activeCount, nearDeadline, tips, onTime };
}

function openReputationTasks() {
    if (isTableEnabled('active')) {
        switchTab('active');
        const tabBtn = document.getElementById('tab-active');
        if (tabBtn) tabBtn.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        openSettings();
        activateSettingsPane('tables');
    }
}

function updateReputationUI(){
    const state = analyzeReputation();
    const strip = document.getElementById('reputation-strip');
    if (strip) {
        strip.classList.remove('good', 'warn', 'bad');
        strip.classList.add(state.level);
    }

    const headline = document.getElementById('reputation-headline');
    if (headline) headline.innerText = state.headline;

    const hint = document.getElementById('reputation-hint');
    if (hint) hint.innerText = state.hint;

    const severity = document.getElementById('reputation-severity');
    if (severity) {
        severity.classList.remove('good', 'warn', 'bad');
        severity.classList.add(state.level);
        severity.innerText = state.chip;
    }

    const score = document.getElementById('reputation-score');
    if (score) score.innerText = `${state.score} / 100`;
    const scoreLabel = document.getElementById('rep-score-label');
    if (scoreLabel) scoreLabel.innerText = state.score;

    const grade = document.getElementById('reputation-grade');
    if (grade) {
        grade.innerText = state.total
            ? `${state.total} ${pluralize(state.total, ['просрочка', 'просрочки', 'просрочек'])} (до ${state.worst} ${pluralize(state.worst, ['дня', 'дней', 'дней'])})`
            : 'Просроченных дедлайнов нет';
    }

    const detail = document.getElementById('reputation-detail');
    if (detail) detail.innerText = state.detail;

    const fallout = document.getElementById('reputation-fallout');
    if (fallout) {
        fallout.style.display = state.level === 'good' ? 'none' : 'block';
        fallout.innerText = state.level === 'good' ? '' : state.fallout;
    }

    const activeCount = document.getElementById('rep-active-count');
    if (activeCount) activeCount.innerText = state.activeCount;

    const repOnTime = document.getElementById('rep-on-time');
    if (repOnTime) {
        const onTime = Math.max(state.onTime, 0);
        repOnTime.innerText = onTime > 0 ? `${onTime} без просрочек` : 'Все задачи просрочены';
    }

    const repOverdue = document.getElementById('rep-overdue');
    if (repOverdue) repOverdue.innerText = state.total;

    const repDelayMax = document.getElementById('rep-delay-max');
    const repDelayAvg = document.getElementById('rep-delay-avg');

    if (repDelayMax) repDelayMax.innerText = state.worst > 0 ? state.worst : '0';
    if (repDelayAvg) repDelayAvg.innerText = state.avg > 0 ? state.avg : '0';

    const tipsEl = document.getElementById('reputation-tips');
    if (tipsEl) {
        // Мы меняем class="rep-tip" на class="rep-tip-card" чтобы подхватились новые стили
        tipsEl.innerHTML = state.tips.map(tip => `
            <div class="rep-tip-card">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span>${tip}</span>
            </div>
        `).join('');
    }

    updatePaceReputation(state);

    const repOnTimePill = document.getElementById('rep-on-time-pill');
    if (repOnTimePill) repOnTimePill.innerText = Math.max(state.onTime, 0);

    const repNearPill = document.getElementById('rep-near-pill');
    if (repNearPill) repNearPill.innerText = state.nearDeadline;

    const repOverduePill = document.getElementById('rep-overdue-pill');
    if (repOverduePill) repOverduePill.innerText = state.total;

    const repChartEl = document.getElementById('reputationChart');
    if (repChartEl) {
        if (chRep) chRep.destroy();
        const onTimeVal = Math.max(state.onTime, 0);
        const nearVal = state.nearDeadline;
        const overdueVal = state.total;
        const totalVal = onTimeVal + nearVal + overdueVal;
        const hasData = totalVal > 0;
        const labels = hasData ? ['В срок', 'На грани', 'Просрочки'] : ['Репутация'];
        const data = hasData ? [onTimeVal, nearVal, overdueVal] : [1];
        const colors = hasData ? ['#2ea043', '#d29922', '#f85149'] : ['#2ea043'];
        chRep = new Chart(repChartEl.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.1,
                cutout: '72%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${hasData ? ctx.parsed : 0}`
                        }
                    },
                    repCenterText: {
                        text: `${state.score} / 100`,
                        subText: state.level === 'good' ? 'Доверие стабильно' : 'Нужно ускориться'
                    }
                }
            },
            plugins: [repCenterText]
        });
    }
}

function updatePaceReputation(state){
    const chip = document.getElementById('pace-rep-chip');
    const text = document.getElementById('pace-rep-text');
    const dot = document.getElementById('pace-rep-dot');
    const caption = document.getElementById('pace-rep-caption');

    if (chip) {
        chip.classList.remove('good', 'warn', 'bad');
        chip.classList.add(state.level);
    }

    if (text) text.innerText = `${state.score} / 100`;
    if (dot) dot.className = `rep-dot ${state.level}`;
    if (caption) caption.innerText = state.level === 'good' ? 'Доверие стабильно' : 'Нужно ускориться';
}

function scrollToReputation(){
    const card = document.getElementById('reputation-card');
    if (card && !card.classList.contains('is-hidden')) {
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        openSettings();
        activateSettingsPane('blocks');
        const toggle = document.getElementById('block-toggle-reputation');
        if (toggle) toggle.focus();
    }
}

function getScopedDataForStats() {
    return {
        active: DATA.active,
        archive: getArchiveByMonth(),
        paused: DATA.paused,
        waiting: DATA.waiting,
        potential: DATA.potential,
    };
}

function calcStats(){
    const scope = getScopedDataForStats();
    const goal = toNumeric(DATA.monthlyGoals[currentMonth]) || 250000;
    let fact = 0, activeFact = 0, plan = 0, totalGross = 0, totalNet = 0;
    let totalExpenses = 0, totalTaxes = 0, totalPaidGross = 0;

    ['active','archive','paused','waiting','potential'].forEach(type => {
        scope[type].forEach(i => {
            totalExpenses += calcContractorAmount(i);
            totalTaxes += toNumeric(i.p) * ((toNumeric(i.taxPrc) || 0) / 100);
        });
    });

    const archiveThisMonth = scope.archive;
    archiveThisMonth.forEach(i => {
        const net = calcNet(i);
        fact += net;
        totalGross += toNumeric(i.p);
        totalNet += net;
        totalPaidGross += toNumeric(i.p);
    });

    scope.active.forEach(i => {
        const net = calcNet(i);
        const gross = toNumeric(i.p);
        const paidPrc = (toNumeric(i.paid)||0)/100;
        const paidGross = gross * paidPrc;
        activeFact += net * paidPrc;
        plan += net * (1 - paidPrc);
        totalGross += gross;
        totalNet += net;
        totalPaidGross += paidGross;
    });

    scope.paused.forEach(i => plan += calcNet(i));
    scope.waiting.forEach(i => plan += calcNet(i));
    scope.potential.forEach(i => plan += calcNet(i));

    const totalFact = fact + activeFact;
    const forecast = totalFact + plan;
    
    const totalMargin = totalNet;
    const totalGrossCombined = totalGross;
    const goalProgress = goal ? Math.round((totalFact/goal)*100) : 0;

    document.getElementById('val-fact').innerText = formatCurrency(totalFact);
    document.getElementById('val-fact-prc').innerText = `${goalProgress}% от цели`;
    document.getElementById('val-active-fact').innerText = formatCurrency(activeFact);
    document.getElementById('val-margin').innerText = formatCurrency(totalMargin);
    document.getElementById('val-margin-prc').innerText = `${totalGrossCombined > 0 ? Math.round((totalMargin/totalGrossCombined)*100) : 0}%`;
    document.getElementById('val-plan').innerText = formatCurrency(plan);
    document.getElementById('val-total').innerText = formatCurrency(forecast);
    document.getElementById('val-total-gross').innerText = formatCurrency(totalGrossCombined);
    document.getElementById('val-expenses').innerText = formatCurrency(totalExpenses);
    document.getElementById('val-taxes').innerText = formatCurrency(totalTaxes);
    document.getElementById('val-paid-gross').innerText = formatCurrency(totalPaidGross);
    document.getElementById('goal-text').innerText = `${formatCurrency(totalFact)} / ${formatCurrency(goal)}`;
    document.getElementById('goal-pill').innerText = `Цель: ${formatCurrency(goal)}`;

    const record = DATA.settings.record || 0;
    const recordProgress = record > 0 ? Math.min(100, (totalFact/record)*100) : 0;
    const recordRemaining = Math.max(0, record - totalFact);
    let motivText = 'Обновим цифры!';
    if (!record) motivText = 'Задай цель и забери рекорд.';
    else if (recordRemaining <= 0) motivText = 'Новый рекорд! Так держать.';
    else if (recordProgress >= 70) motivText = 'Чуть-чуть до рекорда!';
    else motivText = 'Движемся к рекорду каждый день.';

    document.getElementById('record-motiv').innerText = motivText;
    document.getElementById('record-remaining').innerText = record ? (recordRemaining > 0 ? `До рекорда ${formatCurrency(recordRemaining)}` : 'Рекорд побит!') : 'Задайте рекорд в настройках';
    document.getElementById('record-amount').innerText = formatCurrency(record);
    const recCurrentFact = document.getElementById('rec-current-fact');
    if (recCurrentFact) recCurrentFact.innerText = formatCurrency(totalFact);
    document.getElementById('record-progress').style.width = record ? Math.min(100, (totalFact/record)*100) + '%' : '0%';

    document.getElementById('p-bar').style.width = goal > 0 ? Math.min(100, (totalFact/goal)*100) + '%' : '0%';
    document.getElementById('dash-month-name').innerText = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex]?.text || '';
    const scopeNote = 'Срез: все проекты';
    const scopeHint = 'Статистика собирается по всем разделам вне зависимости от выбранной вкладки';
    const scopeEl = document.getElementById('stat-scope-note');
    if (scopeEl) {
        scopeEl.innerText = scopeNote;
        scopeEl.title = scopeHint;
    }
    updateReputationUI();
    updateCharts(totalFact, plan, scope);
    updateTopClientsChart(scope);
}

let chL = null, chP = null, chB = null, chRep = null, chTopClients = null;
let topClientsMode = 'net';
let lastTopClientsScope = null;
function updateCharts(fact, plan, scope){
    const lineCanvas = document.getElementById('lineChart');
    const pieCanvas = document.getElementById('pieChart');
    const barCanvas = document.getElementById('barChart');
    if (!lineCanvas || !pieCanvas || !barCanvas) return;

    const ctxL = lineCanvas.getContext('2d');
    const ctxP = pieCanvas.getContext('2d');
    const ctxB = barCanvas.getContext('2d');

    const [year, month] = currentMonth.split('-').map(Number);

    // Line Chart — опираемся на выбранный месяц
    const daysInM = new Date(year, month, 0).getDate();
    const labelsL = Array.from({ length: daysInM }, (_, i) => i + 1);
    const dataL = new Array(daysInM).fill(0);

    (scope.archive || []).forEach(item => {
        const [itemYear, itemMonth, itemDay] = (item.date || '').split('-').map(Number);
        if (itemYear === year && itemMonth === month && itemDay) {
            const idx = itemDay - 1;
            if (idx >= 0 && idx < daysInM) dataL[idx] += calcNet(item);
        }
    });

    let acc = 0;
    const dataAcc = dataL.map(v => (acc += v));

    if (chL) chL.destroy();
    chL = new Chart(ctxL, {
        type: 'line',
        data: {
            labels: labelsL,
            datasets: [{
                label: 'Факт',
                data: dataAcc,
                borderColor: '#2ea043',
                backgroundColor: 'rgba(46,160,67,0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { grid: { color: getCssVar('--border') } } }
        }
    });

    // Pie chart — факт против остатка/потенциала
    const safeFact = Math.max(0, fact || 0);
    const safePlan = Math.max(0, plan || 0);

    if (chP) chP.destroy();
    chP = new Chart(ctxP, {
        type: 'doughnut',
        data: {
            labels: ['Получено', 'Потенциал/Остаток'],
            datasets: [{
                data: [safeFact, safePlan],
                backgroundColor: [getCssVar('--green'), getCssVar('--border')],
                borderWidth: 0,
                borderRadius: 20,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '85%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: getCssVar('--card'),
                    titleColor: getCssVar('--text'),
                    bodyColor: getCssVar('--muted'),
                    borderColor: getCssVar('--border'),
                    borderWidth: 1,
                    displayColors: true,
                    boxPadding: 4
                }
            }
        }
    });

    // Bar chart — последние 6 месяцев относительно выбранного месяца
    const monthlyTotals = {};
    (scope.archive || []).forEach(item => {
        const key = (item.date || '').slice(0, 7);
        if (key) monthlyTotals[key] = (monthlyTotals[key] || 0) + calcNet(item);
    });

    const barLabels = [];
    const barData = [];
    const barColors = [];

    const anchorDate = new Date(year, month - 1, 1);

    for (let i = 5; i >= 0; i--) {
        const d = new Date(anchorDate);
        d.setMonth(d.getMonth() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const key = `${y}-${m}`;

        barLabels.push(d.toLocaleString('ru', { month: 'short' }));
        barData.push(monthlyTotals[key] || 0);
        barColors.push(key === currentMonth ? getCssVar('--accent') : getCssVar('--chart-bar-bg'));
    }

    if (chB) chB.destroy();
    chB = new Chart(ctxB, {
        type: 'bar',
        data: {
            labels: barLabels,
            datasets: [{
                data: barData,
                backgroundColor: barColors,
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: getCssVar('--muted'), font: { size: 11 }, autoSkip: false }
                },
                y: { display: false }
            }
        }
    });
}

function updateTopClientsChart(scope) {
    const canvas = document.getElementById('topClientsChart');
    if (!canvas) return;

    lastTopClientsScope = scope;

    const modeLabel = document.getElementById('top-clients-mode-label');
    const sub = document.getElementById('top-clients-sub');
    const isGross = topClientsMode === 'gross';
    if (modeLabel) modeLabel.innerText = isGross ? 'Грязная прибыль' : 'Чистая прибыль';
    if (sub) sub.innerText = isGross
        ? 'Без учёта расходов и налогов — все статусы'
        : 'Маржа по активным, архивным, на паузе и в ожидании';

    const valueGetter = isGross ? calcGross : calcNet;
    const datasetLabel = isGross ? 'Грязная прибыль' : 'Чистая прибыль';

    const totals = {};
    ['active','archive','paused','waiting'].forEach(type => {
        (scope[type] || []).forEach(item => {
            const client = (item.c || 'Без имени').trim() || 'Без имени';
            const value = valueGetter(item);
            totals[client] = (totals[client] || 0) + value;
        });
    });

    const entries = Object.entries(totals)
        .filter(([,val]) => val > 0)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 5);

    const labels = entries.length ? entries.map(([name]) => name) : ['Нет данных'];
    const data = entries.length ? entries.map(([,val]) => val) : [0];

    if (chTopClients) chTopClients.destroy();

    chTopClients = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: getCssVar('--purple') || '#a371f7',
                borderRadius: 10,
                barThickness: 18,
                hoverBackgroundColor: '#c084fc'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${datasetLabel}: ${formatCurrency(ctx.parsed.x)}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.06)' },
                    ticks: {
                        color: getCssVar('--muted') || '#8b949e',
                        callback: value => formatCurrency(value)
                    }
                },
                y: {
                    grid: { display: false },
                    ticks: { color: getCssVar('--text') || '#c9d1d9' }
                }
            }
        }
    });
}

function toggleTopClientsMode() {
    topClientsMode = topClientsMode === 'net' ? 'gross' : 'net';
    if (lastTopClientsScope) {
        updateTopClientsChart(lastTopClientsScope);
    }
}

function exp(){
  const payload = buildBackupSnapshot();
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(payload, null, 2)],{type:'application/json'}));
  a.download=`DesignFlow-Backup-${today}.json`;
  a.click();
}
function expCSV(){
    const escape = v => `"${(v || '').toString().replace(/"/g, '""')}"`;
    let csv = ['Статус', 'Клиент', 'Проект', 'Сумма', 'Чистыми', 'Оплачено (%)', 'Налог (%)', 'Расходы', 'Дата Старта', 'Дедлайн/Сдачи', 'Ссылка'].map(escape).join(';') + '\n';
    const addRows = (list, status) => list.forEach(i => csv += [status, i.c, i.n, i.p, calcNet(i), i.paid||0, i.taxPrc||0, calcContractorAmount(i), i.start||'', i.dl||i.date||'', i.link||''].map(escape).join(';') + '\n');
    addRows(DATA.active, 'В работе'); addRows(DATA.waiting, 'Ожидает'); addRows(DATA.potential, 'Потенциал');
    addRows(DATA.paused, 'На паузе'); addRows(DATA.archive, 'Выполнено');
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `DesignFlow-Export-${today}.csv`; a.click();
}
function imp(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try {
      const parsed = JSON.parse(e.target.result);
      const payload = parsed?.data ? parsed : { data: parsed };
      const normalized = {
        version: payload.version || 2,
        data: { ...DATA, ...(payload.data || {}) },
        uiPrefs: payload.uiPrefs || UI_PREFS,
        nameTemplates: Array.isArray(payload.nameTemplates) ? payload.nameTemplates : NAME_TEMPLATES,
        theme: (payload.uiPrefs || UI_PREFS).themeMode || payload.theme
      };
      localStorage.setItem(K, JSON.stringify(normalized));
      if (payload.uiPrefs) localStorage.setItem(UI_PREFS_KEY, JSON.stringify(payload.uiPrefs));
      if (Array.isArray(normalized.nameTemplates)) localStorage.setItem(NAME_TEMPLATES_KEY, JSON.stringify(normalized.nameTemplates));
    } catch(err) {
      localStorage.setItem(K, e.target.result);
    }
    location.reload();
  };
  r.readAsText(f);
}

window.onload = init;
</script>
</body>
</html>
