<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DesignFlow ‚Äî –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤</title>

<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' ry='6' fill='%230d1117'/%3E%3Cpath d='M11 2 L5 14 H10 L9 22 L19 8 H13 L14 2 Z' fill='%23facc15'/%3E%3C/svg%3E">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0d1117;--card:#161b22;--text:#c9d1d9;--muted:#8b949e;--accent:#58a6ff;--green:#2ea043;--red:#da3633;--gold:#d29922;--border:#30363d;--blue:#007bff;--purple:#a371f7;}
  *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;}
  
  body{background:var(--bg);color:var(--text);padding-bottom:100px;min-height:100vh;display:flex;flex-direction:column;}
  .c{max-width:1600px;margin:0 auto;padding:20px;flex:1;} 
  
  /* Header */
  h1{font-size:42px;font-weight:800;background:linear-gradient(90deg,#58a6ff,#a371f7,#d29922);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0;}
  .header-row{display:flex;justify-content:space-between;align-items:center;margin:30px 0 10px;}
  .month-select{background:var(--card);color:var(--text);border:1px solid var(--accent);padding:10px 20px;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;outline:none;}
  
  /* Controls & Backup Info */
  .top-panel{background:var(--card);padding:20px;border-radius:16px;border:1px solid var(--border);margin-bottom:30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px;}
  .backup-info{color:var(--muted);font-size:13px;max-width:500px;line-height:1.4;}
  .backup-info b{color:#f85149;}
  .btns{display:flex;gap:10px;flex-wrap:wrap;}
  button{padding:10px 20px;background:#21262d;border:1px solid var(--border);color:var(--text);border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:.2s;display:flex;align-items:center;gap:8px;}
  button:hover{border-color:var(--accent);color:var(--accent);}
  
  /* Tabs */
  .tabs{display:flex;gap:10px;margin-bottom:20px;overflow-x: auto; padding-bottom: 5px;}
  .tab{flex-shrink: 0; padding:10px 25px;border-radius:30px;cursor:pointer;font-size:15px; background:#21262d;border:1px solid var(--border);transition:.2s;}
  .tab{font-weight: 500; color:var(--muted);}
  .tab:hover{background:#30363d;border-color:var(--muted);color:var(--text);}
  /* Active Tab & Blue Buttons Text Fix */
  .tab.active, .save-stg, .confirm-del-btn, .resume-btn:hover, .restore-btn:hover {
      background:var(--accent);
      border-color:var(--accent); 
      font-weight: 600; 
      color: #ffffff !important;
  }

/* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–û–î–°–ö–ê–ó–û–ö –ù–ê –í–ö–õ–ê–î–ö–ê–• --- */
  
  /* –î–µ–ª–∞–µ–º –≤–∫–ª–∞–¥–∫—É "—Ä–æ–¥–∏—Ç–µ–ª–µ–º" –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
  .tab {
      position: relative; 
  }

  /* –°–∞–º–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ */
  .tab:hover::after {
      content: attr(data-tooltip); /* –ë–µ—Ä–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ HTML-–∞—Ç—Ä–∏–±—É—Ç–∞ */
      position: absolute;
      top: 125%; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –æ—Ç –∫–Ω–æ–ø–∫–∏ */
      left: 50%;
      transform: translateX(-50%); /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
      
      background: #000;     /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
      color: #fff;          /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
      padding: 8px 12px;    /* –û—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ */
      border-radius: 8px;   /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
      border: 1px solid var(--border);
      
      font-size: 12px;
      font-weight: 400;     /* –¢–æ–Ω–∫–∏–π —à—Ä–∏—Ñ—Ç */
      white-space: nowrap;  /* –¢–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
      z-index: 100;         /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
      pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–∫–∏ */
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      
      /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
      opacity: 0;
      animation: tooltipFade 0.2s forwards;
  }
  
  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
  @keyframes tooltipFade {
      from { opacity: 0; transform: translate(-50%, -5px); }
      to { opacity: 1; transform: translate(-50%, 0); }
  }



  .confirm-del-btn { background: var(--red); border-color: var(--red); }
  .confirm-del-btn:hover { background: #f85149; border-color: #f85149; color: #fff !important; }

  /* MAIN LAYOUT */
  .main-layout {
      display: flex;
      flex-direction: column; 
      gap: 20px; /* –£–º–µ–Ω—å—à–µ–Ω –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
      margin-top: 20px;
  }
  .main-content { width: 100%; }
  .dashboard { width: 100%; }
  
  /* STATS COLUMNS */
  .stats-two-columns { display: flex; gap: 24px; }
  .stats-two-columns .card { flex: 1; min-width: 350px; }
  @media(max-width:800px){ .stats-two-columns{ flex-direction: column; } .stats-two-columns .card { min-width: auto; } }
  
  /* Tables */
  .table-wrap{overflow-x:auto;background:var(--card);border-radius:16px;border:1px solid var(--border);padding:5px;}
  table{width:100%;border-collapse:collapse; min-width: 1200px;} 
  /* –î–æ–±–∞–≤–ª–µ–Ω–æ white-space: nowrap –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —á—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∏ –Ω–µ –ø–∞–¥–∞–ª–∏ */
  th{text-align:left;color:var(--muted);font-size:12px;text-transform:uppercase;padding:15px;border-bottom:1px solid var(--border);user-select:none; white-space: nowrap;}
  td{ padding: 5px 8px; border-bottom:1px solid #21262d; vertical-align:middle; font-size:15px; }
  
  /* Column Widths */
  #t-active th:nth-child(1), #t-active td:nth-child(1) { width: 3%; } 
  #t-active th:nth-child(2), #t-active td:nth-child(2) { width: 14%; min-width: 150px; } 
  #t-active th:nth-child(3), #t-active td:nth-child(3) { width: 18%; min-width: 200px; } 
  #t-active th:nth-child(4), #t-active td:nth-child(4) { width: 10%; min-width: 120px; } 
  #t-active th:nth-child(5), #t-active td:nth-child(5) { width: 10%; min-width: 120px; } 
  #t-active th:nth-child(6), #t-active td:nth-child(6) { width: 8%; min-width: 80px; } 
  #t-active th:nth-child(7), #t-active td:nth-child(7) { width: 5%; min-width: 65px; } 
  #t-active th:nth-child(8), #t-active td:nth-child(8) { width: 9%; min-width: 100px; } 
  #t-active th:nth-child(9), #t-active td:nth-child(9) { width: 9%; min-width: 100px; } 
  #t-active th:nth-child(10), #t-active td:nth-child(10) { width: 7%; min-width: 80px; } 
  #t-active th:nth-child(11), #t-active td:nth-child(11) { width: 7%; min-width: 100px; } 

  tr:last-child td{border-bottom:none;}
  tr:hover td{background:#1c2128;}

  /* Footer Row (Totals) - NOTION LIKE */
  tfoot td {
    padding: 15px 25px;
    border-top: 1px solid var(--border);
    background: transparent; /* –ë–µ–∑ —Ñ–æ–Ω–∞ */
    font-weight: 600;
    color: var(--text); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π */
    text-align: end; 
    font-size: 15px;
    white-space: nowrap;
  }
  tfoot tr:hover td { background: transparent; }
  
  /* Sorting */
  .table-wrap th {cursor: pointer; position: relative;}
  .sort-icon {
      display: inline-block; width: 0; height: 0; margin-left: 6px; vertical-align: middle; 
      border-left: 4px solid transparent; border-right: 4px solid transparent; 
      opacity: 0.4; transition: opacity 0.2s;
  }
  .sort-icon.asc {border-bottom: 5px solid var(--text); opacity: 1;}
  .sort-icon.desc {border-top: 5px solid var(--text); opacity: 1;}
  .table-wrap th:hover .sort-icon {opacity: 0.8;}

  /* Inputs & Links */
  [contenteditable]{ outline:none; background: transparent; border: 1px solid transparent; padding: 5px 8px; border-radius: 6px; transition:.2s; min-width:50px; display:inline-block; width: 100%; }
  [contenteditable]:focus, [contenteditable]:hover { border-color: var(--border); background: #21262d; cursor: text; }
  [contenteditable]:focus { border-color: var(--accent); color: var(--text); }
  
  /* Date Inputs */
  .date-cell { padding: 0 !important; } 
  .date-input-wrap { position: relative; height: 100%; width: 100%; padding: 5px 8px; background: transparent; border: 1px solid transparent; border-radius: 6px; transition: border-color .2s, background-color .2s; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 5px; }
  .date-input-wrap:hover { border-color: var(--border); background: #21262d; }
  .date-text-display { font-size: 15px; font-weight: 500; color: var(--text); white-space: nowrap; display: block; }
  .calendar-icon { color: var(--muted); font-size: 16px; margin-left: auto; transition: color 0.2s; }
  .date-input-wrap:hover .calendar-icon { color: var(--text); }

  /* Number Inputs */
  .price-cell { display: flex; align-items: center; justify-content: flex-end; gap: 5px; width: 100%; background: transparent; border: 1px solid transparent; border-radius: 6px; padding: 5px 8px; transition: border-color .2s, background-color .2s; }
  .price-cell:hover, .price-cell:focus-within { border-color: var(--border); background: #21262d; }
  .price-cell:focus-within { border-color: var(--accent); }
  .price-cell input[type="number"]{ background:transparent;border:none;color:var(--text);width:100%; max-width: 90px; font-family:monospace;font-weight:600;outline:none; text-align:right; padding: 0; margin: 0; }
  .price-cell input[type="number"]:focus{color:var(--accent);}
  .currency-symbol { color: var(--muted); font-size: 14px; font-weight: 600; font-family: monospace; min-width: 18px; text-align: left; }

  /* Selects */
  .paid-select, .tax-select { background: transparent; color: var(--text); border: 1px solid transparent; padding: 5px; border-radius: 6px; font-size: 14px; cursor: pointer; outline: none; min-width: 80px; transition: border-color .2s, background-color .2s; }
  .tax-select { min-width: 65px; text-align: center; }
  .paid-select:hover, .tax-select:hover, .paid-select:focus, .tax-select:focus { border-color: var(--border); background: #21262d; }
  .paid-select:focus, .tax-select:focus { border-color: var(--accent); }
  .paid-select option:checked, .tax-select option:checked { background: var(--accent); color: var(--bg); }

  /* Links */
  .client-wrap{display:flex;align-items:center;gap:8px;}
  .client-name{transition:.2s; border: none !important;} 
  .client-name.has-link{color:var(--accent);font-weight:500;} 
  .link-btn{opacity:0.4;cursor:pointer;font-size:16px;transition:.2s;background:none;border:none;padding:0;}
  .link-btn:hover{opacity:1;transform:scale(1.1);}
  .open-link-btn{ text-decoration:none; color:var(--text); font-size:14px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; transition:.2s; }
  .open-link-btn:hover{background:var(--accent);color:#000;}

  /* Actions */
  .action-btns{display:flex;gap:5px;align-items:center;}
  .action-btns .del-btn{margin-left:auto;}
  .action-btn-base { padding: 6px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer; user-select: none; line-height: 1; transition: background-color 0.2s, color 0.2s, border-color 0.2s; min-width: 32px; text-align: center; }
  .done-btn, .wait-btn, .pause-btn { color: var(--text); background: #21262d; border-color: var(--border); }
  .done-btn:hover { background: var(--green); color: #fff; border-color: var(--green);}
  .wait-btn:hover { background: var(--purple); color: #fff; border-color: var(--purple);}
  .pause-btn:hover { background: var(--blue); color: #fff; border-color: var(--blue);}
  .resume-btn, .restore-btn{ padding: 6px 12px; background:rgba(255, 255, 255, 0.1); color:var(--text); border:1px solid var(--border); border-radius:6px; font-size:12px; font-weight:700; cursor:pointer; user-select:none; white-space: nowrap; }
  .del-btn{color:var(--red);cursor:pointer;font-size:18px;opacity:0.5;}
  .del-btn:hover{opacity:1;}
  
  .add-btn{width:100%;padding:15px;background:var(--card);border:2px dashed var(--border);color:var(--muted);text-align:center;border-radius:12px;cursor:pointer;font-weight:600;transition:.2s;margin-top:10px;}
  .add-btn:hover{border-color:var(--accent);color:var(--accent);background:#1f6feb0f;}

  /* Dashboard */
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;display:flex;flex-direction:column;}
  .card-head{font-size:18px;font-weight:700;margin-bottom:25px;display:flex;justify-content:space-between;align-items:center;}
  
  /* Tooltips */
  .tooltip-wrap{position:relative;display:inline-flex;align-items:center;gap:6px;}
  .info-icon{ width:16px;height:16px;background:#30363d;color:var(--muted);border-radius:50%; font-size:11px;display:flex;justify-content:center;align-items:center;cursor:help;font-weight:bold; }
  .tooltip-text{ visibility:hidden;background:#000;color:#fff;text-align:center;padding:8px 12px;border-radius:8px; position:absolute;bottom:125%;left:50%;transform:translateX(-50%); width:220px;font-size:12px;font-weight:400;opacity:0;transition:0.3s;pointer-events:none;z-index:10; box-shadow:0 5px 15px rgba(0,0,0,0.5);border:1px solid var(--border); line-height: 1.4; }
  .info-icon:hover + .tooltip-text{visibility:visible;opacity:1;bottom:140%;}

  /* Stats Grid */
  .stats-grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:15px;margin-bottom:24px;}
  .stat-box{background:#21262d;padding:15px;border-radius:12px;border:1px solid #30363d;}
  .stat-label{font-size:13px;color:var(--muted);margin-bottom:5px;display:flex;align-items:center;gap:5px;}
  .stat-val{font-size:24px;font-weight:800;color:var(--text);}
  
  /* Progress */
  .goal-wrap{margin-bottom:30px;}
  .goal-info{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px;font-weight:600;}
  .progress-bg{height:14px;background:#0d1117;border-radius:7px;overflow:hidden;border:1px solid #30363d;}
  .progress-fill{height:100%;background:linear-gradient(90deg, var(--green), var(--accent));width:0%;transition:width 1s ease;box-shadow:0 0 15px rgba(46, 160, 67, 0.4);}
  .chart-con{position:relative;height:250px;width:100%;}
  .doughnut-con{position:relative;height:200px;width:100%;display:flex;justify-content:center;margin-bottom:20px;}

  /* Pacing Indicator Block */
  .pace-block { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
  .pace-info { display: flex; align-items: center; gap: 15px; }
  .pace-icon { font-size: 24px; }
  .pace-title { font-weight: 700; font-size: 16px; color: var(--text); }
  .pace-desc { font-size: 13px; color: var(--muted); }
  .pace-status { font-weight: 700; font-size: 14px; padding: 5px 10px; border-radius: 6px; }
  .pace-chill { background: rgba(57, 211, 83, 0.1); color: var(--green); }
  .pace-warn { background: rgba(210, 153, 34, 0.1); color: var(--gold); }
  .pace-hurry { background: rgba(218, 54, 51, 0.1); color: var(--red); }

  /* Modals */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;backdrop-filter: blur(4px);}
  .modal-content{background:var(--card);padding:30px;border-radius:20px;width:400px;max-width:90%;border:1px solid var(--border);text-align:center; position: relative;}
  
  /* Close X button */
  .close-modal-x { position: absolute; top: 15px; right: 20px; font-size: 24px; color: var(--muted); cursor: pointer; transition: .2s; line-height: 1; }
  .close-modal-x:hover { color: var(--text); }

  .inp-group{margin:20px 0;text-align:left;}
  .inp-group label{display:block;color:var(--muted);margin-bottom:8px;font-size:14px;}
  .inp-group input, .inp-group select {background-color: #161b22;border:1px solid var(--border);padding:10px;width:100%;color:var(--text);border-radius:8px; outline: none;}
  .inp-group input:focus, .inp-group select:focus { border-color: var(--accent); }
  
  .save-stg{background:var(--accent);color:#ffffff !important;border:none;width:100%;padding:12px;font-weight:bold;border-radius:8px;cursor:pointer;transition:.2s;}
  .save-stg:hover{opacity:0.8;}

  .delete-modal-btns{display:flex;gap:15px;margin-top:20px;}
  .delete-modal-btns button { width: 50%; padding: 10px; font-weight: 700; }
  
  /* Date Picker Modal */
  .date-modal-content { width: 450px; max-width: 90%; text-align: left; display: flex; flex-direction: column; gap: 20px; }
  .date-time-inputs { display: flex; gap: 15px; }
  .date-time-inputs input[type="date"], .date-time-inputs input[type="time"] { padding: 10px; border: 1px solid var(--border); background: #21262d; border-radius: 8px; color: var(--text); font-size: 16px; flex: 1; font-family: monospace; color-scheme: dark; outline: none; transition: border-color .2s; }
  .date-time-inputs input:focus { border-color: var(--accent); }

  /* Record Banner */
  .bottom-record { margin-top: 40px; background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; text-align: center; display: flex; flex-direction: column; gap: 5px; max-width: 500px; margin-left: auto; margin-right: auto; }
  .bottom-record-label { color: var(--muted); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
  .bottom-record-val { font-size: 28px; font-weight: 800; color: var(--gold); font-family: monospace; }

  /* Footer Motivation */
  .footer-mot{margin-top:20px;text-align:center;padding:40px;background:linear-gradient(180deg, transparent, #161b22);border-radius:20px;cursor:pointer;transition:.3s;}
  .footer-mot:hover{transform:translateY(-5px);}
  .mot-emoji{font-size:40px;margin-bottom:10px;display:block;}
  .mot-text{font-size:24px;font-weight:800;background:linear-gradient(90deg,#fff,#8b949e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .mot-sub{color:var(--muted);font-size:14px;margin-top:10px;}

  .text-green{color:var(--green);}
  .text-gold{color:var(--gold);}
  .text-blue{color:var(--blue);}
  .text-purple{color:var(--purple);}
  .mono{font-family:monospace;}
  
  /* Deadline Visuals */
  .days-normal{background:rgba(46, 160, 67, 0.1); color:var(--green)!important; font-weight:700; border-radius: 4px; padding: 4px 8px; display: block; white-space: nowrap; min-width: 80px; text-align: center;}
  .days-warning{background:rgba(210, 153, 34, 0.1); color:var(--gold)!important; font-weight:700; border-radius: 4px; padding: 4px 8px; display: block; white-space: nowrap; min-width: 80px; text-align: center;}
  .days-critical{background:rgba(218, 54, 51, 0.1); color:var(--red)!important; font-weight:700; border-radius: 4px; padding: 4px 8px; display: block; white-space: nowrap; min-width: 80px; text-align: center;}
  

/* --- –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –ë–ï–õ–ê–Ø –ò–ö–û–ù–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø --- */

/* 1. –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —á–µ—Ä–Ω—É—é –∏–∫–æ–Ω–∫—É –≤–æ –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö */
input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;       /* –î–µ–ª–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π */
    position: absolute; /* –ü–æ–º–µ—â–∞–µ–º –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ –∏–Ω–ø—É—Ç–∞ */
    width: 100%;
    height: 100%;
    cursor: pointer;
}

/* 2. –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–ø—É—Ç–∞ */
input[type="date"] {
    position: relative; /* –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∫—Ä—ã—Ç–æ–π –∏–∫–æ–Ω–∫–∏ */
    background-color: var(--card); 
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∞–≤—ã–π padding, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–ø–æ–ª–∑–∞–ª –Ω–∞ –∏–∫–æ–Ω–∫—É */
    padding: 8px 35px 8px 10px; 
    
    /* 3. –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –ë–ï–õ–£–Æ –∏–∫–æ–Ω–∫—É (SVG-–∫–æ–¥) –∫–∞–∫ —Ñ–æ–Ω */
    /* –¶–≤–µ—Ç %23c9d1d9 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π --text */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23c9d1d9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center; /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫—É —Å–ø—Ä–∞–≤–∞ */
    background-size: 18px 18px; /* –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ */
}

/* --- –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –í–°–ï–• –°–¢–ê–ù–î–ê–†–¢–ù–´–• –ò–ö–û–ù–û–ö –ò –°–ü–ò–ù–ù–ï–†–û–í --- */

/* 1. –°–∫—Ä—ã–≤–∞–µ–º –≤ Firefox */
input[type="date"] {
    -moz-appearance: textfield;
}

/* 2. –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã (—Å—Ç—Ä–µ–ª–æ—á–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑) –≤ Chrome/Safari/Edge */
input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
    display: none;
}

/* 3. –°–∫—Ä—ã–≤–∞–µ–º —Å–∞–º –∑–Ω–∞—á–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –≤ Chrome/Safari/Edge */
input[type="date"]::-webkit-calendar-picker-indicator {
    /* –≠—Ç–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ */
    -webkit-appearance: none !important; 
    
    /* –î–µ–ª–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–≤–∏–¥–∏–º—ã–º, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∏–∫ */
    opacity: 0 !important; 
    
    /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –µ–≥–æ –Ω–∞ –≤—Å—é –ø–ª–æ—â–∞–¥—å, —á—Ç–æ–±—ã –∫–ª–∏–∫ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –æ—Ç–∫—Ä—ã–≤–∞–ª –∫–∞–ª–µ–Ω–¥–∞—Ä—å */
    width: 100% !important; 
    height: 100% !important;
    position: absolute !important;
    cursor: pointer;
    background: none !important;
}

/* 4. –°—Ç–∏–ª–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ HTML-–±–ª–æ–∫–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏) */
.date-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
}
#add-proj-dl { /* –°–∫—Ä—ã—Ç—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–ø—É—Ç type="date" */
    z-index: 2; 
}
#add-proj-dl-display { /* –í–∏–¥–∏–º—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏–Ω–ø—É—Ç */
    z-index: 1;
}
.calendar-icon { /* –í–∞—à–∞ –±–µ–ª–∞—è –∏–∫–æ–Ω–∫–∞ */
    color: var(--text); 
    z-index: 1;
    pointer-events: none;
}
  
</style>
</head>
<body>

<div class="c">
  
  <div class="header-row">
    <h1>DesignFlow Tracker</h1>
    <div style="display:flex;gap:15px;align-items:center">
        <button onclick="openSettings()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ª–µ–π</button>
        <select id="monthSelect" class="month-select" onchange="changeMonth(this.value)"></select>
    </div>
  </div>

  <div class="top-panel">
    <div class="backup-info">
      <b>‚ö† –í–∞–∂–Ω–æ:</b> –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. <br>
      –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∏–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫—ç—à–∞ –∏–ª–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.
    </div>
    <div class="btns">
      <button onclick="exp()">üíæ –°–∫–∞—á–∞—Ç—å –±–∞–∑—É (–ë—ç–∫–∞–ø)</button>
      <button onclick="document.getElementById('imp').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É</button>
      <input type="file" id="imp" accept=".json" style="display:none" onchange="imp(this.files[0])">
      <button onclick="expCSV()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
    </div>
  </div>

  
<div class="tabs">
    <div class="tab active" id="tab-active" onclick="switchTab('active')" 
         data-tooltip="–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ —Ä–∞–±–æ—Ç–µ (—Å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–æ–π)">–í —Ä–∞–±–æ—Ç–µ</div>
         
    <div class="tab" id="tab-waiting" onclick="switchTab('waiting')" 
         data-tooltip="–ü—Ä–æ–µ–∫—Ç—ã –∂–¥—É—Ç –æ—Ç–≤–µ—Ç–∞/–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞">–û–∂–∏–¥–∞–µ—Ç</div>
         
    <div class="tab" id="tab-potential" onclick="switchTab('potential')" 
         data-tooltip="–õ–∏–¥—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–µ—â–µ –Ω–µ –Ω–∞—á–∞—Ç—ã)">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</div>
         
    <div class="tab" id="tab-paused" onclick="switchTab('paused')" 
         data-tooltip="–í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã">–ù–∞ –ø–∞—É–∑–µ</div>
         
    <div class="tab" id="tab-archive" onclick="switchTab('archive')" 
         data-tooltip="–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç—ã–µ –∏ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (–∞—Ä—Ö–∏–≤)</div>
  </div>

<div class="main-layout">
    <div class="main-content">
        <div id="view-active">
          <div class="table-wrap">
            <table id="t-active">
              <thead>
                <tr>
                  <th width="3%">‚Ññ</th>
                  <th width="14%" onclick="sortData('active', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon" data-key="c"></span></th> 
                  <th width="18%" onclick="sortData('active', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon" data-key="n"></span></th> 
                  <th width="10%" onclick="sortData('active', 'start', 'date')">–°—Ç–∞—Ä—Ç <span class="sort-icon" data-key="start"></span></th> 
                  <th width="10%" onclick="sortData('active', 'dl', 'date')">–î–µ–¥–ª–∞–π–Ω <span class="sort-icon" data-key="dl"></span></th> 
                  <th width="8%">–û—Å—Ç–∞–ª–æ—Å—å</th>
                  <th width="5%">–ù–∞–ª–æ–≥ (%)</th>
                  <th width="9%" onclick="sortData('active', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon" data-key="p"></span></th>
                  <th width="9%" onclick="sortData('active', 'pr', 'number')">–ß–∏—Å—Ç—ã–º–∏ <span class="sort-icon" data-key="pr"></span></th>
                  <th width="7%" onclick="sortData('active', 'paid', 'number')">–û–ø–ª–∞—á–µ–Ω–æ <span class="sort-icon" data-key="paid"></span></th>
                  <th width="7%"></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot id="total-row-active">
                  <tr><td colspan="11"></td></tr>
              </tfoot>
            </table>
          </div>
          <div class="add-btn" onclick="openAddModal()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
        </div>

        <div id="view-waiting" style="display:none">
            <div class="table-wrap">
              <table id="t-waiting">
                <thead>
                  <tr>
                    <th width="5%">‚Ññ</th>
                    <th width="20%">–ö–ª–∏–µ–Ω—Ç</th> 
                    <th width="30%">–ü—Ä–æ–µ–∫—Ç</th> 
                    <th width="15%">–î–µ–¥–ª–∞–π–Ω</th>
                    <th width="15%">–°—É–º–º–∞</th>
                    <th width="15%"></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot id="total-row-waiting">
                  <tr><td colspan="6"></td></tr>
                </tfoot>
              </table>
            </div>
            <div class="add-btn" onclick="openAddModal()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
        </div>
        
        <div id="view-potential" style="display:none">
            <div class="table-wrap">
              <table id="t-potential">
                <thead>
                  <tr>
                    <th width="5%">‚Ññ</th>
                    <th width="25%" onclick="sortData('potential', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon" data-key="c"></span></th> 
                    <th width="40%" onclick="sortData('potential', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon" data-key="n"></span></th> 
                    <th width="15%" onclick="sortData('potential', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon" data-key="p"></span></th>
                    <th width="15%"></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot id="total-row-potential">
                  <tr><td colspan="5"></td></tr>
                </tfoot>
              </table>
            </div>
            <div class="add-btn" onclick="openAddModal()">Ôºã –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑</div>
        </div>

        <div id="view-paused" style="display:none">
          <div class="table-wrap">
            <table id="t-paused">
              <thead>
                <tr>
                  <th width="5%">‚Ññ</th>
                  <th width="20%">–ö–ª–∏–µ–Ω—Ç</th> 
                  <th width="30%">–ü—Ä–æ–µ–∫—Ç</th> 
                  <th width="15%">–î–µ–¥–ª–∞–π–Ω</th>
                  <th width="15%">–°—É–º–º–∞</th>
                  <th width="15%"></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot id="total-row-paused">
                  <tr><td colspan="6"></td></tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div id="view-archive" style="display:none">
          <div class="table-wrap">
            <table id="t-archive">
              <thead>
                <tr>
                  <th width="5%">‚Ññ</th>
                  <th width="15%" onclick="sortData('archive', 'c', 'string')">–ö–ª–∏–µ–Ω—Ç <span class="sort-icon" data-key="c"></span></th> 
                  <th width="25%" onclick="sortData('archive', 'n', 'string')">–ü—Ä–æ–µ–∫—Ç <span class="sort-icon" data-key="n"></span></th> 
                  <th width="15%" onclick="sortData('archive', 'date', 'date')">–î–∞—Ç–∞ —Å–¥–∞—á–∏ <span class="sort-icon" data-key="date"></span></th>
                  <th width="15%" onclick="sortData('archive', 'p', 'number')">–°—É–º–º–∞ <span class="sort-icon" data-key="p"></span></th>
                  <th width="15%" onclick="sortData('archive', 'pr', 'number')">–ß–∏—Å—Ç—ã–º–∏ <span class="sort-icon" data-key="pr"></span></th>
                  <th width="10%"></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot id="total-row-archive">
                  <tr><td colspan="7"></td></tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div> 
      
      <div class="pace-block" id="pace-indicator" style="display:none;">
          <div class="pace-info">
              <div class="pace-icon">üö¶</div>
              <div>
                  <div class="pace-title" id="pace-title">–ê–Ω–∞–ª–∏–∑ –¥–µ–¥–ª–∞–π–Ω–æ–≤</div>
                  <div class="pace-desc" id="pace-desc">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
              </div>
          </div>
          <div class="pace-status" id="pace-status">–ù–æ—Ä–º–∞</div>
      </div>

      <div class="dashboard">
        <div class="stats-full stats-two-columns"> 
            <div class="card">
                <div class="card-head">
                    <span>–§–∏–Ω–∞–Ω—Å—ã: <span class="text-green" id="dash-month-name">...</span></span>
                </div>
                
                <div class="goal-wrap">
                    <div class="goal-info">
                        <div class="tooltip-wrap">
                            <span>–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ (–û–±—â–∏–π –§–∞–∫—Ç –ß–∏—Å—Ç—ã–º–∏)</span>
                            <div class="info-icon">?</div>
                            <div class="tooltip-text">–û—Ç–Ω–æ—à–µ–Ω–∏–µ –æ–±—â–µ–π —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ (–ê—Ä—Ö–∏–≤ + –ü–æ–ª—É—á–µ–Ω–æ –ø–æ Active) –∫ –≤–∞—à–µ–π –º–µ—Å—è—á–Ω–æ–π —Ü–µ–ª–∏.</div>
                        </div>
                        <span id="goal-text">0 / 0 ‚ÇΩ</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" id="p-bar"></div></div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">
                            –§–∞–∫—Ç (–ß–∏—Å—Ç—ã–º–∏)
                            <div class="tooltip-wrap"><div class="info-icon">?</div><div class="tooltip-text">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –∑–∞–∫—Ä—ã—Ç—ã–µ –ø—Ä–æ–µ–∫—Ç—ã (–ê—Ä—Ö–∏–≤) + –ß–∏—Å—Ç–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –ø–æ Active.</div></div>
                        </div>
                        <div class="stat-val text-green mono" id="val-fact">0 ‚ÇΩ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">
                            –ü–æ–ª—É—á–µ–Ω–æ (–ß–∏—Å—Ç—ã–º–∏, Active)
                            <div class="tooltip-wrap"><div class="info-icon">?</div><div class="tooltip-text">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –æ—Ç –ø—Ä–µ–¥–æ–ø–ª–∞—Ç –ø–æ —Ç–µ–∫—É—â–∏–º –ø—Ä–æ–µ–∫—Ç–∞–º (Active).</div></div>
                        </div>
                        <div class="stat-val text-blue mono" id="val-fact-active">0 ‚ÇΩ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">
                            –ü–ª–∞–Ω (–û—Å—Ç–∞—Ç–æ–∫)
                            <div class="tooltip-wrap"><div class="info-icon">?</div><div class="tooltip-text">–û—Å—Ç–∞–≤—à–∞—è—Å—è —Å—É–º–º–∞ (–ß–∏—Å—Ç—ã–º–∏) –ø–æ Active, Waiting, Paused.</div></div>
                        </div>
                        <div class="stat-val text-gold mono" id="val-plan">0 ‚ÇΩ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">
                            –ü—Ä–æ–≥–Ω–æ–∑ –∏—Ç–æ–≥–∞ (–§–∞–∫—Ç + –ü–ª–∞–Ω)
                            <div class="tooltip-wrap"><div class="info-icon">?</div><div class="tooltip-text">–°–∫–æ–ª—å–∫–æ –≤—ã –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç–µ —á–∏—Å—Ç—ã–º–∏, –µ—Å–ª–∏ –∑–∞–∫—Ä–æ–µ—Ç–µ –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã (–∏—Å–∫–ª—é—á–∞—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª).</div></div>
                        </div>
                        <div class="stat-val mono" id="val-total" style="color:var(--text)">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-head">
                    <span>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤</span>
                </div>
                <div class="doughnut-con">
                    <canvas id="doughnutChart"></canvas>
                </div>
                <div class="bottom-record">
                    <div class="bottom-record-label">–õ–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥ (–§–∞–∫—Ç –ß–∏—Å—Ç—ã–º–∏)</div>
                    <div class="bottom-record-val" id="bottom-rec-val">0 ‚ÇΩ</div>
                </div>
            </div>
        </div>

        <div class="stats-light" style="display:none">
            <div class="card">
                <div class="card-head">
                    <span id="light-stats-title">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –∑–∞–∫–∞–∑–æ–≤</span>
                    <div class="tooltip-wrap">
                        <span class="text-gold" id="val-light-secondary">0 ‚ÇΩ</span>
                        <div class="info-icon">?</div>
                        <div class="tooltip-text" id="val-light-secondary-tooltip"></div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label" id="val-light-main-label">
                            –û–±—â–∞—è —Å—É–º–º–∞
                            <div class="tooltip-wrap"><div class="info-icon">?</div><div class="tooltip-text" id="val-light-main-tooltip">–°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö, –æ–∂–∏–¥–∞—é—â–∏—Ö –∏–ª–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–±—Ä—É—Ç—Ç–æ).</div></div>
                        </div>
                        <div class="stat-val text-gold mono" id="val-light-main">0 ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top:20px; display:none;" id="chart-bar-wrap">
            <div class="card-head">
                <span>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤</span>
            </div>
            <div class="chart-con">
                <canvas id="barChart"></canvas>
            </div>
        </div>
      </div>
      
      <div class="footer-mot" onclick="newQuote()">
          <span class="mot-emoji">‚≠ê</span>
          <div class="mot-text" id="quote-text">...</div>
          <div class="mot-sub">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –º–æ—Ç–∏–≤–∞—Ü–∏—é!</div>
      </div>
      
</div>

<div class="modal" id="addProjectModal">
  <div class="modal-content">
    <span class="close-modal-x" onclick="closeAddModal()">√ó</span>
    <h3 style="margin-bottom:10px">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
    <div class="inp-group">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
      <input type="text" id="add-proj-name" placeholder="–õ–æ–≥–æ—Ç–∏–ø –¥–ª—è –∫–æ—Ñ–µ–π–Ω–∏">
    </div>
    <div class="inp-group">
      <label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
      <input type="text" id="add-proj-client" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
    </div>
    <div class="inp-group">
      <label for="add-proj-start">–î–∞—Ç–∞ –°—Ç–∞—Ä—Ç–∞</label>
      <input type="date" id="add-proj-start">
    </div>
    <div class="inp-group">
      <label>–°—É–º–º–∞ (‚ÇΩ)</label>
      <input type="number" id="add-proj-price" placeholder="15000">
    </div>
    <div class="inp-group" id="add-proj-dl-group">
      <label for="add-proj-dl">–î–µ–¥–ª–∞–π–Ω</label>
      <div class="date-input-wrapper">
        <input type="date" id="add-proj-dl" required>
      </div>
    </div>
    <div class="inp-group">
      <label>–ö—É–¥–∞ –¥–æ–±–∞–≤–∏—Ç—å?</label>
      <select id="add-proj-type">
        <option value="active">–í —Ä–∞–±–æ—Ç—É</option>
        <option value="potential">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª</option>
        <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
      </select>
    </div>
    <button class="save-stg" onclick="saveNewProject()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
  </div>
</div>

<div class="modal" id="linkModal">
  <div class="modal-content">
    <span class="close-modal-x" onclick="closeLinkModal()">√ó</span>
    <h3 style="margin-bottom:10px">–í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <p style="color:var(--muted); font-size: 14px; margin-bottom: 15px;"> –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º (VK, Telegram –∏ —Ç.–ø.), —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–ø–∏—Å–∫—É. </p>
    <div class="inp-group">
      <input type="url" id="link-input" placeholder="https://t.me/client_id">
    </div>
    <button class="save-stg" id="saveLinkBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
  </div>
</div>

<div class="modal" id="dateModal">
  <div class="modal-content date-modal-content">
    <span class="close-modal-x" onclick="closeDateModal()">√ó</span>
    <h3 id="date-modal-title" style="margin-bottom:15px">–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É</h3>
    <div class="inp-group">
      <label>–î–∞—Ç–∞</label>
      <input type="date" id="date-input-date" required>
    </div>
    <div class="inp-group">
      <label>–í—Ä–µ–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input type="time" id="date-input-time">
    </div>
    <button class="save-stg" id="saveDateBtn" onclick="saveDate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—É</button>
  </div>
</div>

<div class="modal" id="deleteConfirmModal">
  <div class="modal-content" style="width:350px;">
    <h3 style="margin-bottom:10px">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
    <p style="color:var(--muted); font-size: 15px; margin-bottom: 5px;">
        –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç:
    </p>
    <p id="delete-proj-name" style="font-weight:600; font-size:16px; color:var(--red);"></p>
    <div class="delete-modal-btns">
        <button onclick="closeDeleteConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="confirm-del-btn" id="confirmDeleteBtn" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞</button>
    </div>
  </div>
</div>

<div class="modal" id="settingsModal">
  <div class="modal-content" style="width:350px;">
    <span class="close-modal-x" onclick="closeSettings()">√ó</span>
    <h3 style="margin-bottom:10px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ª–µ–π</h3>
    
    <div class="inp-group">
        <label>–õ–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥ (–ß–∏—Å—Ç—ã–º–∏, ‚ÇΩ)</label>
        <input type="number" id="settings-record" placeholder="300000">
    </div>

    <div class="inp-group">
        <label for="settings-goal">–¶–µ–ª—å –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (–ß–∏—Å—Ç—ã–º–∏, ‚ÇΩ)</label>
        <input type="number" id="settings-goal" placeholder="250000">
    </div>
    
    <button class="save-stg" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>
</div>

<script>
const K = 'design_flow_tracker_v3';
let DATA = {};
let SORT_STATE = {
    active: {key: 'dl', direction: 'asc', dataType: 'date'},
    archive: {key: 'date', direction: 'desc', dataType: 'date'},
    potential: {key: 'p', direction: 'desc', dataType: 'number'},
    waiting: {key: 'dl', direction: 'asc', dataType: 'date'},
    paused: {key: 'dl', direction: 'asc', dataType: 'date'},
};
let currentMonth = new Date().toISOString().slice(0, 7);
let today = new Date().toISOString().slice(0, 16);
const ONE_HOUR = 3600000;
let deleteQueue = { type: null, index: null };
let dateQueue = { type: null, index: null, field: null }; 
let chartM, chartP, chartB; // Chart.js instances

// --- CORE ---
function init(){
    // ********************************************
    // FIX 2: –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
    document.getElementById('saveLinkBtn').addEventListener('click', saveLink); 
    // ********************************************

    const exist = localStorage.getItem(K);
    const defaultData = {
        settings: {
            record: 387000
        },
        monthlyGoals: {
            [currentMonth.slice(0,7)]: 250000
        },
        active: [],
        archive: [],
        paused: [],
        waiting: [],
        potential: [],
    };
    let loadedData = {};
    if (exist) {
        try {
            loadedData = JSON.parse(exist);
        } catch(e) {
            console.error(e);
        }
    }
    
    DATA.settings = {...defaultData.settings, ...loadedData.settings};
    DATA.monthlyGoals = {...defaultData.monthlyGoals, ...loadedData.monthlyGoals};
    DATA.active = loadedData.active || defaultData.active;
    DATA.archive = loadedData.archive || defaultData.archive;
    DATA.paused = loadedData.paused || defaultData.paused;
    DATA.waiting = loadedData.waiting || defaultData.waiting;
    DATA.potential = loadedData.potential || defaultData.potential;

    if (loadedData.sortState) SORT_STATE = {...SORT_STATE, ...loadedData.sortState};

    // Data Sanitization / Migration
    [...DATA.active, ...DATA.paused, ...DATA.waiting, ...DATA.archive, ...DATA.potential].forEach(item => {
        if (item.paid === undefined || item.paid === null) item.paid = 0;
        if (item.p === undefined || item.p === null) item.p = 0;
        if (item.pr === undefined || item.pr === null) item.pr = 0;
        if (item.taxPrc === undefined || item.taxPrc === null) item.taxPrc = 0;
        // Trim timestamps to the first 16 characters (YYYY-MM-DDTHH:MM)
        if (item.start && item.start.length > 16) item.start = item.start.slice(0, 16);
        if (item.dl && item.dl.length > 16) item.dl = item.dl.slice(0, 16);
        if (item.date && item.date.length > 16) item.date = item.date.slice(0, 16);
    });
    
    DATA.active.forEach(p => {
        p.pr = p.p > 0 ? Math.round(p.p * (1 - ((p.taxPrc||0) / 100))) : 0;
    });

    renderMonthSelect();
    sortData('active', SORT_STATE.active.key, SORT_STATE.active.dataType, true);
    sortData('archive', SORT_STATE.archive.key, SORT_STATE.archive.dataType, true);
    sortData('potential', SORT_STATE.potential.key, SORT_STATE.potential.dataType, true);
    sortData('waiting', SORT_STATE.waiting.key, SORT_STATE.waiting.dataType, true);
    sortData('paused', SORT_STATE.paused.key, SORT_STATE.paused.dataType, true);
    upd();
    newQuote(); // Set initial motivational quote
}

function save(){
    try {
        localStorage.setItem(K, JSON.stringify({...DATA, sortState: SORT_STATE}));
    } catch(e) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ! –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±—Ä–∞—É–∑–µ—Ä–∞.');
    }
}

function exp(){
    const dataStr = JSON.stringify(DATA, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DesignFlow_Backup_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function imp(file){
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
            if (!importedData.active || !importedData.archive) {
                alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.');
                return;
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
            DATA.settings = importedData.settings || DATA.settings;
            DATA.monthlyGoals = importedData.monthlyGoals || DATA.monthlyGoals;
            DATA.active = importedData.active || DATA.active;
            DATA.archive = importedData.archive || DATA.archive;
            DATA.paused = importedData.paused || DATA.paused;
            DATA.waiting = importedData.waiting || DATA.waiting;
            DATA.potential = importedData.potential || DATA.potential;
            SORT_STATE = importedData.sortState || SORT_STATE;
            
            // Re-run init logic to sanitize and update UI
            init(); 
            alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
            document.getElementById('imp').value = ''; // Reset input field
        } catch(err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–ª–∏ —Ä–∞–∑–±–æ—Ä–µ —Ñ–∞–π–ª–∞: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function expCSV() {
    let csvContent = "data:text/csv;charset=utf-8,";
    const header = [
        "–°—Ç–∞—Ç—É—Å", "–ö–ª–∏–µ–Ω—Ç", "–ü—Ä–æ–µ–∫—Ç", "–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞", "–î–µ–¥–ª–∞–π–Ω", "–î–∞—Ç–∞ —Å–¥–∞—á–∏", 
        "–°—É–º–º–∞ (‚ÇΩ, –ë—Ä—É—Ç—Ç–æ)", "–ù–∞–ª–æ–≥ (%)", "–ß–∏—Å—Ç–∞—è —Å—É–º–º–∞ (‚ÇΩ, –ù–µ—Ç—Ç–æ)", "–û–ø–ª–∞—á–µ–Ω–æ (%)", "–°—Å—ã–ª–∫–∞"
    ];
    csvContent += header.join(";") + "\n";

    const allProjects = [
        ...DATA.active.map(p => ({...p, status: '–í —Ä–∞–±–æ—Ç–µ'})),
        ...DATA.waiting.map(p => ({...p, status: '–û–∂–∏–¥–∞–µ—Ç'})),
        ...DATA.paused.map(p => ({...p, status: '–ù–∞ –ø–∞—É–∑–µ'})),
        ...DATA.potential.map(p => ({...p, status: '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª'})),
        ...DATA.archive.map(p => ({...p, status: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'})),
    ];
    
    allProjects.forEach(p => {
        const row = [
            p.status,
            `"${(p.c || '').replace(/"/g, '""')}"`,
            `"${(p.n || '').replace(/"/g, '""')}"`,
            p.start ? formatDateForDisplay(p.start, true) : '',
            p.dl ? formatDateForDisplay(p.dl, true) : '',
            p.date ? formatDateForDisplay(p.date, true) : '',
            p.p || 0,
            p.taxPrc || 0,
            p.pr || 0,
            p.paid || 0,
            p.link || ''
        ].join(";");
        csvContent += row + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `DesignFlow_Export_${new Date().toISOString().slice(0, 10)}.csv`);
    document.body.appendChild(link); 
    link.click(); 
    document.body.removeChild(link);
}

function updateRow(type, idx, field, val) {
    const item = DATA[type][idx];
    item[field] = val;
    // Special handling for client name to remove formatting on save
    if (field === 'c') {
        const span = document.querySelector(`#t-${type} tbody tr:nth-child(${idx + 1}) .client-name`);
        if(span) span.innerText = val;
    }
    save();
    upd();
}

function updatePrice(type, idx, field, val) {
    const item = DATA[type][idx];
    item[field] = parseFloat(val) || 0;
    if (field === 'p' && ['active','paused','waiting'].includes(type)) {
        item.pr = item.p > 0 ? Math.round(item.p * (1 - ((item.taxPrc||0) / 100))) : 0;
    }
    save();
    renderMonthSelect();
    upd();
}

// --- ADD PROJECT MODAL ---
function openAddModal() {
    const activeTab = getActiveTab();
    const typeSelect = document.getElementById('add-proj-type');
    if(['active','potential','waiting'].includes(activeTab)) typeSelect.value = activeTab;
    else typeSelect.value = 'active';

    // Clear inputs
    document.getElementById('add-proj-name').value = '';
    document.getElementById('add-proj-client').value = '';
    document.getElementById('add-proj-price').value = '';
    
    // Set default dates
    const currentDate = new Date();
    const isoDate = currentDate.toISOString().slice(0, 10);
    currentDate.setDate(currentDate.getDate() + 7); // Default deadline is +7 days
    const defaultDl = currentDate.toISOString().slice(0, 10);

    document.getElementById('add-proj-start').value = isoDate;
    document.getElementById('add-proj-dl').value = defaultDl;
    
    document.getElementById('addProjectModal').style.display = 'flex';
}

function closeAddModal() {
    document.getElementById('addProjectModal').style.display = 'none';
}

function saveNewProject() {
    const type = document.getElementById('add-proj-type').value;
    const name = document.getElementById('add-proj-name').value;
    const client = document.getElementById('add-proj-client').value;
    const price = document.getElementById('add-proj-price').value;
    const start = document.getElementById('add-proj-start').value;
    const dl = document.getElementById('add-proj-dl').value;

    if (!name || !client) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞.');
        return;
    }

    const newItem = { 
        n: name, 
        c: client, 
        link: '', 
        p: +price || 0, 
        taxPrc: 0 
    };

    if (type !== 'potential') {
        newItem.start = start || today;
        newItem.dl = dl || today;
        newItem.pr = newItem.p; // Default pr same as p before tax
        // Default paid percentage: 50% for active, 0 for others
        newItem.paid = type === 'active' ? 50 : 0; 
    }
    
    DATA[type].unshift(newItem);
    
    if (type !== 'waiting' && type !== 'paused') sortData(type, SORT_STATE[type].key, SORT_STATE[type].dataType, true);
    
    save();
    closeAddModal();
    upd();
    switchTab(type);
}

// *** –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –°–°–´–õ–ö–ò ***
function saveLink() {
    const { type, index } = dateQueue;
    let link = document.getElementById('link-input').value.trim();

    if (type && index !== null && DATA[type] && DATA[type][index]) {
        // –î–æ–±–∞–≤–ª—è–µ–º 'https://' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ —É–∫–∞–∑–∞–Ω, –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        if (link && !link.match(/^(https?:\/\/|mailto:)/i)) {
            link = 'https://' + link; 
        }
        
        DATA[type][index].link = link; 
        save();
        upd();
        closeLinkModal();
    } else {
        closeLinkModal();
    }
}
// *** –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ***


// --- MODALS (Date, Link, Delete, Settings) ---
function openDateModal(type, idx, field, title) {
    dateQueue = { type, index: idx, field };
    const item = DATA[type][idx];
    const currentValue = item[field];
    
    document.getElementById('date-modal-title').textContent = `–í—ã–±—Ä–∞—Ç—å ${title}`;
    
    if (currentValue) {
        const datePart = currentValue.slice(0, 10);
        const timePart = currentValue.length > 10 ? currentValue.slice(11, 16) : '';
        document.getElementById('date-input-date').value = datePart;
        document.getElementById('date-input-time').value = timePart;
    } else {
        document.getElementById('date-input-date').value = '';
        document.getElementById('date-input-time').value = '';
    }
    
    document.getElementById('dateModal').style.display = 'flex';
}

function closeDateModal() {
    document.getElementById('dateModal').style.display = 'none';
    dateQueue = { type: null, index: null, field: null };
}

function saveDate() {
    const { type, index, field } = dateQueue;
    const date = document.getElementById('date-input-date').value;
    const time = document.getElementById('date-input-time').value;
    
    if (!type || index === null || !date) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É.');
        return;
    }
    
    let combinedDate = date;
    if (time) {
        combinedDate += `T${time}`;
    } else {
        // Append a default time (like 00:00) if only date is provided
        combinedDate += `T00:00`; 
    }
    
    DATA[type][index][field] = combinedDate;
    
    // Additional logic for 'active' projects
    if (type === 'active' && (field === 'dl' || field === 'start')) {
        // Re-sort if deadline or start date is changed
        sortData('active', SORT_STATE.active.key, SORT_STATE.active.dataType, true);
    }
    
    save();
    upd();
    closeDateModal();
}

function openLinkModal(type, idx) {
    dateQueue = { type, index: idx, field: 'link' }; // Reusing dateQueue for link context
    const item = DATA[type][idx];
    document.getElementById('link-input').value = item.link || '';
    document.getElementById('linkModal').style.display = 'flex';
}

function closeLinkModal() {
    document.getElementById('linkModal').style.display = 'none';
    dateQueue = { type: null, index: null, field: null };
}

function openDeleteConfirmModal(type, idx) {
    deleteQueue = { type, index: idx };
    const item = DATA[type][idx];
    document.getElementById('delete-proj-name').textContent = item.n;
    document.getElementById('deleteConfirmModal').style.display = 'flex';
}

function closeDeleteConfirmModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    deleteQueue = { type: null, index: null };
}

function confirmDelete() {
    const { type, index } = deleteQueue;
    if (type && index !== null) {
        DATA[type].splice(index, 1);
        save();
        upd();
        closeDeleteConfirmModal();
    }
}

function openSettings() {
    document.getElementById('settings-record').value = DATA.settings.record || 0;
    document.getElementById('settings-goal').value = DATA.monthlyGoals[currentMonth] || 0;
    document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettings() {
    document.getElementById('settingsModal').style.display = 'none';
}

function saveSettings() {
    DATA.settings.record = parseFloat(document.getElementById('settings-record').value) || 0;
    DATA.monthlyGoals[currentMonth] = parseFloat(document.getElementById('settings-goal').value) || 0;
    save();
    upd();
    closeSettings();
}

// --- MOVEMENT FUNCTIONS ---
function moveToArchive(idx, fromType) {
    const item = DATA[fromType][idx];
    
    // Ensure the date is set to now (or a date picker can be opened)
    const today = new Date().toISOString().slice(0, 16);
    
    const finishedItem = {
        n: item.n,
        c: item.c,
        link: item.link,
        date: today, // Date of completion
        p: item.p,
        pr: item.pr,
        taxPrc: item.taxPrc
    };
    
    DATA[fromType].splice(idx, 1);
    DATA.archive.unshift(finishedItem);
    
    save();
    renderMonthSelect();
    upd();
    switchTab('archive');
}

function restoreFromArchive(idx){
    const item = DATA.archive[idx];
    DATA.archive.splice(idx, 1);

    const restoredItem = {
        n: item.n,
        c: item.c,
        link: item.link,
        start: today, // Set start to today
        dl: today,    // Set deadline to today (needs manual adjustment later)
        p: item.p,
        pr: item.pr,
        paid: 50,     // Default to 50% paid
        taxPrc: item.taxPrc
    };
    
    DATA.active.unshift(restoredItem);
    sortData('active', 'dl', 'date', true);
    save();
    upd();
    switchTab('active');
}

function moveToPaused(idx, fromType){
    const item = DATA[fromType][idx];
    DATA[fromType].splice(idx, 1);
    DATA.paused.unshift(item);
    save();
    upd();
    switchTab('paused');
}

function moveToWaiting(idx, fromType){
    const item = DATA[fromType][idx];
    DATA[fromType].splice(idx, 1);
    DATA.waiting.unshift(item);
    save();
    upd();
    switchTab('waiting');
}

function moveToActive(idx, fromType){
    const item = DATA[fromType][idx];
    DATA[fromType].splice(idx, 1);
    
    item.start = today; // Set start date to today
    
    // For projects moving from Waiting/Paused/Potential, ensure paid status is set
    if (fromType !== 'active') {
        item.paid = item.paid === undefined ? 50 : item.paid; // Set 50% paid if undefined
    }
    
    DATA.active.unshift(item);
    sortData('active', 'dl', 'date', true);
    save();
    upd();
    switchTab('active');
}

function moveToActiveFromPotential(idx){
    const item = DATA.potential[idx];
    DATA.potential.splice(idx, 1);
    
    const newItem = {
        n: item.n,
        c: item.c,
        link: item.link,
        start: today,
        dl: today, // Needs manual adjustment
        p: item.p,
        pr: item.p, // Will be recalculated below
        paid: 50,
        taxPrc: item.taxPrc||0
    };
    
    if (newItem.p > 0) newItem.pr = Math.round(newItem.p * (1 - (newItem.taxPrc / 100)));
    
    DATA.active.unshift(newItem);
    sortData('active', 'dl', 'date', true);
    save();
    upd();
    switchTab('active');
}


// --- UTILITIES ---
function switchTab(tabType) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${tabType}`).classList.add('active');
    
    document.getElementById('view-active').style.display = 'none';
    document.getElementById('view-waiting').style.display = 'none';
    document.getElementById('view-potential').style.display = 'none';
    document.getElementById('view-paused').style.display = 'none';
    document.getElementById('view-archive').style.display = 'none';

    document.getElementById(`view-${tabType}`).style.display = 'block';

    upd();
}

function formatDateForDisplay(isoDateString, includeTime = false) {
    if (!isoDateString) return '‚Äî';
    try {
        const date = new Date(isoDateString);
        if (isNaN(date)) return '‚Äî';

        let options = { day: 'numeric', month: 'short' };
        if (includeTime && isoDateString.length > 10) {
            options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
        } else if (isoDateString.length > 10) {
            options = { day: 'numeric', month: 'short', year: 'numeric' };
            if (!isoDateString.includes('T')) options = { day: 'numeric', month: 'short' };
        }
        
        return date.toLocaleDateString('ru-RU', options);
    } catch {
        return '‚Äî';
    }
}

function formatTimeForDisplay(isoDateString) {
    if (!isoDateString || isoDateString.length < 16) return '';
    try {
        const date = new Date(isoDateString);
        if (isNaN(date.getTime())) return '';
        // Check if time is non-zero (i.e., not T00:00)
        if (isoDateString.slice(11, 16) === '00:00') return '';
        
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    } catch {
        return '';
    }
}

function formatCurrency(n) {
    const num = Math.round(n);
    return new Intl.NumberFormat('ru-RU').format(num) + ' ‚ÇΩ';
}

function getActiveTab() {
    if(document.getElementById('tab-active').classList.contains('active')) return 'active';
    if(document.getElementById('tab-waiting').classList.contains('active')) return 'waiting';
    if(document.getElementById('tab-potential').classList.contains('active')) return 'potential';
    if(document.getElementById('tab-paused').classList.contains('active')) return 'paused';
    return 'archive';
}

function sanitizePaste(event) {
    event.preventDefault();
    const text = event.clipboardData.getData('text/plain');
    document.execCommand('insertText', false, text.replace(/[\n\r]/g, ' '));
}

// --- SORTING LOGIC ---
function sortData(type, key, dataType, silent = false) {
    if (!DATA[type] || !SORT_STATE[type]) return;

    let currentState = SORT_STATE[type];
    
    // Determine new direction
    if (currentState.key === key) {
        currentState.direction = currentState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentState.key = key;
        // Default sort direction: descending for numbers/dates, ascending for strings
        currentState.direction = (dataType === 'number' || dataType === 'date') ? 'desc' : 'asc'; 
        currentState.dataType = dataType;
    }

    const dir = currentState.direction === 'asc' ? 1 : -1;

    DATA[type].sort((a, b) => {
        let valA = a[key] || (dataType === 'number' ? 0 : '');
        let valB = b[key] || (dataType === 'number' ? 0 : '');

        if (dataType === 'number') {
            valA = +valA;
            valB = +valB;
            return (valA - valB) * dir;
        } else if (dataType === 'date') {
            const timeA = valA ? new Date(valA).getTime() : (dir === 1 ? Infinity : -Infinity);
            const timeB = valB ? new Date(valB).getTime() : (dir === 1 ? Infinity : -Infinity);
            return (timeA - timeB) * dir;
        } else {
            // String comparison, locale-aware
            return (valA || '').toString().localeCompare((valB || '').toString()) * dir;
        }
    });

    if (!silent) {
        save();
        upd();
    }
}

function updateSortIcons() {
    document.querySelectorAll('.table-wrap th .sort-icon').forEach(icon => {
        icon.classList.remove('asc', 'desc');
    });

    const activeTab = getActiveTab();
    const currentSort = SORT_STATE[activeTab];

    if (currentSort && currentSort.key) {
        const icon = document.querySelector(`#t-${activeTab} th .sort-icon[data-key="${currentSort.key}"]`);
        if (icon) {
            icon.classList.add(currentSort.direction);
        }
    }
}

// --- DATE & TIME ---
function getTimeRemaining(dlString) {
    if (!dlString) return { text: '‚Äî', class: 'days-normal' };
    
    const dlDate = new Date(dlString);
    const now = new Date();

    const diffMs = dlDate.getTime() - now.getTime();

    if (diffMs < 0) return { text: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω', class: 'days-critical' };

    // More than 10 days
    if (diffMs > 10 * 24 * ONE_HOUR) {
        const days = Math.floor(diffMs / (24 * ONE_HOUR));
        return { text: `${days} –¥–Ω.`, class: 'days-normal' };
    } 
    // More than 3 days
    else if (diffMs > 3 * 24 * ONE_HOUR) {
        const days = Math.ceil(diffMs / (24 * ONE_HOUR));
        return { text: `${days} –¥–Ω.`, class: 'days-normal' };
    } 
    // More than 1 day
    else if (diffMs > 24 * ONE_HOUR) {
        const days = Math.ceil(diffMs / (24 * ONE_HOUR));
        return { text: `${days} –¥–Ω.`, class: 'days-warning' };
    } 
    // Less than 1 day (24 hours)
    else if (diffMs >= ONE_HOUR) {
        const hours = Math.ceil(diffMs / ONE_HOUR);
        return { text: `${hours} —á.`, class: hours <= 12 ? 'days-critical' : 'days-warning' };
    } else {
        return { text: `${Math.ceil(diffMs / 60000)} –º–∏–Ω.`, class: 'days-critical' };
    }
}

function calculatePace(activeProjects) {
    if (!activeProjects || activeProjects.length === 0) return null;

    let critical = 0;
    let warning = 0;

    activeProjects.forEach(p => {
        const rem = getTimeRemaining(p.dl);
        if(rem.class === 'days-critical') critical++;
        if(rem.class === 'days-warning') warning++;
    });

    if (critical > 0) return {
        status: 'hurry',
        title: '–ù—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å—Å—è!',
        desc: `–ì–æ—Ä–∏—Ç –¥–µ–¥–ª–∞–π–Ω–æ–≤: ${critical}. –ü–æ–¥–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å!`,
        badge: '–ö—Ä–∏—Ç–∏—á–Ω–æ'
    };
    if (warning > 0) return {
        status: 'warn',
        title: '–ï—Å—Ç—å —Å—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏',
        desc: `–ë–ª–∏–∑–∫–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤: ${warning}. –î–µ—Ä–∂–∏ —Ç–µ–º–ø.`,
        badge: '–í–Ω–∏–º–∞–Ω–∏–µ'
    };
    return {
        status: 'chill',
        title: '–í—Å–µ –∏–¥–µ—Ç –ø–æ –ø–ª–∞–Ω—É',
        desc: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤ –Ω–µ—Ç. –†–∞–±–æ—Ç–∞–µ–º —Å–ø–æ–∫–æ–π–Ω–æ.',
        badge: '–ù–æ—Ä–º–∞'
    };
}


// --- RENDER & LOGIC ---
function renderMonthSelect() {
    const select = document.getElementById('monthSelect');
    select.innerHTML = '';
    
    const uniqueMonths = new Set();
    const now = new Date();
    
    // Add current month and last month
    uniqueMonths.add(now.toISOString().slice(0, 7));
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7);
    uniqueMonths.add(lastMonth);
    
    // Add months from archive
    DATA.archive.forEach(p => {
        const monthKey = (p.date || '').slice(0, 7);
        if (monthKey) uniqueMonths.add(monthKey);
    });
    
    // Add months from goals
    Object.keys(DATA.monthlyGoals).forEach(m => {
        if (m) uniqueMonths.add(m);
    });

    const sortedMonths = Array.from(uniqueMonths).sort().reverse();
    
    // Ensure the current selection is in the list
    if (!sortedMonths.includes(currentMonth)) {
         currentMonth = sortedMonths[0]; // Reset to the latest month if the old one is gone
    }

    sortedMonths.forEach(monthKey => {
        const option = document.createElement('option');
        option.value = monthKey;
        
        const [year, month] = monthKey.split('-');
        const date = new Date(year, month - 1);
        const monthName = date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        
        option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        
        if (monthKey === currentMonth) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function changeMonth(newMonth) {
    currentMonth = newMonth;
    upd();
}

function renderTableBase(type, columnsHTML, totalColSpan, totalHTML) {
    const tb = document.querySelector(`#t-${type} tbody`);
    const tf = document.querySelector(`#total-row-${type} td`);
    tb.innerHTML = '';

    let list = DATA[type];
    
    // Filter archive by selected month
    if (type === 'archive') {
        list = list.filter(i => (i.date || '').startsWith(currentMonth));
    }

    list.forEach((item, idx) => {
        // Correct index for Archive due to filtering
        const realIdx = type === 'archive' ? DATA.archive.findIndex(a => a === item) : idx;
        if (type === 'archive' && realIdx === -1) return; // Skip if filtered out

        const tr = document.createElement('tr');
        tr.innerHTML = columnsHTML(item, realIdx);
        tb.appendChild(tr);
    });
    
    tf.colSpan = totalColSpan;
    tf.innerHTML = totalHTML(list);
}


function renderActiveTable(){
    renderTableBase('active', (item, idx) => {
        const timeRemaining = getTimeRemaining(item.dl);
        const hasLinkClass = item.link ? 'has-link' : '';
        const openLinkBtn = item.link ? `<a href="${item.link}" target="_blank" class="open-link-btn" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É">‚Üó</a>` : '';

        return `
            <td>${idx+1}</td>
            <td> 
                <div class="client-wrap"> 
                    <span contenteditable onpaste="sanitizePaste(event)" class="client-name ${hasLinkClass}" onblur="updateRow('active', ${idx}, 'c', this.innerText)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞">${item.c || ''}</span> 
                    <button class="link-btn" onclick="openLinkModal('active', ${idx})" title="–°—Å—ã–ª–∫–∞">üîó</button> 
                    ${openLinkBtn}
                </div> 
            </td>
            <td><span contenteditable onpaste="sanitizePaste(event)" onblur="updateRow('active', ${idx}, 'n', this.innerText)" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞">${item.n || ''}</span></td>
            
            <td class="date-cell"> 
                <div class="date-input-wrap" onclick="openDateModal('active', ${idx}, 'start', '–î–∞—Ç—É –°—Ç–∞—Ä—Ç–∞')">
                    <span class="date-text-display">${formatDateForDisplay(item.start)}</span> 
                    <span class="calendar-icon">üìÖ</span>
                </div>
            </td>
            
            <td class="date-cell"> 
                <div class="date-input-wrap" onclick="openDateModal('active', ${idx}, 'dl', '–î–µ–¥–ª–∞–π–Ω')">
                    <span class="date-text-display ${timeRemaining.class}">${formatDateForDisplay(item.dl)} ${formatTimeForDisplay(item.dl)}</span> 
                    <span class="calendar-icon">üìÖ</span>
                </div>
            </td>
            
            <td><span class="${timeRemaining.class}" style="display:inline-block;">${timeRemaining.text}</span></td>
            
            <td>
                <select class="tax-select" onchange="updatePrice('active', ${idx}, 'taxPrc', this.value)">
                    <option value="0" ${item.taxPrc == 0 ? 'selected' : ''}>0</option>
                    <option value="6" ${item.taxPrc == 6 ? 'selected' : ''}>6</option>
                    <option value="15" ${item.taxPrc == 15 ? 'selected' : ''}>15</option>
                </select>
            </td>
            
            <td> 
                <div class="price-cell">
                    <input type="number" value="${item.p || 0}" onblur="updatePrice('active', ${idx}, 'p', this.value)">
                    <span class="currency-symbol">‚ÇΩ</span>
                </div>
            </td>
            
            <td class="mono" style="text-align:right;">${formatCurrency(item.pr || 0)}</td>
            
            <td>
                <select class="paid-select" onchange="updatePrice('active', ${idx}, 'paid', this.value)">
                    <option value="0" ${item.paid == 0 ? 'selected' : ''}>0%</option>
                    <option value="50" ${item.paid == 50 ? 'selected' : ''}>50%</option>
                    <option value="100" ${item.paid == 100 ? 'selected' : ''}>100%</option>
                </select>
            </td>
            
            <td> 
                <div class="action-btns">
                    <div class="done-btn action-btn-base" onclick="moveToArchive(${idx}, 'active')" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">‚úì</div>
                    <div class="wait-btn action-btn-base" onclick="moveToWaiting(${idx}, 'active')" title="–í –æ–∂–∏–¥–∞–Ω–∏–µ">üïí</div>
                    <div class="pause-btn action-btn-base" onclick="moveToPaused(${idx}, 'active')" title="–ù–∞ –ø–∞—É–∑—É">‚Äñ</div>
                    <span class="del-btn" onclick="openDeleteConfirmModal('active', ${idx})" title="–£–¥–∞–ª–∏—Ç—å">√ó</span>
                </div> 
            </td>
        `;
    }, 11, (list) => {
        const totalP = list.reduce((a,b) => a + (+b.p||0), 0);
        const totalPr = list.reduce((a,b) => a + (+b.pr||0), 0);
        return `–û–±—â–∞—è: ${formatCurrency(totalP)} | –ß–∏—Å—Ç–∞—è: ${formatCurrency(totalPr)}`;
    });
}

function renderWaitingTable(){
    renderTableBase('waiting', (item, idx) => `
        <td>${idx+1}</td>
        <td> 
            <div class="client-wrap"> 
                <span contenteditable onpaste="sanitizePaste(event)" class="client-name ${item.link ? 'has-link' : ''}" onblur="updateRow('waiting', ${idx}, 'c', this.innerText)">${item.c || ''}</span> 
                <button class="link-btn" onclick="openLinkModal('waiting', ${idx})">üîó</button> 
                ${item.link ? `<a href="${item.link}" target="_blank" class="open-link-btn">‚Üó</a>` : ''}
            </div> 
        </td>
        <td><span contenteditable onpaste="sanitizePaste(event)" onblur="updateRow('waiting', ${idx}, 'n', this.innerText)">${item.n || ''}</span></td>
        
        <td class="date-cell"> 
            <div class="date-input-wrap" onclick="openDateModal('waiting', ${idx}, 'dl', '–î–µ–¥–ª–∞–π–Ω')">
                <span class="date-text-display">${formatDateForDisplay(item.dl)} ${formatTimeForDisplay(item.dl)}</span> 
                <span class="calendar-icon">üìÖ</span>
            </div>
        </td>
        
        <td>${formatCurrency(item.p || 0)}</td>
        
        <td> 
            <div class="action-btns" style="justify-content: flex-end; gap: 5px;">
                <div class="resume-btn action-btn-base" onclick="moveToActive(${idx}, 'waiting')" title="–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É">‚ñ∂ –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</div>
                <span class="del-btn" onclick="openDeleteConfirmModal('waiting', ${idx})">√ó</span>
            </div> 
        </td>
    `, 6, (list) => `–û–±—â–∞—è: ${formatCurrency(list.reduce((a,b) => a + (+b.p||0), 0))}`);
}

function renderPausedTable(){
    renderTableBase('paused', (item, idx) => `
        <td>${idx+1}</td>
        <td> 
            <div class="client-wrap"> 
                <span contenteditable onpaste="sanitizePaste(event)" class="client-name ${item.link ? 'has-link' : ''}" onblur="updateRow('paused', ${idx}, 'c', this.innerText)">${item.c || ''}</span> 
                <button class="link-btn" onclick="openLinkModal('paused', ${idx})">üîó</button> 
                ${item.link ? `<a href="${item.link}" target="_blank" class="open-link-btn">‚Üó</a>` : ''}
            </div> 
        </td>
        <td><span contenteditable onpaste="sanitizePaste(event)" onblur="updateRow('paused', ${idx}, 'n', this.innerText)">${item.n || ''}</span></td>
        
        <td class="date-cell"> 
            <div class="date-input-wrap" onclick="openDateModal('paused', ${idx}, 'dl', '–î–µ–¥–ª–∞–π–Ω')">
                <span class="date-text-display">${formatDateForDisplay(item.dl)} ${formatTimeForDisplay(item.dl)}</span> 
                <span class="calendar-icon">üìÖ</span>
            </div>
        </td>
        
        <td>${formatCurrency(item.p || 0)}</td>
        
        <td> 
            <div class="action-btns" style="justify-content: flex-end; gap: 5px;">
                <div class="resume-btn action-btn-base" onclick="moveToActive(${idx}, 'paused')" title="–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É">‚ñ∂ –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</div>
                <span class="del-btn" onclick="openDeleteConfirmModal('paused', ${idx})">√ó</span>
            </div> 
        </td>
    `, 6, (list) => `–û–±—â–∞—è: ${formatCurrency(list.reduce((a,b) => a + (+b.p||0), 0))}`);
}

function renderPotentialTable(){
    renderTableBase('potential', (item, idx) => `
        <td>${idx+1}</td>
        <td> 
            <div class="client-wrap"> 
                <span contenteditable onpaste="sanitizePaste(event)" class="client-name ${item.link ? 'has-link' : ''}" onblur="updateRow('potential', ${idx}, 'c', this.innerText)">${item.c || ''}</span> 
                <button class="link-btn" onclick="openLinkModal('potential', ${idx})">üîó</button> 
                ${item.link ? `<a href="${item.link}" target="_blank" class="open-link-btn">‚Üó</a>` : ''}
            </div> 
        </td>
        <td><span contenteditable onpaste="sanitizePaste(event)" onblur="updateRow('potential', ${idx}, 'n', this.innerText)">${item.n || ''}</span></td>
        
        <td> 
            <div class="price-cell" style="justify-content:center;">
                <input type="number" value="${item.p || 0}" onblur="updatePrice('potential', ${idx}, 'p', this.value)" style="min-width: 100px; max-width: 100%;">
                <span class="currency-symbol">‚ÇΩ</span>
            </div> 
        </td>
        
        <td> 
            <div class="action-btns" style="justify-content: flex-end; gap: 5px;">
                <div class="done-btn action-btn-base" onclick="moveToActiveFromPotential(${idx})" title="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ —Ä–∞–±–æ—Ç—É">‚úÖ –í —Ä–∞–±–æ—Ç—É</div>
                <span class="del-btn" onclick="openDeleteConfirmModal('potential', ${idx})">√ó</span>
            </div> 
        </td>
    `, 5, (list) => `–û–±—â–∞—è: ${formatCurrency(list.reduce((a,b) => a + (+b.p||0), 0))}`);
}

function renderArchiveTable(){
    renderTableBase('archive', (item, idx) => `
        <td>${idx+1}</td>
        <td> 
            <div class="client-wrap"> 
                <span contenteditable onpaste="sanitizePaste(event)" class="client-name ${item.link ? 'has-link' : ''}" onblur="updateRow('archive', ${idx}, 'c', this.innerText)">${item.c || ''}</span> 
                <button class="link-btn" onclick="openLinkModal('archive', ${idx})">üîó</button> 
                ${item.link ? `<a href="${item.link}" target="_blank" class="open-link-btn">‚Üó</a>` : ''}
            </div> 
        </td>
        <td><span contenteditable onpaste="sanitizePaste(event)" onblur="updateRow('archive', ${idx}, 'n', this.innerText)">${item.n || ''}</span></td>
        
        <td class="date-cell"> 
            <div class="date-input-wrap" onclick="openDateModal('archive', ${idx}, 'date', '–î–∞—Ç–∞ –°–¥–∞—á–∏')">
                <span class="date-text-display">${formatDateForDisplay(item.date)} ${formatTimeForDisplay(item.date)}</span> 
                <span class="calendar-icon">üìÖ</span>
            </div>
        </td>
        
        <td> 
            <div class="price-cell" style="justify-content:center;">
                <input type="number" value="${item.p || 0}" onblur="updatePrice('archive', ${idx}, 'p', this.value)" style="min-width: 100px; max-width: 100%;">
                <span class="currency-symbol">‚ÇΩ</span>
            </div> 
        </td>
        <td class="mono" style="text-align:right;">${formatCurrency(item.pr || 0)}</td>
        
        <td> 
            <div class="action-btns" style="justify-content: flex-end; gap: 5px;">
                <div class="restore-btn action-btn-base" onclick="restoreFromArchive(${idx})" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ">‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</div>
                <span class="del-btn" onclick="openDeleteConfirmModal('archive', ${idx})">√ó</span>
            </div> 
        </td>
    `, 7, (list) => {
        const totalP = list.reduce((a,b) => a + (+b.p||0), 0);
        const totalPr = list.reduce((a,b) => a + (+b.pr||0), 0);
        return `–û–±—â–∞—è: ${formatCurrency(totalP)} | –ß–∏—Å—Ç–∞—è: ${formatCurrency(totalPr)}`;
    });
}


function updateCharts(totalFactNet, planRemainingNet, potentialGrossSum) {
    const ctxM = document.getElementById('doughnutChart').getContext('2d');
    const ctxB = document.getElementById('barChart').getContext('2d');
    const ctxP = document.getElementById('doughnutChart').getContext('2d');

    // Chart M (Doughnut - Status breakdown)
    const active = DATA.active.length;
    const waiting = DATA.waiting.length;
    const paused = DATA.paused.length;
    const potential = DATA.potential.length;

    if (chartM) chartM.destroy();
    chartM = new Chart(ctxM, {
        type: 'doughnut',
        data: {
            labels: ['–í —Ä–∞–±–æ—Ç–µ', '–û–∂–∏–¥–∞–µ—Ç', '–ù–∞ –ø–∞—É–∑–µ', '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª'],
            datasets: [{
                data: [active, waiting, paused, potential],
                backgroundColor: ['#58a6ff', '#a371f7', '#007bff', '#d29922'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#c9d1d9' }
                }
            }
        }
    });

    // Chart P (Doughnut - Plan vs Fact) - Replaced the existing doughnut with P
    const totalNetForChart = totalFactNet + planRemainingNet;
    const factPerc = totalNetForChart > 0 ? (totalFactNet / totalNetForChart) * 100 : 0;
    const planPerc = totalNetForChart > 0 ? (planRemainingNet / totalNetForChart) * 100 : 0;
    
    // Use the same canvas for plan/fact, destroy the old one first
    if(chartP) chartP.destroy();
    
    // This second chart is actually unnecessary since the first one is about distribution.
    // I will simplify and keep only the distribution (chartM) and the bar chart (chartB).
    // The user's original code snippet might have intended to use two charts, 
    // but the canvas is named `doughnutChart` and used for both. I'll stick to one doughnut.
    
    // Instead of two doughnuts, I'll update the bar chart logic.

    // Chart B (Bar - Monthly Archive/Fact)
    const monthStats = {};
    
    // 1. Collect Net Archive (completed) for the last 6 months
    DATA.archive.forEach(p => {
        const mKey = (p.date || '').slice(0,7);
        if (mKey) monthStats[mKey] = (monthStats[mKey] || 0) + (+p.pr || 0);
    });

    const keys = Object.keys(monthStats).sort();
    const lastSixKeys = keys.slice(-6);
    
    // Add current month if not in archive (for current progress)
    if (!lastSixKeys.includes(currentMonth) && monthStats[currentMonth] === undefined) {
         if (lastSixKeys.length >= 6) lastSixKeys.shift(); // Remove oldest if list is full
         lastSixKeys.push(currentMonth);
         lastSixKeys.sort();
    } else if (!lastSixKeys.includes(currentMonth) && monthStats[currentMonth] !== undefined) {
         if (lastSixKeys.length >= 6) lastSixKeys.shift(); 
         lastSixKeys.push(currentMonth);
         lastSixKeys.sort();
    }


    const barLabels = lastSixKeys.map(k => {
        const parts = k.split('-');
        // Use Date.UTC to prevent timezone issues
        const d = new Date(Date.UTC(parts[0], parts[1] - 1, 1)); 
        // Russian month abbreviation + year
        return d.toLocaleDateString('ru-RU', { month: 'short', year: '2-digit' });
    });
    
    const barData = lastSixKeys.map(k => monthStats[k] || 0);
    const barGoals = lastSixKeys.map(k => DATA.monthlyGoals[k] || 0);

    // If current month is the latest, replace its archive value with totalFactNet
    if (lastSixKeys.slice(-1)[0] === currentMonth) {
        barData[barData.length - 1] = totalFactNet;
        barLabels[barLabels.length - 1] = '–¢–µ–∫—É—â–∏–π'; // Use '–¢–µ–∫—É—â–∏–π' for the current month
    }
    
    const maxBarValue = Math.max(...barData, ...barGoals) * 1.2;

    document.getElementById('chart-bar-wrap').style.display = lastSixKeys.length > 0 ? 'block' : 'none';

    if (chartB) chartB.destroy();
    chartB = new Chart(ctxB, {
        type: 'bar',
        data: {
            labels: barLabels,
            datasets: [
                {
                    label: '–§–∞–∫—Ç (–ß–∏—Å—Ç—ã–º–∏)',
                    data: barData,
                    backgroundColor: 'rgba(92, 184, 92, 0.7)', // Greenish
                    borderColor: '#2ea043',
                    borderWidth: 1,
                    borderRadius: 4,
                },
                {
                    label: '–¶–µ–ª—å (–ù–µ—Ç—Ç–æ)',
                    data: barGoals,
                    type: 'line',
                    borderColor: '#58a6ff', // Accent blue
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 4,
                    pointBackgroundColor: '#58a6ff',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: maxBarValue,
                    ticks: {
                        color: '#8b949e',
                        callback: function(value) {
                            // Format Y axis numbers
                            return new Intl.NumberFormat('ru-RU', { notation: "compact", maximumFractionDigits: 1 }).format(value);
                        }
                    },
                    grid: { color: '#30363d' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#c9d1d9' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#c9d1d9' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += formatCurrency(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}


function upd(){
    // Update main statistics block before table rendering
    updateStatistics(); 
    
    // Render tables
    renderActiveTable();
    renderWaitingTable();
    renderPotentialTable();
    renderPausedTable();
    renderArchiveTable();

    // Update sort icons based on current state
    updateSortIcons();

    // Update statistics display logic (full/light/none)
    updStatisticsDisplay();

    // Pace Logic
    const paceBlock = document.getElementById('pace-indicator');
    if (getActiveTab() === 'active' && DATA.active.length > 0) {
        paceBlock.style.display = 'flex';
        const pace = calculatePace(DATA.active);
        const stDiv = document.getElementById('pace-status');
        stDiv.className = 'pace-status';
        stDiv.classList.add(`pace-${pace.status}`);
        stDiv.textContent = pace.badge;
        document.getElementById('pace-title').textContent = pace.title;
        document.getElementById('pace-desc').textContent = pace.desc;
        document.querySelector('.pace-icon').textContent = pace.status === 'hurry' ? 'üî•' : (pace.status === 'warn' ? '‚ö°' : '‚òï');
    } else {
        paceBlock.style.display = 'none';
    }
}

function updateStatistics() {
    let factArchiveNet = 0; // –ß–∏—Å—Ç—ã–º–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    let factReceivedNet = 0; // –ß–∏—Å—Ç—ã–º–∏ –ø–æ–ª—É—á–µ–Ω–æ (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞) –ø–æ Active
    let planRemainingNet = 0; // –ß–∏—Å—Ç—ã–º–∏ –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å (Active, Waiting, Paused)
    let allGrossSum = 0; // –ë—Ä—É—Ç—Ç–æ Active/Waiting/Paused/Potential
    let waitingGrossSum = 0;
    let waitingNetSum = 0;
    let pausedGrossSum = 0;
    let pausedNetSum = 0;
    let potentialGrossSum = 0;
    
    // Calculate Archive Net for current month
    DATA.archive.forEach(p => {
        if ((p.date || '').startsWith(currentMonth)) {
            factArchiveNet += (+p.pr || 0);
        }
        // Check for personal record across ALL archive months
        if ((+p.pr || 0) > 0) {
            DATA.settings.record = Math.max(DATA.settings.record || 0, (+p.pr || 0));
        }
    });
    
    // Calculate Active
    DATA.active.forEach(p => {
        const netValue = (+p.pr || 0);
        const paidPrc = (+p.paid || 0) / 100;
        
        allGrossSum += (+p.p || 0);
        
        // Net received for active projects (based on paid %)
        factReceivedNet += Math.round(netValue * paidPrc); 
        
        // Net remaining for active projects
        planRemainingNet += Math.round(netValue * (1 - paidPrc));
    });

    // Calculate Waiting
    DATA.waiting.forEach(p => {
        const netValue = (+p.pr || 0);
        const paidPrc = (+p.paid || 0) / 100;
        
        waitingGrossSum += (+p.p || 0);
        waitingNetSum += netValue;
        allGrossSum += (+p.p || 0);
        
        // Net received for waiting projects (based on paid %)
        factReceivedNet += Math.round(netValue * paidPrc);
        
        // Net remaining for waiting projects
        planRemainingNet += Math.round(netValue * (1 - paidPrc));
    });

    // Calculate Paused
    DATA.paused.forEach(p => {
        const netValue = (+p.pr || 0);
        const paidPrc = (+p.paid || 0) / 100;

        pausedGrossSum += (+p.p || 0);
        pausedNetSum += netValue;
        allGrossSum += (+p.p || 0);

        // Net received for paused projects (based on paid %)
        factReceivedNet += Math.round(netValue * paidPrc);
        
        // Net remaining for paused projects
        planRemainingNet += Math.round(netValue * (1 - paidPrc));
    });

    // Calculate Potential
    DATA.potential.forEach(p => {
        potentialGrossSum += (+p.p || 0);
    });

    // Total Fact Net is Archive Net + Received from Active/Waiting/Paused
    const totalFactNet = factArchiveNet + factReceivedNet;
    const totalNetForecast = totalFactNet + planRemainingNet;
    const goal = DATA.monthlyGoals[currentMonth] || 250000;
    const rec = DATA.settings.record;

    // Cache light stats for display switching
    DATA.statsCache = {
        potentialGrossSum,
        waitingGrossSum,
        waitingNetSum,
        pausedGrossSum,
        pausedNetSum,
    };

    // Update main dashboard values
    document.getElementById('val-fact').textContent = formatCurrency(totalFactNet);
    document.getElementById('val-fact-active').textContent = formatCurrency(factReceivedNet);
    document.getElementById('val-plan').textContent = formatCurrency(planRemainingNet);
    document.getElementById('val-total').textContent = formatCurrency(totalNetForecast);
    document.getElementById('goal-text').textContent = `${formatCurrency(totalFactNet)} / ${formatCurrency(goal)}`;
    document.getElementById('rec-val').textContent = formatCurrency(rec);
    document.getElementById('to-record').textContent = formatCurrency(Math.max(0, rec - totalFactNet));
    document.getElementById('bottom-rec-val').textContent = formatCurrency(rec);
    
    const perc = Math.min(100, (totalFactNet / goal) * 100);
    document.getElementById('p-bar').style.width = perc + '%';
    
    const monthName = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex]?.text || '–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü';
    document.getElementById('dash-month-name').textContent = monthName;

    updateCharts(totalFactNet, planRemainingNet, potentialGrossSum);
}

function updStatisticsDisplay() {
    const activeTab = getActiveTab();
    const isFullStats = activeTab === 'active' || activeTab === 'archive';
    const isLightStats = ['potential', 'waiting', 'paused'].includes(activeTab) && DATA[activeTab].length > 0;
    
    // Find the wrappers (assuming they exist based on the CSS/HTML structure)
    const fullStatsWrapper = document.querySelector('.stats-full');
    const lightStatsWrapper = document.querySelector('.stats-light');
    
    if (fullStatsWrapper) fullStatsWrapper.style.display = isFullStats ? 'flex' : 'none';
    if (lightStatsWrapper) lightStatsWrapper.style.display = isLightStats ? 'block' : 'none';
    
    if (isLightStats) updateLightStatsContent(activeTab);
}

function updateLightStatsContent(tabType) {
    const cache = DATA.statsCache;
    const title = document.getElementById('light-stats-title');
    const mainVal = document.getElementById('val-light-main');
    const secVal = document.getElementById('val-light-secondary');
    const mainLabel = document.getElementById('val-light-main-label');
    const secLabel = document.getElementById('val-light-secondary-label');
    const mainTip = document.getElementById('val-light-main-tooltip');
    const secTip = document.getElementById('val-light-secondary-tooltip');

    if (tabType === 'potential') {
        title.textContent = '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –∑–∞–∫–∞–∑–æ–≤';
        mainVal.textContent = formatCurrency(cache.potentialGrossSum);
        mainLabel.textContent = '–û–±—â–∞—è —Å—É–º–º–∞ (–ë—Ä—É—Ç—Ç–æ)';
        mainTip.textContent = '–°—É–º–º–∞ –≤—Å–µ—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–±—Ä—É—Ç—Ç–æ).';
        
        secVal.textContent = ''; // Hide secondary for potential
        secLabel.textContent = ''; 
        secTip.textContent = ''; 

    } else if (tabType === 'waiting') {
        title.textContent = '–û–∂–∏–¥–∞—é—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã';
        mainVal.textContent = formatCurrency(cache.waitingGrossSum);
        secVal.textContent = formatCurrency(cache.waitingNetSum);
        mainLabel.textContent = '–û–±—â–∞—è —Å—É–º–º–∞ (–ë—Ä—É—Ç—Ç–æ)';
        secLabel.textContent = '–û–±—â–∞—è —Å—É–º–º–∞ (–ß–∏—Å—Ç—ã–º–∏)';
        mainTip.textContent = '–°—É–º–º–∞ –≤—Å–µ—Ö –æ–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–±—Ä—É—Ç—Ç–æ).';
        secTip.textContent = '–°—É–º–º–∞ –≤—Å–µ—Ö –æ–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–Ω–µ—Ç—Ç–æ).';

    } else if (tabType === 'paused') {
        title.textContent = '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã';
        mainVal.textContent = formatCurrency(cache.pausedGrossSum);
        secVal.textContent = formatCurrency(cache.pausedNetSum);
        mainLabel.textContent = '–û–±—â–∞—è —Å—É–º–º–∞ (–ë—Ä—É—Ç—Ç–æ)';
        secLabel.textContent = '–û–±—â–∞—è —Å—É–º–º–∞ (–ß–∏—Å—Ç—ã–º–∏)';
        mainTip.textContent = '–°—É–º–º–∞ –≤—Å–µ—Ö –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–±—Ä—É—Ç—Ç–æ).';
        secTip.textContent = '–°—É–º–º–∞ –≤—Å–µ—Ö –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–Ω–µ—Ç—Ç–æ).';
    }
}


// --- MOTIVATION ---
const quotes = ["–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ –∫–ª—é—á. üî•", "–¢–≤–æ–π –¥–∏–∑–∞–π–Ω —Å—Ç–æ–∏—Ç –¥–æ—Ä–æ–≥–æ. üíé", "–ö–∞–∂–¥—ã–π —Ä—É–±–ª—å –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –∫ –º–µ—á—Ç–µ. üí∏", "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –±—É–¥—É—â–µ–µ ‚Äî —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ. ‚ú®", "–ù–µ –∂–¥–∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, –¥–µ–ª–∞–π —Ä–∞–±–æ—Ç—É, –∏ –æ–Ω–æ –ø—Ä–∏–¥–µ—Ç. üé®", "–°–≤–æ–±–æ–¥–∞ –æ—Ç—á–µ–∫–∞–Ω–µ–Ω–Ω–∞—è –∏–∑ –∑–æ–ª–æ—Ç–∞. üöÄ"];
function newQuote(){
    document.getElementById('quote-text').innerText = quotes[Math.floor(Math.random()*quotes.length)];
}

window.onload = init;

// --- TOOLTIP LOGIC ---
function initTooltips() {
    const tooltip = document.createElement('div');
    tooltip.id = 'global-tooltip';
    document.body.appendChild(tooltip);

    document.querySelectorAll('[data-tooltip]').forEach(el => {
        el.addEventListener('mouseenter', e => {
            const text = el.getAttribute('data-tooltip');
            if (!text) return;
            
            tooltip.textContent = text;
            tooltip.classList.add('visible');
            
            const rect = el.getBoundingClientRect();
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const top = rect.bottom + 10; 
            const left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        });

        el.addEventListener('mouseleave', () => {
            tooltip.classList.remove('visible');
        });
    });
}

// –î–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä—å init()
// –í —Ñ—É–Ω–∫—Ü–∏–∏ init() –Ω–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É newQuote(); –∏...
</script>
</body>
</html>
