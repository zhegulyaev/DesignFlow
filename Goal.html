<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DesignFlow Цели v0.1</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --accent: #7c5cff;
      --accent-hover: #6a4bff;
      --text: #1e293b;
      --text-muted: #64748b;
      --bg: #f8fafc; /* Основной фон (светлый) */
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,0.05);
      --red: #ef4444;
      --orange: #f97316;
      --green: #22c55e;
      
      /* Светлая тема для WARNING (Нейтральный стиль, как просили) */
      --warn-bg: var(--card-bg); 
      --warn-border: var(--border); 
      --warn-text: var(--text); 
      --warn-icon: var(--text-muted); 
    }

    body[data-theme="dark"] {
      --bg: #0f172a; /* Темный фон страницы */
      --card-bg: #1e293b; /* Фон карточек в темной теме */
      --text: #e2e8f0; /* Светлый текст */
      --text-muted: #94a3b8;
      --border: #334155;
      background: #020617; /* Чуть более темный фон для body */
      
      /* Темная тема для WARNING (Нейтральный стиль, как просили) */
      --warn-bg: var(--card-bg); 
      --warn-border: var(--border);
      --warn-text: var(--text); 
      --warn-icon: var(--text-muted); 
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s;
      overflow-y: scroll;
    }

    /* --- HEADER --- */
    .header-wrapper {
        margin-top: 24px;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        transition: background .3s, border-color .3s;
    }
    
    .header {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Цвет молнии - желтый/золотой */
      color: #fbbf24; 
      font-size: 20px;
      box-shadow: 0 4px 10px rgba(124, 92, 255, 0.2);
    }

    .logo-text h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }

    .logo-text h1 span {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
      margin-left: 6px;
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 6px;
    }
    
    body[data-theme="dark"] .logo-text h1 span { background: #334155; }

    .logo-text p {
      margin: 4px 0 0;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* --- BUTTONS --- */
    .btn {
      padding: 9px 16px;
      border-radius: 10px;
      background: #f1f5f9;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      border: 1px solid transparent;
      transition: .2s;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      white-space: nowrap;
    }
    
    /* Иконки кнопок наследуют color: var(--text) */
    .btn i { color: inherit; } 

    body[data-theme="dark"] .btn { background: #334155; border-color: #475569; }
    .btn:hover { background: #e2e8f0; }
    body[data-theme="dark"] .btn:hover { background: #475569; }

    .btn.primary { background: var(--accent); color: white; border: none; }
    .btn.primary:hover { background: var(--accent-hover); }
    .btn.primary i { color: white; } /* Белые иконки на Primary кнопках */

    .btn.secondary { background: transparent; border: 1px solid var(--border); }
    .btn.secondary:hover { background: #f8fafc; }
    body[data-theme="dark"] .btn.secondary:hover { background: #1e293b; }

    .btn.danger { background: #fee2e2; color: var(--red); }
    .btn.danger:hover { background: #fecaca; }

    /* --- WARNING BLOCK (НЕЙТРАЛЬНЫЙ СТИЛЬ + ТОЧЕЧНОЕ КРАСНОЕ ВЫДЕЛЕНИЕ) --- */
    .warning-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }
    .warning {
      background: var(--warn-bg);
      border: 1px solid var(--warn-border);
      padding: 16px 24px;
      margin-top: 24px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      display: flex;
      justify-content: space-between; 
      align-items: center;
      gap: 20px;
      color: var(--warn-text); 
    }
    
    .warning-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    /* Дефолтный цвет иконки (серый/заглушенный) */
    .warning i { color: var(--warn-icon); font-size: 16px; margin-top: 2px; } 
    .warning strong { font-weight: 700; color: var(--warn-text); } 
    
    .warning-actions {
        display: flex;
        gap: 10px;
        flex-shrink: 0; 
    }

    /* ТОЧЕЧНОЕ КРАСНОЕ ВЫДЕЛЕНИЕ */
    .warning-red-icon,
    .warning-red-text {
        color: var(--red) !important;
    }
    .warning-red-text {
        font-weight: 700;
    }
    /* КОНЕЦ ТОЧЕЧНОГО КРАСНОГО ВЫДЕЛЕНИЯ */


    /* --- TABS --- */
    .tabs-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
    }
    .tabs {
      display: flex;
      gap: 6px;
      padding: 20px 0 0;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 14px;
      border-radius: 8px;
      background: transparent;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: .2s;
    }

    .tab:hover { background: rgba(0,0,0,0.03); }
    body[data-theme="dark"] .tab:hover { background: rgba(255,255,255,0.05); }

    .tab.active { background: #e0e7ff; color: var(--accent); }
    body[data-theme="dark"] .tab.active { background: rgba(124, 92, 255, 0.2); }

    .tab .count { margin-left: 6px; opacity: 0.7; font-size: 0.9em; }

    /* --- LAYOUT --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px 60px; }

    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      margin-top: 20px;
      align-items: start;
    }

    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .card h2 { font-size: 18px; font-weight: 700; margin: 0 0 20px; display: flex; align-items: center; gap: 8px;}
    .card h2 i { color: var(--accent); }

    /* --- FORM --- */
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
    }

    .form-row > * {
        flex: 1;
    }

    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    
    label { 
      font-size: 12px; 
      color: var(--text-muted); 
      font-weight: 700; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      display: flex;
      align-items: center;
      position: relative; 
    }

    /* --- END TOOLTIP STYLE --- (УДАЛЕНО) */


    input, textarea, select {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg);
      font-size: 14px;
      color: var(--text);
      outline: none;
      width: 100%;
      box-sizing: border-box;
      transition: border-color .2s;
    }

    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: var(--card-bg); }

    input::placeholder, textarea::placeholder {
        color: var(--text-muted);
        opacity: 0.8; 
    }

    body[data-theme="dark"] input, 
    body[data-theme="dark"] textarea, 
    body[data-theme="dark"] select {
      background: #0f172a;
    }
    body[data-theme="dark"] input:focus { background: #1e293b; }
    
    body[data-theme="dark"] input::placeholder,
    body[data-theme="dark"] textarea::placeholder {
        color: var(--text-muted);
        opacity: 1;
    }


    textarea { min-height: 80px; resize: vertical; font-family: inherit; }

    .custom-days-field { display: none; margin-top: 10px; }

    .btn-group { display: flex; gap: 10px; margin-top: 16px; }
    .btn-group .btn { flex: 1; justify-content: center; padding: 12px; }

    /* --- GOAL ITEMS --- */
    .goal-list { display: flex; flex-direction: column; gap: 16px; }

    .goal-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      background: var(--card-bg);
      transition: transform .2s, box-shadow .2s;
      position: relative; /* Для позиционирования чекбокса */
      padding-left: 55px; /* Освобождаем место для чекбокса */
      cursor: pointer;
    }
    
    .goal-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    
    /* Индикатор выбора на карточке */
    .goal-card.selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(124, 92, 255, 0.2), var(--shadow);
    }
    
    .goal-card-content {
        /* Вся внутренняя разметка цели */
        position: relative; 
        z-index: 1;
    }
    
    .goal-checkbox-wrapper {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 2; /* Чекбокс должен быть кликабелен */
        height: 18px;
    }
    
    /* Стиль для самого чекбокса, чтобы он выглядел аккуратно */
    .goal-select-checkbox {
      margin: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg);
      flex-shrink: 0;
      accent-color: var(--accent); /* Цвет при выборе */
    }
    
    body[data-theme="dark"] .goal-select-checkbox {
        background: #0f172a;
        border-color: #475569;
    }

    .goal-header { display: flex; justify-content: space-between; align-items: start; gap: 10px; }
    .goal-title { font-size: 18px; font-weight: 700; line-height: 1.3; color: var(--text); }

    .goal-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 10px 0;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    /* УЛУЧШЕНИЕ: выделение текста времени, чтобы он был более заметным */
    .goal-meta > span { 
        color: var(--text); 
        font-weight: 600; 
    }
    .goal-meta > i { 
        color: var(--text-muted);
    }
    .goal-meta span .fa-clock { color: inherit; }


    .priority-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px; 
    }
    
    /* Цвета и иконки приоритетов */
    .priority-badge i { font-size: 12px; } 

    .priority-high { background: #fee2e2; color: var(--red); }
    .priority-med { background: #ffedd5; color: var(--orange); }
    .priority-low { background: #dcfce7; color: var(--green); }

    /* Dark theme priority badges */
    body[data-theme="dark"] .priority-high { background: #450a0a; color: #f87171; }
    body[data-theme="dark"] .priority-med { background: #451a03; color: #fb923c; }
    body[data-theme="dark"] .priority-low { background: #064e3b; color: #34d399; }

    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
      margin: 16px 0 10px;
    }
    body[data-theme="dark"] .progress-bar { background: #334155; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #c084fc); transition: width .5s; }

    .numbers { display: flex; justify-content: space-between; font-size: 15px; font-weight: 700; margin-bottom: 16px; }
    .numbers span:last-child { color: var(--text-muted); font-weight: 500; font-size: 14px; }

    /* Quick Actions */
    .quick-add { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .quick-btn {
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
      text-align: center;
      transition: .2s;
    }
    .quick-btn:hover { border-color: var(--accent); color: var(--accent); }

    body[data-theme="dark"] .quick-btn { background: #334155; border-color: #475569; }
    body[data-theme="dark"] .quick-btn:hover { background: #475569; border-color: var(--accent); }


    .actions-row { display: flex; gap: 10px; border-top: 1px solid var(--border); padding-top: 16px; }
    .action-icon-btn {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-muted);
      background: transparent;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: .2s;
    }
    .action-icon-btn:hover { background: #f1f5f9; color: var(--text); }
    .action-icon-btn.delete:hover { background: #fee2e2; color: var(--red); }
    
    body[data-theme="dark"] .action-icon-btn:hover { background: #334155; color: var(--text); }
    body[data-theme="dark"] .action-icon-btn.delete:hover { background: #450a0a; color: #f87171; }


    /* УЛУЧШЕННЫЕ СТИЛИ KPI (Новая попытка) */
    .kpi {
      display: flex; 
      justify-content: space-between; /* Используем space-between */
      gap: 15px; 
      margin-top: 16px;
      padding: 0;
      background: none; 
      text-align: center;
    }
    
    .kpi-item { 
      flex: 1; 
      padding: 0; 
      position: relative;
    }
    
    /* Добавляем тонкий вертикальный разделитель */
    .kpi-item:not(:last-child)::after {
        content: '';
        position: absolute;
        right: -8px; 
        top: 5px;
        bottom: 5px;
        width: 1px;
        background: var(--border); 
    }
    
    .kpi-icon {
        color: var(--accent); 
        font-size: 16px;
        margin-bottom: 2px;
        display: block;
    }
    
    .kpi-value { 
        font-size: 20px; /* Крупные и заметные цифры */
        font-weight: 700; 
        color: var(--text); /* Используем основной цвет */
        line-height: 1.1;
    }
    .kpi-label { 
        font-size: 11px; 
        color: var(--text-muted); 
        margin-top: 4px;
        font-weight: 600; 
        text-transform: uppercase; /* Заглавные буквы */
        letter-spacing: 0.2px;
    }
    /* КОНЕЦ УЛУЧШЕННЫХ СТИЛЕЙ KPI */
    
    /* --- MULTI-SELECT MODE STYLES --- */
    /* Панель массовых действий */
    .multi-action-bar {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 20px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
        box-shadow: var(--shadow);
    }
    .multi-action-text {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
    }
    .multi-action-btns {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
    }
    
    /* --- TOAST & MODAL --- */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: all .3s;
      font-size: 14px;
    }
    body[data-theme="dark"] .toast { background: #1e293b; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .toast.show { opacity: 1; transform: translateY(0); }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      animation: slideUp .3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 18px; font-weight: 700; }
    .modal-close { font-size: 20px; cursor: pointer; color: var(--text-muted); }

    .modal-body { padding: 24px; }
    .modal-actions { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
    
    .empty-message { text-align: center; padding: 50px; color: var(--text-muted); font-size: 15px; display: flex; flex-direction: column; align-items: center; gap: 12px; }

    /* --- CONFIRM MODAL SPECIFIC --- */
    #confirm-modal .modal-content { max-width: 400px; }
    #confirm-modal .modal-actions { justify-content: space-between; }
    #confirm-modal .modal-actions .btn { flex: 1; justify-content: center; padding: 12px; }
    #confirm-modal p { font-size: 16px; text-align: center; margin: 0; }

    /* --- FOOTER --- */
    .footer {
        padding: 40px 24px;
        text-align: center;
        border-top: 1px solid var(--border);
        margin-top: 20px;
        color: var(--text-muted);
        font-size: 13px;
    }
    .footer a {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
    }
    .footer a:hover { text-decoration: underline; }
    
    /* Медиа-запрос для адаптивности блока .warning */
    @media (max-width: 600px) {
        .warning {
            flex-direction: column;
            align-items: flex-start;
        }
        .warning-actions {
            margin-top: 10px;
            width: 100%;
            justify-content: stretch;
        }
        .warning-actions .btn {
            flex: 1;
        }
        
        .goal-card {
            padding-left: 20px; /* Убираем отступ для чекбокса, в мобильной версии будет некрасиво */
        }
        .goal-checkbox-wrapper {
            top: 15px; /* Сдвигаем чекбокс в угол */
            right: 15px;
            left: auto;
        }
        
        /* Скрываем текст кнопок действий в мобильной версии */
        .desktop-only { display: none; }
        .multi-action-btns .btn {
            font-size: 0;
            padding: 8px 12px;
        }
        .multi-action-btns .btn i {
            font-size: 14px;
            margin: 0;
        }
    }
    
    @media (min-width: 601px) {
        .desktop-only { display: inline; }
    }
  </style>
</head>
<body>

  <div class="header-wrapper">
    <div class="header">
      <div class="logo-container">
        <div class="logo-icon"><i class="fa-solid fa-bolt"></i></div>
        <div class="logo-text">
          <h1>DesignFlow <span>v0.1</span></h1>
          <p>Трекер целей</p>
        </div>
      </div>
      <div class="header-actions">
        <a href="https://zhegulyaev.github.io/DesignFlow/" class="btn secondary" target="_blank">
          <i class="fa-solid fa-list-check"></i> Трекер проектов
        </a>
        
        <button class="btn" id="theme-btn"><i class="fa-solid fa-moon"></i></button>
      </div>
    </div>
  </div>

  <div class="warning-wrapper">
    <div class="warning"> 
        <div class="warning-content">
            <i class="fa-solid fa-triangle-exclamation warning-red-icon"></i>
            <div>
                <strong class="warning-red-text">Важно:</strong> Данные хранятся только в вашем браузере.<br>
                Обязательно скачивайте резервную копию перед очисткой кэша или переустановкой системы.
            </div>
        </div>
        <div class="warning-actions">
            <button class="btn" id="export-btn"><i class="fa-solid fa-download"></i> Скачать базу</button>
            <button class="btn" id="import-btn"><i class="fa-solid fa-upload"></i> Загрузить</button>
        </div>
    </div>
  </div>

  <div class="tabs-wrapper">
    <div class="tabs">
      <div class="tab active" data-filter="active">Активные <span class="count" id="active-count">0</span></div>
      <div class="tab" data-filter="done">Завершённые <span class="count" id="done-count">0</span></div>
      <div class="tab" data-filter="all">Все цели <span class="count" id="total-count">0</span></div>
      <div class="tab" data-filter="trash">Корзина <span class="count" id="trash-count">0</span></div>
    </div>
  </div>

  <div class="container grid">
    <div class="card">
      <h2><i class="fa-solid fa-square-plus"></i> Создать цель</h2>
      
      <div class="field">
        <label>Название</label>
        <input id="g-title" placeholder="Например: Новый MacBook" />
      </div>

      <div class="form-row">
        <div class="field">
          <label>Сумма</label>
          <input id="g-target" placeholder="100 000 или 100к" inputmode="numeric" />
        </div>
        <div class="field">
          <label>Есть</label>
          <input id="g-current" placeholder="0 или 50к" inputmode="numeric" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Дедлайн</label>
          <input id="g-deadline" type="date" />
        </div>
        <div class="field">
          <label>Приоритет</label>
          <select id="g-priority">
            <option value="med">Средний</option>
            <option value="high">Высокий</option>
            <option value="low">Низкий</option>
          </select>
        </div>
      </div>
      
      <div class="field">
        <label>Шаблон срока</label>
        <select id="g-template">
          <option value="">Выбрать быстрый срок...</option>
          <option value="7">Через неделю (7 дн.)</option>
          <option value="14">Через 2 недели (14 дн.)</option>
          <option value="30">Через месяц (30 дн.)</option>
          <option value="custom">Свой вариант...</option>
        </select>
        <div class="custom-days-field" id="g-custom-days-field">
          <input id="g-custom-days-input" type="number" min="1" placeholder="Введите кол-во дней" />
        </div>
      </div>

      <div class="field">
        <label>Заметка</label>
        <textarea id="g-notes" placeholder="План действий, ссылки, мысли..."></textarea>
      </div>

      <div class="btn-group">
        <button class="btn primary" id="btn-add"><i class="fa-solid fa-plus"></i> Добавить</button>
        <button class="btn secondary" id="btn-demo"><i class="fa-solid fa-wand-magic-sparkles"></i> Демо</button>
      </div>
    </div>

    <div>
       <div class="card" style="margin-bottom: 24px; padding: 20px;">
        <h2 style="font-size: 15px; margin-bottom:12px; color:var(--text-muted); font-weight:600;"><i class="fa-solid fa-chart-pie"></i> Общий прогресс</h2>
        <div class="progress-bar" style="margin-top:0"><div class="progress-fill" id="overall-progress" style="width:0%"></div></div>
        <div style="font-size:13px; color:var(--text-muted); text-align:right; margin-top:8px;" id="overall-text">0%</div>
      </div>
      
      <div class="multi-action-bar" id="multi-action-bar" style="display: none;">
          <div class="multi-action-text" id="multi-action-text">Выбрано: 0</div>
          <div class="multi-action-btns">
              <button class="btn secondary" id="btn-select-all"><i class="fa-solid fa-list-check"></i> <span class="desktop-only">Выбрать все</span></button>
              <button class="btn" id="btn-multi-done" title="Завершить"><i class="fa-solid fa-check"></i> <span class="desktop-only">Готово</span></button>
              <button class="btn danger" id="btn-multi-trash" title="В корзину"><i class="fa-regular fa-trash-can"></i> <span class="desktop-only">В корзину</span></button>
          </div>
      </div>
      <div class="goal-list" id="goals-list"></div>
    </div>
  </div>

  <div class="footer">
    DesignFlow Tracker by <a href="https://t.me/zhegulyaev" target="_blank">Zhegulyaev</a>
  </div>

  <div class="toast" id="toast">
    <i class="fa-solid fa-circle-check"></i> <span id="toast-message"></span>
  </div>

  <input type="file" id="file-import" accept="application/json" style="display:none" />

  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Редактировать</h2>
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Название</label>
          <input id="edit-title" />
        </div>
        <div class="form-row">
          <div class="field">
            <label>Сумма</label>
            <input id="edit-target" inputmode="numeric" placeholder="100 000 или 100к" />
          </div>
          <div class="field">
            <label>Есть сейчас</label>
            <input id="edit-current" inputmode="numeric" placeholder="0 или 50к" />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Дедлайн</label>
            <input id="edit-deadline" type="date" />
          </div>
          <div class="field">
            <label>Приоритет</label>
            <select id="edit-priority">
              <option value="med">Средний</option>
              <option value="high">Высокий</option>
              <option value="low">Низкий</option>
            </select>
          </div>
        </div>
         <div class="field">
          <label>Шаблон срока</label>
          <select id="edit-template">
            <option value="">Не менять</option>
            <option value="7">7 дн.</option>
            <option value="14">14 дн.</option>
            <option value="30">Месяц</option>
            <option value="custom">Свой</option>
          </select>
           <div class="custom-days-field" id="edit-custom-days-field">
            <input id="edit-custom-days-input" type="number" min="1" placeholder="Дней" />
          </div>
        </div>
        <div class="field">
          <label>Заметка</label>
          <textarea id="edit-notes"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="save-edit">Сохранить</button>
      </div>
    </div>
  </div>

  <div class="modal" id="progress-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2>Изменить баланс</h2>
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Сумма операции</label>
          <input id="progress-amount" placeholder="5 000 или 5к" inputmode="numeric" autofocus />
        </div>
      </div>
      <div class="modal-actions" style="justify-content: space-between;">
        <button class="btn danger" id="btn-subtract"><i class="fa-solid fa-minus"></i> Вычесть</button>
        <button class="btn primary" id="btn-add-progress"><i class="fa-solid fa-plus"></i> Добавить</button>
      </div>
    </div>
  </div>

  <div class="modal" id="confirm-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Подтвердите действие</h2>
        <span class="modal-close"><i class="fa-solid fa-xmark"></i></span>
      </div>
      <div class="modal-body">
        <p id="confirm-text"></p>
      </div>
      <div class="modal-actions">
        <button class="btn secondary" id="confirm-cancel">Отмена</button>
        <button class="btn danger" id="confirm-ok">ОК</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const K = 'grok_design_v5'; 
  let DATA = { goals: [] };
  let currentEditId = null;
  let currentProgressId = null;

  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  let confirmAction = null;
  
  // NEW: Multi-selection state and elements
  let selectedGoalIds = new Set();
  const multiActionBar = document.getElementById('multi-action-bar');
  const multiActionText = document.getElementById('multi-action-text');
  const btnSelectAll = document.getElementById('btn-select-all');
  const btnMultiDone = document.getElementById('btn-multi-done');
  const btnMultiTrash = document.getElementById('btn-multi-trash');
  
  // New buttons for trash mode (created once to use in updateMultiActionBar)
  const btnMultiRestore = document.createElement('button');
  btnMultiRestore.className = 'btn';
  btnMultiRestore.innerHTML = '<i class="fa-solid fa-rotate-left"></i> <span class="desktop-only">Восстановить</span>';
  btnMultiRestore.title = 'Восстановить';
  btnMultiRestore.id = 'btn-multi-restore';

  const btnMultiFinalDelete = document.createElement('button');
  btnMultiFinalDelete.className = 'btn danger';
  btnMultiFinalDelete.innerHTML = '<i class="fa-solid fa-ban"></i> <span class="desktop-only">Удалить навсегда</span>';
  btnMultiFinalDelete.title = 'Удалить навсегда';
  btnMultiFinalDelete.id = 'btn-multi-final-delete';


  function showToast(msg) {
    toastMessage.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  function nowISO() { return new Date().toISOString(); }

  function safeParseNum(v) {
    if (!v) return 0;
    // Очистка от пробелов и замена запятой на точку для корректного parseFloat
    // Добавлена обработка суффиксов 'к' и 'k'
    let str = String(v).replace(/\s+/g, '').replace(/,/g, '.').toLowerCase();
    let multiplier = 1;
    if (str.endsWith('к') || str.endsWith('k')) {
        str = str.slice(0, -1);
        multiplier = 1000;
    }
    return (parseFloat(str) || 0) * multiplier;
  }
  
  // Удаляем форматирование oninput, но оставляем onblur
  function formatInput(e) {
    let val = e.target.value.replace(/\s+/g, '');
    if (!isNaN(val) && val !== '') {
      e.target.value = Number(val).toLocaleString('ru-RU');
    }
  }

  function handleBlurFormatting(e) {
    let val = e.target.value;
    const num = safeParseNum(val);
    e.target.value = fmt(num);
  }

  function fmt(n) {
    const num = safeParseNum(n);
    return Math.round(num).toLocaleString('ru-RU');
  }

  ['g-target', 'g-current', 'edit-target', 'edit-current', 'progress-amount'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        // Устанавливаем форматирование по потере фокуса (onblur)
        el.addEventListener('blur', handleBlurFormatting);
        // Добавляем очистку ввода для тех, кто использует 'к' на oninput, чтобы не сбивать курсор
        el.addEventListener('input', (e) => {
             e.target.value = e.target.value.replace(/[^\d\s\.\,\к\k]/g, '');
        });
    }
  });

  function setupDateTemplate(selectId, customGroup, customInputId, dateInputId) {
    const select = document.getElementById(selectId);
    const customDiv = document.getElementById(customGroup);
    const customInp = document.getElementById(customInputId);
    const dateInp = document.getElementById(dateInputId);

    function updateDate(days) {
        if (!days || days <= 0) return;
        const date = new Date();
        date.setDate(date.getDate() + parseInt(days));
        dateInp.value = date.toISOString().slice(0,10);
    }

    select.addEventListener('change', () => {
        if (customDiv) customDiv.style.display = select.value === 'custom' ? 'block' : 'none';
        if (select.value !== 'custom' && select.value !== '') {
            updateDate(select.value);
        }
    });

    if(customInp) customInp.addEventListener('input', () => updateDate(customInp.value));
  }

  setupDateTemplate('g-template', 'g-custom-days-field', 'g-custom-days-input', 'g-deadline');
  setupDateTemplate('edit-template', 'edit-custom-days-field', 'edit-custom-days-input', 'edit-deadline');

  // --- ФУНКЦИИ ДЛЯ РАСЧЕТА ВРЕМЕНИ И ПЛЮРАЛИЗАЦИИ ---

  // Хелпер для правильного склонения слов
  function declOfNum(number, titles) {
    const cases = [2, 0, 1, 1, 1, 2];
    number = Math.abs(number);
    return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
  }
  
  // Функция для расчета и форматирования оставшегося времени
  function formatTimeLeft(deadline) {
    if (!deadline) return { text: '—', totalHours: null };

    // Устанавливаем дедлайн на конец дня (23:59:59) для точности
    // Добавляем 'T23:59:59' к дате, чтобы расчет велся до конца дедлайн-дня
    const deadlineTime = new Date(deadline + 'T23:59:59');
    const now = new Date();
    let diffMs = deadlineTime - now;

    if (diffMs <= 0) {
      // Просрочено
      const absDays = Math.ceil(Math.abs(diffMs) / 86400000); 
      const overdueText = absDays === 0 
          ? `<span style="color:var(--red)">Просрочено (сегодня)</span>`
          : `<span style="color:var(--red)">Просрочено (${absDays} ${declOfNum(absDays, ['день', 'дня', 'дней'])})</span>`;
      return { text: overdueText, totalHours: 0 };
    }

    const MS_PER_DAY = 86400000;
    const MS_PER_HOUR = 3600000;
    const MS_PER_MINUTE = 60000;
    
    const totalHours = diffMs / MS_PER_HOUR;

    let text = 'Осталось ';
    
    if (diffMs < MS_PER_DAY) {
      // Менее 24 часов: часы и минуты
      const hours = Math.floor(diffMs / MS_PER_HOUR);
      const minutes = Math.floor((diffMs % MS_PER_HOUR) / MS_PER_MINUTE);
      
      if (hours === 0 && minutes === 0) {
          text = 'Осталось менее минуты';
      } else {
          text += `${hours} ${declOfNum(hours, ['час', 'часа', 'часов'])}`;
          if (minutes > 0) {
              text += `, ${minutes} ${declOfNum(minutes, ['минута', 'минуты', 'минут'])}`;
          }
      }
      
    } else {
      // Более 24 часов: дни и часы
      const days = Math.floor(diffMs / MS_PER_DAY);
      const remainingMs = diffMs % MS_PER_DAY;
      const hours = Math.floor(remainingMs / MS_PER_HOUR);
      
      text += `${days} ${declOfNum(days, ['день', 'дня', 'дней'])}`;
      if (hours > 0) {
          // Часы добавляются только если осталось 1 или более дней
          text += `, ${hours} ${declOfNum(hours, ['час', 'часа', 'часов'])}`;
      }
    }
    
    return { text: `<span style="color:var(--text)">${text}</span>`, totalHours: totalHours };
  }

  function shortDate(dateStr) {
    if (!dateStr) return '—';
    const date = new Date(dateStr);
    // Добавление 12 часов, чтобы избежать проблем с часовыми поясами, сдвигающими дату на предыдущий день
    date.setHours(12); 
    const day = date.getDate();
    const month = date.toLocaleString('ru-RU', { month: 'short' }).replace('.', '');
    return `${day} ${month}`;
  }

  function save() {
    try {
        localStorage.setItem(K, JSON.stringify({data: {goals: DATA.goals}}));
    } catch(e) {
        showToast('Ошибка сохранения данных в браузере!');
        console.error("Local Storage Save Error:", e);
    }
  }

  function load() {
    try {
      const raw = localStorage.getItem(K);
      if (raw) {
        const parsed = JSON.parse(raw);
        // Добавлена более надежная проверка структуры
        DATA.goals = Array.isArray(parsed.data?.goals) ? parsed.data.goals : [];
      }
    } catch(e) { 
        console.error("Local Storage Load Error:", e); 
        showToast('Ошибка загрузки данных. Загружены пустые цели.');
    }
    render();
  }

  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }
  function openConfirmModal(text, callback, isDestructive = false) {
        document.getElementById('confirm-text').textContent = text;
        confirmAction = callback;
        const okBtn = document.getElementById('confirm-ok');
        okBtn.className = isDestructive ? 'btn danger' : 'btn primary';
        okBtn.textContent = isDestructive ? 'Удалить' : 'ОК';
        openModal('confirm-modal');
  }

  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.onclick = () => closeModal(btn.closest('.modal').id);
  });
  document.querySelectorAll('.modal').forEach(modal => {
    modal.onclick = (e) => { if (e.target === modal) closeModal(modal.id); };
  });
  
  document.getElementById('confirm-ok').onclick = () => {
      if(confirmAction) confirmAction();
      closeModal('confirm-modal');
      confirmAction = null;
  };
  document.getElementById('confirm-cancel').onclick = () => {
      closeModal('confirm-modal');
      confirmAction = null;
  };

  // --- NEW: MULTI-SELECTION LOGIC ---

  function updateMultiActionBar(visibleGoals) {
    const selectedCount = selectedGoalIds.size;
    
    // Manage visibility
    multiActionBar.style.display = selectedCount > 0 ? 'flex' : 'none';
    multiActionText.textContent = `Выбрано: ${selectedCount}`;
    
    const actionBtnsContainer = multiActionBar.querySelector('.multi-action-btns');
    actionBtnsContainer.innerHTML = ''; // Clear previous buttons
    
    const filter = document.querySelector('.tab.active').dataset.filter;
    
    if (filter === 'trash') {
        // Trash mode actions
        actionBtnsContainer.appendChild(btnSelectAll);
        btnSelectAll.innerHTML = `<i class="fa-solid fa-list-check"></i> <span class="desktop-only">${selectedCount === visibleGoals.length && visibleGoals.length > 0 ? 'Снять выделение' : 'Выбрать все'}</span>`;
        actionBtnsContainer.appendChild(btnMultiRestore);
        actionBtnsContainer.appendChild(btnMultiFinalDelete);
    } else if (filter === 'active' || filter === 'done' || filter === 'all') {
        // Active/Done/All mode actions
        actionBtnsContainer.appendChild(btnSelectAll);
        btnSelectAll.innerHTML = `<i class="fa-solid fa-list-check"></i> <span class="desktop-only">${selectedCount === visibleGoals.length && visibleGoals.length > 0 ? 'Снять выделение' : 'Выбрать все'}</span>`;

        // Check the status of selected goals to determine which button to show for completion
        const selected = DATA.goals.filter(g => selectedGoalIds.has(g.id));
        const allSelectedAreDone = selected.every(g => g.status === 'done');
        
        btnMultiDone.innerHTML = allSelectedAreDone 
            ? '<i class="fa-solid fa-rotate-left"></i> <span class="desktop-only">Вернуть</span>'
            : '<i class="fa-solid fa-check"></i> <span class="desktop-only">Готово</span>';
            
        btnMultiDone.title = allSelectedAreDone ? 'Вернуть в работу' : 'Завершить';
        
        actionBtnsContainer.appendChild(btnMultiDone);
        actionBtnsContainer.appendChild(btnMultiTrash);
    }
  }
  
  function toggleSelection(goalId) {
    if (selectedGoalIds.has(goalId)) {
        selectedGoalIds.delete(goalId);
    } else {
        selectedGoalIds.add(goalId);
    }
    // Re-render to update the selected class and action bar
    render(); 
  }
  
  function getSelectedGoals() {
      return DATA.goals.filter(g => selectedGoalIds.has(g.id));
  }
  
  // Select/Deselect All
  if(btnSelectAll) {
      btnSelectAll.onclick = () => {
          const filter = document.querySelector('.tab.active').dataset.filter;
          const visibleGoals = DATA.goals.filter(g => {
            if (filter === 'active') return g.status === 'active';
            if (filter === 'done') return g.status === 'done';
            if (filter === 'trash') return g.status === 'trash';
            if (filter === 'all') return g.status !== 'trash';
            return false;
          });
          
          if (selectedGoalIds.size === visibleGoals.length && visibleGoals.length > 0) {
              selectedGoalIds.clear(); // Deselect all
              showToast('Выделение снято');
          } else {
              selectedGoalIds.clear(); // Ensure clear first
              visibleGoals.forEach(g => selectedGoalIds.add(g.id)); // Select all
              showToast(`Выбрано ${visibleGoals.length} целей`);
          }
          render();
      };
  }

  // Bulk Done / Restore (from done)
  if(btnMultiDone) {
      btnMultiDone.onclick = () => {
          const selected = getSelectedGoals();
          if (selected.length === 0) return showToast('Сначала выберите цели!');
          
          const allDone = selected.every(g => g.status === 'done');
          const newStatus = allDone ? 'active' : 'done';
          const actionText = allDone ? 'вернуть в работу' : 'завершить';
          
          openConfirmModal(`Вы действительно хотите ${actionText} ${selected.length} целей?`, () => {
              selected.forEach(g => {
                  g.status = newStatus;
                  g.updatedAt = nowISO();
              });
              selectedGoalIds.clear();
              save(); render();
              showToast(newStatus === 'done' ? `Выполнено ${selected.length} целей!` : `Восстановлено ${selected.length} целей!`);
          });
      };
  }

  // Bulk Trash
  if(btnMultiTrash) {
      btnMultiTrash.onclick = () => {
          const selected = getSelectedGoals();
          if (selected.length === 0) return showToast('Сначала выберите цели!');
          
          openConfirmModal(`Переместить ${selected.length} целей в корзину?`, () => {
              selected.forEach(g => {
                  g.status = 'trash';
                  g.updatedAt = nowISO();
              });
              selectedGoalIds.clear();
              save(); render();
              showToast(`В корзину перемещено ${selected.length} целей`);
          });
      };
  }
  
  // Bulk Restore (from trash)
  if(btnMultiRestore) {
      btnMultiRestore.onclick = () => {
          const selected = getSelectedGoals();
          if (selected.length === 0) return showToast('Сначала выберите цели!');
          
          openConfirmModal(`Восстановить ${selected.length} целей из корзины?`, () => {
              selected.forEach(g => {
                  g.status = 'active';
                  g.updatedAt = nowISO();
              });
              selectedGoalIds.clear();
              save(); render();
              showToast(`Восстановлено ${selected.length} целей`);
          });
      };
  }

  // Bulk Final Delete (from trash)
  if(btnMultiFinalDelete) {
      btnMultiFinalDelete.onclick = () => {
          const selected = getSelectedGoals();
          if (selected.length === 0) return showToast('Сначала выберите цели!');
          
          openConfirmModal(`Удалить ${selected.length} целей безвозвратно?`, () => {
              const idsToDelete = Array.from(selectedGoalIds);
              DATA.goals = DATA.goals.filter(g => !idsToDelete.includes(g.id));
              selectedGoalIds.clear();
              save(); render();
              showToast(`Удалено навсегда ${selected.length} целей`);
          }, true);
      };
  }
  
  // --- END MULTI-SELECTION LOGIC ---


  function render() {
    const list = document.getElementById('goals-list');
    list.innerHTML = '';

    const filter = document.querySelector('.tab.active').dataset.filter;
    
    let visible = DATA.goals.filter(g => {
      if (filter === 'active') return g.status === 'active';
      if (filter === 'done') return g.status === 'done';
      if (filter === 'trash') return g.status === 'trash';
      if (filter === 'all') return g.status !== 'trash';
      return false;
    });

    if (visible.length === 0) {
      list.innerHTML = `<div class="empty-message"><i class="fa-regular fa-folder-open"></i><span>Список пуст</span></div>`;
      selectedGoalIds.clear(); // Clear selection if the list is empty
      updateMultiActionBar(visible);
      return; // Exit render early
    }
    
    // NEW: Update multi-action bar here before rendering cards
    updateMultiActionBar(visible);

    const active = DATA.goals.filter(g => g.status === 'active');
    const totalT = active.reduce((s,g) => s + safeParseNum(g.target), 0);
    const totalC = active.reduce((s,g) => s + safeParseNum(g.current), 0);
    const overall = totalT ? (totalC / totalT) * 100 : 0;

    document.getElementById('overall-progress').style.width = overall + '%';
    document.getElementById('overall-text').textContent = `Собрано ${fmt(totalC)} из ${fmt(totalT)} (${overall.toFixed(0)}%)`;

    document.getElementById('active-count').textContent = active.length;
    document.getElementById('done-count').textContent = DATA.goals.filter(g => g.status === 'done').length;
    document.getElementById('trash-count').textContent = DATA.goals.filter(g => g.status === 'trash').length;
    document.getElementById('total-count').textContent = DATA.goals.filter(g => g.status !== 'trash').length;

    visible.sort((a,b) => (b.updatedAt || b.createdAt || '') .localeCompare(a.updatedAt || a.createdAt || ''));
    
    const isTrash = (filter === 'trash');

    visible.forEach(g => {
      const target = safeParseNum(g.target);
      const current = safeParseNum(g.current);
      const pct = (target ? (current / target) * 100 : 0).toFixed(0);
      
      const { text: deadlineText, totalHours: hoursLeft } = formatTimeLeft(g.deadline);
      const isOverdue = hoursLeft !== null && hoursLeft <= 0;
      
      let pIcon = '';
      let pText = '';
      let pClass = '';

      if (g.priority === 'high') {
          pClass = 'priority-high';
          pIcon = '<i class="fa-solid fa-fire"></i>';
          pText = 'Высокий';
      } else if (g.priority === 'low') {
          pClass = 'priority-low';
          pIcon = '<i class="fa-solid fa-leaf"></i>';
          pText = 'Низкий';
      } else { // med
          pClass = 'priority-med';
          pIcon = '<i class="fa-solid fa-bolt"></i>'; 
          pText = 'Средний';
      }
      
      // Расчет в день, округляем до целых
      const neededPerHour = isOverdue || hoursLeft === null || hoursLeft <= 0 ? 0 : (target - current) / hoursLeft;
      const neededPerDay = neededPerHour * 24;


      const el = document.createElement('div');
      el.className = `goal-card ${selectedGoalIds.has(g.id) ? 'selected' : ''} ${isTrash ? 'goal-card-trash' : ''}`;
      el.dataset.id = g.id; // Add data-id for easy access
      
      let controls = '';
      
      // ИСПОЛЬЗУЕМ ИСПРАВЛЕННУЮ ПЕРЕМЕННУЮ isTrash
      if (!isTrash) {
          controls = `
            <div class="quick-add">
                <div class="quick-btn" data-add="1000" data-goal-id="${g.id}">+ 1к</div>
                <div class="quick-btn" data-add="5000" data-goal-id="${g.id}">+ 5к</div>
                <div class="quick-btn" data-add="10000" data-goal-id="${g.id}">+ 10к</div>
                <button class="quick-btn" data-act="progress" data-goal-id="${g.id}" style="flex-basis: 50px;"><i class="fa-solid fa-right-left"></i> +/-</button>
            </div>
            <div class="actions-row">
                <button class="action-icon-btn" data-act="edit" data-goal-id="${g.id}"><i class="fa-solid fa-pen"></i> <span class="desktop-only">Редактировать</span></button>
                <button class="action-icon-btn" data-act="done" data-goal-id="${g.id}">
                    ${g.status === 'done' ? '<i class="fa-solid fa-rotate-left"></i> <span class="desktop-only">Вернуть</span>' : '<i class="fa-solid fa-check"></i> <span class="desktop-only">Готово</span>'}
                </button>
                <button class="action-icon-btn delete" data-act="del" data-goal-id="${g.id}" style="margin-left:auto"><i class="fa-regular fa-trash-can"></i> <span class="desktop-only">В корзину</span></button>
            </div>
          `;
      } else {
          controls = `
             <div class="actions-row">
                <button class="action-icon-btn" data-act="restore" data-goal-id="${g.id}"><i class="fa-solid fa-rotate-left"></i> <span class="desktop-only">Восстановить</span></button>
                <button class="action-icon-btn delete" data-act="del-final" data-goal-id="${g.id}" style="margin-left:auto"><i class="fa-solid fa-ban"></i> <span class="desktop-only">Удалить навсегда</span></button>
            </div>
          `;
      }

      el.innerHTML = `
        <div class="goal-checkbox-wrapper">
             <input type="checkbox" class="goal-select-checkbox" data-id="${g.id}" ${selectedGoalIds.has(g.id) ? 'checked' : ''}>
        </div>
        <div class="goal-card-content">
            <div class="goal-header">
                <div class="goal-title">${g.title}</div>
                <div class="priority-badge ${pClass}">${pIcon} ${pText}</div>
            </div>
            <div class="goal-meta">
              <i class="fa-regular fa-clock"></i> ${deadlineText}
            </div>

            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <div class="numbers">
              <span>${fmt(current)}</span>
              <span>${fmt(target)} • ${pct}%</span>
            </div>

            ${g.status === 'active' || g.status === 'trash' || g.status === 'done' ? controls : ''}
            
            <div class="kpi">
              <div class="kpi-item">
                 <div class="kpi-value">${fmt(target - current)}</div>
                 <div class="kpi-label">Осталось</div>
              </div>
              <div class="kpi-item">
                 <div class="kpi-value" style="color:var(--text);">${shortDate(g.deadline)}</div> 
                 <div class="kpi-label">Дедлайн</div>
              </div>
              ${!isOverdue && hoursLeft !== null && hoursLeft > 0 ? `
              <div class="kpi-item">
                 <div class="kpi-value">${fmt(neededPerDay)}</div>
                 <div class="kpi-label">В день</div>
              </div>` : `
              <div class="kpi-item">
                 <div class="kpi-value" style="color:var(--text-muted)">—</div>
                 <div class="kpi-label">В день</div>
              </div>`}
            </div>
            
            ${g.notes ? `<div style="margin-top:12px; font-size:13px; color:var(--text-muted); padding:10px; background:var(--bg); border-radius:8px; line-height:1.4;">${g.notes}</div>` : ''}
        </div>
      `;
      
      // Attach single action listeners using data-goal-id
      el.querySelectorAll('[data-act]').forEach(btn => {
        btn.onclick = (e) => {
            // Prevent event from bubbling to the card/checkbox click handler
            e.stopPropagation(); 
            const act = btn.dataset.act;
            const goalId = btn.dataset.goalId;
            const g = DATA.goals.find(x => x.id === goalId);

            if (act === 'edit') openEditModal(goalId);
            if (act === 'progress') openProgressModal(goalId);
            if (act === 'done') {
                const newStatus = g.status === 'done' ? 'active' : 'done';
                openConfirmModal(`Вы действительно хотите ${newStatus === 'done' ? 'завершить' : 'вернуть в работу'} цель "${g.title}"?`, () => {
                    g.status = newStatus;
                    g.updatedAt = nowISO();
                    save(); render();
                    showToast(newStatus === 'done' ? 'Цель выполнена!' : 'Цель активна');
                });
            }
            if (act === 'del') {
                 openConfirmModal(`Переместить цель "${g.title}" в корзину?`, () => {
                    g.status = 'trash';
                    g.updatedAt = nowISO();
                    save(); render();
                    showToast('В корзине');
                });
            }
            if (act === 'restore') {
                g.status = 'active';
                save(); render();
                showToast('Восстановлено');
            }
            if (act === 'del-final') {
                openConfirmModal(`Удалить цель "${g.title}" безвозвратно?`, () => {
                    DATA.goals = DATA.goals.filter(x => x.id !== goalId);
                    save(); render();
                    showToast('Удалено');
                }, true);
            }
        }
      });
      
      // Quick add listeners
      el.querySelectorAll('[data-add]').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation(); // Stop propagation
          const delta = parseInt(btn.dataset.add);
          const goalId = btn.dataset.goalId;
          const g = DATA.goals.find(x => x.id === goalId);
          g.current = safeParseNum(g.current) + delta;
          g.updatedAt = nowISO();
          save(); render();
          showToast(`+ ${fmt(delta)}`);
        };
      });

      // Checkbox listener
      el.querySelector('.goal-select-checkbox').addEventListener('change', (e) => {
          e.stopPropagation(); // Critical to stop propagation on the checkbox itself
          toggleSelection(g.id);
      });
      
      // Click listener for the card to also toggle selection, but not on inner elements
      el.addEventListener('click', (e) => {
          // Only toggle if the click is directly on the card or the main content area, 
          // not on buttons, links, or inputs inside.
          if (!e.target.closest('.quick-add') && !e.target.closest('.actions-row') && e.target.type !== 'checkbox') {
              toggleSelection(g.id);
          }
      });


      list.appendChild(el);
    });
  }

  // --- ACTIONS ---

  function openEditModal(id) {
    const g = DATA.goals.find(x => x.id === id);
    if (!g) return;
    currentEditId = id;
    document.getElementById('edit-title').value = g.title || '';
    // Форматирование при открытии
    document.getElementById('edit-target').value = fmt(g.target); 
    document.getElementById('edit-current').value = fmt(g.current);
    document.getElementById('edit-deadline').value = g.deadline || '';
    document.getElementById('edit-priority').value = g.priority || 'med';
    document.getElementById('edit-notes').value = g.notes || '';
    document.getElementById('edit-template').value = '';
    document.getElementById('edit-custom-days-field').style.display = 'none';
    
    openModal('edit-modal');
  }

  document.getElementById('save-edit').onclick = () => {
    openConfirmModal('Сохранить изменения в цели?', () => {
        const g = DATA.goals.find(x => x.id === currentEditId);
        if (!g) return;
        g.title = document.getElementById('edit-title').value.trim();
        // Используем safeParseNum для преобразования отформатированного ввода в число
        g.target = safeParseNum(document.getElementById('edit-target').value); 
        g.current = safeParseNum(document.getElementById('edit-current').value);
        g.deadline = document.getElementById('edit-deadline').value || null;
        g.priority = document.getElementById('edit-priority').value;
        g.notes = document.getElementById('edit-notes').value.trim();
        g.updatedAt = nowISO();
        save(); render();
        closeModal('edit-modal');
        showToast('Сохранено');
    });
  };

  function openProgressModal(id) {
    currentProgressId = id;
    document.getElementById('progress-amount').value = '';
    openModal('progress-modal');
  }

  function updateProgress(isSubtract) {
    const g = DATA.goals.find(x => x.id === currentProgressId);
    if (!g) return;
    // Используем safeParseNum, чтобы обработать ввод типа "5к"
    const val = safeParseNum(document.getElementById('progress-amount').value); 
    if (val <= 0) { showToast('Введите положительную сумму!'); return; }
    
    openConfirmModal(`${isSubtract ? 'Вычесть' : 'Добавить'} ${fmt(val)}?`, () => {
        if (isSubtract) {
            g.current = Math.max(0, g.current - val);
            showToast(`Вычтено ${fmt(val)}`);
        } else {
            g.current = g.current + val;
            showToast(`Добавлено ${fmt(val)}`);
        }
        g.updatedAt = nowISO();
        save(); render();
        closeModal('progress-modal');
    });
  }

  document.getElementById('btn-add-progress').onclick = () => updateProgress(false);
  document.getElementById('btn-subtract').onclick = () => updateProgress(true);

  document.getElementById('btn-add').onclick = () => {
    const title = document.getElementById('g-title').value.trim();
    if (!title) { showToast('Введите название!'); return; }

    const g = {
      id: Date.now().toString(36),
      title,
      priority: document.getElementById('g-priority').value,
      target: safeParseNum(document.getElementById('g-target').value),
      current: safeParseNum(document.getElementById('g-current').value),
      deadline: document.getElementById('g-deadline').value || null,
      notes: document.getElementById('g-notes').value.trim(),
      status: 'active',
      createdAt: nowISO(),
      updatedAt: nowISO()
    };

    DATA.goals.push(g);
    save(); render();
    showToast('Цель создана');
    
    ['g-title','g-target','g-current','g-deadline','g-notes','g-custom-days-input'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
    });
    document.getElementById('g-template').value = '';
    document.getElementById('g-custom-days-field').style.display = 'none';
  };

  const demoGoals = [
      { t: 'Поездка на Бали', target: 200000, cur: 45000, p: 'high', note: 'Серфинг и отдых' },
      { t: 'Новый iPhone 16', target: 120000, cur: 10000, p: 'med', note: 'Подарок себе на ДР' },
      { t: 'Финансовая подушка', target: 500000, cur: 125000, p: 'high', note: '6 месяцев расходов' },
      { t: 'Курсы английского', target: 60000, cur: 0, p: 'low', note: 'Уровень B2 к лету' }
  ];

  document.getElementById('btn-demo').onclick = () => {
    // Добавляем цели только если их нет или для целей, которые уже не активны (чтобы не загромождать список)
    if (DATA.goals.filter(g => g.status === 'active').length > 0) {
        showToast('Активные цели уже есть. Создайте вручную!');
        return;
    }
    
    demoGoals.forEach(rnd => {
        const d = new Date();
        d.setDate(d.getDate() + 30 + Math.floor(Math.random() * 60));

        const g = {
          id: Date.now().toString(36) + Math.random().toString(36).slice(2),
          title: rnd.t,
          priority: rnd.p,
          target: rnd.target,
          current: rnd.cur,
          deadline: d.toISOString().slice(0,10),
          notes: rnd.note,
          status: 'active',
          createdAt: nowISO(),
          updatedAt: nowISO()
        };
        DATA.goals.push(g);
    });
    
    save(); 
    render(); 
    showToast('Демо-цели добавлены!');
  };

  // --- ЛОГИКА СОХРАНЕНИЯ ТЕМЫ ---
  
  document.getElementById('theme-btn').onclick = () => {
    const isDarkNow = document.body.dataset.theme === 'dark';
    const newTheme = isDarkNow ? '' : 'dark';
    document.body.dataset.theme = newTheme;
    localStorage.setItem('theme', newTheme);
    
    document.querySelector('#theme-btn i').className = newTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
  };


  document.getElementById('export-btn').onclick = () => {
    const dataToExport = localStorage.getItem(K);
    if (!dataToExport) {
        showToast('Нет данных для скачивания!');
        return;
    }
    
    const blob = new Blob([dataToExport], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'designflow-goals.json';
    a.click();
    showToast('Скачано');
  };

  document.getElementById('import-btn').onclick = () => document.getElementById('file-import').click();
  document.getElementById('file-import').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        try {
            // Проверка, что файл содержит JSON
            JSON.parse(reader.result); 
            openConfirmModal('Загрузить данные? Текущие будут заменены!', () => {
                localStorage.setItem(K, reader.result);
                load();
                showToast('База загружена');
            });
        } catch(err) {
            showToast('Ошибка: Файл поврежден или не является JSON.');
        }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      selectedGoalIds.clear(); // Сброс выделения при смене вкладки
      render();
    };
  });

  // --- ИНИЦИАЛИЗАЦИЯ (загрузка данных и темы) ---
  
  // 1. Применяем сохраненную тему перед загрузкой данных
  const savedTheme = localStorage.getItem('theme') || '';
  document.body.dataset.theme = savedTheme;
  
  // 2. Устанавливаем иконку на кнопке темы в соответствии с сохраненным состоянием
  const isDark = savedTheme === 'dark';
  const themeButtonIcon = document.querySelector('#theme-btn i');
  if (themeButtonIcon) {
      themeButtonIcon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
  }
  
  // 3. Загружаем данные
  load();
})();
</script>
</body>
</html>
